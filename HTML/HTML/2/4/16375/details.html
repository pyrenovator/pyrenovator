<html><h3>Pattern ID :16375
</h3><img src='55190683.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
        q = self.q.forward(h)
        k = self.k.forward(h)
        v = self.v.forward(h)
        q<a id="change"> = </a><a id="change">q.reshape(</a>m, n, 2<a id="change"> ** </a>8<a id="change">)</a>
        q = q.permute(0, 2, 1)
        k = k.reshape(m, n, 2 ** 8)
        w = torch.bmm(q, k)
        w /= n ** 0.5</code></pre><h3>After Change</h3><pre><code class='java'>
        w = torch.softmax(w, dim=2)
        w = w.permute(0, 2, 1)
        h = torch.bmm(v, w)
        token_count = <a id="change">int(</a>sqrt(h.shape[-1])<a id="change">)</a>
        h = h.reshape(m, n, token_count, token_count)
        h = self.proj_out.forward(h)
        return x + h
</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 4</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/kuprel/min-dalle/commit/798e6ac5a3088671c76168feaddbb88a9f9added#diff-024e676f25160dfa6354e48855cae744cc7cb035bf29895c0f175c97b19ab05fL45' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 55190683</div><div id='project'> Project Name: kuprel/min-dalle</div><div id='commit'> Commit Name: 798e6ac5a3088671c76168feaddbb88a9f9added</div><div id='time'> Time: 2022-07-17</div><div id='author'> Author: brkuprel@gmail.com</div><div id='file'> File Name: min_dalle/models/vqgan_detokenizer.py</div><div id='m_class'> M Class Name: AttentionBlock</div><div id='n_method'> N Class Name: AttentionBlock</div><div id='m_method'> M Method Name: forward(2)</div><div id='n_method'> N Method Name: forward(2)</div><div id='m_parent_class'> M Parent Class: nn.Module</div><div id='n_parent_class'> N Parent Class: Module</div><div id='m_file'> M File Name: min_dalle/models/vqgan_detokenizer.py</div><div id='n_file'> N File Name: min_dalle/models/vqgan_detokenizer.py</div><div id='m_start'> M Start Line: 45</div><div id='m_end'> M End Line: 57</div><div id='n_start'> N Start Line: 48</div><div id='n_end'> N End Line: 59</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
            predicted_probs, predicted = self.get_predicted(outputs)
            &#47&#47 if segmentation reshape the predictions and labels
            if len(predicted.shape) &gt; 2:
                predicted<a id="change"> = </a><a id="change">predicted.T.reshape(
                    </a>predicted.shape[0]<a id="change"> * </a>predicted.shape[2] * predicted.shape[3],
                    predicted.shape[1]<a id="change">,
                )</a>
                labels = labels.T.reshape(
                    labels.shape[0] * labels.shape[2] * labels.shape[3], labels.shape[1]
                )
</code></pre><h3>After Change</h3><pre><code class='java'>
        if criterion:
            total_loss = total_loss / len(dataloader.dataset)

        predicted_total = [<a id="change">int(</a>i<a id="change">)</a> for i in predicted_total]

        &#47&#47print(labels_total, predicted_total)
</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/biasvariancelabs/aitlas/commit/91b0085c154780bb7c833f1ecca31419c87ea510#diff-8c90d9e0305520faf5687b35e4d44d83709cb7e5160a7973610665e9a7133487L217' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 55190687</div><div id='project'> Project Name: biasvariancelabs/aitlas</div><div id='commit'> Commit Name: 91b0085c154780bb7c833f1ecca31419c87ea510</div><div id='time'> Time: 2021-04-26</div><div id='author'> Author: ivica.dimitrovski@yahoo.com</div><div id='file'> File Name: aitlas/base/models.py</div><div id='m_class'> M Class Name: BaseModel</div><div id='n_method'> N Class Name: BaseModel</div><div id='m_method'> M Method Name: evaluate_model(4)</div><div id='n_method'> N Method Name: evaluate_model(4)</div><div id='m_parent_class'> M Parent Class: nn.Module,Configurable</div><div id='n_parent_class'> N Parent Class: nn.Module,Configurable</div><div id='m_file'> M File Name: aitlas/base/models.py</div><div id='n_file'> N File Name: aitlas/base/models.py</div><div id='m_start'> M Start Line: 233</div><div id='m_end'> M End Line: 251</div><div id='n_start'> N Start Line: 221</div><div id='n_end'> N End Line: 280</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
    &#47&#47 ww = 30, hh = 30, cc = 192, num_patches = 14, valid_ww = 28, overlap_s = 1

    center = tf.reshape(pad_inputs[:, :valid_ww, :valid_ww, :], temp_shape) &#47&#47 (1, 14, 2, 14, 2, 192)
    ww_overlap<a id="change"> = </a><a id="change">tf.reshape(</a>pad_inputs[:, :valid_ww, overlap_s:valid_ww<a id="change"> + </a>overlap_s, :], temp_shape<a id="change">)</a>  &#47&#47 (1, 14, 2, 14, 2, 192)
    hh_overlap = tf.reshape(pad_inputs[:, overlap_s:valid_ww + overlap_s, :valid_ww, :], temp_shape)  &#47&#47 (1, 14, 2, 14, 2, 192)
    corner_overlap = tf.reshape(pad_inputs[:, overlap_s:valid_ww + overlap_s, overlap_s:valid_ww + overlap_s, :], temp_shape) &#47&#47 (1, 14, 2, 14, 2, 192)
    &#47&#47 print(f"{center.shape = }, {corner_overlap.shape = }")</code></pre><h3>After Change</h3><pre><code class='java'>
        pad_inputs = inputs

    _, hh, ww, cc = pad_inputs.shape
    num_patches_hh, num_patches_ww = <a id="change">int(</a>tf.math.ceil(hh / strides) - 1<a id="change">)</a>, int(tf.math.ceil(ww / strides) - 1)
    valid_hh, valid_ww = num_patches_hh * strides, num_patches_ww * strides
    overlap_s = kernel_size - strides
    temp_shape = (-1, num_patches_hh, strides, num_patches_ww, strides, cc)</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/leondgarse/keras_cv_attention_models/commit/c945694eeaf340f96627ec0155b9b26ddad5d30c#diff-346aa59a353ab2958ad8559a1c05a8fc850eaead58fd103d6bcb5a5130b699ceL178' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 55190684</div><div id='project'> Project Name: leondgarse/keras_cv_attention_models</div><div id='commit'> Commit Name: c945694eeaf340f96627ec0155b9b26ddad5d30c</div><div id='time'> Time: 2021-10-08</div><div id='author'> Author: leondgarse@gmail.com</div><div id='file'> File Name: keras_cv_attention_models/common_layers.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: tpu_extract_patches_overlap_1(6)</div><div id='n_method'> N Method Name: tpu_extract_patches_overlap_1(6)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: keras_cv_attention_models/common_layers.py</div><div id='n_file'> N File Name: keras_cv_attention_models/common_layers.py</div><div id='m_start'> M Start Line: 180</div><div id='m_end'> M End Line: 214</div><div id='n_start'> N Start Line: 183</div><div id='n_end'> N End Line: 217</div><BR>