<html><h3>Pattern ID :16513
</h3><img src='55458618.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
            assert len(records) == 2
            assert isinstance(records[0], argilla.TextClassificationRecord)

    mock_log<a id="change"> = </a>MockLog()
    <a id="change">monkeypatch.setattr(</a>argilla, <a id="change">"log"</a>, mock_log<a id="change">)</a>
    mock = TestClient(app)

    mock.post(
        expected_endpoint,</code></pre><h3>After Change</h3><pre><code class='java'>
    time.sleep(0.5)
    df = argilla.load(expected_dataset_name)
    df = df.to_pandas()
    <a id="change">assert </a>len(df) == 3


def test_argilla_middleware_for_token_classification(</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 4</div><BR><div id='size'>Non-data size: 3</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/recognai/rubrix/commit/53a57f79e195ff5e2ff75c4c4c19acb2f93bd41e#diff-0e0cbea3dbbb2c79cf5b4d495b5c0db3d7a537c19ff26fd82e2ea8858a6128a0L34' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 55458618</div><div id='project'> Project Name: recognai/rubrix</div><div id='commit'> Commit Name: 53a57f79e195ff5e2ff75c4c4c19acb2f93bd41e</div><div id='time'> Time: 2022-11-22</div><div id='author'> Author: francis@argilla.io</div><div id='file'> File Name: tests/client/test_asgi.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: test_argilla_middleware_for_text_classification(2)</div><div id='n_method'> N Method Name: test_argilla_middleware_for_text_classification(1)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: tests/client/test_asgi.py</div><div id='n_file'> N File Name: tests/client/test_asgi.py</div><div id='m_start'> M Start Line: 66</div><div id='m_end'> M End Line: 85</div><div id='n_start'> N Start Line: 34</div><div id='n_end'> N End Line: 104</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
            assert len(records) == 2
            assert isinstance(records[0], argilla.TokenClassificationRecord)

    mock_log<a id="change"> = </a>MockLog()
    <a id="change">monkeypatch.setattr(</a>argilla, <a id="change">"log"</a>, mock_log<a id="change">)</a>
    mock = TestClient(app)

    mock.post(
        expected_endpoint,</code></pre><h3>After Change</h3><pre><code class='java'>
    time.sleep(0.5)
    df = argilla.load(expected_dataset_name)
    df = df.to_pandas()
    <a id="change">assert </a>len(df) == 2

    mock.get(
        expected_endpoint_get,</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/recognai/rubrix/commit/53a57f79e195ff5e2ff75c4c4c19acb2f93bd41e#diff-0e0cbea3dbbb2c79cf5b4d495b5c0db3d7a537c19ff26fd82e2ea8858a6128a0L88' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 55458616</div><div id='project'> Project Name: recognai/rubrix</div><div id='commit'> Commit Name: 53a57f79e195ff5e2ff75c4c4c19acb2f93bd41e</div><div id='time'> Time: 2022-11-22</div><div id='author'> Author: francis@argilla.io</div><div id='file'> File Name: tests/client/test_asgi.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: test_argilla_middleware_for_token_classification(2)</div><div id='n_method'> N Method Name: test_argilla_middleware_for_token_classification(1)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: tests/client/test_asgi.py</div><div id='n_file'> N File Name: tests/client/test_asgi.py</div><div id='m_start'> M Start Line: 123</div><div id='m_end'> M End Line: 138</div><div id='n_start'> N Start Line: 109</div><div id='n_end'> N End Line: 187</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
    monkeypatch.setenv("BBS_DATA_AND_MODELS_DIR", "some_path")

    fake_sqlalchemy = Mock()
    fake_load_ee_models_library<a id="change"> = </a>Mock()
    fake_load_ee_models_library.return_value = pd.DataFrame(
        columns=["entity_type", "model_id", "model_path", "entity_type_name"]
    )
    fake_mining_server_inst = Mock()
    fake_mining_server_class = Mock(return_value=fake_mining_server_inst)

    monkeypatch.setattr(
        "bluesearch.server.mining_server.MiningServer", fake_mining_server_class
    )
    monkeypatch.setattr(
        "bluesearch.entrypoint.mining_server.sqlalchemy", fake_sqlalchemy
    )
    <a id="change">monkeypatch.setattr(
        "bluesearch.entrypoint.mining_server.load_ee_models_library"</a>,
        fake_load_ee_models_library<a id="change">,
    )</a>

    if db_type not in {"mysql", "sqlite"}:
        with pytest.raises(ValueError):
            get_mining_app()</code></pre><h3>After Change</h3><pre><code class='java'>
        assert kwargs["connection"] == fake_sqlalchemy.create_engine.return_value
        assert "ee" in kwargs["models_libs"]
        assert isinstance(kwargs["models_libs"]["ee"], dict)
        <a id="change">assert </a>len(kwargs["models_libs"]["ee"]) == len(entity_types)
</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/bluebrain/search/commit/05fe137611fffaab1cdfb9f3c04b32bb8964666d#diff-59fc08f138bb741ccd97fab6f56c488d0545b27a60cb0539088d52d4262b9b63L38' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 55458615</div><div id='project'> Project Name: bluebrain/search</div><div id='commit'> Commit Name: 05fe137611fffaab1cdfb9f3c04b32bb8964666d</div><div id='time'> Time: 2021-06-22</div><div id='author'> Author: 47669575+EmilieDel@users.noreply.github.com</div><div id='file'> File Name: tests/test_entrypoint/test_mining_server.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: test_send_through(6)</div><div id='n_method'> N Method Name: test_send_through(4)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: tests/test_entrypoint/test_mining_server.py</div><div id='n_file'> N File Name: tests/test_entrypoint/test_mining_server.py</div><div id='m_start'> M Start Line: 52</div><div id='m_end'> M End Line: 71</div><div id='n_start'> N Start Line: 38</div><div id='n_end'> N End Line: 80</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
            ["CHEMICAL", "CHEBI", "path/to/model_3", f"{data_dir}/path/to/model_3"],
        ],
    )
    fake_load_ee_models_library<a id="change"> = </a>Mock()
    fake_load_ee_models_library.return_value = df_model_library
    fake_sqlalchemy = Mock()
    fake_create_mining_cache = Mock()
    monkeypatch.setattr(
        "bluesearch.entrypoint.create_mining_cache.sqlalchemy", fake_sqlalchemy
    )
    <a id="change">monkeypatch.setattr(
        "bluesearch.entrypoint.create_mining_cache.load_ee_models_library"</a>,
        fake_load_ee_models_library<a id="change">,
    )</a>
    monkeypatch.setattr(
        "bluesearch.database.CreateMiningCache", fake_create_mining_cache
    )
    monkeypatch.setattr(</code></pre><h3>After Change</h3><pre><code class='java'>

    &#47&#47 Check the args/kwargs
    assert kwargs["database_engine"] == fake_sqlalchemy.create_engine()
    <a id="change">assert </a>isinstance(kwargs["ee_models_paths"], dict)
    assert len(kwargs["ee_models_paths"]) == len(available_models)
    assert kwargs["target_table_name"] == target_table_name
    assert kwargs["workers_per_model"] == n_processes_per_model</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/bluebrain/search/commit/05fe137611fffaab1cdfb9f3c04b32bb8964666d#diff-eb6867eaad1ec93599103bb9af4fee07a7f212f5c5417c4b51e670fa54658efdL78' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 55458612</div><div id='project'> Project Name: bluebrain/search</div><div id='commit'> Commit Name: 05fe137611fffaab1cdfb9f3c04b32bb8964666d</div><div id='time'> Time: 2021-06-22</div><div id='author'> Author: 47669575+EmilieDel@users.noreply.github.com</div><div id='file'> File Name: tests/test_entrypoint/test_create_mining_cache.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: test_send_through(9)</div><div id='n_method'> N Method Name: test_send_through(7)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: tests/test_entrypoint/test_create_mining_cache.py</div><div id='n_file'> N File Name: tests/test_entrypoint/test_create_mining_cache.py</div><div id='m_start'> M Start Line: 88</div><div id='m_end'> M End Line: 163</div><div id='n_start'> N Start Line: 85</div><div id='n_end'> N End Line: 135</div><BR>