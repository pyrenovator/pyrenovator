<html><h3>Pattern ID :12672
</h3><img src='42953598.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
            os.makedirs(output, exist_ok=True)

        &#47&#47 Zip files
        <a id="change">if compression == "zip"</a>:
            with ZipFile(path, "w", ZIP_DEFLATED) as zfile:
                for root, _, files in sorted(os.walk(self.path())):
                    for f in files:</code></pre><h3>After Change</h3><pre><code class='java'>
            os.makedirs(output, exist_ok=True)

        &#47&#47 Pack into compressed file
        compress<a id="change"> = </a><a id="change">CompressFactory().create(</a>path<a id="change">)</a>
        compress.pack(self.path(), path)

        &#47&#47 Save file to cloud storage, if necessary
        cloud = self.cloud(config)</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 4</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/neuml/txtai/commit/de8b2ee5991bb513905ec7fe782b8f5ff2ed71c0#diff-c7b5d494605657e2c026e8076a5ddaac4c6be25c973d805ad9e2b815b3d66fcdL111' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 42953598</div><div id='project'> Project Name: neuml/txtai</div><div id='commit'> Commit Name: de8b2ee5991bb513905ec7fe782b8f5ff2ed71c0</div><div id='time'> Time: 2022-11-01</div><div id='author'> Author: 561939+davidmezzetti@users.noreply.github.com</div><div id='file'> File Name: src/python/txtai/embeddings/archive.py</div><div id='m_class'> M Class Name: Archive</div><div id='n_method'> N Class Name: Archive</div><div id='m_method'> M Method Name: save(3)</div><div id='n_method'> N Method Name: save(3)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: src/python/txtai/embeddings/archive.py</div><div id='n_file'> N File Name: src/python/txtai/embeddings/archive.py</div><div id='m_start'> M Start Line: 115</div><div id='m_end'> M End Line: 135</div><div id='n_start'> N Start Line: 111</div><div id='n_end'> N End Line: 112</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        if self.module_backends:
            self.dht_handler_thread.start()

        <a id="change">if self.checkpoint_saver is not None</a>:
            self.checkpoint_saver.start()

        for process in self.conn_handlers:</code></pre><h3>After Change</h3><pre><code class='java'>
    def run(self):
        while True:
            block_indices = self._choose_blocks()
            self.module_container<a id="change"> = </a><a id="change">ModuleContainer.create(
                dht=self.dht,
                prefix=self.prefix,
                converted_model_name_or_path=self.converted_model_name_or_path,
                block_config=self.block_config,
                memory_cache=self.memory_cache,
                throughput=self.throughput,
                block_indices=block_indices,
                num_handlers=self.num_handlers,
                min_batch_size=self.min_batch_size,
                max_batch_size=self.max_batch_size,
                inference_max_length=self.inference_max_length,
                torch_dtype=self.torch_dtype,
                cache_dir=self.cache_dir,
                device=self.device,
                compression=self.compression,
                stats_report_interval=self.stats_report_interval,
                update_period=self.update_period,
                expiration=self.expiration,
                prefetch_batches=self.prefetch_batches,
                sender_threads=self.sender_threads,
                use_auth_token=self.use_auth_token,
                load_in_8bit=self.load_in_8bit,
                start=True,
            )</a>
            try:
                self.module_container.ready.wait()

                while True:</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/bigscience-workshop/distributed-bloom/commit/149f433763e2eb332b16de91cf47809579706001#diff-e0bb43e77afdc23f85aefba41e3d8fda1554c6402c8e08536508ed6246d8068fL68' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 42953597</div><div id='project'> Project Name: bigscience-workshop/distributed-bloom</div><div id='commit'> Commit Name: 149f433763e2eb332b16de91cf47809579706001</div><div id='time'> Time: 2022-10-12</div><div id='author'> Author: hxrussia@gmail.com</div><div id='file'> File Name: src/server/server.py</div><div id='m_class'> M Class Name: Server</div><div id='n_method'> N Class Name: Server</div><div id='m_method'> M Method Name: run(1)</div><div id='n_method'> N Method Name: run(1)</div><div id='m_parent_class'> M Parent Class: threading.Thread</div><div id='n_parent_class'> N Parent Class: threading.Thread</div><div id='m_file'> M File Name: src/server/server.py</div><div id='n_file'> N File Name: src/server/server.py</div><div id='m_start'> M Start Line: 73</div><div id='m_end'> M End Line: 99</div><div id='n_start'> N Start Line: 148</div><div id='n_end'> N End Line: 190</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
    if accelerator.mixed_precision == "fp16" and accelerator.distributed_type == accelerate_dataclasses.DistributedType.DEEPSPEED and config.decoder.learned_variance:
        raise ValueError("DeepSpeed fp16 mode does not support learned variance")

    <a id="change">if accelerator.process_index != accelerator.local_process_index</a> and accelerator.distributed_type == accelerate_dataclasses.DistributedType.DEEPSPEED:
        &#47&#47 This is an invalid configuration until we figure out how to handle this
        raise ValueError("DeepSpeed does not support multi-node distributed training")
    </code></pre><h3>After Change</h3><pre><code class='java'>
    &#47&#47 If clip is in the model, we need to remove it for compatibility with deepspeed
    clip = None
    if config.decoder.clip is not None:
        clip<a id="change"> = </a><a id="change">config.decoder.clip.create()</a>  &#47&#47 Of course we keep it to use it during training, just not in the decoder as that causes issues
        config.decoder.clip = None
    &#47&#47 Create the decoder model and print basic info
    decoder = config.decoder.create()</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/lucidrains/dalle2-pytorch/commit/cbaadb693116b214cc29d0569ed0c0a5b9178ab7#diff-1960fa4032117c7620576aea3bf67f017dd87a2077278af4c2f17abf549114b0L540' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 42953596</div><div id='project'> Project Name: lucidrains/dalle2-pytorch</div><div id='commit'> Commit Name: cbaadb693116b214cc29d0569ed0c0a5b9178ab7</div><div id='time'> Time: 2022-08-20</div><div id='author'> Author: aidan.dempster@gmail.com</div><div id='file'> File Name: train_decoder.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: initialize_training(2)</div><div id='n_method'> N Method Name: initialize_training(2)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: train_decoder.py</div><div id='n_file'> N File Name: train_decoder.py</div><div id='m_start'> M Start Line: 547</div><div id='m_end'> M End Line: 593</div><div id='n_start'> N Start Line: 593</div><div id='n_end'> N End Line: 608</div><BR>