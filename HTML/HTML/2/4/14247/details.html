<html><h3>Pattern ID :14247
</h3><img src='47277856.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
    bn_conv_pairs = []
    for node in ordered_conv_fc_nodes:
        &#47&#47 Filter out combinations that are not supported
        if node in conv_linear_bn_activation_info_dict.keys() and is_valid_bn_fold(<a id="change">node.get_module()</a>, model, False):
            bn_info = conv_linear_bn_activation_info_dict[node]
            if bn_info.input_bn and bn_info.input_bn not in bn_picked_for_folding:
                bn_conv_pairs.append((bn_info.input_bn.get_module(), node.get_module()))</code></pre><h3>After Change</h3><pre><code class='java'>
                    logger.info(&quot...... invalid combination to fold %s&quot, [node.name, bn_info.output_bn.name])

    bn_conv_pairs = []
    for <a id="change">node</a> in ordered_conv_fc_nodes:
        &#47&#47 Filter out combinations that are not supported
        if node in conv_linear_bn_activation_info_dict.keys():
            bn_info = conv_linear_bn_activation_info_dict[node]
            if bn_info.input_bn and bn_info.input_bn not in bn_picked_for_folding:
                if is_valid_bn_fold(<a id="change">node.get_module()</a>, model, False):
                    bn_conv_pairs.append((bn_info.input_bn.get_module(), node.get_module()))
                    bn_picked_for_folding.add(bn_info.input_bn)
                else:</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 2</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/quic/aimet/commit/af9f7ad7564670c9f38250b1fd2949c0958b6f48#diff-ec30297caa489fdc47f6610594dae10bfeb0ceabbe2ff7a5378c662a10819d30L109' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 47277856</div><div id='project'> Project Name: quic/aimet</div><div id='commit'> Commit Name: af9f7ad7564670c9f38250b1fd2949c0958b6f48</div><div id='time'> Time: 2023-01-13</div><div id='author'> Author: quic_mtuttle@quicinc.com</div><div id='file'> File Name: TrainingExtensions/onnx/src/python/aimet_onnx/batch_norm_fold.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: find_all_batch_norms_to_fold(1)</div><div id='n_method'> N Method Name: find_all_batch_norms_to_fold(1)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: TrainingExtensions/onnx/src/python/aimet_onnx/batch_norm_fold.py</div><div id='n_file'> N File Name: TrainingExtensions/onnx/src/python/aimet_onnx/batch_norm_fold.py</div><div id='m_start'> M Start Line: 109</div><div id='m_end'> M End Line: 134</div><div id='n_start'> N Start Line: 110</div><div id='n_end'> N End Line: 141</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>

    conv_bn_pairs = []
    &#47&#47 Backward fold is given priority over Forward fold
    for <a id="change">node</a> in ordered_conv_fc_nodes:
        &#47&#47 Filter out combinations that are not supported
        if node in conv_linear_bn_activation_info_dict.keys() and is_valid_bn_fold(<a id="change">node.get_module()</a>, model, True):
            bn_info = conv_linear_bn_activation_info_dict[node]
            if bn_info.output_bn and bn_info.output_bn not in bn_picked_for_folding:
                conv_bn_pairs.append((node.get_module(), bn_info.output_bn.get_module()))</code></pre><h3>After Change</h3><pre><code class='java'>

    conv_bn_pairs = []
    &#47&#47 Backward fold is given priority over Forward fold
    for <a id="change">node</a> in ordered_conv_fc_nodes:
        &#47&#47 Filter out combinations that are not supported
        if node in conv_linear_bn_activation_info_dict.keys():
            bn_info = conv_linear_bn_activation_info_dict[node]
            if bn_info.output_bn and bn_info.output_bn not in bn_picked_for_folding:
                if is_valid_bn_fold(<a id="change">node.get_module()</a>, model, True):
                    conv_bn_pairs.append((node.get_module(), bn_info.output_bn.get_module()))
                    bn_picked_for_folding.add(bn_info.output_bn)
                else:</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/quic/aimet/commit/af9f7ad7564670c9f38250b1fd2949c0958b6f48#diff-ec30297caa489fdc47f6610594dae10bfeb0ceabbe2ff7a5378c662a10819d30L98' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 47277858</div><div id='project'> Project Name: quic/aimet</div><div id='commit'> Commit Name: af9f7ad7564670c9f38250b1fd2949c0958b6f48</div><div id='time'> Time: 2023-01-13</div><div id='author'> Author: quic_mtuttle@quicinc.com</div><div id='file'> File Name: TrainingExtensions/onnx/src/python/aimet_onnx/batch_norm_fold.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: find_all_batch_norms_to_fold(1)</div><div id='n_method'> N Method Name: find_all_batch_norms_to_fold(1)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: TrainingExtensions/onnx/src/python/aimet_onnx/batch_norm_fold.py</div><div id='n_file'> N File Name: TrainingExtensions/onnx/src/python/aimet_onnx/batch_norm_fold.py</div><div id='m_start'> M Start Line: 109</div><div id='m_end'> M End Line: 134</div><div id='n_start'> N Start Line: 110</div><div id='n_end'> N End Line: 141</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        self.assertEqual(bn2_new.type, &quotFusedBatchNormV3&quot)

        training_tf_placeholder = set()
        for <a id="change">bn</a> in [bn1_new, bn2_new]:
            &#47&#47 Check if training flag of batchnorm is replaced to placeholder
            bn_training = <a id="change">bn.get_module()</a>.inputs[0].op.inputs[0]
            self.assertEqual(bn_training.op.type, &quotPlaceholderWithDefault&quot)
            training_tf_placeholder.add(bn_training)
</code></pre><h3>After Change</h3><pre><code class='java'>
        self.assertEqual(bn2_new.type, &quotFusedBatchNormV3&quot)

        training_tf_placeholder = set()
        for <a id="change">bn</a> in [bn1_new, bn2_new]:
            &#47&#47 Check if training flag of batchnorm is replaced to placeholder
            bn_training = BNUtils.get_training(<a id="change">bn.get_module()</a>)
            self.assertEqual(bn_training.op.type, &quotPlaceholderWithDefault&quot)
            training_tf_placeholder.add(bn_training)
</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/quic/aimet/commit/191496aa99204d35e2982ce18f41c67c4adaa29b#diff-d1404cf90bb38355be09076748156a72abb220544bd6a9ace2b0574c04e52190L146' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 47277852</div><div id='project'> Project Name: quic/aimet</div><div id='commit'> Commit Name: 191496aa99204d35e2982ce18f41c67c4adaa29b</div><div id='time'> Time: 2022-10-25</div><div id='author'> Author: quic_kyuykim@quicinc.com</div><div id='file'> File Name: TrainingExtensions/tensorflow/test/python/non_eager/test_bn_mutable.py</div><div id='m_class'> M Class Name: TestBnMutable</div><div id='n_method'> N Class Name: TestBnMutable</div><div id='m_method'> M Method Name: test_modify_sess_bn_mutable_with_v1_bn_model(1)</div><div id='n_method'> N Method Name: test_modify_sess_bn_mutable_with_v1_bn_model(1)</div><div id='m_parent_class'> M Parent Class: unittest.TestCase</div><div id='n_parent_class'> N Parent Class: unittest.TestCase</div><div id='m_file'> M File Name: TrainingExtensions/tensorflow/test/python/non_eager/test_bn_mutable.py</div><div id='n_file'> N File Name: TrainingExtensions/tensorflow/test/python/non_eager/test_bn_mutable.py</div><div id='m_start'> M Start Line: 148</div><div id='m_end'> M End Line: 217</div><div id='n_start'> N Start Line: 160</div><div id='n_end'> N End Line: 225</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        &#47&#47 there should be only 4 connected graph ops, input, simpleRNN , Dense and Softmax
        self.assertTrue(len(conn_graph.get_all_ops()) == 4)
        simple_rnn_detected = False
        for <a id="change">op</a> in conn_graph.get_all_ops().values():
            if op.type == &quotSimpleRNN&quot:
                simple_rnn_detected = True
                inner_list = op.internal_ops
                self.assertTrue(<a id="change">op.get_module()</a> == sess.graph.get_operation_by_name(&quotsimple_rnn/while/MatMul&quot))
                self.assertTrue(op.name == &quotsimple_rnn&quot)
        self.assertTrue(simple_rnn_detected)
        self.assertTrue(len(inner_list) == 49)</code></pre><h3>After Change</h3><pre><code class='java'>
        &#47&#47 there should be only 4 connected graph ops, input, simpleRNN , Dense and Softmax
        self.assertEqual(4, len(conn_graph.get_all_ops()))
        simple_rnn_detected = False
        for <a id="change">op</a> in conn_graph.get_all_ops().values():
            if op.type == &quotSimpleRNN&quot:
                simple_rnn_detected = True
                inner_list = op.internal_ops
                self.assertEqual(49, len(inner_list))
                self.assertEqual(<a id="change">op.get_module()</a>, sess.graph.get_operation_by_name(&quotrnn0/while/MatMul&quot))
                self.assertEqual(&quotrnn0&quot, op.name)
        self.assertTrue(simple_rnn_detected)
</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/quic/aimet/commit/e484e14e2f1cb569964b67fda431f17087449fc7#diff-9438b2bdd09acefee9eaa87411414067e5ddeec56ab224b73b186eaa5f3b1360L392' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 47277855</div><div id='project'> Project Name: quic/aimet</div><div id='commit'> Commit Name: e484e14e2f1cb569964b67fda431f17087449fc7</div><div id='time'> Time: 2020-10-01</div><div id='author'> Author: quic_akhobare@quicinc.com</div><div id='file'> File Name: TrainingExtensions/tensorflow/test/python/test_tf_connected_graph_with_subgraph_matcher.py</div><div id='m_class'> M Class Name: TestTfConnectedGraph</div><div id='n_method'> N Class Name: TestTfConnectedGraph</div><div id='m_method'> M Method Name: test_model_with_simple_rnn_layer(1)</div><div id='n_method'> N Method Name: test_model_with_simple_rnn_layer(1)</div><div id='m_parent_class'> M Parent Class: unittest.TestCase</div><div id='n_parent_class'> N Parent Class: unittest.TestCase</div><div id='m_file'> M File Name: TrainingExtensions/tensorflow/test/python/test_tf_connected_graph_with_subgraph_matcher.py</div><div id='n_file'> N File Name: TrainingExtensions/tensorflow/test/python/test_tf_connected_graph_with_subgraph_matcher.py</div><div id='m_start'> M Start Line: 412</div><div id='m_end'> M End Line: 437</div><div id='n_start'> N Start Line: 412</div><div id='n_end'> N End Line: 437</div><BR>