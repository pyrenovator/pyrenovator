<html><h3>Pattern ID :31632
</h3><img src='92272202.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
    &#47&#47 weight = (groups, rcout, cin, H, W)
    &#47&#47 output = (bs, groups, rcout, oy, ox)

    conv<a id="change"> = </a><a id="change">clbuild(</a>"conv", <a id="change">
    __kernel void conv(__global const float *input, __global const float *weight, __global float *output,
      int H, int W, int groups, int rcout, int cin, int oy, int ox, int iy, int ix, int ys, int xs) {

      int B = get_global_id(0)/(groups*rcout);  // range 0-bs
      int g = (get_global_id(0)/rcout)%groups;
      int c = get_global_id(0) % rcout;

      int Y = get_global_id(1);  // range 0-oy
      int X = get_global_id(2);  // range 0-ox
      int IY = Y*ys;
      int IX = X*xs;

      float acc = 0.0;
      for (int ci = 0; ci &lt; cin; ci++) {
        for (int y = IY; y &lt; IY+H; y++) {
          for (int x = IX; x &lt; IX+W; x++) {
            acc += input[B*groups*cin*iy*ix + g*cin*iy*ix + ci*iy*ix + y*ix + x] * \
              weight[g*rcout*cin*H*W + c*cin*H*W + ci*H*W + (y-IY)*W + (x-IX)];
          }
        }
      }
      output[B*groups*rcout*oy*ox + g*rcout*oy*ox + c*oy*ox + Y*ox + X] = acc;
    }</a><a id="change">)</a>

    conv_args = H, W, groups, rcout, cin, oy, ox, iy, ix, ys, xs
    conv([bs*groups*rcout, oy, ox], None, x.cl, w.cl, ret.cl, *[i32(x) for x in conv_args])
    return ret</code></pre><h3>After Change</h3><pre><code class='java'>

    &#47&#47 output buffer
    conv_args = H, W, groups, rcout, cin, oy, ox, iy, ix, ys, xs, bs
    <a id="change">return </a>conv(x, w, buffer_new(ctx, (bs, cout, oy, ox)), conv_args)

  def backward(ctx, grad_output):
    bs,_,oy,ox = grad_output.shape</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 3</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/geohot/tinygrad/commit/f01bad36c23c0261528608907a65f3371bc7076b#diff-8bb45fb4c0a48bb117ccd344d322687d080ebe652d54492029b741e4bf0e6d46L166' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 92272202</div><div id='project'> Project Name: geohot/tinygrad</div><div id='commit'> Commit Name: f01bad36c23c0261528608907a65f3371bc7076b</div><div id='time'> Time: 2022-06-05</div><div id='author'> Author: geohot@gmail.com</div><div id='file'> File Name: tinygrad/ops/ops_gpu.py</div><div id='m_class'> M Class Name: Conv2D</div><div id='n_method'> N Class Name: Conv2D</div><div id='m_method'> M Method Name: forward(5)</div><div id='n_method'> N Method Name: forward(5)</div><div id='m_parent_class'> M Parent Class: Function</div><div id='n_parent_class'> N Parent Class: Function</div><div id='m_file'> M File Name: tinygrad/ops/ops_gpu.py</div><div id='n_file'> N File Name: tinygrad/ops/ops_gpu.py</div><div id='m_start'> M Start Line: 166</div><div id='m_end'> M End Line: 204</div><div id='n_start'> N Start Line: 170</div><div id='n_end'> N End Line: 171</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
  @staticmethod
  def forward(ctx, x):
    ret = buffer_like(ctx, x)
    prg<a id="change"> = </a><a id="change">clbuild(</a>ctx.cl_ctx, <a id="change">
    __kernel void relu(
        __global const float *a_g, __global float *res_g)
    {
      int gid = get_global_id(0);
      res_g[gid] = min(a_g[gid], (float)0.);
    }
    </a><a id="change">)</a>
    prg.relu(ctx.cl_queue, [np.prod(ret.shape)], None, x, ret)
    return ret

  @staticmethod</code></pre><h3>After Change</h3><pre><code class='java'>
class ReLU(Function):
  @staticmethod
  def forward(ctx, x):
    <a id="change">return </a>unary_op(ctx, &quotres_g[gid] = min(a_g[gid], (float)0.);&quot, x)

  @staticmethod
  def backward(ctx, grad_output):</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/geohot/tinygrad/commit/231c1134bd26ae20631da4cae05fb96ce3525751#diff-b7e8a4d3462e65523c8cfd523079177ad58eb9176481ea76a4dedbe501683059L170' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 92272201</div><div id='project'> Project Name: geohot/tinygrad</div><div id='commit'> Commit Name: 231c1134bd26ae20631da4cae05fb96ce3525751</div><div id='time'> Time: 2020-11-02</div><div id='author'> Author: geohot@gmail.com</div><div id='file'> File Name: tinygrad/opsgpu.py</div><div id='m_class'> M Class Name: ReLU</div><div id='n_method'> N Class Name: ReLU</div><div id='m_method'> M Method Name: forward(2)</div><div id='n_method'> N Method Name: forward(2)</div><div id='m_parent_class'> M Parent Class: Function</div><div id='n_parent_class'> N Parent Class: Function</div><div id='m_file'> M File Name: tinygrad/opsgpu.py</div><div id='n_file'> N File Name: tinygrad/opsgpu.py</div><div id='m_start'> M Start Line: 171</div><div id='m_end'> M End Line: 181</div><div id='n_start'> N Start Line: 184</div><div id='n_end'> N End Line: 184</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
    ctx.save_for_backward(input)

    ret = buffer_new(ctx, (1,))
    prg<a id="change"> = </a><a id="change">clbuild(</a>ctx.cl_ctx, <a id="change">
    __kernel void sum(
        __global const float *a_g, int sz, __global float *res_g)
    {
      float out = 0.0;
      for (int x = 0; x &lt; sz; x++) {
        out += a_g[x];
      }
      res_g[0] = out;
    }
    </a><a id="change">)</a>
    prg.sum(ctx.cl_queue, [input.shape[0]], None, input, np.int32(np.prod(input.shape)), ret)
    return ret

  @staticmethod</code></pre><h3>After Change</h3><pre><code class='java'>
  @staticmethod
  def forward(ctx, input):
    ctx.save_for_backward(input)
    <a id="change">return </a>reduce_op(ctx, "out += a", "out", input, (1,))

  @staticmethod
  def backward(ctx, grad_output):</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/geohot/tinygrad/commit/aeb90226a8647615b77a1b63dde00e21529d2bb5#diff-b7e8a4d3462e65523c8cfd523079177ad58eb9176481ea76a4dedbe501683059L187' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 92272200</div><div id='project'> Project Name: geohot/tinygrad</div><div id='commit'> Commit Name: aeb90226a8647615b77a1b63dde00e21529d2bb5</div><div id='time'> Time: 2020-11-09</div><div id='author'> Author: geohot@gmail.com</div><div id='file'> File Name: tinygrad/opsgpu.py</div><div id='m_class'> M Class Name: Sum</div><div id='n_method'> N Class Name: Sum</div><div id='m_method'> M Method Name: forward(2)</div><div id='n_method'> N Method Name: forward(2)</div><div id='m_parent_class'> M Parent Class: Function</div><div id='n_parent_class'> N Parent Class: Function</div><div id='m_file'> M File Name: tinygrad/opsgpu.py</div><div id='n_file'> N File Name: tinygrad/opsgpu.py</div><div id='m_start'> M Start Line: 190</div><div id='m_end'> M End Line: 203</div><div id='n_start'> N Start Line: 209</div><div id='n_end'> N End Line: 209</div><BR>