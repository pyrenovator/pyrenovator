<link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>

    if buckets != n:
        context = F.pad(context, (0, 0, 0, 0, 1, 0), value=0.)
        context = context[:, <a id="change">:-1</a>]

    attn_einsum_eq = &quotbhund,bhude-&gt;bhune&quot if not one_kv_head else &quotbhund,bude-&gt;bhune&quot
    attn = torch.einsum(attn_einsum_eq, b_q, context)</code></pre><h3>After Change</h3><pre><code class='java'>
    b_q, b_k, b_v = map(bucket_fn, (q, k, v))

    b_k_sum = b_k.sum(dim=-2)
    b_k_cumsum = <a id="change">b_k_sum.cumsum(dim=-2).type(</a>dtype<a id="change">)</a>

    context_einsum_eq = &quotbhund,bhune-&gt;bhude&quot if not one_kv_head else &quotbund,bune-&gt;bude&quot
    context = torch.einsum(context_einsum_eq, b_k, b_v)
    context_cumsum = context.cumsum(dim=-3).type(dtype)

    context = safe_div(context_cumsum, b_k_cumsum.unsqueeze(-1))

    if bucket_size != 1:
        context = F.pad(context, (0, 0, 0, 0, 1, 0), value=0.)
        seq_dim = 1 if one_kv_head else 2
        context<a id="change">, _ = </a>split_at_index(seq_dim, -1, context)

    attn_einsum_eq = &quotbhund,bhude-&gt;bhune&quot if not one_kv_head else &quotbhund,bude-&gt;bhune&quot
    attn = torch.einsum(attn_einsum_eq, b_q, context)</code></pre>