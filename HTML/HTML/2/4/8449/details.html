<html><h3>Pattern ID :8449
</h3><img src='29420805.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
            expected_res = torch.tensor(0., device=input.device, dtype=torch.double)
            expected_grads = []
            for i in range(batch_size):
                res = <a id="change">module(input[i].unsqueeze(0)).sum()</a>
                <a id="change">expected_grads.append(</a>torch.autograd.grad(res, module.parameters(), torch.ones_like(res))<a id="change">)</a>
                expected_res += res
            expected_grads = tuple(torch.stack(grad) for grad in zip(*expected_grads))
        self.assertEqual(actual_res, expected_res)
        [self.assertEqual(actual, expected) for (actual, expected) in zip(actual_grads, expected_grads)]</code></pre><h3>After Change</h3><pre><code class='java'>
                del param.grad_sample
            if diff_input:
                actual_grads.append(input.grad.clone())
                input.grad<a id="change"> = </a><a id="change">torch.zeros_like(</a>input.grad<a id="change">)</a>

            &#47&#47 get per sample grads with a for loop
            expected_res = torch.tensor(0., device=input.device, dtype=torch.double)
            expected_grads = []</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 4</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/pytorch/pytorch/commit/8b8f3e836b80d9f5f7fc3c865cefdfd9d1dcb0b4#diff-79c838607df182fe7fbd14bb4c3aee276e798cd68fac56931485103c6877fe5cL254' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 29420805</div><div id='project'> Project Name: pytorch/pytorch</div><div id='commit'> Commit Name: 8b8f3e836b80d9f5f7fc3c865cefdfd9d1dcb0b4</div><div id='time'> Time: 2022-03-31</div><div id='author'> Author: samdow@fb.com</div><div id='file'> File Name: test/test_expanded_weights.py</div><div id='m_class'> M Class Name: TestExpandedWeightModule</div><div id='n_method'> N Class Name: TestExpandedWeightModule</div><div id='m_method'> M Method Name: _do_test(3)</div><div id='n_method'> N Method Name: _do_test(3)</div><div id='m_parent_class'> M Parent Class: TestCase</div><div id='n_parent_class'> N Parent Class: TestCase</div><div id='m_file'> M File Name: test/test_expanded_weights.py</div><div id='n_file'> N File Name: test/test_expanded_weights.py</div><div id='m_start'> M Start Line: 265</div><div id='m_end'> M End Line: 268</div><div id='n_start'> N Start Line: 254</div><div id='n_end'> N End Line: 279</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
            &#47&#47 get per sample grads with a for loop, running over the input twice
            expected_grads = []
            for i in range(batch_size):
                res = <a id="change">module(input[i].unsqueeze(0)).sum()</a>
                <a id="change">expected_grads.append(</a>torch.autograd.grad(res, module.parameters(), torch.ones_like(res))<a id="change">)</a>
            expected_grads = tuple(torch.stack(grad) for grad in zip(*expected_grads))
        assert [self.assertEqual(actual, 2 * expected) for (actual, expected) in zip(actual_grads, expected_grads)]

    def test_per_sample_api_failing(self):</code></pre><h3>After Change</h3><pre><code class='java'>
                del param.grad_sample
            if diff_input:
                actual_grads.append(input.grad.clone())
                input.grad<a id="change"> = </a><a id="change">torch.zeros_like(</a>input.grad<a id="change">)</a>


            &#47&#47 get per sample grads with a for loop, running over the input twice
            expected_grads = []</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/pytorch/pytorch/commit/8b8f3e836b80d9f5f7fc3c865cefdfd9d1dcb0b4#diff-79c838607df182fe7fbd14bb4c3aee276e798cd68fac56931485103c6877fe5cL274' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 29420806</div><div id='project'> Project Name: pytorch/pytorch</div><div id='commit'> Commit Name: 8b8f3e836b80d9f5f7fc3c865cefdfd9d1dcb0b4</div><div id='time'> Time: 2022-03-31</div><div id='author'> Author: samdow@fb.com</div><div id='file'> File Name: test/test_expanded_weights.py</div><div id='m_class'> M Class Name: TestExpandedWeightModule</div><div id='n_method'> N Class Name: TestExpandedWeightModule</div><div id='m_method'> M Method Name: _do_test_multi_input(3)</div><div id='n_method'> N Method Name: _do_test_multi_input(3)</div><div id='m_parent_class'> M Parent Class: TestCase</div><div id='n_parent_class'> N Parent Class: TestCase</div><div id='m_file'> M File Name: test/test_expanded_weights.py</div><div id='n_file'> N File Name: test/test_expanded_weights.py</div><div id='m_start'> M Start Line: 283</div><div id='m_end'> M End Line: 299</div><div id='n_start'> N Start Line: 294</div><div id='n_end'> N End Line: 323</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        for emo_ind in range(4):
            preds_i = np.argmax(preds[:, emo_ind], axis=-1)
            truths_i = truths[:, emo_ind]
            <a id="change">acc.append(</a><a id="change">torch.sum(</a>truths_i == preds_i<a id="change">)</a>.item() / len(preds)<a id="change">)</a>
            f1.append(f1_score(truths_i, preds_i, average=&quotweighted&quot))
    else:
        preds = np.argmax(preds, axis=-1)
        acc = torch.sum(truths == preds).item() / len(preds)</code></pre><h3>After Change</h3><pre><code class='java'>
    truths = truths.cpu().detach()

    preds_inds = np.argmax(preds, axis=-1)
    preds<a id="change"> = </a><a id="change">torch.zeros_like(</a>preds<a id="change">)</a>

    for i in range(total):
        preds[i, preds_inds[i]] = 1
</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/wenliangdai/modality-transferable-mer/commit/38664b152a63fb703932bd0b32dfdf90fb6b3d48#diff-0aeb543dc2f4cfda989f7c60a43d968c7b7fb62a96bfcc862e73340dc0cdc97aL147' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 29420808</div><div id='project'> Project Name: wenliangdai/modality-transferable-mer</div><div id='commit'> Commit Name: 38664b152a63fb703932bd0b32dfdf90fb6b3d48</div><div id='time'> Time: 2020-06-15</div><div id='author'> Author: wenliang.dai.1995@gmail.com</div><div id='file'> File Name: src/evaluate.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: eval_iemocap(2)</div><div id='n_method'> N Method Name: eval_iemocap(3)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: src/evaluate.py</div><div id='n_file'> N File Name: src/evaluate.py</div><div id='m_start'> M Start Line: 147</div><div id='m_end'> M End Line: 166</div><div id='n_start'> N Start Line: 155</div><div id='n_end'> N End Line: 177</div><BR>