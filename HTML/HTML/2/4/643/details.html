<html><h3>Pattern ID :643
</h3><img src='3033518.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>

    async def _wait_for_cancel(self):
        Do NOT override this method when inheriting from :class:`GatewayPea`
        with <a id="change">zmq</a>.asyncio.Context() as ctx, <a id="change"></a>_init_socket<a id="change">(
            ctx, self.ctrl_addr, None, SocketType.PAIR_BIND, use_ipc=True
        )[0] as sock:
            </a>msg = await recv_message_async(sock)
            if msg.request.command == &quotTERMINATE&quot:
                msg.envelope.status.code = jina_pb2.StatusProto.SUCCESS
                await self.async_cancel()</code></pre><h3>After Change</h3><pre><code class='java'>
                await self.async_cancel()
                return
            else:
                await <a id="change">asyncio.sleep(0.1</a><a id="change">)</a>

    async def _loop_body(self):
        Do NOT override this method when inheriting from :class:`GatewayPea`
        try:</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 3</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/jina-ai/jina/commit/b195b132559bd8881d801f43e650041a0e67ce32#diff-1b61bf7c933cc5a617bff6182870d4369feb548dd213045ed1e198660a866bd5L33' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 3033518</div><div id='project'> Project Name: jina-ai/jina</div><div id='commit'> Commit Name: b195b132559bd8881d801f43e650041a0e67ce32</div><div id='time'> Time: 2021-07-05</div><div id='author'> Author: joan.martinez@jina.ai</div><div id='file'> File Name: jina/peapods/runtimes/zmq/asyncio.py</div><div id='m_class'> M Class Name: AsyncZMQRuntime</div><div id='n_method'> N Class Name: AsyncZMQRuntime</div><div id='m_method'> M Method Name: _wait_for_cancel(1)</div><div id='n_method'> N Method Name: _wait_for_cancel(1)</div><div id='m_parent_class'> M Parent Class: ZMQRuntime</div><div id='n_parent_class'> N Parent Class: ZMQRuntime</div><div id='m_file'> M File Name: jina/peapods/runtimes/zmq/asyncio.py</div><div id='n_file'> N File Name: jina/peapods/runtimes/zmq/asyncio.py</div><div id='m_start'> M Start Line: 33</div><div id='m_end'> M End Line: 42</div><div id='n_start'> N Start Line: 46</div><div id='n_end'> N End Line: 53</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
    client = docker.from_env()
    containers = client.containers.list()
    assert container.id not in containers
    <a id="change">with </a><a id="change">pytest.raises(docker.errors.NotFound):
        </a>pod._container


@pytest.fixture(scope=&quotmodule&quot)</code></pre><h3>After Change</h3><pre><code class='java'>
    ) as pod:
        container = pod._container
        status = container.status
        <a id="change">time.sleep(
            2</a><a id="change">
        )</a>  &#47&#47 to avoid desync between the start and close process which could lead to container never get terminated

    assert status == &quotrunning&quot
    client = docker.from_env()</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/jina-ai/jina/commit/5398029280fe3f4aedd8a8b7058f97fbec353d03#diff-7fd06d7ff37d0b1bf9f5ebc9584613d3fa2f27bfb5a18747f448d8988def2d88L25' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 3033515</div><div id='project'> Project Name: jina-ai/jina</div><div id='commit'> Commit Name: 5398029280fe3f4aedd8a8b7058f97fbec353d03</div><div id='time'> Time: 2022-03-11</div><div id='author'> Author: 55492238+samsja@users.noreply.github.com</div><div id='file'> File Name: tests/unit/orchestrate/pods/container/test_container_pod.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: test_container_pod_pass_envs(1)</div><div id='n_method'> N Method Name: test_container_pod_pass_envs(1)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: tests/unit/orchestrate/pods/container/test_container_pod.py</div><div id='n_file'> N File Name: tests/unit/orchestrate/pods/container/test_container_pod.py</div><div id='m_start'> M Start Line: 47</div><div id='m_end'> M End Line: 50</div><div id='n_start'> N Start Line: 43</div><div id='n_end'> N End Line: 45</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        replicas=3,
    )

    <a id="change">with </a><a id="change">flow:
        </a>with kubernetes_tools.get_port_forward_contextmanager(
            &quottest-flow-slow-process-executor&quot, flow.port_expose
        ):
            client_kwargs = dict(</code></pre><h3>After Change</h3><pre><code class='java'>
        namespace, gateway_pod_name, flow.port_expose, flow.port_expose, config_path
    ):
        &#47&#47 send requests and validate
        <a id="change">time.sleep(0.1</a><a id="change">)</a>
        client_kwargs = dict(
            host=&quotlocalhost&quot,
            port=flow.port_expose,
        )</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/jina-ai/jina/commit/6e9e7ef32f61cab04c6efc7a9f21659d26b50fdb#diff-9b579174c9a02ec0d540df54159de6ebe4b52ddccf227b3419430e9dfe4539d2L161' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 3033520</div><div id='project'> Project Name: jina-ai/jina</div><div id='commit'> Commit Name: 6e9e7ef32f61cab04c6efc7a9f21659d26b50fdb</div><div id='time'> Time: 2022-01-10</div><div id='author'> Author: joan.martinez@jina.ai</div><div id='file'> File Name: tests/k8s/test_graceful_request_handling.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: test_no_message_lost_during_kill(3)</div><div id='n_method'> N Method Name: test_no_message_lost_during_kill(2)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: tests/k8s/test_graceful_request_handling.py</div><div id='n_file'> N File Name: tests/k8s/test_graceful_request_handling.py</div><div id='m_start'> M Start Line: 162</div><div id='m_end'> M End Line: 253</div><div id='n_start'> N Start Line: 251</div><div id='n_end'> N End Line: 355</div><BR>