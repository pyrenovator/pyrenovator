<html><h3>Pattern ID :41741
</h3><img src='117016731.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
        key_dim = make_divisible(cc * key_dim, divisor=8) // num_heads  &#47&#47 regard as key_dim_ratio
    else:
        key_dim = cc // num_heads  &#47&#47 Default value
    qk_scale = float(1.0<a id="change"> / </a>tf.math.sqrt(<a id="change">tf.cast(</a>key_dim, "float32"<a id="change">)</a>))
    out_shape = cc if out_shape is None else out_shape
    emb_dim = num_heads * key_dim
    kv_kernel = block_size + halo_size * 2</code></pre><h3>After Change</h3><pre><code class='java'>
    &#47&#47 print(f"&gt;&gt;&gt;&gt; {attn_query.shape = }, {key.shape = }, {value.shape = }, {kv_inp.shape = }, {pos_query.shape = }, {num_heads = }")
    &#47&#47 attention_scores = [batch, num_heads, hh, ww, query_block * query_block, kv_kernel * kv_kernel]
    &#47&#47 attention_scores = layers.Lambda(lambda xx: functional.matmul(xx[0], xx[1], transpose_b=True))([attn_query, key])
    attention_scores = attn_query @ <a id="change">functional.transpose(</a>key, [0, 1, 2, 3, 5, 4]<a id="change">)</a>
    &#47&#47 pos = [batch, num_heads * hh * ww, query_block, query_block, kv_kernel, kv_kernel]
    pos = RelativePositionalEmbedding(position_height=kv_kernel, name=name and name + "pos_emb")(pos_query)
    &#47&#47 print(f"&gt;&gt;&gt;&gt; {pos.shape = }, {attention_scores.shape = }")
    pos = functional.reshape(pos, [-1, *attention_scores.shape[1:]])</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 3</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/leondgarse/keras_cv_attention_models/commit/e05e233f369a1d58f912872b1581a80d15cacc3f#diff-5a0036f02e35afe08c2170dc9b0e1131865080e554a879c04557e7a873330e74L23' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 117016731</div><div id='project'> Project Name: leondgarse/keras_cv_attention_models</div><div id='commit'> Commit Name: e05e233f369a1d58f912872b1581a80d15cacc3f</div><div id='time'> Time: 2023-02-07</div><div id='author'> Author: leondgarse@gmail.com</div><div id='file'> File Name: keras_cv_attention_models/halonet/halonet.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: halo_attention(11)</div><div id='n_method'> N Method Name: halo_attention(11)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: keras_cv_attention_models/halonet/halonet.py</div><div id='n_file'> N File Name: keras_cv_attention_models/halonet/halonet.py</div><div id='m_start'> M Start Line: 23</div><div id='m_end'> M End Line: 98</div><div id='n_start'> N Start Line: 28</div><div id='n_end'> N End Line: 106</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
    scaled_attention_logits = matmul_qk / tf.math.sqrt(dk)
    &#47&#47 add the mask to the scaled tensor.
    if mask is not None:
        scaled_attention_logits += (<a id="change">tf.cast(</a>mask<a id="change">, dtype=q.dtype) * -</a>1e9)
    &#47&#47 softmax is normalized on the last axis (seq_len_k) so that the scores
    &#47&#47 add up to 1.
    attention_weights = tf.nn.softmax(scaled_attention_logits, axis=-1)  &#47&#47 (..., seq_len_q, seq_len_k)</code></pre><h3>After Change</h3><pre><code class='java'>
) -&gt; Tuple[tf.Tensor, tf.Tensor]:
     Scaled Dot-Product Attention 

    scores = tf.matmul(query, <a id="change">tf.transpose(</a>key<a id="change">, perm=[0, 1, 3, 2])</a>) / math.sqrt(query.shape[-1])
    if mask is not None:
        scores = tf.where(mask == 0, -1e9, scores)
    p_attn = tf.nn.softmax(scores, axis=-1)</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/mindee/doctr/commit/9530f81d15395006b4844299236bdadba11c1dde#diff-e1106a3628d5365c5fe2e4fec7304ea8e40c58a5439f23d8f20513e722955178L70' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 117016732</div><div id='project'> Project Name: mindee/doctr</div><div id='commit'> Commit Name: 9530f81d15395006b4844299236bdadba11c1dde</div><div id='time'> Time: 2022-07-01</div><div id='author'> Author: felixdittrich92@gmail.com</div><div id='file'> File Name: doctr/models/recognition/transformer/tensorflow.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: scaled_dot_product_attention(4)</div><div id='n_method'> N Method Name: scaled_dot_product_attention(4)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: doctr/models/recognition/transformer/tensorflow.py</div><div id='n_file'> N File Name: doctr/models/recognition/transformer/tensorflow.py</div><div id='m_start'> M Start Line: 88</div><div id='m_end'> M End Line: 99</div><div id='n_start'> N Start Line: 63</div><div id='n_end'> N End Line: 67</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>

    def augmentation(self, img, label):
        rate    = tf.random.uniform(shape=[2], minval=0.5, maxval=2.0, dtype=tf.float32, name=&quotresize_rate&quot) &#47&#47seed=121,
        r_shape = tf.cast(<a id="change">tf.cast(</a>tf.shape(img)[1:3],tf.float32<a id="change">) * </a>rate, tf.int32)
        self.switcher_img = {                
                &quotoriginal&quot   :  img,
                &quotscaling&quot    :  tf.image.resize_with_crop_or_pad(img, r_shape[0], r_shape[1]),</code></pre><h3>After Change</h3><pre><code class='java'>
                &quotscaling&quot    :  self.scale(img),
                &quotvflip&quot      :  tf.image.random_flip_up_down(img),
                &quothflip&quot      :  tf.image.random_flip_left_right(img),
                &quottranspose&quot  :  <a id="change">self.transpose(</a>img<a id="change">)</a>,
                &quotrot90&quot      :  tf.image.rot90(img, k = 1), 
                &quotbrightness&quot :  tf.image.random_brightness(img, 0.5),
                &quotcontrast&quot   :  tf.image.random_contrast(img, 0.3, 0.5),</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/camma-public/cholect45/commit/790744de7c8b504394359549313b0b4eacd70136#diff-56901b9d32e868f395fac00ecce1c97c8d10b6e086f0212216c9b2f749c7d5bbL113' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 117016727</div><div id='project'> Project Name: camma-public/cholect45</div><div id='commit'> Commit Name: 790744de7c8b504394359549313b0b4eacd70136</div><div id='time'> Time: 2022-05-06</div><div id='author'> Author: nwoye.chinedu@gmail.com</div><div id='file'> File Name: dataloader_tf.py</div><div id='m_class'> M Class Name: CholecT50</div><div id='n_method'> N Class Name: CholecT50</div><div id='m_method'> M Method Name: augmentation(3)</div><div id='n_method'> N Method Name: augmentation(3)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: dataloader_tf.py</div><div id='n_file'> N File Name: dataloader_tf.py</div><div id='m_start'> M Start Line: 114</div><div id='m_end'> M End Line: 128</div><div id='n_start'> N Start Line: 117</div><div id='n_end'> N End Line: 127</div><BR>