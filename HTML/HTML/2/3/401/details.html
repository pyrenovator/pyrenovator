<html><h3>Pattern ID :401
</h3><img src='2331302.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
            cluster_means_spatial = cluster_means_spatial.permute(3, 0, 1, 2)

        &#47&#47 compute the distance to cluster means
        dist_to_mean = <a id="change">torch.norm(</a>embeddings<a id="change"> - </a>cluster_means_spatial, self.norm<a id="change">, dim=0)</a>

        if ignore_zero_label:
            &#47&#47 zero out distances corresponding to 0-label cluster, so that it does not contribute to the loss
            dist_mask = torch.ones_like(dist_to_mean)</code></pre><h3>After Change</h3><pre><code class='java'>
            ignore_zero_label: if True ignores the cluster corresponding to the 0-label
        
        assert target.dim() in (2, 3)
        ignore_labels = [0]<a id="change"> if </a>ignore_zero_label<a id="change"> else </a>None
        return cimpl._compute_variance_term_scatter(
            cluster_means, embeddings.unsqueeze(0), target.unsqueeze(0),
            self.norm, self.delta_var, instance_counts, ignore_labels</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 3</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/constantinpape/torch-em/commit/6b3c4ed59bff373d2b2f945e3f1aa300659ce9e9#diff-4ae644b7c870f8b2444a41dc20b100f7c4de0377aea62d81ec64ab36f8a94a4fL143' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 2331302</div><div id='project'> Project Name: constantinpape/torch-em</div><div id='commit'> Commit Name: 6b3c4ed59bff373d2b2f945e3f1aa300659ce9e9</div><div id='time'> Time: 2021-12-28</div><div id='author'> Author: c.pape@gmx.net</div><div id='file'> File Name: torch_em/loss/spoco_loss.py</div><div id='m_class'> M Class Name: ContrastiveLossBase</div><div id='n_method'> N Class Name: ContrastiveLossBase</div><div id='m_method'> M Method Name: _compute_variance_term(6)</div><div id='n_method'> N Method Name: _compute_variance_term(6)</div><div id='m_parent_class'> M Parent Class: nn.Module</div><div id='n_parent_class'> N Parent Class: nn.Module</div><div id='m_file'> M File Name: torch_em/loss/spoco_loss.py</div><div id='n_file'> N File Name: torch_em/loss/spoco_loss.py</div><div id='m_start'> M Start Line: 167</div><div id='m_end'> M End Line: 199</div><div id='n_start'> N Start Line: 143</div><div id='n_end'> N End Line: 147</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        &#47&#47 the linear system solved is with matrix AtA
        atb_check = ata @ solved_x[i].cpu()

        max_offset = <a id="change">torch.norm(</a>atb<a id="change"> - </a>atb_check<a id="change">, p=float("inf"))</a>
        assert max_offset &lt; 1e-4


def check_sparse_solver_multistep(test_exception: bool):</code></pre><h3>After Change</h3><pre><code class='java'>

        &#47&#47 the linear system solved is with matrix AtA
        solved_xi_cpu = solved_x[i].cpu()
        damp = damping<a id="change"> if </a>float_damping<a id="change"> else </a>damping[i]  &#47&#47 type: ignore
        atb_check = ata @ solved_xi_cpu + damp * solved_xi_cpu

        torch.testing.assert_close(atb, atb_check, atol=1e-2, rtol=1e-2)</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/facebookresearch/theseus/commit/00eee1a15c0f987f86c542d694ff6efc7b8fb1f9#diff-014672fddd42904f05996cc54f069475055044eb4e706177792d9c63c17eb890L26' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 2331306</div><div id='project'> Project Name: facebookresearch/theseus</div><div id='commit'> Commit Name: 00eee1a15c0f987f86c542d694ff6efc7b8fb1f9</div><div id='time'> Time: 2022-11-04</div><div id='author'> Author: luisen.p@gmail.com</div><div id='file'> File Name: theseus/optimizer/linear/tests/test_lu_cuda_sparse_solver.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: test_sparse_solver(2)</div><div id='n_method'> N Method Name: test_sparse_solver(0)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: theseus/optimizer/linear/tests/test_lu_cuda_sparse_solver.py</div><div id='n_file'> N File Name: theseus/optimizer/linear/tests/test_lu_cuda_sparse_solver.py</div><div id='m_start'> M Start Line: 33</div><div id='m_end'> M End Line: 64</div><div id='n_start'> N Start Line: 28</div><div id='n_end'> N End Line: 73</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        else:
            &#47&#47  Calculate the distance from the new sample point x to the 
            &#47&#47  most recent;y added sample already in the cache 
            dist_to_last_added = <a id="change">LA.norm(</a>x<a id="change"> - </a>self.samples[:,self.last_added_ind-1]<a id="change">)</a>
            self.distances[0,self.last_added_ind-1] = 0 &#47&#47 will be set exactly below
            
            &#47&#47  Overestimate the distances from the new sample point x to all 
            &#47&#47  the other sample points by applying the triangle inequality </code></pre><h3>After Change</h3><pre><code class='java'>
            &#47&#47 sample = self.samples[:,self.last_added_ind-1]
            &#47&#47 diff = x - sample
            &#47&#47 dist_to_last_added = LA.norm(diff)
            device = torch.device(&quotcuda&quot<a id="change"> if </a>torch.cuda.is_available()<a id="change"> else </a>&quotcpu&quot)  
            sample = self.samples[:,self.last_added_ind-1]
            sample_gpu = torch.from_numpy(sample).to(device=device)
            x_gpu = torch.from_numpy(x).to(device=device)</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/sun-umn/pygranso/commit/869d77dd9452e4de4f09f17c886c0696fdb1926e#diff-a10cea76d1f67f814b5c0d3ad50eb9de30896ce6635a17b22f746caf2258292eL31' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 2331308</div><div id='project'> Project Name: sun-umn/pygranso</div><div id='commit'> Commit Name: 869d77dd9452e4de4f09f17c886c0696fdb1926e</div><div id='time'> Time: 2021-09-08</div><div id='author'> Author: 52502144+Buyun-Liang@users.noreply.github.com</div><div id='file'> File Name: private/neighborhoodCache.py</div><div id='m_class'> M Class Name: nC</div><div id='n_method'> N Class Name: nC</div><div id='m_method'> M Method Name: getCachedNeighborhoodAbout(3)</div><div id='n_method'> N Method Name: getCachedNeighborhoodAbout(3)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: private/neighborhoodCache.py</div><div id='n_file'> N File Name: private/neighborhoodCache.py</div><div id='m_start'> M Start Line: 43</div><div id='m_end'> M End Line: 43</div><div id='n_start'> N Start Line: 48</div><div id='n_end'> N End Line: 53</div><BR>