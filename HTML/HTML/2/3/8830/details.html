<html><h3>Pattern ID :8830
</h3><img src='32504398.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
        assert loaded_model.lr_scheduler is None
        return

    saved = <a id="change">saved_model.lr_scheduler.state_dict()</a>
    loaded = loaded_model.lr_scheduler.state_dict()
    assert sorted(saved.keys()) == sorted(loaded.keys())
    for key in saved.keys():
        if isinstance(saved[key], torch.Tensor):</code></pre><h3>After Change</h3><pre><code class='java'>
    saved_sd = saved_scheduler.state_dict()
    loaded_sd = loaded_scheduler.state_dict()

    <a id="change">print(f"saved_sd = {saved_sd}"</a><a id="change">)</a>
    print(f"loaded_sd = {loaded_sd}")

    assert saved_sd.keys() == loaded_sd.keys()
</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 6</div><BR><div id='size'>Non-data size: 2</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/microsoft/deepspeed/commit/f2ac7eafd54c49acb8981650637dedd939e96c14#diff-6eee5e126ab9bfa31fb81f0a6c57603a485f7f60e021787c7b266f198515f35cL26' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 32504398</div><div id='project'> Project Name: microsoft/deepspeed</div><div id='commit'> Commit Name: f2ac7eafd54c49acb8981650637dedd939e96c14</div><div id='time'> Time: 2020-05-19</div><div id='author'> Author: jerasley@microsoft.com</div><div id='file'> File Name: tests/unit/test_checkpointing.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: compare_lr_scheduler_states(2)</div><div id='n_method'> N Method Name: compare_lr_scheduler_states(2)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: tests/unit/test_checkpointing.py</div><div id='n_file'> N File Name: tests/unit/test_checkpointing.py</div><div id='m_start'> M Start Line: 26</div><div id='m_end'> M End Line: 39</div><div id='n_start'> N Start Line: 66</div><div id='n_end'> N End Line: 87</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>


def load_tgz(model, weight):
    for key, value in <a id="change">model.state_dict()</a>.items():
        print(key, value.shape)
    assert False
</code></pre><h3>After Change</h3><pre><code class='java'>
        bc_name = name
        for pattern, sub in name_convertor:
            name = re.sub(pattern, sub, name)
        <a id="change">print(</a>bc_name, <a id="change">&quot-&gt;&quot</a>, name<a id="change">)</a>
        print(param.shape)
        param.data.copy_(npz_dim_convertor(name, weight.get(name)))

    assert False</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/hankyul2/efficientnetv2-pytorch/commit/e07d26d87af78820bbc1759857b72f583ce0f1cd#diff-600eb4af4e96cecc12ba845a91eec941459033637f18e3ad4b4b0faa6d44ae98L29' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 32504397</div><div id='project'> Project Name: hankyul2/efficientnetv2-pytorch</div><div id='commit'> Commit Name: e07d26d87af78820bbc1759857b72f583ce0f1cd</div><div id='time'> Time: 2021-11-12</div><div id='author'> Author: consistant1y@ajou.ac.kr</div><div id='file'> File Name: src/pretrained_weight_loader.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: load_tgz(2)</div><div id='n_method'> N Method Name: load_tgz(2)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: src/pretrained_weight_loader.py</div><div id='n_file'> N File Name: src/pretrained_weight_loader.py</div><div id='m_start'> M Start Line: 30</div><div id='m_end'> M End Line: 31</div><div id='n_start'> N Start Line: 48</div><div id='n_end'> N End Line: 115</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        accs = model_max.finetunning(x_spt, y_spt, x_qry, y_qry, c_spt, c_qry, n_spt, n_qry, g_spt, g_qry, feat)
        accs_all_test.append(accs)
    
    torch.save(<a id="change">model_max.state_dict()</a>, &quot./model.pt&quot)

    accs = np.array(accs_all_test).mean(axis=0).astype(np.float16)
    print(&quotEarly Stopped Test acc:&quot, accs[-1])</code></pre><h3>After Change</h3><pre><code class='java'>
            accs_all_test.append(accs)

        accs = np.array(accs_all_test).mean(axis=0).astype(np.float16)
        <a id="change">print(</a>&quotEpoch:&quot, epoch + 1, <a id="change">&quot Val acc:&quot</a>, str(accs[-1])[:5]<a id="change">)</a>
        if accs[-1] &gt; max_acc:
            max_acc = accs[-1]
            model_max = copy.deepcopy(maml)
                </code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/mims-harvard/g-meta/commit/edbc5799976b391ada110fedab31bca222247449#diff-51163a010a0c642dd9b0b2723c6484a8c2b6ccd2812d7a26857bf4eb042d0c3eL31' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 32504393</div><div id='project'> Project Name: mims-harvard/g-meta</div><div id='commit'> Commit Name: edbc5799976b391ada110fedab31bca222247449</div><div id='time'> Time: 2020-10-18</div><div id='author'> Author: kh2383@nyu.edu</div><div id='file'> File Name: G-Meta/train.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: main(0)</div><div id='n_method'> N Method Name: main(0)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: G-Meta/train.py</div><div id='n_file'> N File Name: G-Meta/train.py</div><div id='m_start'> M Start Line: 87</div><div id='m_end'> M End Line: 149</div><div id='n_start'> N Start Line: 92</div><div id='n_end'> N End Line: 148</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
                  torch.save(net, checkpoint_fname)

                  logging.info(f&quotCheckpoint {epoch + 1} saved !&quot)
        net.load_state_dict(<a id="change">net.state_dict()</a>)
        net.eval()
    return net
</code></pre><h3>After Change</h3><pre><code class='java'>
    val_loader = torch.utils.data.DataLoader(val_dataset, batch_size=batch_size, shuffle=False, num_workers=0)
    net = net.to(device=device)
    if torch.cuda.device_count() &gt; 1:
      <a id="change">print("Let&quots use"</a>, torch.cuda.device_count(), "GPUs!"<a id="change">)</a>
      &#47&#47 dim = 0 [30, xxx] -&gt; [10, ...], [10, ...], [10, ...] on 3 GPUs
      net = DataParallelPassthrough(net, device_ids=config[&quotdevice_ids&quot])

    net=net.to(device=device)</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/aangelopoulos/im2im-uq/commit/4f4c3450295e67f2d2c5b91db7bd5bde5ca5c6c8#diff-c267b9d77a461c28fd7fb2a2b3e40928fe58f6723ec3378f0b681b3b95c24782L135' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 32504391</div><div id='project'> Project Name: aangelopoulos/im2im-uq</div><div id='commit'> Commit Name: 4f4c3450295e67f2d2c5b91db7bd5bde5ca5c6c8</div><div id='time'> Time: 2021-06-24</div><div id='author'> Author: angelopoulos@n0024.abc0</div><div id='file'> File Name: core/scripts/train.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: train_net(12)</div><div id='n_method'> N Method Name: train_net(13)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: core/scripts/train.py</div><div id='n_file'> N File Name: core/scripts/train.py</div><div id='m_start'> M Start Line: 147</div><div id='m_end'> M End Line: 260</div><div id='n_start'> N Start Line: 70</div><div id='n_end'> N End Line: 175</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        return
    torch.save({
        &quotmodel_state_dict&quot: model.state_dict(),
        &quotoptimizer_state_dict&quot: <a id="change">optimizer.state_dict()</a>
    }, &quot../Model/&quot + save_path)
    print(&quotModel saved to ==&gt; {../Model/save_path}&quot)

def load(name, model, optimizer):</code></pre><h3>After Change</h3><pre><code class='java'>
    }
    save_path = &quot../Model/&quot + save_path
    torch.save(checkpoint, save_path)
    <a id="change">print(f&quotModel saved to ==&gt; {save_path}&quot</a><a id="change">)</a>

def load(name, model, optimizer):
    checkpoint = torch.load(&quot../Model/&quot + name)
    model.load_state_dict(checkpoint[&quotmodel_state_dict&quot])</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/samyuen101234/masked_face_recognition/commit/6b21ac9f73b84c637155cb1d3c6b4ced167ca373#diff-c3e57dc8ea5d98f913a2701669ef46fed030bdfe092a398d645c7a6c6e435cd2L9' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 32504389</div><div id='project'> Project Name: samyuen101234/masked_face_recognition</div><div id='commit'> Commit Name: 6b21ac9f73b84c637155cb1d3c6b4ced167ca373</div><div id='time'> Time: 2021-05-05</div><div id='author'> Author: yxiear@connect.ust.hk</div><div id='file'> File Name: Code/train.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: save(4)</div><div id='n_method'> N Method Name: save(3)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: Code/train.py</div><div id='n_file'> N File Name: Code/train.py</div><div id='m_start'> M Start Line: 12</div><div id='m_end'> M End Line: 16</div><div id='n_start'> N Start Line: 18</div><div id='n_end'> N End Line: 28</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        kk: (np.cumproduct(vv.shape)[-1] if len(vv.shape) != 0 else 1) for kk, vv in torch_model.state_dict().items() if ".num_batches_tracked" not in kk
    }
    print("&gt;&gt;&gt;&gt; torch_model total_parameters :", np.sum(list(torch_params.values())))
    stacked_state_dict = state_dict_stack_by_layer(<a id="change">torch_model.state_dict()</a>, skip_weights=skip_weights, unstack_weights=unstack_weights)
    aa = {kk: [1 if isinstance(jj, float) else jj.shape for jj in vv] for kk, vv in stacked_state_dict.items()}
    print("&gt;&gt;&gt;&gt; Torch weights:")
    _ = [print("  &quot{}&quot: {}".format(kk, vv)) for kk, vv in aa.items()]</code></pre><h3>After Change</h3><pre><code class='java'>
    from skimage.data import chelsea

    if isinstance(torch_model, str):
        <a id="change">print("&gt;&gt;&gt;&gt; Reload Torch weight file:"</a>, torch_model<a id="change">)</a>
        torch_model = torch.load(torch_model, map_location=torch.device(&quotcpu&quot))
    is_state_dict = isinstance(torch_model, dict)

     Chelsea the cat  </code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/leondgarse/keras_cv_attention_models/commit/595d36b2f10fd36ac66a39f902327e803dcddcc7#diff-37028f58f90dc39d0ed1f23dec40bd7e001ad2d587c2dd6ddd16655aaec34d38L131' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 32504386</div><div id='project'> Project Name: leondgarse/keras_cv_attention_models</div><div id='commit'> Commit Name: 595d36b2f10fd36ac66a39f902327e803dcddcc7</div><div id='time'> Time: 2021-10-31</div><div id='author'> Author: leondgarse@gmail.com</div><div id='file'> File Name: keras_cv_attention_models/download_and_load.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: keras_reload_from_torch_model(11)</div><div id='n_method'> N Method Name: keras_reload_from_torch_model(11)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: keras_cv_attention_models/download_and_load.py</div><div id='n_file'> N File Name: keras_cv_attention_models/download_and_load.py</div><div id='m_start'> M Start Line: 150</div><div id='m_end'> M End Line: 199</div><div id='n_start'> N Start Line: 151</div><div id='n_end'> N End Line: 216</div><BR>