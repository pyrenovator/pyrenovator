<html><h3>Pattern ID :29929
</h3><img src='88803577.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
    marked_bn_set = set()

    for conv_linear_op in ordered_conv_linears:
        <a id="change">if </a>conv_linear_op in convs_linears_bn_activation_info_dict.keys():
            bn_info = convs_linears_bn_activation_info_dict[conv_linear_op]
            if bn_info.output_bn:
                if bn_info.output_bn not in marked_bn_set:
                    fold_backward = True
                    if return_bn_conn_op:
                        bn_conv_linear_pairs.append((conv_linear_op, bn_info.output_bn, fold_backward))
                    else:
                        bn_conv_linear_pairs.append((conv_linear_op, bn_info.output_bn.get_tf_op_with_io_tensor(),
                                                     fold_backward))
                    marked_bn_set.add(bn_info.output_bn)
            elif bn_info.input_bn:
                if bn_info.input_bn not in marked_bn_set:
                    fold_backward<a id="change"> = </a>False
                    if return_bn_conn_op:
                        bn_conv_linear_pairs.append((conv_linear_op, bn_info.input_bn, fold_backward))
                    else:</code></pre><h3>After Change</h3><pre><code class='java'>
        output_op_names = [output_op_names]

    conn_graph = ConnectedGraph(sess.graph, start_op_names, output_op_names)
    bn_conv_linear_pairs, _ = <a id="change">_find_all_batch_norms_to_fold(</a>conn_graph, start_op_names, output_op_names,
                                                            return_bn_conn_op<a id="change">)</a>
    return bn_conv_linear_pairs


def _get_bias_tensor(sess: tf.compat.v1.Session, conv: tf.Operation) -&gt; libpymo.TensorParams():</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 3</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/quic/aimet/commit/a46cd2aec955ef8814978c5c7b306e85692730cb#diff-20ad217060f226e6b244e1893b396fbd745234790405f01bca9c70f6f20b2c14L147' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 88803577</div><div id='project'> Project Name: quic/aimet</div><div id='commit'> Commit Name: a46cd2aec955ef8814978c5c7b306e85692730cb</div><div id='time'> Time: 2023-04-12</div><div id='author'> Author: quic_hitameht@quicinc.com</div><div id='file'> File Name: TrainingExtensions/tensorflow/src/python/aimet_tensorflow/batch_norm_fold.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: find_all_batch_norms_to_fold(4)</div><div id='n_method'> N Method Name: find_all_batch_norms_to_fold(4)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: TrainingExtensions/tensorflow/src/python/aimet_tensorflow/batch_norm_fold.py</div><div id='n_file'> N File Name: TrainingExtensions/tensorflow/src/python/aimet_tensorflow/batch_norm_fold.py</div><div id='m_start'> M Start Line: 163</div><div id='m_end'> M End Line: 196</div><div id='n_start'> N Start Line: 147</div><div id='n_end'> N End Line: 155</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
    if not isinstance(input_op_names, (str, List)):
        logger.error(&quotstart op names must be passed as a string or a List of strings&quot)
    &#47&#47 if passed start op name is only a string - create a list for connected graph
    <a id="change">if </a>isinstance(input_op_names, str):
        input_op_names<a id="change"> = </a>[input_op_names]
    &#47&#47 if passed output op name is only a string - create a list for connected graph
    if isinstance(output_op_names, str):
        output_op_names = [output_op_names]</code></pre><h3>After Change</h3><pre><code class='java'>
    assert sim.connected_graph is not None

    connected_graph = sim.connected_graph
    bn_conv_linear_pairs, _ = <a id="change">_find_all_batch_norms_to_fold(</a>connected_graph, starting_op_names, output_op_names<a id="change">)</a>
    _fold_given_auto_selected_batch_norms_scale(sim, bn_conv_linear_pairs)


def _fold_given_auto_selected_batch_norms_scale(sim: QuantizationSimModel, layer_pairs: List[PairType]):</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/quic/aimet/commit/a46cd2aec955ef8814978c5c7b306e85692730cb#diff-20ad217060f226e6b244e1893b396fbd745234790405f01bca9c70f6f20b2c14L415' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 88803598</div><div id='project'> Project Name: quic/aimet</div><div id='commit'> Commit Name: a46cd2aec955ef8814978c5c7b306e85692730cb</div><div id='time'> Time: 2023-04-12</div><div id='author'> Author: quic_hitameht@quicinc.com</div><div id='file'> File Name: TrainingExtensions/tensorflow/src/python/aimet_tensorflow/batch_norm_fold.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: fold_all_batch_norms_to_scale(3)</div><div id='n_method'> N Method Name: fold_all_batch_norms_to_scale(3)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: TrainingExtensions/tensorflow/src/python/aimet_tensorflow/batch_norm_fold.py</div><div id='n_file'> N File Name: TrainingExtensions/tensorflow/src/python/aimet_tensorflow/batch_norm_fold.py</div><div id='m_start'> M Start Line: 428</div><div id='m_end'> M End Line: 439</div><div id='n_start'> N Start Line: 379</div><div id='n_end'> N End Line: 383</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
                bn_picked_for_folding.add(bn_info.output_bn)

    for _, module in ordered_conv_fc_nodes:
        <a id="change">if </a>module in conv_linear_bn_activation_info_dict.keys():
            bn_info<a id="change"> = </a>conv_linear_bn_activation_info_dict[module]
            if bn_info.input_bn and bn_info.input_bn not in bn_picked_for_folding:
                bn_conv_linear_pairs.append((bn_info.input_bn.get_module(), module))
                bn_picked_for_folding.add(bn_info.input_bn)</code></pre><h3>After Change</h3><pre><code class='java'>
    
    connected_graph = ConnectedGraph(model,
                                     utils.create_rand_tensors_given_shapes(input_shapes))
    conv_bn_pairs, bn_conv_pairs = <a id="change">_find_all_batch_norms_to_fold(</a>model, input_shapes, connected_graph<a id="change">)</a>
    return conv_bn_pairs + bn_conv_pairs


def _find_all_batch_norms_to_fold(</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/quic/aimet/commit/5cceda6cd2e3487d2a03a04cbf5fd5dc285c78c2#diff-481ed223eef209da6647ee5a59b88cc044f808238c4215c64ad369756c172e68L190' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 88803606</div><div id='project'> Project Name: quic/aimet</div><div id='commit'> Commit Name: 5cceda6cd2e3487d2a03a04cbf5fd5dc285c78c2</div><div id='time'> Time: 2022-05-16</div><div id='author'> Author: quic_kyunggeu@quicinc.com</div><div id='file'> File Name: TrainingExtensions/torch/src/python/aimet_torch/batch_norm_fold.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: find_all_batch_norms_to_fold(2)</div><div id='n_method'> N Method Name: find_all_batch_norms_to_fold(2)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: TrainingExtensions/torch/src/python/aimet_torch/batch_norm_fold.py</div><div id='n_file'> N File Name: TrainingExtensions/torch/src/python/aimet_torch/batch_norm_fold.py</div><div id='m_start'> M Start Line: 190</div><div id='m_end'> M End Line: 222</div><div id='n_start'> N Start Line: 268</div><div id='n_end'> N End Line: 279</div><BR>