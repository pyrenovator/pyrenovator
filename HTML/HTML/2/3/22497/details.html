<html><h3>Pattern ID :22497
</h3><img src='71040699.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
                num_corrects = torch.sum(max_class[mask_tile] == expr.view(-1)[mask_tile]).item()
                acc = num_corrects / valid_items
                progress_dict[&quotacc_expr&quot] = acc
        <a id="change">return </a><a id="change">{
            </a>&quotloss&quot: loss,
            &quotprogress_bar&quot: progress_dict,
            &quotlog&quot: log_dict<a id="change">
        }</a>

    def validation_step(self, batch, batch_idx):
        v, a, v_hat, a_hat = [], [], [], []
        </code></pre><h3>After Change</h3><pre><code class='java'>
        log_dict = {&quotloss_v&quot: loss_v, &quotloss_a&quot: loss_a, &quotloss&quot: loss}

        if self.hparams.test_lr:
            <a id="change">self.lr_test.step()</a>
            lr = self.lr_test.get_lr()[0]

        if self.hparams.loss == &quotmtl&quot:
            mask = batch[&quotexpr_valid&quot]</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 9</div><BR><div id='size'>Non-data size: 3</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/sailordiary/m3f.pytorch/commit/4409fb98c3e6b08df8f54b16de60ef07522c5c9a#diff-806f82422552da4fd8e7f277c42d565823581d20382c946937ce3f69879bca96L131' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 71040699</div><div id='project'> Project Name: sailordiary/m3f.pytorch</div><div id='commit'> Commit Name: 4409fb98c3e6b08df8f54b16de60ef07522c5c9a</div><div id='time'> Time: 2020-02-03</div><div id='author'> Author: me@sailorzhang.com</div><div id='file'> File Name: models/model.py</div><div id='m_class'> M Class Name: AffWild2VA</div><div id='n_method'> N Class Name: AffWild2VA</div><div id='m_method'> M Method Name: training_step(3)</div><div id='n_method'> N Method Name: training_step(3)</div><div id='m_parent_class'> M Parent Class: pl.LightningModule</div><div id='n_parent_class'> N Parent Class: pl.LightningModule</div><div id='m_file'> M File Name: models/model.py</div><div id='n_file'> N File Name: models/model.py</div><div id='m_start'> M Start Line: 131</div><div id='m_end'> M End Line: 154</div><div id='n_start'> N Start Line: 133</div><div id='n_end'> N End Line: 160</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>

    def train_step(self, batch, params: ParamsType = None) -&gt; MetricType:
        super().train_step(batch, params)
        res = <a id="change">{</a>&quotidx&quot: self.global_steps + 0.5, &quotw&quot: params.w(self.eidx)<a id="change">}</a>
        &#47&#47 print(res)
        time.sleep(0.05)
        <a id="change">return </a>res


trainer = MyTrainer(params)</code></pre><h3>After Change</h3><pre><code class='java'>

        &#47&#47 loss.backward()
        self.accelerate.backward(Lall)
        <a id="change">self.optim.step()</a>

        with torch.no_grad():
            meter.mean.A = (logits.argmax(dim=-1) == ys).float().mean()
</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/sailist/lumo/commit/609ff44f8446ef020a7684565ff6a763462dd291#diff-dd22299bd8bdad085c8d223df9ee75008e7a9377c5b96217f96ba95c3033e89dL24' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 71040698</div><div id='project'> Project Name: sailist/lumo</div><div id='commit'> Commit Name: 609ff44f8446ef020a7684565ff6a763462dd291</div><div id='time'> Time: 2022-04-02</div><div id='author'> Author: sailist@outlook.com</div><div id='file'> File Name: examples/trainer/quick_start.py</div><div id='m_class'> M Class Name: MyTrainer</div><div id='n_method'> N Class Name: MyTrainer</div><div id='m_method'> M Method Name: train_step(3)</div><div id='n_method'> N Method Name: train_step(3)</div><div id='m_parent_class'> M Parent Class: Trainer</div><div id='n_parent_class'> N Parent Class: Trainer</div><div id='m_file'> M File Name: examples/trainer/quick_start.py</div><div id='n_file'> N File Name: examples/trainer/quick_start.py</div><div id='m_start'> M Start Line: 26</div><div id='m_end'> M End Line: 29</div><div id='n_start'> N Start Line: 59</div><div id='n_end'> N End Line: 74</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        &#47&#47 (N, |V|, L), (N, L) -&gt; (N, 1) -&gt; (1)
        &#47&#47 the lengths are different  -&gt; pad should not be ignored
        loss = F.cross_entropy(logits, y, ignore_index=self.hparams[&quotpad_token_id&quot]).sum()
        <a id="change">return </a><a id="change">{
            </a>&quotloss&quot: loss,
            &quotlogits&quot: logits.detach()<a id="change">
        }</a>

    def on_train_batch_end(self, outputs: dict, batch: Tuple[torch.Tensor, torch.Tensor], *args, **kwargs) -&gt; None:
        &#47&#47 watch the loss for this batch
        _, y = batch</code></pre><h3>After Change</h3><pre><code class='java'>
        :return: a scalar tensor
        
        X, y = batch
        loss, logits = <a id="change">self.step(</a>X, y<a id="change">)</a>
        self.log("Train/Loss", loss)
        self.acc_train.update(logits.detach(), target=y.detach())
        return {
            &quotloss&quot: loss</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/eubinecto/the-clean-transformer/commit/339e441dd77323d567cf3dd1bacac2b2ef87bcba#diff-5deeab51632c0b3aa16a9c050330b4db05fd266d4e90311f1e76bc5da6474a30L63' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 71040697</div><div id='project'> Project Name: eubinecto/the-clean-transformer</div><div id='commit'> Commit Name: 339e441dd77323d567cf3dd1bacac2b2ef87bcba</div><div id='time'> Time: 2021-12-10</div><div id='author'> Author: eubinecto</div><div id='file'> File Name: dekorde/models.py</div><div id='m_class'> M Class Name: Transformer</div><div id='n_method'> N Class Name: Transformer</div><div id='m_method'> M Method Name: training_step(2)</div><div id='n_method'> N Method Name: training_step(2)</div><div id='m_parent_class'> M Parent Class: LightningModule,ABC</div><div id='n_parent_class'> N Parent Class: LightningModule,ABC</div><div id='m_file'> M File Name: dekorde/models.py</div><div id='n_file'> N File Name: dekorde/models.py</div><div id='m_start'> M Start Line: 69</div><div id='m_end'> M End Line: 83</div><div id='n_start'> N Start Line: 83</div><div id='n_end'> N End Line: 88</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        &#47&#47 - pred_prev_image -&gt; "x_t-1"
        for t in tqdm.tqdm(reversed(range(num_inference_steps)), total=num_inference_steps):
            &#47&#47 1. predict noise residual
            timesteps = torch.tensor(<a id="change">[</a>inference_step_times[t]<a id="change"></a>] * image.shape[0], device=torch_device)
            pred_noise_t = self.unet(image, timesteps)

            if isinstance(pred_noise_t, dict):
                pred_noise_t = pred_noise_t["sample"]

            &#47&#47 2. predict previous mean of image x_t-1
            pred_prev_image = self.noise_scheduler.step(pred_noise_t, image, t, num_inference_steps, eta)

            &#47&#47 3. optionally sample variance
            variance = 0
            if eta &gt; 0:
                noise = torch.randn(image.shape, generator=generator).to(image.device)
                variance = self.noise_scheduler.get_variance(t, num_inference_steps).sqrt() * eta * noise

            &#47&#47 4. set current image to prev_image: x_t -&gt; x_t-1
            image = pred_prev_image + variance

        &#47&#47 decode image with vae
        image = self.vqvae.decode(image)
        <a id="change">return </a>image
</code></pre><h3>After Change</h3><pre><code class='java'>

            &#47&#47 2. predict previous mean of image x_t-1 and add variance depending on eta
            &#47&#47 do x_t -&gt; x_t-1
            image = <a id="change">self.scheduler.step(</a>residual, t, image, eta<a id="change">)</a>["prev_sample"]

        &#47&#47 decode image with vae
        image = self.vqvae.decode(image)</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/huggingface/diffusers/commit/f448360bd0dfe5e28ee65ab2130532db91d5eafe#diff-5a7ee70ffdbd476077b691c023447641dd657f00acfc79868f392d410574c691L15' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 71040695</div><div id='project'> Project Name: huggingface/diffusers</div><div id='commit'> Commit Name: f448360bd0dfe5e28ee65ab2130532db91d5eafe</div><div id='time'> Time: 2022-07-15</div><div id='author'> Author: patrick.v.platen@gmail.com</div><div id='file'> File Name: src/diffusers/pipelines/latent_diffusion_uncond/pipeline_latent_diffusion_uncond.py</div><div id='m_class'> M Class Name: LatentDiffusionUncondPipeline</div><div id='n_method'> N Class Name: LatentDiffusionUncondPipeline</div><div id='m_method'> M Method Name: __call__(6)</div><div id='n_method'> N Method Name: __call__(6)</div><div id='m_parent_class'> M Parent Class: DiffusionPipeline</div><div id='n_parent_class'> N Parent Class: DiffusionPipeline</div><div id='m_file'> M File Name: src/diffusers/pipelines/latent_diffusion_uncond/pipeline_latent_diffusion_uncond.py</div><div id='n_file'> N File Name: src/diffusers/pipelines/latent_diffusion_uncond/pipeline_latent_diffusion_uncond.py</div><div id='m_start'> M Start Line: 31</div><div id='m_end'> M End Line: 71</div><div id='n_start'> N Start Line: 31</div><div id='n_end'> N End Line: 50</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        self.log("train/acc", acc, on_step=False, on_epoch=True, prog_bar=True)

        &#47&#47 we can return here anything and then read it in some callback or in training_epoch_end() below
        <a id="change">return </a><a id="change">{</a>"loss": loss, "preds": preds, "targets": y<a id="change">}</a>

    &#47&#47 logic for a single validation step
    def validation_step(self, batch, batch_idx):
        x, y = batch</code></pre><h3>After Change</h3><pre><code class='java'>
        return loss, preds, y

    def training_step(self, batch: Any, batch_idx: int) -&gt; Dict[str, torch.Tensor]:
        loss, preds, targets = <a id="change">self.step(</a>batch<a id="change">)</a>

        &#47&#47 log train metrics to your loggers!
        acc = self.train_accuracy(preds, targets)
        self.log("train/loss", loss, on_step=False, on_epoch=True, prog_bar=False)</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/ashleve/lightning-hydra-template/commit/b1e0bf9717f578221bb7f3460519051490cec8b6#diff-25687b55b8499032cbdde988ba1c9f30865fd2ac8d456ff8cfc2b05aa4901da4L31' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 71040694</div><div id='project'> Project Name: ashleve/lightning-hydra-template</div><div id='commit'> Commit Name: b1e0bf9717f578221bb7f3460519051490cec8b6</div><div id='time'> Time: 2021-03-10</div><div id='author'> Author: zalewski.ukas@gmail.com</div><div id='file'> File Name: src/models/mnist_model.py</div><div id='m_class'> M Class Name: LitModelMNIST</div><div id='n_method'> N Class Name: LitModelMNIST</div><div id='m_method'> M Method Name: training_step(3)</div><div id='n_method'> N Method Name: training_step(3)</div><div id='m_parent_class'> M Parent Class: pl.LightningModule</div><div id='n_parent_class'> N Parent Class: pl.LightningModule</div><div id='m_file'> M File Name: src/models/mnist_model.py</div><div id='n_file'> N File Name: src/models/mnist_model.py</div><div id='m_start'> M Start Line: 31</div><div id='m_end'> M End Line: 43</div><div id='n_start'> N Start Line: 63</div><div id='n_end'> N End Line: 74</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        self.log("val/acc", acc, on_step=False, on_epoch=True, prog_bar=True)

        &#47&#47 we can return here anything and then read it in some callback or in validation_epoch_end() below
        <a id="change">return </a><a id="change">{</a>"loss": loss, "preds": preds, "targets": y<a id="change">}</a>

    &#47&#47 logic for a single testing step
    def test_step(self, batch, batch_idx):
        x, y = batch</code></pre><h3>After Change</h3><pre><code class='java'>
        return {"loss": loss, "preds": preds, "targets": targets}

    def validation_step(self, batch: Any, batch_idx: int) -&gt; Dict[str, torch.Tensor]:
        loss, preds, targets = <a id="change">self.step(</a>batch<a id="change">)</a>

        &#47&#47 log val metrics to your loggers!
        acc = self.val_accuracy(preds, targets)
        self.log("val/loss", loss, on_step=False, on_epoch=True, prog_bar=False)</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/ashleve/lightning-hydra-template/commit/b1e0bf9717f578221bb7f3460519051490cec8b6#diff-25687b55b8499032cbdde988ba1c9f30865fd2ac8d456ff8cfc2b05aa4901da4L46' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 71040693</div><div id='project'> Project Name: ashleve/lightning-hydra-template</div><div id='commit'> Commit Name: b1e0bf9717f578221bb7f3460519051490cec8b6</div><div id='time'> Time: 2021-03-10</div><div id='author'> Author: zalewski.ukas@gmail.com</div><div id='file'> File Name: src/models/mnist_model.py</div><div id='m_class'> M Class Name: LitModelMNIST</div><div id='n_method'> N Class Name: LitModelMNIST</div><div id='m_method'> M Method Name: validation_step(3)</div><div id='n_method'> N Method Name: validation_step(3)</div><div id='m_parent_class'> M Parent Class: pl.LightningModule</div><div id='n_parent_class'> N Parent Class: pl.LightningModule</div><div id='m_file'> M File Name: src/models/mnist_model.py</div><div id='n_file'> N File Name: src/models/mnist_model.py</div><div id='m_start'> M Start Line: 46</div><div id='m_end'> M End Line: 58</div><div id='n_start'> N Start Line: 76</div><div id='n_end'> N End Line: 86</div><BR>