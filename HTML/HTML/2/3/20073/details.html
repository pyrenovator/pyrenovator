<html><h3>Pattern ID :20073
</h3><img src='65733705.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
        mask = [np.array(ii)[0].mean(0) for ii in attn_scores][::-1]
        cum_mask = [matmul_prod(mask[: ii + 1]).mean(0) for ii in range(len(mask))]
        mask = [ii.mean(0) for ii in mask]
    elif <a id="change">check_type_is("bot") or check_type_is("coatnet")</a>:
        &#47&#47 bot attn_score [batch, num_heads, hh * ww, hh * ww]
        print("&gt;&gt;&gt;&gt; Attention type: bot / coatnet")
        mask = [np.array(ii)[0].mean((0)) for ii in attn_scores if len(ii.shape) == 4][::-1]
        if check_type_is("bot"):
            mask = [clip_max_value_matrix(ii) for ii in mask]  &#47&#47 Or it will be too dark.
            method<a id="change"> = </a>"avg"
        else:
            method = "max"
        cum_mask = [mask[0]] + [down_sample_matrix_axis_0(mask[ii], mask[ii - 1].shape[1], method) for ii in range(1, len(mask))]</code></pre><h3>After Change</h3><pre><code class='java'>
        mask = [np.array(ii)[0].mean((0)) for ii in attn_scores if len(ii.shape) == 4][::-1]
        cum_mask = [mask[0]] + [down_sample_matrix_axis_0(mask[ii], mask[ii - 1].shape[1], "max") for ii in range(1, len(mask))]
        cum_mask = [matmul_prod(cum_mask[: ii + 1]).max(0) for ii in range(len(cum_mask))]
        mask = [<a id="change">ii.max(</a>0<a id="change">)</a> for ii in mask]
    elif check_type_is("halo"):
        &#47&#47 halo attn_score [batch, num_heads, hh, ww, query_block * query_block, kv_kernel * kv_kernel]
        print("&gt;&gt;&gt;&gt; Attention type: halo")</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 3</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/leondgarse/keras_cv_attention_models/commit/e9f47afc799618ba61952db4bf9d679fbcc664cc#diff-1ec9a19aafb9379c6e226dccc101dafcc65576f11136e0603301b13fca3f7db4L268' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 65733705</div><div id='project'> Project Name: leondgarse/keras_cv_attention_models</div><div id='commit'> Commit Name: e9f47afc799618ba61952db4bf9d679fbcc664cc</div><div id='time'> Time: 2021-12-27</div><div id='author'> Author: leondgarse@gmail.com</div><div id='file'> File Name: keras_cv_attention_models/visualizing/visualizing.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: plot_attention_score_maps(6)</div><div id='n_method'> N Method Name: plot_attention_score_maps(6)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: keras_cv_attention_models/visualizing/visualizing.py</div><div id='n_file'> N File Name: keras_cv_attention_models/visualizing/visualizing.py</div><div id='m_start'> M Start Line: 269</div><div id='m_end'> M End Line: 281</div><div id='n_start'> N Start Line: 268</div><div id='n_end'> N End Line: 283</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        key of spatial data in adata.obsm
    
    &#47&#47 reindex adata1 and adata2 by matching then calculate the pairwise euclidean distance
    if <a id="change">abs(adata1.obsm[spatial_key].max()) &gt; 1 or abs(adata1.obsm[spatial_key].min()) &gt; 1</a>:
        adata1.obsm[&quotscale_spatial&quot]<a id="change"> = </a>adata1.obsm[spatial_key]/adata1.obsm[spatial_key].max()
    if abs(adata2.obsm[spatial_key].max()) &gt; 1 or abs(adata2.obsm[spatial_key].min()) &gt; 1:
        adata2.obsm[&quotscale_spatial&quot] = adata2.obsm[spatial_key]/adata2.obsm[spatial_key].max()
    spatial_key = &quotscale_spatial&quot</code></pre><h3>After Change</h3><pre><code class='java'>
    &#47&#47 reindex adata1 and adata2 by matching then calculate the pairwise euclidean distance
    for adata in [adata1, adata2]:
        coord = adata.obsm[spatial_key]
        if abs(coord.ptp()) &gt; 1 or abs(<a id="change">coord.max()</a>) &gt; 1:
            adata.obsm[&quotscale_spatial&quot] = (coord - coord.min(0))/coord.ptp(0)
        else:
            adata.obsm[&quotscale_spatial&quot] = coord</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/gao-lab/slat/commit/7cdf361c26cbdb2ff6bcb4a29245fc7d6f06001c#diff-e9b9ee3543f96df4a09e302567041dfd7e93dcd4838571849c1a64725a1c4148L198' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 65733693</div><div id='project'> Project Name: gao-lab/slat</div><div id='commit'> Commit Name: 7cdf361c26cbdb2ff6bcb4a29245fc7d6f06001c</div><div id='time'> Time: 2023-04-17</div><div id='author'> Author: xiachenrui@mail.cbi.pku.edu.cn</div><div id='file'> File Name: scSLAT/metrics.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: euclidean_dis(4)</div><div id='n_method'> N Method Name: euclidean_dis(4)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: scSLAT/metrics.py</div><div id='n_file'> N File Name: scSLAT/metrics.py</div><div id='m_start'> M Start Line: 218</div><div id='m_end'> M End Line: 224</div><div id='n_start'> N Start Line: 218</div><div id='n_end'> N End Line: 225</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>

def any_broadcast(data, root_rank, max_size=4096):
    broadcast arbitrary data from root_rank to all nodes.
    if <a id="change">not hasattr(any_broadcast, &quot_in_buffer&quot) or \
            max_size != any_broadcast._in_buffer.size()</a>:
        any_broadcast._buffer<a id="change"> = </a>torch.cuda.ByteTensor(max_size)
    buffer_ = any_broadcast._buffer

    enc = pickle.dumps(data)</code></pre><h3>After Change</h3><pre><code class='java'>
    broadcast arbitrary data from root_rank to all nodes.
    enc = pickle.dumps(data)

    max_size = <a id="change">hvd.allgather(torch.tensor([len(enc)]).cuda()).max()</a>.item()
    buffer_, enc_byte = _encode(enc, max_size)

    hvd.broadcast_(buffer_, root_rank)</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/chenrocks/uniter/commit/bb8926528e3783f339e8f4ae58ba6ff35ae6bc26#diff-74a54520c6efe03926ad7245c4eed444b8ca1f1d1abcc5860c5d6b50d9188074L184' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 65733696</div><div id='project'> Project Name: chenrocks/uniter</div><div id='commit'> Commit Name: bb8926528e3783f339e8f4ae58ba6ff35ae6bc26</div><div id='time'> Time: 2020-08-06</div><div id='author'> Author: Yen-Chun.Chen@microsoft.com</div><div id='file'> File Name: utils/distributed.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: any_broadcast(2)</div><div id='n_method'> N Method Name: any_broadcast(3)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: utils/distributed.py</div><div id='n_file'> N File Name: utils/distributed.py</div><div id='m_start'> M Start Line: 184</div><div id='m_end'> M End Line: 205</div><div id='n_start'> N Start Line: 196</div><div id='n_end'> N End Line: 203</div><BR>