<html><h3>Pattern ID :33159
</h3><img src='95837588.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
    logging.info(model)
    model.apply(model.init_weights)
    model.actions_before_train()
    <a id="change">model.to(</a>model.device<a id="change">)</a>

    &#47&#47 Run model
    data_dict = dict()
    for phase in [&quottrain&quot, &quotdev&quot, &quottest&quot]:</code></pre><h3>After Change</h3><pre><code class='java'>
    os.environ[&quotCUDA_VISIBLE_DEVICES&quot] = args.gpu
    args.device = torch.device(&quotcpu&quot)
    if args.gpu != &quot&quot and torch.cuda.is_available():
        args.device<a id="change"> = </a>torch.device(&quotcuda&quot)
    logging.info(&quotDevice: {}&quot.format(args.device))

    &#47&#47 Read data
    corpus_path = os.path.join(args.path, args.dataset, model_name.reader + &quot.pkl&quot)
    if not args.regenerate and os.path.exists(corpus_path):
        logging.info(&quotLoad corpus from {}&quot.format(corpus_path))
        corpus = pickle.load(open(corpus_path, &quotrb&quot))
    else:
        corpus = reader_name(args)
        logging.info(&quotSave corpus to {}&quot.format(corpus_path))
        pickle.dump(corpus, open(corpus_path, &quotwb&quot))

    &#47&#47 Define model
    model = model_name(args, corpus).to(args.device)
    <a id="change">logging.info(</a>&quot&#47&#47params: {}&quot.format(model.count_variables())<a id="change">)</a>
    logging.info(model)

    &#47&#47 Run model
    data_dict = dict()</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 5</div><BR><div id='size'>Non-data size: 3</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/thuwangcy/rechorus/commit/1990a3b0a81e17f87d94705868f12cead7fe06c7#diff-2e5ad92c43aa96cc3a9cef6c6aec998b216f1379c43b1f651013d25e55989312L42' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 95837588</div><div id='project'> Project Name: thuwangcy/rechorus</div><div id='commit'> Commit Name: 1990a3b0a81e17f87d94705868f12cead7fe06c7</div><div id='time'> Time: 2022-06-08</div><div id='author'> Author: THUwangcy@gmail.com</div><div id='file'> File Name: src/main.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: main(0)</div><div id='n_method'> N Method Name: main(0)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: src/main.py</div><div id='n_file'> N File Name: src/main.py</div><div id='m_start'> M Start Line: 43</div><div id='m_end'> M End Line: 79</div><div id='n_start'> N Start Line: 42</div><div id='n_end'> N End Line: 78</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        y_good = y[0]
        y_good = y_good.reshape((1,1,1))
        x_good = x_good.to(DEVICE)
        y_good = <a id="change">y_good.to(</a>DEVICE<a id="change">)</a>

        onehot_encoder = utils.make_onehot_encoder(label_features)
        y_good = onehot_encoder(y_good.item()).to(DEVICE)
        y_good = y_good.reshape((1, 1, y_good.shape[0]))</code></pre><h3>After Change</h3><pre><code class='java'>
    &#47&#47     y_good = torch.unsqueeze(torch.unsqueeze(y_good, 0), 0)

    &#47&#47     x_recon = model(x_good.float(), y_good.float())
    x<a id="change"> = </a>input_data
    y = input_label
    x_recon = model(x,y) &#47&#47 has shape [batch_size, seq_len, 159]
    logging.info(&quotxrecon has&quot)
    <a id="change">logging.info(</a>x_recon.shape<a id="change">)</a>
    _, seq_len, _ = x.shape

    x_formatted = x[0].reshape((seq_len, -1, 3))
    x_recon_formatted = x_recon[0].reshape((seq_len, -1, 3))</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/bioshape-lab/pirounet/commit/149d8ab584d8a5bd20c5f508a727bb53b470cc0f#diff-b846f0a50c78707b6a72060ccf30dec6e1367880274b53faa6ad883a975416a4L349' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 95837557</div><div id='project'> Project Name: bioshape-lab/pirounet</div><div id='commit'> Commit Name: 149d8ab584d8a5bd20c5f508a727bb53b470cc0f</div><div id='time'> Time: 2022-05-17</div><div id='author'> Author: papillon@umail.ucsb.edu</div><div id='file'> File Name: move/generate_f.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: recongeneral(8)</div><div id='n_method'> N Method Name: recongeneral(8)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: move/generate_f.py</div><div id='n_file'> N File Name: move/generate_f.py</div><div id='m_start'> M Start Line: 367</div><div id='m_end'> M End Line: 382</div><div id='n_start'> N Start Line: 384</div><div id='n_end'> N End Line: 388</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        token_ids = torch.unsqueeze(torch.LongTensor(input_ids), 0).to(self.device)
        attention_mask = torch.unsqueeze(torch.LongTensor(encode_results.get(&quotattention_mask&quot)), 0).to(self.device)
        segment_ids = torch.unsqueeze(torch.LongTensor(encode_results.get(&quottoken_type_ids&quot)), 0).to(self.device)
        model_outputs = <a id="change">self.model(token_ids, attention_mask, segment_ids).detach().to(</a>&quotcpu&quot<a id="change">)</a>
        model_output = torch.squeeze(model_outputs)
        results = self.data_manager.extract_entities(sentence, model_output)
        results_dict = {}
        for class_id, result_set in results.items():</code></pre><h3>After Change</h3><pre><code class='java'>
        
        预测接口
        
        start_time<a id="change"> = </a>time.time()
        encode_results = self.data_manager.tokenizer(sentence, padding=&quotmax_length&quot)
        input_ids = encode_results.get(&quotinput_ids&quot)
        token_ids = torch.unsqueeze(torch.LongTensor(input_ids), 0).to(self.device)
        attention_mask = torch.unsqueeze(torch.LongTensor(encode_results.get(&quotattention_mask&quot)), 0).to(self.device)
        segment_ids = torch.unsqueeze(torch.LongTensor(encode_results.get(&quottoken_type_ids&quot)), 0).to(self.device)
        logits, _ = self.model(token_ids, attention_mask, segment_ids)
        logit = torch.squeeze(logits.to(&quotcpu&quot))
        results = self.data_manager.extract_entities(sentence, logit)
        <a id="change">self.logger.info(</a>&quotpredict time consumption: %.3f(ms)&quot % ((time.time() - start_time) * 1000)<a id="change">)</a>
        results_dict = {}
        for class_id, result_set in results.items():
            results_dict[self.data_manager.reverse_categories[class_id]] = list(result_set)
        return results_dict</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/stanleylsx/entity_extractor_by_pointer/commit/53fb785dbe629c71f02b0f58a40d3f36e5eb3dc2#diff-37057fd6c2d2a9dd7d0167af43022d320464f2295904468cba54a58d1f90f3b4L25' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 95837568</div><div id='project'> Project Name: stanleylsx/entity_extractor_by_pointer</div><div id='commit'> Commit Name: 53fb785dbe629c71f02b0f58a40d3f36e5eb3dc2</div><div id='time'> Time: 2022-06-08</div><div id='author'> Author: gzlishouxian@gmail.com</div><div id='file'> File Name: engines/predict.py</div><div id='m_class'> M Class Name: Predictor</div><div id='n_method'> N Class Name: Predictor</div><div id='m_method'> M Method Name: predict_one(2)</div><div id='n_method'> N Method Name: predict_one(2)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: engines/predict.py</div><div id='n_file'> N File Name: engines/predict.py</div><div id='m_start'> M Start Line: 31</div><div id='m_end'> M End Line: 35</div><div id='n_start'> N Start Line: 30</div><div id='n_end'> N End Line: 39</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
    print(device)
    dbnet = DBTextModel().to(device)
    dbnet.train()
    criterion = <a id="change">DBLoss(alpha=1, beta=10, negative_ratio=3,
                       reduction=&quotmean&quot).to(</a>device<a id="change">)</a>
    db_optimizer = torch_optim.Adam(dbnet.parameters(),
                                    lr=0.001,
                                    weight_decay=0.0,
                                    amsgrad=False)</code></pre><h3>After Change</h3><pre><code class='java'>
    )

    &#47&#47 setup log folder
    log_dir_path<a id="change"> = </a>os.path.join(cfg.meta.root_dir, "logs")
    if not os.path.exists(log_dir_path):
        os.makedirs(log_dir_path)
    tfb_log_dir = os.path.join(log_dir_path, str(time.time()))
    <a id="change">logger.info(</a>tfb_log_dir<a id="change">)</a>
    if not os.path.exists(tfb_log_dir):
        os.makedirs(tfb_log_dir)
    tfb_writer = SummaryWriter(tfb_log_dir)
</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/huyhoang17/db_text_minimal/commit/1ccb73f6566551e5b6640c2b14d69b2a3d2334d8#diff-a454ee593451c002ad5a1322d7dc3d2574f234a8290c006a07243760eb453bbdL55' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 95837532</div><div id='project'> Project Name: huyhoang17/db_text_minimal</div><div id='commit'> Commit Name: 1ccb73f6566551e5b6640c2b14d69b2a3d2334d8</div><div id='time'> Time: 2020-06-02</div><div id='author'> Author: hoangphan0710@gmail.com</div><div id='file'> File Name: src/train.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: main(1)</div><div id='n_method'> N Method Name: main(0)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: src/train.py</div><div id='n_file'> N File Name: src/train.py</div><div id='m_start'> M Start Line: 58</div><div id='m_end'> M End Line: 250</div><div id='n_start'> N Start Line: 62</div><div id='n_end'> N End Line: 283</div><BR>