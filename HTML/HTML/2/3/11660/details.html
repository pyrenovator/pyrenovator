<html><h3>Pattern ID :11660
</h3><img src='39494410.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
            &#47&#47 Apply the attention mask
            w = w + attention_mask

        w = <a id="change">nn.Softmax(dim=-1)(</a>w<a id="change">)</a>
        w = self.attn_dropout(w)

        &#47&#47 Mask heads if we want to
        if head_mask is not None:</code></pre><h3>After Change</h3><pre><code class='java'>
            w = w + attention_mask

        &#47&#47 w = nn.Softmax(dim=-1)(w)
        w= <a id="change">torch.softmax(</a>w<a id="change">,dim=-1)</a>
        w = self.attn_dropout(w)

        &#47&#47 Mask heads if we want to
        if head_mask is not None:</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 4</div><BR><div id='size'>Non-data size: 3</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/saareliad/ftpipe/commit/f425b1397e951a9c7f000859dd49902ce61a30bd#diff-bfd41db8b65ddcf31046174a35ac39e126403ee18272bdf1099cc03bb0aeb0a6L154' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 39494410</div><div id='project'> Project Name: saareliad/ftpipe</div><div id='commit'> Commit Name: f425b1397e951a9c7f000859dd49902ce61a30bd</div><div id='time'> Time: 2019-12-12</div><div id='author'> Author: alondej@gmail.com</div><div id='file'> File Name: NLP_models/modeling_gpt2.py</div><div id='m_class'> M Class Name: Attention</div><div id='n_method'> N Class Name: Attention</div><div id='m_method'> M Method Name: _attn(6)</div><div id='n_method'> N Method Name: _attn(6)</div><div id='m_parent_class'> M Parent Class: nn.Module</div><div id='n_parent_class'> N Parent Class: nn.Module</div><div id='m_file'> M File Name: NLP_models/modeling_gpt2.py</div><div id='n_file'> N File Name: NLP_models/modeling_gpt2.py</div><div id='m_start'> M Start Line: 154</div><div id='m_end'> M End Line: 160</div><div id='n_start'> N Start Line: 154</div><div id='n_end'> N End Line: 161</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
    def forward(self, g_t: torch.Tensor) -&gt; torch.Tensor:
        train_bs, class_num = g_t.size(0), g_t.size(1)
        g_t_temp = g_t / self.temperature
        g_t_temp_softmax = <a id="change">nn.Softmax(dim=1)(</a>g_t_temp<a id="change">)</a>
        target_entropy_weight = entropy(g_t_temp_softmax).detach()
        target_entropy_weight = 1 + torch.exp(-target_entropy_weight)
        target_entropy_weight = train_bs * target_entropy_weight / torch.sum(target_entropy_weight)
        c_matrix = g_t_temp_softmax.mul(target_entropy_weight.view(-1,1)).transpose(1,0).mm(g_t_temp_softmax)</code></pre><h3>After Change</h3><pre><code class='java'>

    def forward(self, logits: torch.Tensor) -&gt; torch.Tensor:
        batch_size, num_classes = logits.shape
        predictions = <a id="change">F.softmax(</a>logits / self.temperature<a id="change">, dim=1)</a>  &#47&#47 batch_size x num_classes
        entropy_weight = entropy(predictions).detach()
        entropy_weight = 1 + torch.exp(-entropy_weight)
        entropy_weight = (batch_size * entropy_weight / torch.sum(entropy_weight)).unsqueeze(dim=1)  &#47&#47 batch_size x 1</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/thuml/transfer-learning-library/commit/7f63cd30ea0e7cf8961db90d2af8630e2429b434#diff-970938af033d5bdedb6c8ae49305f52cf895a99e2cc388cc89c2cf008f45f9e9L16' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 39494408</div><div id='project'> Project Name: thuml/transfer-learning-library</div><div id='commit'> Commit Name: 7f63cd30ea0e7cf8961db90d2af8630e2429b434</div><div id='time'> Time: 2020-08-28</div><div id='author'> Author: 13126830206@163.com</div><div id='file'> File Name: dalib/adaptation/mcc.py</div><div id='m_class'> M Class Name: MinimumClassConfusionLoss</div><div id='n_method'> N Class Name: MinimumClassConfusionLoss</div><div id='m_method'> M Method Name: forward(2)</div><div id='n_method'> N Method Name: forward(2)</div><div id='m_parent_class'> M Parent Class: nn.Module</div><div id='n_parent_class'> N Parent Class: nn.Module</div><div id='m_file'> M File Name: dalib/adaptation/mcc.py</div><div id='n_file'> N File Name: dalib/adaptation/mcc.py</div><div id='m_start'> M Start Line: 17</div><div id='m_end'> M End Line: 23</div><div id='n_start'> N Start Line: 41</div><div id='n_end'> N End Line: 46</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
    return torch.tanh(x)

def softmax(x, axis=None):
    return <a id="change">torch.nn.Softmax(dim=axis)(</a>x<a id="change">)</a>

def minimum(x,y):
    return torch.minimum(x, y)
</code></pre><h3>After Change</h3><pre><code class='java'>

def softmax(x, axis=None):
    axis = axis or -1
    return <a id="change">torch.softmax(</a>x<a id="change">, dim=axis)</a>

def minimum(x,y):
    return torch.minimum(x, y)
</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/zj-zhang/amber/commit/199d5986c6c56617052c61676eb82c4ba7ec8ba2#diff-2cd19417c5da8881e61cee3fe5f33b8b2ef0daf4aa750f38322c38bf1092f962L35' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 39494409</div><div id='project'> Project Name: zj-zhang/amber</div><div id='commit'> Commit Name: 199d5986c6c56617052c61676eb82c4ba7ec8ba2</div><div id='time'> Time: 2022-12-05</div><div id='author'> Author: zzj.zju@gmail.com</div><div id='file'> File Name: amber/backend/pytorch/math.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: softmax(2)</div><div id='n_method'> N Method Name: softmax(2)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: amber/backend/pytorch/math.py</div><div id='n_file'> N File Name: amber/backend/pytorch/math.py</div><div id='m_start'> M Start Line: 36</div><div id='m_end'> M End Line: 36</div><div id='n_start'> N Start Line: 38</div><div id='n_end'> N End Line: 39</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
            attn_mask = ProbMask(B, H, L_Q, index, scores, device=V.device)
            scores = scores + attn_mask.additive_matrix

        attn = <a id="change">nn.Softmax(dim=-1)(</a>scores<a id="change">)</a>

        context_in[torch.arange(B)[:, None, None],
                   torch.arange(H)[None, :, None],
                   index, :] = torch.matmul(attn, V)</code></pre><h3>After Change</h3><pre><code class='java'>
            attn_mask = ProbMask(B, H, L_Q, index, scores, device=V.device)
            scores.masked_fill_(attn_mask.mask, -np.inf)

        attn = <a id="change">torch.softmax(</a>scores<a id="change">, dim=-1)</a> &#47&#47 nn.Softmax(dim=-1)(scores)

        context_in[torch.arange(B)[:, None, None],
                   torch.arange(H)[None, :, None],</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/zhouhaoyi/informer2020/commit/70524e942cdc80a07ea1caffa907d92544701cc5#diff-5a4c62511bcb230aabde06b4492839a39912e40a36708e5552a50c7e943073b6L83' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 39494407</div><div id='project'> Project Name: zhouhaoyi/informer2020</div><div id='commit'> Commit Name: 70524e942cdc80a07ea1caffa907d92544701cc5</div><div id='time'> Time: 2020-12-08</div><div id='author'> Author: 1095715895@qq.com</div><div id='file'> File Name: models/attn.py</div><div id='m_class'> M Class Name: ProbAttention</div><div id='n_method'> N Class Name: ProbAttention</div><div id='m_method'> M Method Name: _update_context(7)</div><div id='n_method'> N Method Name: _update_context(7)</div><div id='m_parent_class'> M Parent Class: nn.Module</div><div id='n_parent_class'> N Parent Class: nn.Module</div><div id='m_file'> M File Name: models/attn.py</div><div id='n_file'> N File Name: models/attn.py</div><div id='m_start'> M Start Line: 87</div><div id='m_end'> M End Line: 90</div><div id='n_start'> N Start Line: 79</div><div id='n_end'> N End Line: 82</div><BR>