<html><h3>Pattern ID :17836
</h3><img src='58563864.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
        model_score = None
    &#47&#47 Remove rows from x, y and w, which contain Nan in any columns in y_test.
    x_test, y_test, __ = drop_nan_by_y_index(x_test, y_test)
    pred_test<a id="change"> = </a><a id="change">model.predict(</a>x_test<a id="change">)</a>
    model_pearsonr = pearsonr(np.ravel(pred_test), np.ravel(y_test.values))[0]

    return pred_score, {"model_score": model_score, "model_pearsonr": model_pearsonr}
</code></pre><h3>After Change</h3><pre><code class='java'>
    pred_score, y_test, __ = drop_nan_by_y_index(pred_score, y_test)
    model_pearsonr = pearsonr(np.ravel(pred_score.values), np.ravel(y_test.values))[0]

    return pred_score<a id="change">, {"model_pearsonr": model_pearsonr}, rid</a>


def backtest_analysis(pred, rid):
    backtest and analysis</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 9</div><BR><div id='size'>Non-data size: 3</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/microsoft/qlib/commit/c22bd73f67ec445bc4f542ee9004667663c38f0e#diff-e85369ca90d47fb4376b973050e0f2bd66cca8aa16ab93949415c3af58b2a288L82' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 58563864</div><div id='project'> Project Name: microsoft/qlib</div><div id='commit'> Commit Name: c22bd73f67ec445bc4f542ee9004667663c38f0e</div><div id='time'> Time: 2020-11-20</div><div id='author'> Author: dw1920@nyu.edu</div><div id='file'> File Name: tests/test_all_pipeline.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: train(0)</div><div id='n_method'> N Method Name: train(0)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: tests/test_all_pipeline.py</div><div id='n_file'> N File Name: tests/test_all_pipeline.py</div><div id='m_start'> M Start Line: 82</div><div id='m_end'> M End Line: 104</div><div id='n_start'> N Start Line: 111</div><div id='n_end'> N End Line: 130</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
            with torch.no_grad():
                x_tensor = torch.from_numpy(image).to(DEVICE).unsqueeze(0)
                print(x_tensor.shape)
                pr_mask<a id="change"> = </a><a id="change">seg_model.predict(</a>x_tensor<a id="change">)</a>
                pr_mask = pr_mask.argmax(dim=1).squeeze().cpu().numpy().astype(&quotuint8&quot)

                save_vis(
                    out_fp="./vis{}.png".format(str(i)),</code></pre><h3>After Change</h3><pre><code class='java'>
        n = np.random.choice(len(dataset))

        image, gt_mask = dataset[n]
        image_vis = image.permute((1<a id="change">, 2, 0</a>)).cpu().numpy().astype(&quotuint8&quot)
        gt_mask_vis = gt_mask.squeeze().cpu().numpy().astype(&quotuint8&quot)

        if seg_model is not None:</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/ais-bonn/vp-suite/commit/e8b74aea072bfc2c6f36278093202f5b017967f0#diff-b601549f53dd2792fb726f06778dc09d2a665ab9ec045898f6e564a87f7a8c23L10' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 58563853</div><div id='project'> Project Name: ais-bonn/vp-suite</div><div id='commit'> Commit Name: e8b74aea072bfc2c6f36278093202f5b017967f0</div><div id='time'> Time: 2021-07-15</div><div id='author'> Author: boltres@ais.uni-bonn.de</div><div id='file'> File Name: visualize.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: visualize(3)</div><div id='n_method'> N Method Name: visualize(2)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: visualize.py</div><div id='n_file'> N File Name: visualize.py</div><div id='m_start'> M Start Line: 16</div><div id='m_end'> M End Line: 25</div><div id='n_start'> N Start Line: 10</div><div id='n_end'> N End Line: 23</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
                    &quotmodel_file&quot: model_file
                })
                for X, y, split in zip(Xs, ys, splits):
                    y_pred<a id="change"> = </a><a id="change">calibrator.predict(</a>X<a id="change">)</a>
                    metrics[-1][&quotaccuracy_&quot + split] = (
                        accuracy_score(y, y_pred))
                    metrics[-1][&quotf1_&quot + split] = f1_score(y, y_pred)
</code></pre><h3>After Change</h3><pre><code class='java'>
                Xs, y_trues, y_preds = (
                    (X_valid, X_test),
                    (y_valid, y_test),
                    (y_pred_valid<a id="change">, y_pred_test</a>)
                )
                metrics.append({
                    &quotmodel_file&quot: model_file</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/tsafavi/codex/commit/cb963c8738f08ad97f74288ac4c819e6d951624a#diff-63cb8341b2788ac17860a4b44bf2e5dfa952838e7a342922b0840c00a2e20ae7L144' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 58563852</div><div id='project'> Project Name: tsafavi/codex</div><div id='commit'> Commit Name: cb963c8738f08ad97f74288ac4c819e6d951624a</div><div id='time'> Time: 2020-06-07</div><div id='author'> Author: tsafavi@umich.edu</div><div id='file'> File Name: scripts/tc.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: main(0)</div><div id='n_method'> N Method Name: main(0)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: scripts/tc.py</div><div id='n_file'> N File Name: scripts/tc.py</div><div id='m_start'> M Start Line: 169</div><div id='m_end'> M End Line: 191</div><div id='n_start'> N Start Line: 175</div><div id='n_end'> N End Line: 231</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>

        hashtag_set = list(set(reduce(lambda x, y: x + y, hashtags)))
        
        word_segmenter_output<a id="change"> = </a><a id="change">self.word_segmenter.predict(</a>hashtag_set<a id="change">, **segmenter_kwargs)</a>

        segmentations = word_segmenter_output.output
</code></pre><h3>After Change</h3><pre><code class='java'>
  
    def segment(self, tweets: List[str], regex_flag: Any = 0, preprocessing_kwargs: dict = {}, segmenter_kwargs: dict = {} ):

        hashtag_container<a id="change">, word_segmenter_output</a> = self.build_hashtag_container(tweets, preprocessing_kwargs, segmenter_kwargs)
        output = list(self.segmented_tweet_generator(tweets, *dataclasses.astuple(hashtag_container), flag=regex_flag))

        return TweetSegmenterOutput(</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/ruanchaves/hashformers/commit/45a0244f0004ef35ff19ba10ad322d58b621216e#diff-ee9fdeb737f1bd0b8d722c65e2c31c3e8ccecae8a377b43b81c74fc351bbfa87L329' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 58563849</div><div id='project'> Project Name: ruanchaves/hashformers</div><div id='commit'> Commit Name: 45a0244f0004ef35ff19ba10ad322d58b621216e</div><div id='time'> Time: 2022-02-06</div><div id='author'> Author: ruanchaves93@gmail.com</div><div id='file'> File Name: src/hashformers/segmenter.py</div><div id='m_class'> M Class Name: TweetSegmenter</div><div id='n_method'> N Class Name: TweetSegmenter</div><div id='m_method'> M Method Name: segment(5)</div><div id='n_method'> N Method Name: segment(5)</div><div id='m_parent_class'> M Parent Class: BaseSegmenter</div><div id='n_parent_class'> N Parent Class: BaseSegmenter</div><div id='m_file'> M File Name: src/hashformers/segmenter.py</div><div id='n_file'> N File Name: src/hashformers/segmenter.py</div><div id='m_start'> M Start Line: 329</div><div id='m_end'> M End Line: 342</div><div id='n_start'> N Start Line: 346</div><div id='n_end'> N End Line: 349</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        results = torch.cat(
            [
                x.logits
                for x in <a id="change">self.trainer.predict(
                    model=self.model, dataloaders=loader, return_predictions=True
                )</a>
            ]
        )
        softmax = self.softmax(results)
        &#47&#47 get confidence scores and label ints
        confidence_and_labels_tensor = torch.max(softmax, dim=-1)
        &#47&#47 section id correlates with index of batchencoding data
        section_id = 0
        for doc in docs:
            for section in doc.sections:
                for token_index, (offsets, word_id) in enumerate(
                    zip(
                        loader.dataset.encodings.encodings[section_id].offsets,
                        loader.dataset.encodings.encodings[section_id].word_ids,
                    )
                ):
                    &#47&#47 word_id is None if token is a special token (e.g. [CLS] in bery)
                    if word_id is not None:
                        label<a id="change"> = </a>self.config.id2label[
                            confidence_and_labels_tensor[1][section_id][token_index].item()
                        ]
                        &#47&#47 update the parse states</code></pre><h3>After Change</h3><pre><code class='java'>
        return all_words

    def _run(self, docs: List[Document]) -&gt; Tuple[List[Document], List[Document]]:
        loader<a id="change">, id_section_map</a> = self.get_dataloader(docs)
        &#47&#47 run the transformer and get results
        confidence_and_labels_tensor = self.get_confidence_and_labels_tensor(loader)
        for section_index, section in id_section_map.items():</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/astrazeneca/kazu/commit/4d1b6d74c016688209d82e500016dd8eda45da27#diff-9ec49f69bf2c8adcd8a03e6c8e31f8cdc4c5d41c030cc74bfd06e94922c367ddL60' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 58563861</div><div id='project'> Project Name: astrazeneca/kazu</div><div id='commit'> Commit Name: 4d1b6d74c016688209d82e500016dd8eda45da27</div><div id='time'> Time: 2021-11-16</div><div id='author'> Author: richard.jackson4@astrazeneca.com</div><div id='file'> File Name: azner/steps/ner/hf_token_classification.py</div><div id='m_class'> M Class Name: TransformersModelForTokenClassificationNerStep</div><div id='n_method'> N Class Name: TransformersModelForTokenClassificationNerStep</div><div id='m_method'> M Method Name: _run(2)</div><div id='n_method'> N Method Name: _run(2)</div><div id='m_parent_class'> M Parent Class: BaseStep</div><div id='n_parent_class'> N Parent Class: BaseStep</div><div id='m_file'> M File Name: azner/steps/ner/hf_token_classification.py</div><div id='n_file'> N File Name: azner/steps/ner/hf_token_classification.py</div><div id='m_start'> M Start Line: 61</div><div id='m_end'> M End Line: 103</div><div id='n_start'> N Start Line: 189</div><div id='n_end'> N End Line: 220</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
            Prediction accuracy

        
        pred<a id="change"> = </a><a id="change">self.predict(</a>x<a id="change">)</a>.detach().cpu()
        label = torch.where(y.T)[1]
        return (pred == label).detach().float().mean().tolist()
</code></pre><h3>After Change</h3><pre><code class='java'>
            Prediction accuracy.

        
        return true[range(pred.shape[0])<a id="change">, pred.squeeze(-1)</a>].detach().mean().item()
</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/omicsml/dance/commit/0e70e4a8267eb2dbba694b513b54b95fb6dfecf4#diff-a31d842f071311ae2d29369af923cc293571b19beb8834792d53a3b28ea6b6a2L198' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 58563860</div><div id='project'> Project Name: omicsml/dance</div><div id='commit'> Commit Name: 0e70e4a8267eb2dbba694b513b54b95fb6dfecf4</div><div id='time'> Time: 2022-11-22</div><div id='author'> Author: 36778645+RemyLau@users.noreply.github.com</div><div id='file'> File Name: dance/modules/single_modality/cell_type_annotation/actinn.py</div><div id='m_class'> M Class Name: ACTINN</div><div id='n_method'> N Class Name: ACTINN</div><div id='m_method'> M Method Name: score(3)</div><div id='n_method'> N Method Name: score(3)</div><div id='m_parent_class'> M Parent Class: nn.Module</div><div id='n_parent_class'> N Parent Class: nn.Module</div><div id='m_file'> M File Name: dance/modules/single_modality/cell_type_annotation/actinn.py</div><div id='n_file'> N File Name: dance/modules/single_modality/cell_type_annotation/actinn.py</div><div id='m_start'> M Start Line: 214</div><div id='m_end'> M End Line: 216</div><div id='n_start'> N Start Line: 214</div><div id='n_end'> N End Line: 214</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>


        input_ids, attention_mask, segment_ids, valid_masks, label_ids, label_masks = batch
        prediction<a id="change">, valid_len = </a><a id="change">self.predict(</a>batch<a id="change">)</a>
        metrics.evaluate(prediction, label_ids, valid_len)


</code></pre><h3>After Change</h3><pre><code class='java'>
        label_result = torch.cat(label_result)
        pred_result = torch.cat(pred_result)

        p<a id="change">, r, f1, _</a> = precision_recall_fscore_support(label_result.cpu().numpy(),
                                                      pred_result.cpu().numpy(),
                                                      average="macro")
</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/jinzhuoran/cogie/commit/a3df407e630e8b4bbcc3388fd34d0361d70fbdc9#diff-cdcb9cac06f0d71a01bb436ba0e17fb0a72b98ca816c4ffa4aa04568f29e3dceL270' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 58563857</div><div id='project'> Project Name: jinzhuoran/cogie</div><div id='commit'> Commit Name: a3df407e630e8b4bbcc3388fd34d0361d70fbdc9</div><div id='time'> Time: 2022-04-07</div><div id='author'> Author: 1208314139@qq.com</div><div id='file'> File Name: cogie/models/ner/w2ner.py</div><div id='m_class'> M Class Name: W2NER</div><div id='n_method'> N Class Name: W2NER</div><div id='m_method'> M Method Name: evaluate(2)</div><div id='n_method'> N Method Name: evaluate(3)</div><div id='m_parent_class'> M Parent Class: nn.Module</div><div id='n_parent_class'> N Parent Class: nn.Module</div><div id='m_file'> M File Name: cogie/models/ner/w2ner.py</div><div id='n_file'> N File Name: cogie/models/ner/w2ner.py</div><div id='m_start'> M Start Line: 271</div><div id='m_end'> M End Line: 286</div><div id='n_start'> N Start Line: 272</div><div id='n_end'> N End Line: 297</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
                    one_hot_label = torch.zeros(Y_Val.shape[0], self.target_classes).to(self.device)
                    one_hot_label.scatter_(1,Y_Val.view(-1, 1), 1)   
                else:
                    predicted_y<a id="change"> = </a><a id="change">self.predict(</a>self.unlabeled_x<a id="change">)</a>
                    one_hot_label = torch.zeros(self.unlabeled_x.shape[0], self.target_classes).to(self.device)
                    one_hot_label.scatter_(1, predicted_y.view(-1, 1), 1)
                l0_grads = scores - one_hot_label
                l0_expand = torch.repeat_interleave(l0_grads, embDim, dim=1)</code></pre><h3>After Change</h3><pre><code class='java'>
            
            else:
                predicted_y = self.predict(self.unlabeled_x)
                self.X_new = np.concatenate((self.unlabeled_x<a id="change">,self.X</a>), axis = 0)
                self.Y_new = np.concatenate((predicted_y,self.Y), axis = 0)

                loader = DataLoader(self.handler(self.X_new,self.Y_new,select=False),shuffle=False,\</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/decile-team/distil/commit/3df78396807a37fd7c5f507504634bc8f97cec2e#diff-9503d48bf5d468382e816b5ff2ff407d781c5bd9132ca7277c942f9a89e7cb33L79' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 58563856</div><div id='project'> Project Name: decile-team/distil</div><div id='commit'> Commit Name: 3df78396807a37fd7c5f507504634bc8f97cec2e</div><div id='time'> Time: 2021-01-04</div><div id='author'> Author: you@example.com</div><div id='file'> File Name: active_learning_strategies/glister.py</div><div id='m_class'> M Class Name: GLISTER</div><div id='n_method'> N Class Name: GLISTER</div><div id='m_method'> M Method Name: _update_grads_val(3)</div><div id='n_method'> N Method Name: _update_grads_val(3)</div><div id='m_parent_class'> M Parent Class: Strategy</div><div id='n_parent_class'> N Parent Class: Strategy</div><div id='m_file'> M File Name: active_learning_strategies/glister.py</div><div id='n_file'> N File Name: active_learning_strategies/glister.py</div><div id='m_start'> M Start Line: 81</div><div id='m_end'> M End Line: 143</div><div id='n_start'> N Start Line: 81</div><div id='n_end'> N End Line: 153</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
                interaction = batched_data
                batch_size = interaction.length
                if batch_size &lt;= self.test_batch_size:
                    scores<a id="change"> = </a><a id="change">self.model.predict(</a>interaction.to(self.device)<a id="change">)</a>
                else:
                    scores = self._spilt_predict(interaction, batch_size)

            self.eval_collector.eval_batch_collect(scores, interaction)</code></pre><h3>After Change</h3><pre><code class='java'>
            if eval_data.dl_type == DataLoaderType.FULL:
                interaction, scores, positive_u, positive_i = self._full_sort_batch_eval(batched_data)
            else:
                interaction<a id="change">, scores, positive_u, positive_i</a> = self._neg_sample_batch_eval(batched_data)
            self.eval_collector.eval_batch_collect(scores, interaction, positive_u, positive_i)
        self.eval_collector.model_collect(self.model)
        struct = self.eval_collector.get_data_struct()</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/rucaibox/recbole/commit/e0606ca1e91775af9b883c58c7449ffef4746549#diff-e38b0c7af084318af2abfe6a4023b17aa4e190267c4467908362cacf3187f601L368' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 58563859</div><div id='project'> Project Name: rucaibox/recbole</div><div id='commit'> Commit Name: e0606ca1e91775af9b883c58c7449ffef4746549</div><div id='time'> Time: 2021-07-18</div><div id='author'> Author: 970955517@qq.com</div><div id='file'> File Name: recbole/trainer/trainer.py</div><div id='m_class'> M Class Name: Trainer</div><div id='n_method'> N Class Name: Trainer</div><div id='m_method'> M Method Name: evaluate(5)</div><div id='n_method'> N Method Name: evaluate(5)</div><div id='m_parent_class'> M Parent Class: AbstractTrainer</div><div id='n_parent_class'> N Parent Class: AbstractTrainer</div><div id='m_file'> M File Name: recbole/trainer/trainer.py</div><div id='n_file'> N File Name: recbole/trainer/trainer.py</div><div id='m_start'> M Start Line: 400</div><div id='m_end'> M End Line: 421</div><div id='n_start'> N Start Line: 412</div><div id='n_end'> N End Line: 427</div><BR>