<html><h3>Pattern ID :23651
</h3><img src='73885063.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>

        &#47&#47 loop over the epoch
        for n in range(nepoch):
            <a id="change">print(&quot----------------------------------------&quot</a><a id="change">)</a>
            print(&quotepoch %d&quot % n)

            cumulative_loss = 0
</code></pre><h3>After Change</h3><pre><code class='java'>
        &#47&#47 log data
        Log data for the optimization.
        log.info(&quot  Task                :&quot, self.task)
        <a id="change">log.info(
            &quot  Number Parameters   : {0}&quot</a>, self.wf.get_number_parameters()<a id="change">)</a>
        <a id="change">log.info(&quot  Number of epoch     : {0}&quot</a>, nepoch<a id="change">)</a>
        log.info(&quot  Batch size          : {0}&quot, batchsize)
        log.info(&quot  Loss function       : {0}&quot, loss)
        log.info(&quot  Gardients           : {0}&quot, grad)
        log.info(
            &quot  Resampling mode     : {0}&quot, self.resampling_options.mode)
        <a id="change">log.info(
            &quot  Resampling every    : {0}&quot</a>, self.resampling_options.resample_every<a id="change">)</a>
        <a id="change">log.info(
            &quot  Resampling steps    : {0}&quot</a>, self.resampling_options.nstep_update<a id="change">)</a>

        &#47&#47 loop over the epoch
        for n in range(nepoch):
</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 5</div><BR><div id='size'>Non-data size: 5</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/nlesc-jcer/qmctorch/commit/60e768b52e4631096cf4dff91b1926931e73277f#diff-0c7ac0561c683227ec3bebb7bb6d2af7035c80e22da43e9b48fd7a667bc20c5aL47' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 73885063</div><div id='project'> Project Name: nlesc-jcer/qmctorch</div><div id='commit'> Commit Name: 60e768b52e4631096cf4dff91b1926931e73277f</div><div id='time'> Time: 2020-05-26</div><div id='author'> Author: nicolas.gm.renaud@gmail.com</div><div id='file'> File Name: qmctorch/solver/solver_orbital.py</div><div id='m_class'> M Class Name: SolverOrbital</div><div id='n_method'> N Class Name: SolverOrbital</div><div id='m_method'> M Method Name: run(7)</div><div id='n_method'> N Method Name: run(7)</div><div id='m_parent_class'> M Parent Class: SolverBase</div><div id='n_parent_class'> N Parent Class: SolverBase</div><div id='m_file'> M File Name: qmctorch/solver/solver_orbital.py</div><div id='n_file'> N File Name: qmctorch/solver/solver_orbital.py</div><div id='m_start'> M Start Line: 95</div><div id='m_end'> M End Line: 124</div><div id='n_start'> N Start Line: 47</div><div id='n_end'> N End Line: 144</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
            step=-1, observation=obs, deterministic=False, env=env
        )
        transition = env.step(act_result)
        <a id="change">print(
            f"action={act_result.action}, reward={transition.reward}, "
            f"terminal={transition.terminal}"</a><a id="change">,
        )</a>
        if transition.terminal:
            obs = env.reset()
        else:
            obs = transition.observation</code></pre><h3>After Change</h3><pre><code class='java'>
    env = PickFromPileEnv(gui=not args.nogui, retime=10)
    t_start = time.time()
    obs = env.reset()
    <a id="change">logger.info(f"{time.time() - t_start:.2f} [s]"</a><a id="change">)</a>
    if args.print_obs:
        pprint.pprint(obs)

    agent = DqnAgent(env=env)
    agent.build(training=False)

    while True:
        for key in obs:
            obs[key] = obs[key][None, None, :]
        act_result = agent.act(
            step=-1, observation=obs, deterministic=False, env=env
        )
        t_start = time.time()
        transition = env.step(act_result)
        <a id="change">logger.info(f"{time.time() - t_start:.2f} [s]"</a><a id="change">)</a>
        <a id="change">logger.info(
            f"action={act_result.action}, reward={transition.reward}, "
            f"terminal={transition.terminal}"</a><a id="change">,
        )</a>
        if transition.terminal:
            t_start = time.time()
            obs = env.reset()
            <a id="change">logger.info(f"{time.time() - t_start:.2f} [s]"</a><a id="change">)</a>
        else:
            obs = transition.observation

</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/wkentaro/reorientbot/commit/7288c4ac7c6f55faa88907d8dad3fd9ef6ff8370#diff-6299cb1ac345e82c13bd71910b55cf515d01b5ffb544262be2a8000c840304a7L9' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 73885062</div><div id='project'> Project Name: wkentaro/reorientbot</div><div id='commit'> Commit Name: 7288c4ac7c6f55faa88907d8dad3fd9ef6ff8370</div><div id='time'> Time: 2021-04-27</div><div id='author'> Author: www.kentaro.wada@gmail.com</div><div id='file'> File Name: examples/target_pick/check_exploration.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: main(0)</div><div id='n_method'> N Method Name: main(0)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: examples/target_pick/check_exploration.py</div><div id='n_file'> N File Name: examples/target_pick/check_exploration.py</div><div id='m_start'> M Start Line: 12</div><div id='m_end'> M End Line: 27</div><div id='n_start'> N Start Line: 14</div><div id='n_end'> N End Line: 47</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>

            self.print_observable(cumulative_loss)

            <a id="change">print(&quot----------------------------------------&quot</a><a id="change">)</a>

            &#47&#47 resample the data
            pos = self.resample(n, pos)
</code></pre><h3>After Change</h3><pre><code class='java'>
                                        Defaults to wf.task.
        

        <a id="change">log.info(&quot&quot</a><a id="change">)</a>
        log.info(&quot  Optimization&quot)

        &#47&#47 observalbe
        if not hasattr(self, &quotobservable&quot):
            self.track_observable([&quotlocal_energy&quot])

        self.evaluate_gradient = {
            &quotauto&quot: self.evaluate_grad_auto,
            &quotmanual&quot: self.evaluate_grad_manual}[grad]

        if &quotlpos_needed&quot not in self.opt.__dict__.keys():
            self.opt.lpos_needed = False

        &#47&#47 sample the wave function
        pos = self.sampler(self.wf.pdf)

        &#47&#47 get the loss
        self.loss = Loss(self.wf, method=loss, clip=clip_loss)
        self.loss.use_weight = (
            self.resampling_options.resample_every &gt; 1)

        &#47&#47 orthogonalization penalty for the MO coeffs
        self.ortho_loss = OrthoReg()

        &#47&#47 handle the batch size
        if batchsize is None:
            batchsize = len(pos)

        &#47&#47 change the number of steps/walker size
        _nstep_save = self.sampler.nstep
        _ntherm_save = self.sampler.ntherm
        _nwalker_save = self.sampler.walkers.nwalkers
        if self.resampling_options.mode == &quotupdate&quot:
            self.sampler.ntherm = -1
            self.sampler.nstep = self.resampling_options.nstep_update
            self.sampler.walkers.nwalkers = pos.shape[0]
            self.sampler.nwalkers = pos.shape[0]

        &#47&#47 create the data loader
        self.dataset = DataSet(pos)
        self.dataloader = DataLoader(
            self.dataset, batch_size=batchsize)

        cumulative_loss = []
        min_loss = 1E3

        &#47&#47 get the initial observalbe
        self.store_observable(pos)

        &#47&#47 log data
        Log data for the optimization.
        log.info(&quot  Task                :&quot, self.task)
        log.info(
            &quot  Number Parameters   : {0}&quot, self.wf.get_number_parameters())
        log.info(&quot  Number of epoch     : {0}&quot, nepoch)
        log.info(&quot  Batch size          : {0}&quot, batchsize)
        log.info(&quot  Loss function       : {0}&quot, loss)
        <a id="change">log.info(&quot  Gardients           : {0}&quot</a>, grad<a id="change">)</a>
        <a id="change">log.info(
            &quot  Resampling mode     : {0}&quot</a>, self.resampling_options.mode<a id="change">)</a>
        <a id="change">log.info(
            &quot  Resampling every    : {0}&quot</a>, self.resampling_options.resample_every<a id="change">)</a>
        log.info(
            &quot  Resampling steps    : {0}&quot, self.resampling_options.nstep_update)

        &#47&#47 loop over the epoch</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/nlesc-jcer/qmctorch/commit/60e768b52e4631096cf4dff91b1926931e73277f#diff-0c7ac0561c683227ec3bebb7bb6d2af7035c80e22da43e9b48fd7a667bc20c5aL27' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 73885071</div><div id='project'> Project Name: nlesc-jcer/qmctorch</div><div id='commit'> Commit Name: 60e768b52e4631096cf4dff91b1926931e73277f</div><div id='time'> Time: 2020-05-26</div><div id='author'> Author: nicolas.gm.renaud@gmail.com</div><div id='file'> File Name: qmctorch/solver/solver_orbital.py</div><div id='m_class'> M Class Name: SolverOrbital</div><div id='n_method'> N Class Name: SolverOrbital</div><div id='m_method'> M Method Name: run(7)</div><div id='n_method'> N Method Name: run(7)</div><div id='m_parent_class'> M Parent Class: SolverBase</div><div id='n_parent_class'> N Parent Class: SolverBase</div><div id='m_file'> M File Name: qmctorch/solver/solver_orbital.py</div><div id='n_file'> N File Name: qmctorch/solver/solver_orbital.py</div><div id='m_start'> M Start Line: 95</div><div id='m_end'> M End Line: 124</div><div id='n_start'> N Start Line: 47</div><div id='n_end'> N End Line: 144</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
    ambient_prof = raw_adata.X.sum(axis=0) / raw_adata.X.sum()

    if verbose:
        <a id="change">print(</a>"Estimating ambient profile for ", feature_type, <a id="change">"..."</a><a id="change">)</a>

    i = 0
    while i &lt; iterations:
        &#47&#47 calculate joint probability (log) of being cell-free droplets for each droplet</code></pre><h3>After Change</h3><pre><code class='java'>
        )
    

    <a id="change">setup_logger</a> = get_logger("setup_anndata", verbose=verbose)

    if feature_type is None:
        feature_type = adata.var["feature_types"].unique()
    elif isinstance(feature_type, str):
        feature_type = [feature_type]

    &#47&#47 take subset genes to save memory
    &#47&#47 raw_adata._inplace_subset_var(raw_adata.var_names.isin(adata.var_names))
    &#47&#47 raw_adata._inplace_subset_obs(raw_adata.X.sum(axis=1) &gt;= min_raw_counts)
    raw_adata = raw_adata[:, raw_adata.var_names.isin(adata.var_names)]
    raw_adata = raw_adata[raw_adata.X.sum(axis=1) &gt;= min_raw_counts]

    raw_adata.obs["total_counts"] = raw_adata.X.sum(axis=1)

    if sample is not None:
        sample = int(sample)
    else:
        sample = raw_adata.shape[0]

    &#47&#47 check n_batch
    if n_batch is None:
        n_batch = int(np.ceil(sample / 5000))
    else:
        n_batch = int(n_batch)

    &#47&#47 check if per batch contains too many droplets
    if sample / n_batch &gt; 5000:
        setup_logger.info(
            "The number of droplets per batch is too large, this may cause memory issue, please increase the number of batches."
        )

    idx = np.random.choice(
        raw_adata.shape[0], size=min(raw_adata.shape[0], sample), replace=False
    )
    raw_adata = raw_adata[idx]

    <a id="change">setup_logger.info(
        f"Randomly sample {sample:d} droplets from {raw_adata.shape[0]:d} droplets."</a><a id="change">
    )</a>
    &#47&#47 initial estimation of ambient profile, will be update
    ambient_prof = raw_adata.X.sum(axis=0) / raw_adata.X.sum()

    setup_logger.info(f"Estimating ambient profile for {feature_type}...")

    i = 0
    while i &lt; iterations:
        &#47&#47 calculate joint probability (log) of being cell-free droplets for each droplet
        log_prob = []
        batch_idx = np.floor(
            np.array(range(raw_adata.shape[0])) / raw_adata.shape[0] * n_batch
        )
        for b in range(n_batch):
            try:
                count_batch = raw_adata[batch_idx == b].X.astype(int).A
            except MemoryError:
                raise MemoryError("use more batches by setting a higher n_batch")
            log_prob_batch = Multinomial(
                probs=torch.tensor(ambient_prof), validate_args=False
            ).log_prob(torch.Tensor(count_batch))
            log_prob.append(log_prob_batch)

        log_prob = np.concatenate(log_prob, axis=0)
        raw_adata.obs["log_prob"] = log_prob
        raw_adata.obs["droplets"] = "other droplets"

        &#47&#47 cell-containing droplets
        raw_adata.obs.loc[
            raw_adata.obs_names.isin(adata.obs_names), "droplets"
        ] = "cells"

        &#47&#47 identify cell-free droplets
        raw_adata.obs["droplets"] = raw_adata.obs["droplets"].mask(
            raw_adata.obs["log_prob"] &gt;= np.log(prob) * raw_adata.shape[1],
            "cell-free droplets",
        )
        emptydrops = raw_adata[raw_adata.obs["droplets"] == "cell-free droplets"]

        if emptydrops.shape[0] &lt; 50:
            raise Exception("Too few emptydroplets! Lower the prob parameter")

        ambient_prof = emptydrops.X.sum(axis=0) / emptydrops.X.sum()

        i += 1

        <a id="change">setup_logger.info(f"Iteration: {i:d}"</a><a id="change">)</a>

    &#47&#47 update ambient profile for each feature type
    for ft in feature_type:
        tmp = emptydrops[:, emptydrops.var["feature_types"] == ft]
        adata.uns[f"ambient_profile_{ft}"] = pd.DataFrame(
            tmp.X.sum(axis=0).reshape(-1, 1) / tmp.X.sum(),
            index=tmp.var_names,
            columns=[f"ambient_profile_{ft}"],
        )

        <a id="change">setup_logger.info(f"Estimated ambient profile for {ft} saved in adata.uns"</a><a id="change">)</a>

    &#47&#47 update ambient profile for all feature types
    adata.uns[f"ambient_profile_all"] = pd.DataFrame(
        emptydrops.X.sum(axis=0).reshape(-1, 1) / emptydrops.X.sum(),
        index=emptydrops.var_names,
        columns=[f"ambient_profile_all"],
    )

    <a id="change">setup_logger.info("Estimated ambient profile for all features saved in adata.uns"</a><a id="change">)</a>

    if kneeplot:
        _, axs = plt.subplots(2, figsize=figsize)
</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/novartis/scar/commit/f8432f3aff8e3a1d6489be806ee93dd695029e4c#diff-5750bc0adda553d5d0b511b5097d256259aaae1176478ac91e9539f740112139L11' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 73885070</div><div id='project'> Project Name: novartis/scar</div><div id='commit'> Commit Name: f8432f3aff8e3a1d6489be806ee93dd695029e4c</div><div id='time'> Time: 2023-05-01</div><div id='author'> Author: 43896555+CaibinSh@users.noreply.github.com</div><div id='file'> File Name: scar/main/_setup.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: setup_anndata(11)</div><div id='n_method'> N Method Name: setup_anndata(11)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: scar/main/_setup.py</div><div id='n_file'> N File Name: scar/main/_setup.py</div><div id='m_start'> M Start Line: 89</div><div id='m_end'> M End Line: 199</div><div id='n_start'> N Start Line: 90</div><div id='n_end'> N End Line: 195</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        
        if show:
            print(&quotcm&quot,cm)
            <a id="change">print(&quotresults&quot</a>, test_results<a id="change">)</a>

        return test_results

    def class_count(self, labels):</code></pre><h3>After Change</h3><pre><code class='java'>
        test_results[&quotAcc&quot] = acc
        
        logger.info
        <a id="change">logger.info("***** Test: Confusion Matrix *****"</a><a id="change">)</a>
        <a id="change">logger.info("%s"</a>, str(cm)<a id="change">)</a>
        <a id="change">logger.info("***** Test results *****"</a><a id="change">)</a>
        
        for key in sorted(test_results.keys()):
            <a id="change">logger.info("  %s = %s"</a>, key, str(test_results[key])<a id="change">)</a>

        return test_results

    def class_count(self, labels):</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/thuiar/textoir/commit/6a35f12fcf05f6820d4aa84709f9bea47aaeae71#diff-fe7b1b5c33a055cd63133026ac2180a34ddad32720ec96dc0106aefa203b7d97L241' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 73885066</div><div id='project'> Project Name: thuiar/textoir</div><div id='commit'> Commit Name: 6a35f12fcf05f6820d4aa84709f9bea47aaeae71</div><div id='time'> Time: 2021-06-05</div><div id='author'> Author: zhang-hl20@mails.tsinghua.edu.cn</div><div id='file'> File Name: open_intent_detection/methods/ADB/manager.py</div><div id='m_class'> M Class Name: ADBManager</div><div id='n_method'> N Class Name: ADBManager</div><div id='m_method'> M Method Name: test(4)</div><div id='n_method'> N Method Name: test(4)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: open_intent_detection/methods/ADB/manager.py</div><div id='n_file'> N File Name: open_intent_detection/methods/ADB/manager.py</div><div id='m_start'> M Start Line: 244</div><div id='m_end'> M End Line: 254</div><div id='n_start'> N Start Line: 245</div><div id='n_end'> N End Line: 259</div><BR>