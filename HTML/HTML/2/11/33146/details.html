<html><h3>Pattern ID :33146
</h3><img src='95817398.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
    
    if not dataset_name:
        raise ValueError("No dataset name provided.")
    <a id="change">try:
        logging.info(f"Trying to retrieve AzureML Dataset &quot{dataset_name}&quot"</a><a id="change">)</a>
        azureml_dataset = Dataset.get_by_name(workspace, name=dataset_name)
        <a id="change">logging.info("Dataset found."</a><a id="change">)</a>
    <a id="change">except </a>Exception:
        <a id="change">logging.info(</a>f"Retrieving datastore &quot{datastore_name}&quot from AzureML workspace"<a id="change">)</a>
        datastore = get_datastore(workspace, datastore_name)
        logging.info(f"Creating a new dataset from data in folder &quot{dataset_name}&quot in the datastore")
        &#47&#47 Ensure that there is a / at the end of the file path, otherwise folder that share a prefix could create
        &#47&#47 trouble (for example, folders foo and foo_bar exist, and I&quotm trying to create a dataset from "foo")</code></pre><h3>After Change</h3><pre><code class='java'>
        aml_dataset = _get_or_create_v1_dataset(datastore_name, dataset_name, workspace)
        return aml_dataset
    else:
        <a id="change">try:
            </a>ml_client<a id="change"> = </a>get_ml_client(ml_client=ml_client)
            aml_dataset = _get_or_create_v2_dataset(datastore_name, dataset_name, ml_client)
        <a id="change">except </a>HttpResponseError as e:
            if "Cannot create v2 Data Version in v1 Data Container" in e.message:
                logging.info("This appears to be a v1 Data Container. Reverting to API v1 to create this Dataset")
            aml_dataset = _get_or_create_v1_dataset(datastore_name, dataset_name, workspace)</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 8</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/microsoft/hi-ml/commit/0b65bd42cf0637114021b72fcb3d50a0eb27ee58#diff-05c8833d240ea1622fc8c3911063e990667c8d5149d011611d63ea5c52ce3715L43' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 95817398</div><div id='project'> Project Name: microsoft/hi-ml</div><div id='commit'> Commit Name: 0b65bd42cf0637114021b72fcb3d50a0eb27ee58</div><div id='time'> Time: 2022-11-07</div><div id='author'> Author: 66642528+mebristo@users.noreply.github.com</div><div id='file'> File Name: hi-ml-azure/src/health_azure/datasets.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: get_or_create_dataset(5)</div><div id='n_method'> N Method Name: get_or_create_dataset(3)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: hi-ml-azure/src/health_azure/datasets.py</div><div id='n_file'> N File Name: hi-ml-azure/src/health_azure/datasets.py</div><div id='m_start'> M Start Line: 43</div><div id='m_end'> M End Line: 65</div><div id='n_start'> N Start Line: 194</div><div id='n_end'> N End Line: 232</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
    def send_message_json(self, topic, message, wait_for_publish=True):
        ret_info = self._client.publish(topic, payload=message)
        if wait_for_publish:
            <a id="change">try:
                logging.info("send_message. WAIT"</a><a id="change">)</a>
                ret_info.wait_for_publish(1)
                <a id="change">logging.info("send_message. END"</a><a id="change">)</a>
            <a id="change">except </a>Exception as e:
                <a id="change">logging.info(</a>"send_message. topic = {}, message = {}".format(topic, message)<a id="change">)</a>
                pass

    def on_connect(self, client, userdata, flags, rc):
        &#47&#47 Callback connected listeners</code></pre><h3>After Change</h3><pre><code class='java'>
            except Exception as e:
                pass

        <a id="change">try:
            </a>sent<a id="change"> = </a>ret_info.is_published()
            return sent
        <a id="change">except </a>Exception as e:
            return False

    def on_connect(self, client, userdata, flags, rc):</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/fedml-ai/fedml/commit/cb0398c65f605b6c11c028b2b2c7f61e7357dc58#diff-793de5724862553149726e0bdf155ba373a53ac72b4fa9c2cd2afa289e1c81edL85' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 95817397</div><div id='project'> Project Name: fedml-ai/fedml</div><div id='commit'> Commit Name: cb0398c65f605b6c11c028b2b2c7f61e7357dc58</div><div id='time'> Time: 2022-12-11</div><div id='author'> Author: alex.gpt.llm@gmail.com</div><div id='file'> File Name: python/fedml/core/distributed/communication/mqtt/mqtt_manager.py</div><div id='m_class'> M Class Name: MqttManager</div><div id='n_method'> N Class Name: MqttManager</div><div id='m_method'> M Method Name: send_message_json(4)</div><div id='n_method'> N Method Name: send_message_json(4)</div><div id='m_parent_class'> M Parent Class: object</div><div id='n_parent_class'> N Parent Class: object</div><div id='m_file'> M File Name: python/fedml/core/distributed/communication/mqtt/mqtt_manager.py</div><div id='n_file'> N File Name: python/fedml/core/distributed/communication/mqtt/mqtt_manager.py</div><div id='m_start'> M Start Line: 88</div><div id='m_end'> M End Line: 96</div><div id='n_start'> N Start Line: 103</div><div id='n_end'> N End Line: 116</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
    
    if not dataset_name:
        raise ValueError("No dataset name provided.")
    <a id="change">try:
        logging.info(f"Trying to retrieve AzureML Dataset &quot{dataset_name}&quot"</a><a id="change">)</a>
        azureml_dataset = Dataset.get_by_name(workspace, name=dataset_name)
        <a id="change">logging.info(</a>"Dataset found."<a id="change">)</a>
    <a id="change">except </a>Exception:
        <a id="change">logging.info(f"Retrieving datastore &quot{datastore_name}&quot from AzureML workspace"</a><a id="change">)</a>
        datastore = get_datastore(workspace, datastore_name)
        logging.info(f"Creating a new dataset from data in folder &quot{dataset_name}&quot in the datastore")
        &#47&#47 Ensure that there is a / at the end of the file path, otherwise folder that share a prefix could create
        &#47&#47 trouble (for example, folders foo and foo_bar exist, and I&quotm trying to create a dataset from "foo")</code></pre><h3>After Change</h3><pre><code class='java'>
        aml_dataset = _get_or_create_v1_dataset(datastore_name, dataset_name, workspace)
        return aml_dataset
    else:
        <a id="change">try:
            </a>ml_client = get_ml_client(ml_client=ml_client)
            aml_dataset<a id="change"> = </a>_get_or_create_v2_dataset(datastore_name, dataset_name, ml_client)
        <a id="change">except </a>HttpResponseError as e:
            if "Cannot create v2 Data Version in v1 Data Container" in e.message:
                logging.info("This appears to be a v1 Data Container. Reverting to API v1 to create this Dataset")
            aml_dataset = _get_or_create_v1_dataset(datastore_name, dataset_name, workspace)</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/microsoft/hi-ml/commit/0b65bd42cf0637114021b72fcb3d50a0eb27ee58#diff-05c8833d240ea1622fc8c3911063e990667c8d5149d011611d63ea5c52ce3715L43' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 95817394</div><div id='project'> Project Name: microsoft/hi-ml</div><div id='commit'> Commit Name: 0b65bd42cf0637114021b72fcb3d50a0eb27ee58</div><div id='time'> Time: 2022-11-07</div><div id='author'> Author: 66642528+mebristo@users.noreply.github.com</div><div id='file'> File Name: hi-ml-azure/src/health_azure/datasets.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: get_or_create_dataset(5)</div><div id='n_method'> N Method Name: get_or_create_dataset(3)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: hi-ml-azure/src/health_azure/datasets.py</div><div id='n_file'> N File Name: hi-ml-azure/src/health_azure/datasets.py</div><div id='m_start'> M Start Line: 43</div><div id='m_end'> M End Line: 65</div><div id='n_start'> N Start Line: 194</div><div id='n_end'> N End Line: 232</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        mqtt_send_start_time = time.time()
        ret_info = self._client.publish(topic, payload=message)
        if wait_for_publish:
            <a id="change">try:
                logging.info("send_message. WAIT"</a><a id="change">)</a>
                ret_info.wait_for_publish(1)
                <a id="change">logging.info("send_message. END"</a><a id="change">)</a>
            <a id="change">except </a>Exception as e:
                <a id="change">logging.info(</a>"send_message. topic = {}, message = {}".format(topic, message)<a id="change">)</a>
                pass
        MLOpsProfilerEvent.log_to_wandb({"Comm/send_delay_mqtt": time.time() - mqtt_send_start_time})

    def send_message_json(self, topic, message, wait_for_publish=True):</code></pre><h3>After Change</h3><pre><code class='java'>
                pass
        MLOpsProfilerEvent.log_to_wandb({"Comm/send_delay_mqtt": time.time() - mqtt_send_start_time})

        <a id="change">try:
            </a>sent<a id="change"> = </a>ret_info.is_published()
            return sent
        <a id="change">except </a>Exception as e:
            return False

    def send_message_json(self, topic, message, wait_for_publish=True):</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/fedml-ai/fedml/commit/cb0398c65f605b6c11c028b2b2c7f61e7357dc58#diff-793de5724862553149726e0bdf155ba373a53ac72b4fa9c2cd2afa289e1c81edL72' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 95817390</div><div id='project'> Project Name: fedml-ai/fedml</div><div id='commit'> Commit Name: cb0398c65f605b6c11c028b2b2c7f61e7357dc58</div><div id='time'> Time: 2022-12-11</div><div id='author'> Author: alex.gpt.llm@gmail.com</div><div id='file'> File Name: python/fedml/core/distributed/communication/mqtt/mqtt_manager.py</div><div id='m_class'> M Class Name: MqttManager</div><div id='n_method'> N Class Name: MqttManager</div><div id='m_method'> M Method Name: send_message(4)</div><div id='n_method'> N Method Name: send_message(4)</div><div id='m_parent_class'> M Parent Class: object</div><div id='n_parent_class'> N Parent Class: object</div><div id='m_file'> M File Name: python/fedml/core/distributed/communication/mqtt/mqtt_manager.py</div><div id='n_file'> N File Name: python/fedml/core/distributed/communication/mqtt/mqtt_manager.py</div><div id='m_start'> M Start Line: 76</div><div id='m_end'> M End Line: 83</div><div id='n_start'> N Start Line: 88</div><div id='n_end'> N End Line: 102</div><BR>