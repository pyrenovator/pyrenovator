<html><h3>Pattern ID :30691
</h3><img src='90521061.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
        params = self.params
        param_to_key = {param: key for key, param in params.items()}

        ret_state = <a id="change">{
            param_to_key[param]: state_val for param, state_val in state.items()
        }</a>

        ret_groups = []
        for group in param_groups:
            param_keys = []</code></pre><h3>After Change</h3><pre><code class='java'>

        ret_state = {}
        for param, state_val in state.items():
            <a id="change">if </a><a id="change">isinstance(</a>state_val, dict<a id="change">)</a>:
                ret_state[param_to_key[param]]<a id="change"> = </a>{}
                <a id="change">for </a>k, v in state_val.items()<a id="change">:
                    </a><a id="change">if </a>hasattr(v, "state_dict") and callable(v.state_dict):
                        ret_state[param_to_key[param]][k]<a id="change"> = </a>v.state_dict()
                    else:
                        ret_state[param_to_key[param]][k] = v
            else:
                <a id="change">ret_state[param_to_key[param]]</a><a id="change"> = </a>state_val

        ret_groups = []
        for group in param_groups:</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 4</div><BR><div id='size'>Non-data size: 10</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/facebookresearch/torchrec/commit/00a35aca584e7e580f81e0e83711f4c6be82454b#diff-2d9cd2597cf063f8fbce2086a2b429c297a491df31e7283784e0bb1467de966eL82' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 90521061</div><div id='project'> Project Name: facebookresearch/torchrec</div><div id='commit'> Commit Name: 00a35aca584e7e580f81e0e83711f4c6be82454b</div><div id='time'> Time: 2022-12-06</div><div id='author'> Author: hjmshi@meta.com</div><div id='file'> File Name: torchrec/optim/keyed.py</div><div id='m_class'> M Class Name: KeyedOptimizer</div><div id='n_method'> N Class Name: KeyedOptimizer</div><div id='m_method'> M Method Name: state_dict(1)</div><div id='n_method'> N Method Name: state_dict(1)</div><div id='m_parent_class'> M Parent Class: optim.Optimizer</div><div id='n_parent_class'> N Parent Class: optim.Optimizer</div><div id='m_file'> M File Name: torchrec/optim/keyed.py</div><div id='n_file'> N File Name: torchrec/optim/keyed.py</div><div id='m_start'> M Start Line: 82</div><div id='m_end'> M End Line: 83</div><div id='n_start'> N Start Line: 83</div><div id='n_end'> N End Line: 97</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        params = self.params
        param_to_key = {param: key for key, param in params.items()}

        ret_state = <a id="change">{
            param_to_key[param]: state_val for param, state_val in state.items()
        }</a>

        ret_groups = []
        for group in param_groups:
            param_keys = []</code></pre><h3>After Change</h3><pre><code class='java'>
        params = self.params
        param_to_key = {param: key for key, param in params.items()}

        <a id="change">ret_state</a> = {}
        for param, state_val in state.items():
            <a id="change">if </a><a id="change">isinstance(</a>state_val, dict<a id="change">)</a>:
                ret_state[param_to_key[param]]<a id="change"> = </a>{}
                <a id="change">for </a>k, <a id="change">v</a> in state_val.items()<a id="change">:
                    </a><a id="change">if </a>hasattr(v, "state_dict") and callable(v.state_dict):
                        ret_state[param_to_key[param]][k]<a id="change"> = </a>v.state_dict()
                    else:
                        ret_state[param_to_key[param]][k] = v
            else:
                <a id="change">ret_state[param_to_key[param]]</a><a id="change"> = </a>state_val

        ret_groups = []
        for group in param_groups:</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/facebookresearch/torchrec/commit/00a35aca584e7e580f81e0e83711f4c6be82454b#diff-2d9cd2597cf063f8fbce2086a2b429c297a491df31e7283784e0bb1467de966eL69' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 90521063</div><div id='project'> Project Name: facebookresearch/torchrec</div><div id='commit'> Commit Name: 00a35aca584e7e580f81e0e83711f4c6be82454b</div><div id='time'> Time: 2022-12-06</div><div id='author'> Author: hjmshi@meta.com</div><div id='file'> File Name: torchrec/optim/keyed.py</div><div id='m_class'> M Class Name: KeyedOptimizer</div><div id='n_method'> N Class Name: KeyedOptimizer</div><div id='m_method'> M Method Name: state_dict(1)</div><div id='n_method'> N Method Name: state_dict(1)</div><div id='m_parent_class'> M Parent Class: optim.Optimizer</div><div id='n_parent_class'> N Parent Class: optim.Optimizer</div><div id='m_file'> M File Name: torchrec/optim/keyed.py</div><div id='n_file'> N File Name: torchrec/optim/keyed.py</div><div id='m_start'> M Start Line: 82</div><div id='m_end'> M End Line: 83</div><div id='n_start'> N Start Line: 83</div><div id='n_end'> N End Line: 97</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        else:
            device = torch.device("cpu")

    sharder_map: Dict[Type[nn.Module], ModuleSharder[nn.Module]] = <a id="change">{
        sharder.module_type: sharder for sharder in sharders
    }</a>
    assert (
        type(module) in sharder_map
    ), f"module is of type {type(module)} which is not in sharder_map {sharder_map}"
</code></pre><h3>After Change</h3><pre><code class='java'>

    &#47&#47 Run sharding generators.
    shardable_parameters = sharder.shardable_parameters(module)
    <a id="change">if </a><a id="change">isinstance(</a>plan, Callable<a id="change">)</a>:
        gen<a id="change"> = </a>plan
        <a id="change">plan</a> = {}
        for table_name, param in shardable_parameters.items():
            <a id="change">plan[table_name]</a><a id="change"> = </a>gen(
                param,
                get_local_size(env.world_size),
                env.world_size,
                device.type,
                sharder,
            )
    else:
        <a id="change">for </a>table_name, <a id="change">sharding</a> in plan.items()<a id="change">:
            </a><a id="change">if </a>isinstance(sharding, Callable):
                param = shardable_parameters[table_name]
                plan[table_name]<a id="change"> = </a>sharding(
                    param,
                    get_local_size(env.world_size),
                    env.world_size,</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/facebookresearch/torchrec/commit/fea86b1e691d7eb472b34eb8cd2c0ca805b28364#diff-45e18683634f2b914b42fcec6573a37cc0b972578839e9dd381c2d3c176bdebdL31' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 90521057</div><div id='project'> Project Name: facebookresearch/torchrec</div><div id='commit'> Commit Name: fea86b1e691d7eb472b34eb8cd2c0ca805b28364</div><div id='time'> Time: 2023-01-22</div><div id='author'> Author: divchenko@fireworks.ai</div><div id='file'> File Name: torchrec/distributed/shard.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: shard(5)</div><div id='n_method'> N Method Name: shard(5)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: torchrec/distributed/shard.py</div><div id='n_file'> N File Name: torchrec/distributed/shard.py</div><div id='m_start'> M Start Line: 33</div><div id='m_end'> M End Line: 82</div><div id='n_start'> N Start Line: 37</div><div id='n_end'> N End Line: 111</div><BR>