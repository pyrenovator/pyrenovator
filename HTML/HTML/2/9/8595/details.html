<html><h3>Pattern ID :8595
</h3><img src='29787631.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
    pred_keys = [result[&quotpred_key&quot] for result in results[0]]
    ret = []
    for i, pred_key in enumerate(pred_keys):
      metrics_list<a id="change"> = </a><a id="change">[result[i][&quotmetrics&quot] for result in results]</a>
      costs = [self.get_cost(metrics_for_threshold, config)
               for metrics_for_threshold in metrics_list]
      best_idx = np.argmin(costs)
      &#47&#47 Divide best index by 100 to get threshold value between 0 and 1.
      single_threshold<a id="change"> = </a>best_idx / 100
      faceted_thresholds = {}
      for facet_key in config.facets:
        faceted_thresholds[facet_key] = {</code></pre><h3>After Change</h3><pre><code class='java'>
          types.MulticlassPreds, field_spec).parent:
        pred_keys.append(pred_key)

    indexed_outputs = <a id="change">{
        ex[&quotid&quot]: output for (ex, output) in zip(indexed_inputs, model_outputs)
    }</a>

    &#47&#47 Try all margins for thresholds from 0 to 1, by hundreths.
    margins_to_try = [
        self.threshold_to_margin(t) for t in np.linspace(0, 1, 101)]</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 9</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/pair-code/lit/commit/c5289c07a1ba31719eb4b4ddaf1aa8a3793f6e73#diff-6cae70c3c1981641d1f1ddee87470ae8ef95a8d0d94a9ef6af454f4569c2557fL87' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 29787631</div><div id='project'> Project Name: pair-code/lit</div><div id='commit'> Commit Name: c5289c07a1ba31719eb4b4ddaf1aa8a3793f6e73</div><div id='time'> Time: 2021-08-19</div><div id='author'> Author: jwexler@google.com</div><div id='file'> File Name: lit_nlp/components/thresholder.py</div><div id='m_class'> M Class Name: Thresholder</div><div id='n_method'> N Class Name: Thresholder</div><div id='m_method'> M Method Name: run_with_metadata(6)</div><div id='n_method'> N Method Name: run_with_metadata(6)</div><div id='m_parent_class'> M Parent Class: lit_components.Interpreter</div><div id='n_parent_class'> N Parent Class: lit_components.Interpreter</div><div id='m_file'> M File Name: lit_nlp/components/thresholder.py</div><div id='n_file'> N File Name: lit_nlp/components/thresholder.py</div><div id='m_start'> M Start Line: 87</div><div id='m_end'> M End Line: 125</div><div id='n_start'> N Start Line: 186</div><div id='n_end'> N End Line: 238</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
    pred_keys = [result[&quotpred_key&quot] for result in results[0]]
    ret = []
    for i, pred_key in enumerate(pred_keys):
      metrics_list = <a id="change">[result[i][&quotmetrics&quot] for result in results]</a>
      costs<a id="change"> = </a>[self.get_cost(metrics_for_threshold, config)
               for metrics_for_threshold in metrics_list]
      best_idx<a id="change"> = </a>np.argmin(costs)
      &#47&#47 Divide best index by 100 to get threshold value between 0 and 1.
      single_threshold = best_idx / 100
      faceted_thresholds = {}</code></pre><h3>After Change</h3><pre><code class='java'>
          types.MulticlassPreds, field_spec).parent:
        pred_keys.append(pred_key)

    indexed_outputs = <a id="change">{
        ex[&quotid&quot]: output for (ex, output) in zip(indexed_inputs, model_outputs)
    }</a>

    &#47&#47 Try all margins for thresholds from 0 to 1, by hundreths.
    margins_to_try = [
        self.threshold_to_margin(t) for t in np.linspace(0, 1, 101)]</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/pair-code/lit/commit/c5289c07a1ba31719eb4b4ddaf1aa8a3793f6e73#diff-6cae70c3c1981641d1f1ddee87470ae8ef95a8d0d94a9ef6af454f4569c2557fL68' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 29787638</div><div id='project'> Project Name: pair-code/lit</div><div id='commit'> Commit Name: c5289c07a1ba31719eb4b4ddaf1aa8a3793f6e73</div><div id='time'> Time: 2021-08-19</div><div id='author'> Author: jwexler@google.com</div><div id='file'> File Name: lit_nlp/components/thresholder.py</div><div id='m_class'> M Class Name: Thresholder</div><div id='n_method'> N Class Name: Thresholder</div><div id='m_method'> M Method Name: run_with_metadata(6)</div><div id='n_method'> N Method Name: run_with_metadata(6)</div><div id='m_parent_class'> M Parent Class: lit_components.Interpreter</div><div id='n_parent_class'> N Parent Class: lit_components.Interpreter</div><div id='m_file'> M File Name: lit_nlp/components/thresholder.py</div><div id='n_file'> N File Name: lit_nlp/components/thresholder.py</div><div id='m_start'> M Start Line: 87</div><div id='m_end'> M End Line: 125</div><div id='n_start'> N Start Line: 186</div><div id='n_end'> N End Line: 238</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>

        if self.momentum_classifier is not None:
            &#47&#47 collect logits
            logits<a id="change"> = </a><a id="change">[out["logits"] for out in outs]</a>

            &#47&#47 momentum loss and stats
            loss = sum(out["loss"] for out in outs) / self.num_crops
            acc1 = sum(out["acc1"] for out in outs) / self.num_crops
            acc5 = sum(out["acc5"] for out in outs) / self.num_crops

            metrics = {
                "train_momentum_acc1": acc1,
                "train_momentum_acc5": acc5,
                "train_momentum_class_loss": loss,
            }
            self.log_dict(metrics, on_epoch=True, sync_dist=True)

            parent_outs["loss"] += loss
            parent_outs["logits_momentum"]<a id="change"> = </a>logits

        return parent_outs
</code></pre><h3>After Change</h3><pre><code class='java'>
        X = X[: self.num_crops]

        momentum_outs = [self._shared_step_momentum(x, targets) for x in X]
        momentum_outs = <a id="change">{
            "momentum_" + k: [out[k] for out in momentum_outs] for k in momentum_outs[0].keys()
        }</a>

        if self.momentum_classifier is not None:
            &#47&#47 momentum loss and stats
            momentum_outs["momentum_loss"] = sum(momentum_outs["momentum_loss"]) / self.num_crops</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/vturrisi/contrastive-learning/commit/12f8477aa7501dd146595f66b36b10a324bffeb0#diff-bf0f79abb0e767723150e5fe64a4a5935492d2fcf2eb222cfe5f8c901bcd11b0L573' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 29787639</div><div id='project'> Project Name: vturrisi/contrastive-learning</div><div id='commit'> Commit Name: 12f8477aa7501dd146595f66b36b10a324bffeb0</div><div id='time'> Time: 2021-08-16</div><div id='author'> Author: vt.turrisi@gmail.com</div><div id='file'> File Name: solo/methods/base.py</div><div id='m_class'> M Class Name: BaseMomentumModel</div><div id='n_method'> N Class Name: BaseMomentumModel</div><div id='m_method'> M Method Name: training_step(3)</div><div id='n_method'> N Method Name: training_step(3)</div><div id='m_parent_class'> M Parent Class: BaseModel</div><div id='n_parent_class'> N Parent Class: BaseModel</div><div id='m_file'> M File Name: solo/methods/base.py</div><div id='n_file'> N File Name: solo/methods/base.py</div><div id='m_start'> M Start Line: 588</div><div id='m_end'> M End Line: 620</div><div id='n_start'> N Start Line: 586</div><div id='n_end'> N End Line: 612</div><BR>