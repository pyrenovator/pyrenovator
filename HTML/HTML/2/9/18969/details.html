<html><h3>Pattern ID :18969
</h3><img src='61674239.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
            ipts_jac_trace_approx.append(torch.mean(torch.stack(trace_jv)))  &#47&#47 Get averaged jacobian trace approximation
        outputs_jacobians_approx.append(ipts_jac_trace_approx)  &#47&#47 Get mean of jacobians of all model&quots outputs

    <a id="change">return _normalize_weights(</a>torch.mean(torch.Tensor(outputs_jacobians_approx), dim=0), all_outputs_indices, alpha<a id="change">)</a>


def _normalize_weights(jacobians_traces: torch.Tensor,
                       all_outputs_indices: List[int],</code></pre><h3>After Change</h3><pre><code class='java'>
        outputs_jacobians_approx.append(ipts_jac_trace_approx)

    mean_per_point = torch.mean(torch.Tensor(outputs_jacobians_approx), dim=0)  &#47&#47 Get mean of jacobians of all model&quots outputs
    <a id="change">if norm_weights</a>:
        <a id="change">return </a><a id="change">_normalize_weights(mean_per_point</a>, all_outputs_indices, alpha<a id="change">)</a>
    else:
        <a id="change">return mean_per_point</a>


def _normalize_weights(jacobians_traces: torch.Tensor,
                       all_outputs_indices: List[int],</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 6</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/sony/model_optimization/commit/63ab7c6eb23382998914ee42eb4852d6ccf0eec6#diff-2dc34d537990012234ca8b55b9d0fe4e2d136aa77e177631c99ec2895763ee44L199' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 61674239</div><div id='project'> Project Name: sony/model_optimization</div><div id='commit'> Commit Name: 63ab7c6eb23382998914ee42eb4852d6ccf0eec6</div><div id='time'> Time: 2022-08-03</div><div id='author'> Author: ofirg6@gmail.com</div><div id='file'> File Name: model_compression_toolkit/core/pytorch/back2framework/model_gradients.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: pytorch_iterative_approx_jacobian_trace(8)</div><div id='n_method'> N Method Name: pytorch_iterative_approx_jacobian_trace(7)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: model_compression_toolkit/core/pytorch/back2framework/model_gradients.py</div><div id='n_file'> N File Name: model_compression_toolkit/core/pytorch/back2framework/model_gradients.py</div><div id='m_start'> M Start Line: 236</div><div id='m_end'> M End Line: 263</div><div id='n_start'> N Start Line: 199</div><div id='n_end'> N End Line: 271</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
                ipts_jac_trace_approx.append(tf.reduce_mean(trace_jv))  &#47&#47 Get averaged jacobian trace approximation
            outputs_jacobians_approx.append(ipts_jac_trace_approx)  &#47&#47 Get mean of jacobians of all model&quots outputs

        <a id="change">return _normalize_weights(</a>tf.reduce_mean(outputs_jacobians_approx, axis=0), all_outputs_indices, alpha<a id="change">)</a>


def _model_outputs_computation(graph_float: common.Graph,
                               model_input_tensors: Dict[BaseNode, np.ndarray],</code></pre><h3>After Change</h3><pre><code class='java'>
                ipts_jac_trace_approx.append(tf.sqrt(tf.reduce_mean(trace_jv)))  &#47&#47 Get averaged squared jacobian trace approximation
            outputs_jacobians_approx.append(ipts_jac_trace_approx)

        <a id="change">mean_per_point</a> = tf.reduce_mean(outputs_jacobians_approx, axis=0)  &#47&#47 Get mean of jacobian approx of all model outputs
        <a id="change">if norm_weights</a>:
            <a id="change">return </a><a id="change">_normalize_weights(</a>mean_per_point, all_outputs_indices, alpha<a id="change">)</a>
        else:
            <a id="change">return </a>mean_per_point


def _model_outputs_computation(graph_float: common.Graph,</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/sony/model_optimization/commit/63ab7c6eb23382998914ee42eb4852d6ccf0eec6#diff-231946b7c3045ac9a8fddbfd5cae4ef7e0e05a7a0a16aab8a4d561e522cce80fL97' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 61674238</div><div id='project'> Project Name: sony/model_optimization</div><div id='commit'> Commit Name: 63ab7c6eb23382998914ee42eb4852d6ccf0eec6</div><div id='time'> Time: 2022-08-03</div><div id='author'> Author: ofirg6@gmail.com</div><div id='file'> File Name: model_compression_toolkit/core/keras/back2framework/model_gradients.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: keras_iterative_approx_jacobian_trace(8)</div><div id='n_method'> N Method Name: keras_iterative_approx_jacobian_trace(7)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: model_compression_toolkit/core/keras/back2framework/model_gradients.py</div><div id='n_file'> N File Name: model_compression_toolkit/core/keras/back2framework/model_gradients.py</div><div id='m_start'> M Start Line: 134</div><div id='m_end'> M End Line: 155</div><div id='n_start'> N Start Line: 104</div><div id='n_end'> N End Line: 163</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>

        mean_per_point = tf.reduce_mean(outputs_jacobians_approx, axis=0)  &#47&#47 Get mean of jacobian approx of all model outputs
        if norm_weights:
            <a id="change">return _normalize_weights(</a>mean_per_point, all_outputs_indices, alpha<a id="change">)</a>
        else:
            return mean_per_point

</code></pre><h3>After Change</h3><pre><code class='java'>
                    trace_jv.append(jac_trace_approx)
            ipts_jac_trace_approx.append(2 * tf.reduce_mean(trace_jv) / output.shape[-1])  &#47&#47 Get averaged squared jacobian trace approximation

        <a id="change">ipts_jac_trace_approx</a> = tf.reduce_mean([ipts_jac_trace_approx], axis=0)  &#47&#47 Just to get one tensor instead of list of tensors with single element

        <a id="change">if norm_weights</a>:
            <a id="change">return </a><a id="change">_normalize_weights(</a>ipts_jac_trace_approx, all_outputs_indices, alpha<a id="change">)</a>
        else:
            <a id="change">return </a>ipts_jac_trace_approx


def _model_outputs_computation(graph_float: common.Graph,</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/sony/model_optimization/commit/8489a444227d29f03755d326a710095dabdce7fc#diff-231946b7c3045ac9a8fddbfd5cae4ef7e0e05a7a0a16aab8a4d561e522cce80fL100' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 61674240</div><div id='project'> Project Name: sony/model_optimization</div><div id='commit'> Commit Name: 8489a444227d29f03755d326a710095dabdce7fc</div><div id='time'> Time: 2023-01-04</div><div id='author'> Author: ofirg6@gmail.com</div><div id='file'> File Name: model_compression_toolkit/core/keras/back2framework/model_gradients.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: keras_iterative_approx_jacobian_trace(8)</div><div id='n_method'> N Method Name: keras_iterative_approx_jacobian_trace(8)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: model_compression_toolkit/core/keras/back2framework/model_gradients.py</div><div id='n_file'> N File Name: model_compression_toolkit/core/keras/back2framework/model_gradients.py</div><div id='m_start'> M Start Line: 139</div><div id='m_end'> M End Line: 174</div><div id='n_start'> N Start Line: 141</div><div id='n_end'> N End Line: 181</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
            ipts_jac_trace_approx.append(torch.mean(torch.stack(trace_jv)))  &#47&#47 Get averaged jacobian trace approximation
        outputs_jacobians_approx.append(ipts_jac_trace_approx)  &#47&#47 Get mean of jacobians of all model&quots outputs

    <a id="change">return _normalize_weights(</a>torch.mean(torch.Tensor(outputs_jacobians_approx), dim=0), all_outputs_indices, alpha<a id="change">)</a>


def _normalize_weights(jacobians_traces: torch.Tensor,
                       all_outputs_indices: List[int],</code></pre><h3>After Change</h3><pre><code class='java'>
            ipts_jac_trace_approx.append(torch.sqrt(torch.mean(torch.stack(trace_jv))))  &#47&#47 Get averaged jacobian trace approximation
        outputs_jacobians_approx.append(ipts_jac_trace_approx)

    <a id="change">mean_per_point</a> = torch.mean(torch.Tensor(outputs_jacobians_approx), dim=0)  &#47&#47 Get mean of jacobians of all model&quots outputs
    <a id="change">if norm_weights</a>:
        <a id="change">return </a><a id="change">_normalize_weights(</a>mean_per_point, all_outputs_indices, alpha<a id="change">)</a>
    else:
        <a id="change">return </a>mean_per_point


def _normalize_weights(jacobians_traces: torch.Tensor,</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/sony/model_optimization/commit/63ab7c6eb23382998914ee42eb4852d6ccf0eec6#diff-2dc34d537990012234ca8b55b9d0fe4e2d136aa77e177631c99ec2895763ee44L192' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 61674243</div><div id='project'> Project Name: sony/model_optimization</div><div id='commit'> Commit Name: 63ab7c6eb23382998914ee42eb4852d6ccf0eec6</div><div id='time'> Time: 2022-08-03</div><div id='author'> Author: ofirg6@gmail.com</div><div id='file'> File Name: model_compression_toolkit/core/pytorch/back2framework/model_gradients.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: pytorch_iterative_approx_jacobian_trace(8)</div><div id='n_method'> N Method Name: pytorch_iterative_approx_jacobian_trace(7)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: model_compression_toolkit/core/pytorch/back2framework/model_gradients.py</div><div id='n_file'> N File Name: model_compression_toolkit/core/pytorch/back2framework/model_gradients.py</div><div id='m_start'> M Start Line: 236</div><div id='m_end'> M End Line: 263</div><div id='n_start'> N Start Line: 199</div><div id='n_end'> N End Line: 271</div><BR>