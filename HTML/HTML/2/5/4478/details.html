<html><h3>Pattern ID :4478
</h3><img src='16333933.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
  outr = out.relu()
  outl = outr.logsoftmax()
  outm = outl.mul(m)
  outa<a id="change"> = </a>outm.add(m)
  outx = <a id="change">outa.sum()</a>
  <a id="change">outx.backward()</a>
  return outx.data, x.grad, W.grad

def test_pytorch():
  x = torch.tensor(x_init, requires_grad=True)</code></pre><h3>After Change</h3><pre><code class='java'>
  m = Tensor(m_init)
  out = x.dot(W).relu()
  out = out.logsoftmax()
  out = <a id="change">out.mul(m).add(m).sum()</a>
  <a id="change">out.backward()</a>
  return out.data, x.grad, W.grad

def test_pytorch():
  x = torch.tensor(x_init, requires_grad=True)</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 5</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/geohot/tinygrad/commit/2681c79bc56a42ab4ae67f4c8d04323b6943f266#diff-ae070fbd66c55f7bf108994c0a42ffe69eee7319b5bf0f47bef0fcdbd8b496b3L11' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 16333933</div><div id='project'> Project Name: geohot/tinygrad</div><div id='commit'> Commit Name: 2681c79bc56a42ab4ae67f4c8d04323b6943f266</div><div id='time'> Time: 2020-10-18</div><div id='author'> Author: geohot@gmail.com</div><div id='file'> File Name: test/test.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: test_tinygrad(0)</div><div id='n_method'> N Method Name: test_tinygrad(0)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: test/test.py</div><div id='n_file'> N File Name: test/test.py</div><div id='m_start'> M Start Line: 11</div><div id='m_end'> M End Line: 20</div><div id='n_start'> N Start Line: 11</div><div id='n_end'> N End Line: 17</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
            y = m(x)
            t[1] = time_synchronized()
            try:
                _ = <a id="change">y.sum().backward()</a>
                t[2] = time_synchronized()
            except:  &#47&#47 no backward method
                t[2] = float(&quotnan&quot)
            dtf += (t[1] - t[0]) * 1000 / n  &#47&#47 ms per op forward</code></pre><h3>After Change</h3><pre><code class='java'>

    results = []
    logging.basicConfig(format="%(message)s", level=logging.INFO)
    device<a id="change"> = </a>device or select_device()
    print(f"{&quotParams&quot:&gt;12s}{&quotGFLOPs&quot:&gt;12s}{&quotGPU_mem (GB)&quot:&gt;14s}{&quotforward (ms)&quot:&gt;14s}{&quotbackward (ms)&quot:&gt;14s}"
          f"{&quotinput&quot:&gt;24s}{&quotoutput&quot:&gt;24s}")

    for x in input if isinstance(input, list) else [input]:
        x = x.to(device)
        x.requires_grad = True
        for m in ops if isinstance(ops, list) else [ops]:
            m = m.to(device) if hasattr(m, &quotto&quot) else m  &#47&#47 device
            m = m.half() if hasattr(m, &quothalf&quot) and isinstance(x, torch.Tensor) and x.dtype is torch.float16 else m
            tf, tb, t = 0., 0., [0., 0., 0.]  &#47&#47 dt forward, backward
            try:
                flops = thop.profile(m, inputs=(x,), verbose=False)[0] / 1E9 * 2  &#47&#47 GFLOPs
            except:
                flops = 0

            try:
                for _ in range(n):
                    t[0] = time_sync()
                    y = m(x)
                    t[1] = time_sync()
                    try:
                        _ = <a id="change">(sum([yi.sum() for yi in y]) if isinstance(y, list) else y).sum().backward()</a>
                        t[2] = time_sync()
                    except Exception as e:  &#47&#47 no backward method
                        print(e)
                        t[2] = float(&quotnan&quot)</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/fcakyon/yolov5-pip/commit/5324365eacdf6cd58cfc37cc133bbc344f1922be#diff-a48815b08733f1fa35d79a8996296f380a25f82d4612e89bd45db6601b991df4L98' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 16333936</div><div id='project'> Project Name: fcakyon/yolov5-pip</div><div id='commit'> Commit Name: 5324365eacdf6cd58cfc37cc133bbc344f1922be</div><div id='time'> Time: 2021-08-24</div><div id='author'> Author: 34196005+fcakyon@users.noreply.github.com</div><div id='file'> File Name: yolov5/utils/torch_utils.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: profile(4)</div><div id='n_method'> N Method Name: profile(4)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: yolov5/utils/torch_utils.py</div><div id='n_file'> N File Name: yolov5/utils/torch_utils.py</div><div id='m_start'> M Start Line: 105</div><div id='m_end'> M End Line: 136</div><div id='n_start'> N Start Line: 112</div><div id='n_end'> N End Line: 153</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
  W = torch.tensor(W_init, requires_grad=True)
  m = torch.tensor(m_init)
  out = x.matmul(W)
  outr<a id="change"> = </a>out.relu()
  outl = torch.nn.functional.log_softmax(outr, dim=1)
  outm = outl.mul(m)
  outa = outm.add(m)
  outx = <a id="change">outa.sum()</a>
  <a id="change">outx.backward()</a>
  return outx.detach().numpy(), x.grad, W.grad

for x,y in zip(test_tinygrad(), test_pytorch()):
  print(x,y)</code></pre><h3>After Change</h3><pre><code class='java'>
  m = torch.tensor(m_init)
  out = x.matmul(W).relu()
  out = torch.nn.functional.log_softmax(out, dim=1)
  out = <a id="change">out.mul(m).add(m).sum()</a>
  <a id="change">out.backward()</a>
  return out.detach().numpy(), x.grad, W.grad

for x,y in zip(test_tinygrad(), test_pytorch()):
  print(x,y)</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/geohot/tinygrad/commit/2681c79bc56a42ab4ae67f4c8d04323b6943f266#diff-ae070fbd66c55f7bf108994c0a42ffe69eee7319b5bf0f47bef0fcdbd8b496b3L22' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 16333939</div><div id='project'> Project Name: geohot/tinygrad</div><div id='commit'> Commit Name: 2681c79bc56a42ab4ae67f4c8d04323b6943f266</div><div id='time'> Time: 2020-10-18</div><div id='author'> Author: geohot@gmail.com</div><div id='file'> File Name: test/test.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: test_pytorch(0)</div><div id='n_method'> N Method Name: test_pytorch(0)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: test/test.py</div><div id='n_file'> N File Name: test/test.py</div><div id='m_start'> M Start Line: 24</div><div id='m_end'> M End Line: 33</div><div id='n_start'> N Start Line: 21</div><div id='n_end'> N End Line: 27</div><BR>