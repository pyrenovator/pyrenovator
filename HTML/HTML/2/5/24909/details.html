<html><h3>Pattern ID :24909
</h3><img src='76735314.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
        sr.generate()
        pred_score = sr.load()

    y_test<a id="change"> = </a><a id="change">dataset.prepare("test"</a><a id="change">, col_set="label")</a>
    pred_score<a id="change">, y_test, __ = </a>drop_nan_by_y_index(pred_score, y_test)
    model_pearsonr = pearsonr(np.ravel(pred_score.values), np.ravel(y_test.values))[0]

    return pred_score, {"model_pearsonr": model_pearsonr}, rid</code></pre><h3>After Change</h3><pre><code class='java'>
        ic = sar.load(sar.get_path("ic.pkl"))
        ric = sar.load(sar.get_path("ric.pkl"))

    return pred_score<a id="change">, {"ic": ic, "ric": ric}, rid</a>


def backtest_analysis(pred, rid):
    backtest and analysis</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 4</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/microsoft/qlib/commit/89586562226b1f3aaf4b38ef283af92ffe105e71#diff-e85369ca90d47fb4376b973050e0f2bd66cca8aa16ab93949415c3af58b2a288L112' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 76735314</div><div id='project'> Project Name: microsoft/qlib</div><div id='commit'> Commit Name: 89586562226b1f3aaf4b38ef283af92ffe105e71</div><div id='time'> Time: 2020-11-21</div><div id='author'> Author: dw1920@nyu.edu</div><div id='file'> File Name: tests/test_all_pipeline.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: train(0)</div><div id='n_method'> N Method Name: train(0)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: tests/test_all_pipeline.py</div><div id='n_file'> N File Name: tests/test_all_pipeline.py</div><div id='m_start'> M Start Line: 112</div><div id='m_end'> M End Line: 130</div><div id='n_start'> N Start Line: 119</div><div id='n_end'> N End Line: 131</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        save_path=None,
    ):

        dl_train<a id="change"> = </a><a id="change">dataset.prepare("train"</a><a id="change">, col_set=["feature", "label"], data_key=DataHandlerLP.DK_L)</a>
        dl_valid = dataset.prepare("valid", col_set=["feature", "label"], data_key=DataHandlerLP.DK_L)

        dl_train.config(fillna_type="ffill+bfill")  &#47&#47 process nan brought by dataloader
        dl_valid.config(fillna_type="ffill+bfill")  &#47&#47 process nan brought by dataloader

        train_loader<a id="change"> = </a>DataLoader(
            dl_train, batch_size=self.batch_size, shuffle=True, num_workers=self.n_jobs, drop_last=True
        )
        valid_loader = DataLoader(</code></pre><h3>After Change</h3><pre><code class='java'>
        save_path=None,
    ):

        df_train<a id="change">, df_valid, df_test</a> = dataset.prepare(
            ["train", "valid", "test"],
            col_set=["feature", "label"],
            data_key=DataHandlerLP.DK_L,</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/microsoft/qlib/commit/bee031af68cd0864c8329de13608c2d4feb58fc1#diff-fe0bd624f58dd8fe7dd95d97a1d8ef4de2800a5a92cb439e19aee34c6628b9bfL147' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 76735312</div><div id='project'> Project Name: microsoft/qlib</div><div id='commit'> Commit Name: bee031af68cd0864c8329de13608c2d4feb58fc1</div><div id='time'> Time: 2021-07-21</div><div id='author'> Author: yl3851@uw.edu</div><div id='file'> File Name: qlib/contrib/model/pytorch_localformer.py</div><div id='m_class'> M Class Name: LocalformerModel</div><div id='n_method'> N Class Name: LocalformerModel</div><div id='m_method'> M Method Name: fit(4)</div><div id='n_method'> N Method Name: fit(4)</div><div id='m_parent_class'> M Parent Class: Model</div><div id='n_parent_class'> N Parent Class: Model</div><div id='m_file'> M File Name: qlib/contrib/model/pytorch_localformer.py</div><div id='n_file'> N File Name: qlib/contrib/model/pytorch_localformer.py</div><div id='m_start'> M Start Line: 154</div><div id='m_end'> M End Line: 165</div><div id='n_start'> N Start Line: 173</div><div id='n_end'> N End Line: 200</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        save_path=None,
    ):

        dl_train<a id="change"> = </a><a id="change">dataset.prepare("train"</a><a id="change">, col_set=["feature", "label"], data_key=DataHandlerLP.DK_L)</a>
        dl_valid = dataset.prepare("valid", col_set=["feature", "label"], data_key=DataHandlerLP.DK_L)

        dl_train.config(fillna_type="ffill+bfill")  &#47&#47 process nan brought by dataloader
        dl_valid.config(fillna_type="ffill+bfill")  &#47&#47 process nan brought by dataloader

        train_loader<a id="change"> = </a>DataLoader(
            dl_train, batch_size=self.batch_size, shuffle=True, num_workers=self.n_jobs, drop_last=True
        )
        valid_loader = DataLoader(</code></pre><h3>After Change</h3><pre><code class='java'>
            data_key=DataHandlerLP.DK_L,
        )

        x_train<a id="change">, y_train</a> = df_train["feature"], df_train["label"]
        x_valid, y_valid = df_valid["feature"], df_valid["label"]

        save_path = get_or_create_path(save_path)</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/microsoft/qlib/commit/bee031af68cd0864c8329de13608c2d4feb58fc1#diff-82a48ba3edeb02bda1232a9cf7a21b13b2ab82fa992719af2e4494d6fe969887L144' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 76735322</div><div id='project'> Project Name: microsoft/qlib</div><div id='commit'> Commit Name: bee031af68cd0864c8329de13608c2d4feb58fc1</div><div id='time'> Time: 2021-07-21</div><div id='author'> Author: yl3851@uw.edu</div><div id='file'> File Name: qlib/contrib/model/pytorch_transformer.py</div><div id='m_class'> M Class Name: TransformerModel</div><div id='n_method'> N Class Name: TransformerModel</div><div id='m_method'> M Method Name: fit(4)</div><div id='n_method'> N Method Name: fit(4)</div><div id='m_parent_class'> M Parent Class: Model</div><div id='n_parent_class'> N Parent Class: Model</div><div id='m_file'> M File Name: qlib/contrib/model/pytorch_transformer.py</div><div id='n_file'> N File Name: qlib/contrib/model/pytorch_transformer.py</div><div id='m_start'> M Start Line: 151</div><div id='m_end'> M End Line: 162</div><div id='n_start'> N Start Line: 172</div><div id='n_end'> N End Line: 199</div><BR>