<link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
        * `x` is the Tensor at the head of a key or a query with shape `[seq_len, batch_size, n_heads, d]`
        
        &#47&#47 Extract the shape
        seq_len<a id="change">, batch_size, n_heads, d</a> = x.shape

        &#47&#47 $\frac{d}{2}$
        d_2 = d // 2</code></pre><h3>After Change</h3><pre><code class='java'>
        &#47&#47 \end{align}
        &#47&#47
        &#47&#47 for $i \in {1, 2, ..., \frac{d}{2}}$
        x_rope = (x_rope * self.cos_cached[<a id="change">:x.shape[0]</a>]) + (neg_half_x * self.sin_cached[:x.shape[0]])

        &#47&#47
        <a id="change">return </a>torch.cat((x_rope, x_pass), dim=-1)


class RotaryPEMultiHeadAttention(MultiHeadAttention):</code></pre>