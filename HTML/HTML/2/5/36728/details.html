<html><h3>Pattern ID :36728
</h3><img src='104820607.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
        self.encoder.load_state_dict(torch.load(encoder_path))
        for i, popart in enumerate(self.popart):
            if popart:
                popart_path = <a id="change">os.path.join(path</a>, <a id="change">"popart{i}.pt"</a><a id="change">)</a>
                popart.load_state_dict(torch.load(popart_path))
        for i, critic in enumerate(self.critics):
            critic_path = os.path.join(path, f"critic{i}.pt")
            critic.load_state_dict(torch.load(critic_path))
        for i, actor in enumerate(self.actors):
            actor_path = <a id="change">os.path.join(path</a>, f"actor{i}.pt"<a id="change">)</a>
            actor.load_state_dict(torch.load(actor_path))

    def discrete_forward(self, obs, from_cpu=True, num_envs=1):
        if from_cpu:</code></pre><h3>After Change</h3><pre><code class='java'>
            critic.load_state_dict(_load(f"critic{i}.pt"))
        for i, actor in enumerate(self.actors):
            actor.load_state_dict(_load(f"actor{i}.pt"))
        <a id="change">self.inverse_model.load_state_dict(</a>_load("inverse.pt")<a id="change">)</a>
        self.contrastive_model.load_state_dict(_load("contrastive.pt"))

    def discrete_forward(self, obs, from_cpu=True, num_envs=1):
        if from_cpu:</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 3</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/jakegrigsby/super_sac/commit/2925467bae79b5fcd67a4992e9b81ce51e390bfa#diff-271251aea3a24b98abf3fef4342551fd0a04db7fbd885642c6134e07f4f10529L175' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 104820607</div><div id='project'> Project Name: jakegrigsby/super_sac</div><div id='commit'> Commit Name: 2925467bae79b5fcd67a4992e9b81ce51e390bfa</div><div id='time'> Time: 2022-01-02</div><div id='author'> Author: jcg6dn@virginia.edu</div><div id='file'> File Name: super_sac/agent.py</div><div id='m_class'> M Class Name: Agent</div><div id='n_method'> N Class Name: Agent</div><div id='m_method'> M Method Name: load(2)</div><div id='n_method'> N Method Name: load(2)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: super_sac/agent.py</div><div id='n_file'> N File Name: super_sac/agent.py</div><div id='m_start'> M Start Line: 175</div><div id='m_end'> M End Line: 186</div><div id='n_start'> N Start Line: 191</div><div id='n_end'> N End Line: 202</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
            torch.save(actor.state_dict(), actor_path)

    def load(self, path):
        encoder_path = <a id="change">os.path.join(</a>path, "encoder.pt"<a id="change">)</a>
        self.encoder.load_state_dict(torch.load(encoder_path))
        for i, popart in enumerate(self.popart):
            if popart:
                popart_path = <a id="change">os.path.join(</a>path, <a id="change">"popart{i}.pt"</a><a id="change">)</a>
                popart.load_state_dict(torch.load(popart_path))
        for i, critic in enumerate(self.critics):
            critic_path = os.path.join(path, f"critic{i}.pt")
            critic.load_state_dict(torch.load(critic_path))</code></pre><h3>After Change</h3><pre><code class='java'>
            critic.load_state_dict(_load(f"critic{i}.pt"))
        for i, actor in enumerate(self.actors):
            actor.load_state_dict(_load(f"actor{i}.pt"))
        <a id="change">self.inverse_model.load_state_dict(</a>_load("inverse.pt")<a id="change">)</a>
        self.contrastive_model.load_state_dict(_load("contrastive.pt"))

    def discrete_forward(self, obs, from_cpu=True, num_envs=1):
        if from_cpu:</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/jakegrigsby/super_sac/commit/2925467bae79b5fcd67a4992e9b81ce51e390bfa#diff-271251aea3a24b98abf3fef4342551fd0a04db7fbd885642c6134e07f4f10529L174' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 104820606</div><div id='project'> Project Name: jakegrigsby/super_sac</div><div id='commit'> Commit Name: 2925467bae79b5fcd67a4992e9b81ce51e390bfa</div><div id='time'> Time: 2022-01-02</div><div id='author'> Author: jcg6dn@virginia.edu</div><div id='file'> File Name: super_sac/agent.py</div><div id='m_class'> M Class Name: Agent</div><div id='n_method'> N Class Name: Agent</div><div id='m_method'> M Method Name: load(2)</div><div id='n_method'> N Method Name: load(2)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: super_sac/agent.py</div><div id='n_file'> N File Name: super_sac/agent.py</div><div id='m_start'> M Start Line: 175</div><div id='m_end'> M End Line: 186</div><div id='n_start'> N Start Line: 191</div><div id='n_end'> N End Line: 202</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
    logger.info(f"truth: {truth}")

    &#47&#47 Run management
    <a id="change">archive</a> = "/groups/icecube/asogaard/gnn/results/upgrade_nmo_sensitivity/"
    run_name = "{}_regression".format(config["target"])

    &#47&#47 Log configuration to W&B
    wandb_logger.experiment.config.update(config)

    &#47&#47 Common variables
    with sqlite3.connect(config["db"]) as conn:
        inclusive_selection = pd.read_sql_query(
            "SELECT event_no FROM truth", conn
        ).values.ravel()

    training_selection = list(
        filter(lambda event_no: event_no % 5 &gt; 0, inclusive_selection)
    )
    testing_selection = list(
        filter(lambda event_no: event_no % 5 == 0, inclusive_selection)
    )

    dataloader_opts = dict(
        db=config["db"],
        pulsemaps=config["pulsemaps"],
        features=features,
        truth=truth,
        batch_size=config["batch_size"],
        num_workers=config["num_workers"],
    )

    training_dataloader = make_dataloader(
        shuffle=True,
        selection=training_selection,
        **dataloader_opts,
    )
    testing_dataloader = make_dataloader(
        shuffle=False,
        selection=testing_selection,
        **dataloader_opts,
    )

    &#47&#47 Export Run IDs / Sub-run IDs / Event IDs for the validation dataset as a CSV-file.
    export_ids(
        training_dataloader,
        testing_dataloader,
        os.path.join(archive, run_name),
    )

    &#47&#47 Building model
    detector = IceCubeUpgrade(
        graph_builder=KNNGraphBuilder(nb_nearest_neighbours=8),
    )
    gnn = DynEdge_V2(
        nb_inputs=detector.nb_outputs,
        layer_size_scale=config["gnn/size_scale"],
    )

    if config["target"] == "zenith":
        task = ZenithReconstructionWithKappa(
            hidden_size=gnn.nb_outputs,
            target_labels=config["target"],
            loss_function=VonMisesFisher2DLoss(),
        )
    elif config["target"] in ["energy", "energy_track"]:
        task = EnergyReconstruction(
            hidden_size=gnn.nb_outputs,
            target_labels=config["target"],
            loss_function=LogCoshLoss(),
            transform_prediction_and_target=lambda p: torch.log10(p + 1),
        )
    else:
        task = InelasticityReconstruction(
            hidden_size=gnn.nb_outputs,
            target_labels=config["target"],
            loss_function=MSELoss(),
        )

    model = Model(
        detector=detector,
        gnn=gnn,
        tasks=[task],
        optimizer_class=Adam,
        optimizer_kwargs={"lr": 1e-03, "eps": 1e-03},
        scheduler_class=PiecewiseLinearLR,
        scheduler_kwargs={
            "milestones": [
                0,
                len(training_dataloader) / 2,
                len(training_dataloader) * config["n_epochs"],
            ],
            "factors": [1e-2, 1, 1e-02],
        },
        scheduler_config={
            "interval": "step",
        },
    )

    &#47&#47 Training model
    callbacks = [
        EarlyStopping(
            monitor="val_loss",
            patience=config["patience"],
        ),
        ProgressBar(),
    ]

    trainer = Trainer(
        default_root_dir=archive,
        gpus=config["gpus"],
        max_epochs=config["n_epochs"],
        callbacks=callbacks,
        log_every_n_steps=1,
        logger=wandb_logger,
    )

    try:
        trainer.fit(model, training_dataloader, testing_dataloader)
    except KeyboardInterrupt:
        logger.warning("[ctrl+c] Exiting gracefully.")
        pass

    &#47&#47 Saving model
    model.save(<a id="change">os.path.join(</a>archive, <a id="change">f"{run_name}.pth"</a><a id="change">)</a>)
    model.save_state_dict(<a id="change">os.path.join(</a>archive, f"{run_name}_state_dict.pth"<a id="change">)</a>)

    &#47&#47 Saving predictions to file
    if target == "zenith":</code></pre><h3>After Change</h3><pre><code class='java'>
    &#47&#47 Resetting model (to avoid saving Trainer, DataLoader, etc.)
    model.save_state_dict("state_dict.pth")
    model = model_factory()
    <a id="change">model.load_state_dict(</a>"state_dict.pth"<a id="change">)</a>

    save_results(config["db"], run_name, results, archive, model)

</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/icecube/graphnet/commit/be16a08a0268cf890b979d3aaffa9391c3a18877#diff-b3d98a7242977adf04d40b280bbf1c9b0964b9b65b2f0f5a04d395e44f5460b0L101' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 104820598</div><div id='project'> Project Name: icecube/graphnet</div><div id='commit'> Commit Name: be16a08a0268cf890b979d3aaffa9391c3a18877</div><div id='time'> Time: 2022-06-17</div><div id='author'> Author: andreas.sogaard@gmail.com</div><div id='file'> File Name: studies/upgrade_nmo_sensitivity/modelling/train_model.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: main(1)</div><div id='n_method'> N Method Name: main(1)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: studies/upgrade_nmo_sensitivity/modelling/train_model.py</div><div id='n_file'> N File Name: studies/upgrade_nmo_sensitivity/modelling/train_model.py</div><div id='m_start'> M Start Line: 133</div><div id='m_end'> M End Line: 254</div><div id='n_start'> N Start Line: 231</div><div id='n_end'> N End Line: 287</div><BR>