<html><h3>Pattern ID :42223
</h3><img src='118795093.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
        try:
            pea_args_idx = 0
            for i in range(len(self.peas)):
                pea<a id="change"> = </a>self.peas[i]
                <a id="change">if pea.role == PeaRoleType.PARALLEL</a>:
                    pea.close()
                    _args = self.peas_args[&quotpeas&quot][pea_args_idx]
                    _args.noblock_on_start = True
                    &#47&#47&#47&#47&#47&#47 BACKWARDS COMPATIBILITY, so THAT DUMP_PATH is in runtime_args
                    _args.dump_path = dump_path
                    &#47&#47&#47&#47&#47&#47
                    _args.uses_with = uses_with
                    new_pea = BasePea(_args)
                    self.enter_context(new_pea)
                    await new_pea.async_wait_start_success()
                    new_pea.activate_runtime()
                    self.peas[i]<a id="change"> = </a>new_pea
                    pea_args_idx += 1
        except:
            raise</code></pre><h3>After Change</h3><pre><code class='java'>
            else:
                uses_with = {&quotdump_path&quot: dump_path}
        try:
            <a id="change">await </a>self.replica_set.rolling_update(
                dump_path=dump_path, uses_with=uses_with
            )
        except:</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 5</div><BR><div id='size'>Non-data size: 5</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/jina-ai/jina/commit/d7f57cd1b3ef4a56517dfae3d99d39ba16cd5d43#diff-835bc1cd3c6f383278831a1eae34edcb26abb646fe00e719bbdb28614271c267L584' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 118795093</div><div id='project'> Project Name: jina-ai/jina</div><div id='commit'> Commit Name: d7f57cd1b3ef4a56517dfae3d99d39ba16cd5d43</div><div id='time'> Time: 2021-10-21</div><div id='author'> Author: joan.martinez@jina.ai</div><div id='file'> File Name: jina/peapods/pods/__init__.py</div><div id='m_class'> M Class Name: Pod</div><div id='n_method'> N Class Name: Pod</div><div id='m_method'> M Method Name: rolling_update(2)</div><div id='n_method'> N Method Name: rolling_update(2)</div><div id='m_parent_class'> M Parent Class: BasePod</div><div id='n_parent_class'> N Parent Class: BasePod</div><div id='m_file'> M File Name: jina/peapods/pods/__init__.py</div><div id='n_file'> N File Name: jina/peapods/pods/__init__.py</div><div id='m_start'> M Start Line: 584</div><div id='m_end'> M End Line: 601</div><div id='n_start'> N Start Line: 645</div><div id='n_end'> N End Line: 647</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>

        from jina.helper import extend_rest_interface

        uvicorn_kwargs<a id="change"> = </a>self.args.uvicorn_kwargs or {}

        for ssl_file in [&quotssl_keyfile&quot, &quotssl_certfile&quot]:
            if getattr(self.args, ssl_file):
                <a id="change">if ssl_file not in uvicorn_kwargs.keys()</a>:
                    uvicorn_kwargs[ssl_file]<a id="change"> = </a>getattr(self.args, ssl_file)

        self._server = UviServer(
            config=Config(</code></pre><h3>After Change</h3><pre><code class='java'>
            metrics_registry=self.metrics_registry,
            runtime_name=self.args.name,
        )
        <a id="change">await </a>self.gateway.setup_server()

    async def _wait_for_cancel(self):
        Do NOT override this method when inheriting from :class:`GatewayPod`</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/jina-ai/jina/commit/243639dd2b953fab8654747cbfdf6a0953b95578#diff-410c00baa1f1b433c783f22870944c8c01d2b11fea67e8174f1cccb123b71601L16' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 118795027</div><div id='project'> Project Name: jina-ai/jina</div><div id='commit'> Commit Name: 243639dd2b953fab8654747cbfdf6a0953b95578</div><div id='time'> Time: 2022-09-19</div><div id='author'> Author: alaeddine-13@live.fr</div><div id='file'> File Name: jina/serve/runtimes/gateway/http/__init__.py</div><div id='m_class'> M Class Name: HTTPGatewayRuntime</div><div id='n_method'> N Class Name: HTTPGatewayRuntime</div><div id='m_method'> M Method Name: async_setup(1)</div><div id='n_method'> N Method Name: async_setup(1)</div><div id='m_parent_class'> M Parent Class: GatewayRuntime</div><div id='n_parent_class'> N Parent Class: GatewayRuntime</div><div id='m_file'> M File Name: jina/serve/runtimes/gateway/http/__init__.py</div><div id='n_file'> N File Name: jina/serve/runtimes/gateway/http/__init__.py</div><div id='m_start'> M Start Line: 22</div><div id='m_end'> M End Line: 86</div><div id='n_start'> N Start Line: 22</div><div id='n_end'> N End Line: 43</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>

        from jina.helper import extend_rest_interface

        uvicorn_kwargs<a id="change"> = </a>self.args.uvicorn_kwargs or {}
        for ssl_file in [&quotssl_keyfile&quot, &quotssl_certfile&quot]:
            if getattr(self.args, ssl_file):
                <a id="change">if ssl_file not in uvicorn_kwargs.keys()</a>:
                    uvicorn_kwargs[ssl_file]<a id="change"> = </a>getattr(self.args, ssl_file)

        self._server = UviServer(
            config=Config(</code></pre><h3>After Change</h3><pre><code class='java'>
            metrics_registry=self.metrics_registry,
            runtime_name=self.args.name,
        )
        <a id="change">await </a>self.gateway.setup_server()

    async def _wait_for_cancel(self):
        Do NOT override this method when inheriting from :class:`GatewayPod`</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/jina-ai/jina/commit/243639dd2b953fab8654747cbfdf6a0953b95578#diff-e6d0367084667001dfbb860f2fa1a8ead7d4a5149fa61e1bcd1ebef114f94175L16' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 118795071</div><div id='project'> Project Name: jina-ai/jina</div><div id='commit'> Commit Name: 243639dd2b953fab8654747cbfdf6a0953b95578</div><div id='time'> Time: 2022-09-19</div><div id='author'> Author: alaeddine-13@live.fr</div><div id='file'> File Name: jina/serve/runtimes/gateway/websocket/__init__.py</div><div id='m_class'> M Class Name: WebSocketGatewayRuntime</div><div id='n_method'> N Class Name: WebSocketGatewayRuntime</div><div id='m_method'> M Method Name: async_setup(1)</div><div id='n_method'> N Method Name: async_setup(1)</div><div id='m_parent_class'> M Parent Class: GatewayRuntime</div><div id='n_parent_class'> N Parent Class: GatewayRuntime</div><div id='m_file'> M File Name: jina/serve/runtimes/gateway/websocket/__init__.py</div><div id='n_file'> N File Name: jina/serve/runtimes/gateway/websocket/__init__.py</div><div id='m_start'> M Start Line: 22</div><div id='m_end'> M End Line: 86</div><div id='n_start'> N Start Line: 21</div><div id='n_end'> N End Line: 36</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        
        assert os.getpid() != self.runtime_pid, "must be called by a ConnectionHandler, not runtime"
        assert descr.device is None and descr
        allocated_handle<a id="change"> = </a>None
        allocated_size_bytes = descr.numel() * torch.finfo(descr.dtype).bits // 8
        loop = asyncio.get_event_loop()
        try:
            async with hivemind.utils.enter_asynchronously(self._lock_acquire_memory):
                if self.current_size_bytes + allocated_size_bytes &gt; self.max_size_bytes:
                    await loop.run_in_executor(
                        None, self._wait_until_available, allocated_size_bytes, self.alloc_timeout
                    )
                async with hivemind.utils.enter_asynchronously(self._lock_metadata):
                    allocated_handle = int(self.handle_counter)
                    self.current_size_bytes += allocated_size_bytes
                    self.handle_counter += 1  &#47&#47 note: this will eventually overflow and it is okay
                    self._pipe_send.send((allocated_handle, descr))

            yield allocated_handle
        finally:
            <a id="change">if allocated_handle is not None</a>:
                async with hivemind.utils.enter_asynchronously(self._lock_metadata):
                    self._pipe_send.send((allocated_handle, None))  &#47&#47 signal runtime to free that handle
                    self.current_size_bytes<a id="change"> -= </a>allocated_size_bytes
                self._memory_freed_event.set()

    def _wait_until_available(self, allocated_size: int, timeout: Optional[float] = None):</code></pre><h3>After Change</h3><pre><code class='java'>
        alloc_size = descr.numel() * torch.finfo(descr.dtype).bits // 8
        alloc_task = asyncio.create_task(self._schedule_alloc(alloc_size, descr))
        try:
            yield <a id="change">await </a>shield_and_wait(alloc_task)
        finally:
            await shield_and_wait(self._schedule_free(alloc_size, alloc_task))
</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/bigscience-workshop/distributed-bloom/commit/9997ada3bbeacfa2264f8df1f13f4d1d783f48e5#diff-0d326cb7311bb84956f9689fd7806b921f38e66a1da74458c857ac9db2b6c55cL58' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 118795064</div><div id='project'> Project Name: bigscience-workshop/distributed-bloom</div><div id='commit'> Commit Name: 9997ada3bbeacfa2264f8df1f13f4d1d783f48e5</div><div id='time'> Time: 2022-12-22</div><div id='author'> Author: borzunov.alexander@gmail.com</div><div id='file'> File Name: src/petals/server/memory_cache.py</div><div id='m_class'> M Class Name: MemoryCache</div><div id='n_method'> N Class Name: MemoryCache</div><div id='m_method'> M Method Name: allocate_cache(2)</div><div id='n_method'> N Method Name: allocate_cache(2)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: src/petals/server/memory_cache.py</div><div id='n_file'> N File Name: src/petals/server/memory_cache.py</div><div id='m_start'> M Start Line: 69</div><div id='m_end'> M End Line: 92</div><div id='n_start'> N Start Line: 72</div><div id='n_end'> N End Line: 79</div><BR>