<html><h3>Pattern ID :16355
</h3><img src='55175673.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
    &#47&#47 Compare the set of files in the magic folder with the outputs stored in the run context of the parent run
    azureml_parent_folder = expected / REGRESSION_TEST_AZUREML_PARENT_FOLDER
    if azureml_parent_folder.is_dir():
        <a id="change">if </a>PARENT_RUN_CONTEXT is None:
            <a id="change">raise </a>ValueError(f"The set of expected test results in {expected} contains a folder "
                             f"{REGRESSION_TEST_AZUREML_PARENT_FOLDER}, but the present run is not a cross-validation "
                             "child run")
        compare_folder_contents(azureml_parent_folder, run=PARENT_RUN_CONTEXT)</code></pre><h3>After Change</h3><pre><code class='java'>
             (REGRESSION_TEST_AZUREML_FOLDER, "AzureML outputs in present run", None, RUN_CONTEXT),
             (REGRESSION_TEST_AZUREML_PARENT_FOLDER, "AzureML outputs in parent run", None, PARENT_RUN_CONTEXT)]:
        folder = expected / subfolder
        <a id="change">if </a>folder.is_dir():
            <a id="change">logging.info(f"Comparing results in {folder} against {message_prefix}:"</a><a id="change">)</a>
            if actual_folder is None and run_to_compare is None:
                raise ValueError(f"The set of expected test results in {expected} contains a folder "
                                 f"{subfolder}, but there is no (parent) run to compare against.")
            new_messages = compare_folder_contents(folder, actual_folder=actual_folder, run=run_to_compare)</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 4</div><BR><div id='size'>Non-data size: 4</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/microsoft/innereye-deeplearning/commit/be36e392062eadc4863d09867f3b03fcf1b02d9e#diff-6498adfa8b54ae4ec16cc7b14f10dd3fcaaa901256453928908653a9d6019766L280' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 55175673</div><div id='project'> Project Name: microsoft/innereye-deeplearning</div><div id='commit'> Commit Name: be36e392062eadc4863d09867f3b03fcf1b02d9e</div><div id='time'> Time: 2021-06-21</div><div id='author'> Author: antonsc@microsoft.com</div><div id='file'> File Name: InnerEye/ML/baselines_util.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: compare_folders_and_run_outputs(2)</div><div id='n_method'> N Method Name: compare_folders_and_run_outputs(2)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: InnerEye/ML/baselines_util.py</div><div id='n_file'> N File Name: InnerEye/ML/baselines_util.py</div><div id='m_start'> M Start Line: 290</div><div id='m_end'> M End Line: 302</div><div id='n_start'> N Start Line: 280</div><div id='n_end'> N End Line: 300</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
    if not config.model_uri:
        &#47&#47 an MLflow model was not found in the current run, so we simply reuse
        &#47&#47 the service created during the previous step run
        <a id="change">if </a>not existing_services:
            <a id="change">raise </a>RuntimeError(
                f"An MLflow model with name `{config.model_name}` was not "
                f"trained in the current pipeline run and no previous "
                f"service was found."</code></pre><h3>After Change</h3><pre><code class='java'>
        service = cast(MLFlowDeploymentService, existing_services[0])

    &#47&#47 check for conditions to deploy the model
    <a id="change">if </a>not model_uri:
        &#47&#47 an MLflow model was not trained in the current run, so we simply reuse
        &#47&#47 the currently running service created for the same model, if any
        if not existing_services:
            logger.warning(
                f"An MLflow model with name `{config.model_name}` was not "
                f"logged in the current pipeline run and no running MLflow "
                f"model server was found. Please ensure that your pipeline "
                f"includes an `mlflow_enable` decorated step that trains a "
                f"model and logs it to MLflow. This could also happen if "
                f"re-training a model in the current pipeline run was skipped "
                f"due to caching."
            )
            &#47&#47 return an inactive service just because we have to return
            &#47&#47 something
            return service
        <a id="change">logger.info(
            f"An MLflow model with name `{config.model_name}` was not "
            f"trained in the current pipeline run. Reusing the existing "
            f"MLflow model server."</a><a id="change">
        )</a>
        if not service.is_running:
            service.start(config.timeout)

        &#47&#47 return the existing service</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/maiot-io/zenml/commit/2bbc792044e1d159c5353e442759377f7dd64b08#diff-796fb8aec733c033378e8cb1814d1d866d6401fd039e96a9f66abf2158a662e7L72' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 55175672</div><div id='project'> Project Name: maiot-io/zenml</div><div id='commit'> Commit Name: 2bbc792044e1d159c5353e442759377f7dd64b08</div><div id='time'> Time: 2022-05-05</div><div id='author'> Author: stefan@zenml.io</div><div id='file'> File Name: src/zenml/integrations/mlflow/steps/mlflow_deployer.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: mlflow_model_deployer_step(3)</div><div id='n_method'> N Method Name: mlflow_model_deployer_step(3)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: src/zenml/integrations/mlflow/steps/mlflow_deployer.py</div><div id='n_file'> N File Name: src/zenml/integrations/mlflow/steps/mlflow_deployer.py</div><div id='m_start'> M Start Line: 89</div><div id='m_end'> M End Line: 156</div><div id='n_start'> N Start Line: 90</div><div id='n_end'> N End Line: 177</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        if self.hparams.optim is None:
            optimizer = torch.optim.Adam(parameters, lr=1e-4)
        else:
            <a id="change">if </a>&quot_target_&quot not in to_DictConfig(self.hparams.optim).keys():
                <a id="change">raise </a>ValueError("Please provide a _target_ class for model.optim arg!")
            optimizer = hydra.utils.instantiate(to_DictConfig(self.hparams.optim), params=self.parameters())
        self._init_lr = optimizer.param_groups[0][&quotlr&quot]
</code></pre><h3>After Change</h3><pre><code class='java'>
            self.log_text.info(" No optimizer was specified, defaulting to AdamW with 1e-4 lr.")
            self.hparams.optimizer.name = &quotadamw&quot

        <a id="change">if </a>hasattr(self, &quotno_weight_decay&quot):
            <a id="change">self.log_text.info(f"Model has method no_weight_decay, which will be used."</a><a id="change">)</a>
        optim_kwargs = {k: v for k, v in self.hparams.optimizer.items() if k not in [&quotname&quot, &quot_target_&quot]}
        optimizer = create_optimizer_v2(model_or_params=self, opt=self.hparams.optimizer.name, **optim_kwargs)
        self._init_lr = optimizer.param_groups[0][&quotlr&quot]
</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/rolnicklab/climart/commit/d4a8bf41fb5dda3d04a45e31cd930fd10964e0a5#diff-dca6b8fd81d3b9ed48032bdf44c4c4abc9d74ab04f63bb89b348809f4e8fb4a2L291' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 55175675</div><div id='project'> Project Name: rolnicklab/climart</div><div id='commit'> Commit Name: d4a8bf41fb5dda3d04a45e31cd930fd10964e0a5</div><div id='time'> Time: 2022-06-06</div><div id='author'> Author: salvaruehling@gmail.com</div><div id='file'> File Name: climart/models/base_model.py</div><div id='m_class'> M Class Name: BaseModel</div><div id='n_method'> N Class Name: BaseModel</div><div id='m_method'> M Method Name: configure_optimizers(1)</div><div id='n_method'> N Method Name: configure_optimizers(1)</div><div id='m_parent_class'> M Parent Class: LightningModule</div><div id='n_parent_class'> N Parent Class: LightningModule</div><div id='m_file'> M File Name: climart/models/base_model.py</div><div id='n_file'> N File Name: climart/models/base_model.py</div><div id='m_start'> M Start Line: 292</div><div id='m_end'> M End Line: 298</div><div id='n_start'> N Start Line: 320</div><div id='n_end'> N End Line: 329</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
            experiment_name = "experiment"
        else:
            if experiment_name not in self.experiments:
                <a id="change">if </a>mlflow.get_experiment_by_name(experiment_name) is not None:
                    <a id="change">raise </a>Exception(
                        "The experiment has already been created before. Please pick another name or delete the files under uri."
                    )
                experiment_id = mlflow.create_experiment(experiment_name)</code></pre><h3>After Change</h3><pre><code class='java'>
            experiment_name = "experiment"
        else:
            if experiment_name not in self.experiments:
                <a id="change">if </a>mlflow.get_experiment_by_name(experiment_name) is not None:
                    <a id="change">logger.info(
                        "The experiment has already been created before. Try to resume the experiment..."</a><a id="change">
                    )</a>
                    experiment_id = mlflow.get_experiment_by_name(experiment_name).experiment_id
                else:
                    experiment_id = mlflow.create_experiment(experiment_name)
            else:</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/microsoft/qlib/commit/004e2f557b3711289bcab953e5e4a413b6332fb0#diff-e5df31bd210e4f211f646f4edfc4859a4ab575477977ec3e663957c4d1ec4f09L166' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 55175678</div><div id='project'> Project Name: microsoft/qlib</div><div id='commit'> Commit Name: 004e2f557b3711289bcab953e5e4a413b6332fb0</div><div id='time'> Time: 2020-11-09</div><div id='author'> Author: dw1920@nyu.edu</div><div id='file'> File Name: qlib/workflow/expm.py</div><div id='m_class'> M Class Name: MLflowExpManager</div><div id='n_method'> N Class Name: MLflowExpManager</div><div id='m_method'> M Method Name: create_exp(3)</div><div id='n_method'> N Method Name: create_exp(3)</div><div id='m_parent_class'> M Parent Class: ExpManager</div><div id='n_parent_class'> N Parent Class: ExpManager</div><div id='m_file'> M File Name: qlib/workflow/expm.py</div><div id='n_file'> N File Name: qlib/workflow/expm.py</div><div id='m_start'> M Start Line: 186</div><div id='m_end'> M End Line: 190</div><div id='n_start'> N Start Line: 186</div><div id='n_end'> N End Line: 193</div><BR>