<html><h3>Pattern ID :406
</h3><img src='2350291.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
      px_ = (w.shape[3] - 1) * C.dx - xdw.shape[3] - C.px + C.sx * (grad_output_dw.shape[3]-1) + 1
      Cdw = get_conv_args(xdw.shape, grad_output_dw.shape, padding=(C.px, px_, C.py, py_), stride=(C.dy, C.dx), dilation=(C.sy, C.sx), groups=C.groups)
      grad_weight = ctx._conv(xdw, grad_output_dw, Cdw)
      dw<a id="change"> = </a><a id="change">grad_weight.movement_op(</a>MovementOps.PERMUTE, (1<a id="change">,0,2,3</a>)<a id="change">)</a>
    return dx, dw
</code></pre><h3>After Change</h3><pre><code class='java'>
      py_ = (w.shape[2] - 1) * C.dy - xdw.shape[2] - C.py + C.sy * (grad_output_dw.shape[2]-1) + 1
      px_ = (w.shape[3] - 1) * C.dx - xdw.shape[3] - C.px + C.sx * (grad_output_dw.shape[3]-1) + 1
      Cdw = get_conv_args(xdw.shape, grad_output_dw.shape, padding=(C.px, px_, C.py, py_), stride=(C.dy, C.dx), dilation=(C.sy, C.sx), groups=C.groups)
      dw = <a id="change">ctx._conv(xdw, grad_output_dw, Cdw).movement_op(</a>MovementOps.PERMUTE, (1<a id="change">,0,2,3</a>)<a id="change">)</a>

    return dx, dw
</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 5</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/geohot/tinygrad/commit/4d4ea47ca71533192a174e00c863b4ea58be35cf#diff-2160099cd6a4d64858c555c33546afb784d0dfdc80731362c7170e01ba362a97L189' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 2350291</div><div id='project'> Project Name: geohot/tinygrad</div><div id='commit'> Commit Name: 4d4ea47ca71533192a174e00c863b4ea58be35cf</div><div id='time'> Time: 2022-07-03</div><div id='author'> Author: geohot@gmail.com</div><div id='file'> File Name: tinygrad/mlops.py</div><div id='m_class'> M Class Name: Conv2D</div><div id='n_method'> N Class Name: Conv2D</div><div id='m_method'> M Method Name: backward(2)</div><div id='n_method'> N Method Name: backward(2)</div><div id='m_parent_class'> M Parent Class: Function</div><div id='n_parent_class'> N Parent Class: Function</div><div id='m_file'> M File Name: tinygrad/mlops.py</div><div id='n_file'> N File Name: tinygrad/mlops.py</div><div id='m_start'> M Start Line: 189</div><div id='m_end'> M End Line: 195</div><div id='n_start'> N Start Line: 191</div><div id='n_end'> N End Line: 196</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>

    if ctx.needs_input_grad[1]:   &#47&#47 compute derivative of weights using ProcessingOps.CONV
      xdw = x.movement_op(MovementOps.RESHAPE, (C.bs, C.groups, C.cin, C.iy, C.ix))
      xdw<a id="change"> = </a><a id="change">xdw.movement_op(</a>MovementOps.PERMUTE, (2<a id="change">,1,0,3,4</a>)<a id="change">)</a>
      xdw = xdw.movement_op(MovementOps.RESHAPE, (C.cin, C.groups*C.bs, C.iy, C.ix))
      grad_output_dw = grad_output.movement_op(MovementOps.PERMUTE, (1,0,2,3))
      grad_output_dw = grad_output_dw.movement_op(MovementOps.RESHAPE, (C.cout, C.bs, C.oy, C.ox))
      py_ = (w.shape[2] - 1) * C.dy - xdw.shape[2] - C.py + C.sy * (grad_output_dw.shape[2]-1) + 1</code></pre><h3>After Change</h3><pre><code class='java'>
      dx = ctx._conv(xt, wt, Cdx)

    if ctx.needs_input_grad[1]:   &#47&#47 compute derivative of weights using ProcessingOps.CONV
      xdw = <a id="change">x.movement_op(MovementOps.RESHAPE, (C.bs, C.groups, C.cin, C.iy, C.ix)).movement_op(</a>MovementOps.PERMUTE, (2<a id="change">, 1, 0, 3, 4</a>)<a id="change">)</a>
      xdw = xdw.movement_op(MovementOps.RESHAPE, (C.cin, C.groups*C.bs, C.iy, C.ix))
      grad_output_dw = grad_output.movement_op(MovementOps.PERMUTE, (1,0,2,3))
      py_ = (w.shape[2] - 1) * C.dy - xdw.shape[2] - C.py + C.sy * (grad_output_dw.shape[2]-1) + 1
      px_ = (w.shape[3] - 1) * C.dx - xdw.shape[3] - C.px + C.sx * (grad_output_dw.shape[3]-1) + 1</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/geohot/tinygrad/commit/02cd8510cb09bb739861d938b8ee572866f2ad3d#diff-2160099cd6a4d64858c555c33546afb784d0dfdc80731362c7170e01ba362a97L169' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 2350289</div><div id='project'> Project Name: geohot/tinygrad</div><div id='commit'> Commit Name: 02cd8510cb09bb739861d938b8ee572866f2ad3d</div><div id='time'> Time: 2022-07-03</div><div id='author'> Author: geohot@gmail.com</div><div id='file'> File Name: tinygrad/mlops.py</div><div id='m_class'> M Class Name: Conv2D</div><div id='n_method'> N Class Name: Conv2D</div><div id='m_method'> M Method Name: backward(2)</div><div id='n_method'> N Method Name: backward(2)</div><div id='m_parent_class'> M Parent Class: Function</div><div id='n_parent_class'> N Parent Class: Function</div><div id='m_file'> M File Name: tinygrad/mlops.py</div><div id='n_file'> N File Name: tinygrad/mlops.py</div><div id='m_start'> M Start Line: 171</div><div id='m_end'> M End Line: 194</div><div id='n_start'> N Start Line: 179</div><div id='n_end'> N End Line: 188</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
      &#47&#47 undo hack for non multiples of 4 on C.rcout
      if added_output_channels != 0:
        ret = ret.movement_op(MovementOps.RESHAPE, (C.bs, C.oy, C.ox, C.groups, C.rcout))
        xs = [(0<a id="change">, s</a>) for s in ret.shape]
        xs[4] = (0, ret.shape[4]-added_output_channels)
        ret<a id="change"> = </a><a id="change">ret.movement_op(</a>MovementOps.SHRINK, xs<a id="change">)</a>
        C = C._replace(rcout = C.rcout - added_output_channels, cout = C.groups * (C.rcout - added_output_channels))

      ret = ret.movement_op(MovementOps.RESHAPE, (C.bs, C.oy, C.ox, C.cout))
      ret = ret.movement_op(MovementOps.PERMUTE, (0,3,1,2))</code></pre><h3>After Change</h3><pre><code class='java'>
      &#47&#47 undo hack for non multiples of 4 on C.rcout
      if added_output_channels != 0:
        ret = ret.movement_op(MovementOps.RESHAPE, (C.bs, C.oy, C.ox, C.groups, C.rcout))
        ret = <a id="change">ret.movement_op(</a>MovementOps.SHRINK, [(0, s-added_output_channels) if i == 4 else (0<a id="change">, s</a>) for i,s in enumerate(ret.shape)]<a id="change">)</a>
        C = C._replace(rcout = C.rcout - added_output_channels, cout = C.groups * (C.rcout - added_output_channels))

      ret = ret.movement_op(MovementOps.RESHAPE, (C.bs, C.oy, C.ox, C.cout))
      ret = ret.movement_op(MovementOps.PERMUTE, (0,3,1,2))</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/geohot/tinygrad/commit/3acf62d4896f51f9fbf005a9ff882afd23b6eb6b#diff-566a7254fa321896c55ed04f6d3eb9cf38ac84ee952b4e44a107c006cf886b16L249' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 2350294</div><div id='project'> Project Name: geohot/tinygrad</div><div id='commit'> Commit Name: 3acf62d4896f51f9fbf005a9ff882afd23b6eb6b</div><div id='time'> Time: 2023-01-25</div><div id='author'> Author: geohot@gmail.com</div><div id='file'> File Name: tinygrad/lazy.py</div><div id='m_class'> M Class Name: LazyBuffer</div><div id='n_method'> N Class Name: LazyBuffer</div><div id='m_method'> M Method Name: processing_op(4)</div><div id='n_method'> N Method Name: processing_op(4)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: tinygrad/lazy.py</div><div id='n_file'> N File Name: tinygrad/lazy.py</div><div id='m_start'> M Start Line: 253</div><div id='m_end'> M End Line: 352</div><div id='n_start'> N Start Line: 253</div><div id='n_end'> N End Line: 344</div><BR>