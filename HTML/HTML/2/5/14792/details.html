<html><h3>Pattern ID :14792
</h3><img src='48658677.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>

    mask_cond = paddle.arange(mask.shape[-1])
    mask_cond = mask_cond &lt; (mask_cond + 1).reshape([mask.shape[-1], 1])
    mask = paddle.where(mask_cond, <a id="change">paddle.full(</a>mask_cond.shape, <a id="change">0</a><a id="change">)</a>, mask)

    if past_key_values_length &gt; 0:
        <a id="change">mask[:, :past_key_values_length]</a> = False

    expanded_mask<a id="change"> = </a>mask.unsqueeze(0).expand([batch_size, target_length, target_length + past_key_values_length])
    return expanded_mask

</code></pre><h3>After Change</h3><pre><code class='java'>
    if past_key_values_length &gt; 0:
        mask = paddle.concat([paddle.zeros(target_length, past_key_values_length), mask], axis=-1)

    return <a id="change">mask[None, None, :, :]</a>.expand([batch_size, 1, target_length, target_length + past_key_values_length])


def _expand_mask(mask, dtype, tgt_length):</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 4</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/paddlepaddle/paddlenlp/commit/5f01f073ed6e140743170652b201c16356350dc7#diff-99e104eff4c095428aa1cd5d186107ae22737297e8ec3b5c12cd138e69a79cb5L96' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 48658677</div><div id='project'> Project Name: paddlepaddle/paddlenlp</div><div id='commit'> Commit Name: 5f01f073ed6e140743170652b201c16356350dc7</div><div id='time'> Time: 2023-04-13</div><div id='author'> Author: 40840292+linjieccc@users.noreply.github.com</div><div id='file'> File Name: paddlenlp/transformers/llama/modeling.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: _make_causal_mask(3)</div><div id='n_method'> N Method Name: _make_causal_mask(3)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: paddlenlp/transformers/llama/modeling.py</div><div id='n_file'> N File Name: paddlenlp/transformers/llama/modeling.py</div><div id='m_start'> M Start Line: 96</div><div id='m_end'> M End Line: 106</div><div id='n_start'> N Start Line: 101</div><div id='n_end'> N End Line: 109</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>

        src_idx = self._get_src_permutation_idx(indices)

        target_classes = <a id="change">torch.full(</a>src_logits.shape[:2], <a id="change">0</a><a id="change">, dtype=torch.int64, device=src_logits.device)</a>
        <a id="change">target_classes[src_idx]</a> = 1

        loss_ce<a id="change"> = </a>F.cross_entropy(src_logits.transpose(1, 2), target_classes, weight=self.cls_weights.cuda(), label_smoothing=0.0)

        return loss_ce
</code></pre><h3>After Change</h3><pre><code class='java'>
        &#47&#47 Remove non existent classes
        valid_ids = (cls_labels != -1).nonzero()

        loss_ce = F.binary_cross_entropy_with_logits(<a id="change">cls_preds[valid_ids]</a>.squeeze(), cls_labels[valid_ids].squeeze())
        return loss_ce

    def loss_bboxes(self, outputs, targets, matches, num_boxes, matches_per_class=1):</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/bwittmann/transoar/commit/09f57bf9bd1146b57db0cce80a0901defe5e5d63#diff-72325bd8560b0c87dc6c780bd674d1f642bdf043c4336b8d7d2033c2cfe1d9efL35' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 48658675</div><div id='project'> Project Name: bwittmann/transoar</div><div id='commit'> Commit Name: 09f57bf9bd1146b57db0cce80a0901defe5e5d63</div><div id='time'> Time: 2022-02-15</div><div id='author'> Author: bastian.wittmann@tum.de</div><div id='file'> File Name: transoar/models/criterion.py</div><div id='m_class'> M Class Name: TransoarCriterion</div><div id='n_method'> N Class Name: TransoarCriterion</div><div id='m_method'> M Method Name: loss_class(3)</div><div id='n_method'> N Method Name: loss_class(3)</div><div id='m_parent_class'> M Parent Class: nn.Module</div><div id='n_parent_class'> N Parent Class: nn.Module</div><div id='m_file'> M File Name: transoar/models/criterion.py</div><div id='n_file'> N File Name: transoar/models/criterion.py</div><div id='m_start'> M Start Line: 40</div><div id='m_end'> M End Line: 47</div><div id='n_start'> N Start Line: 41</div><div id='n_end'> N End Line: 47</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        idx = self._get_src_permutation_idx(indices)

        target_classes_o = torch.cat([t["labels"][J] for t, (_, J) in zip(targets, indices)])
        target_classes = <a id="change">torch.full(</a>src_logits.shape[:2], <a id="change">0</a><a id="change">,
                                    dtype=torch.int64, device=src_logits.device)</a>
        <a id="change">target_classes[idx]</a> = target_classes_o

        loss_ce<a id="change"> = </a>F.cross_entropy(src_logits.transpose(1, 2), target_classes, self.cls_weights.to(device=src_logits.device))

        return loss_ce
</code></pre><h3>After Change</h3><pre><code class='java'>
        &#47&#47 Remove non existent classes
        valid_ids = (soft_labels.flatten() != -1).nonzero()

        loss_ce = F.binary_cross_entropy_with_logits(<a id="change">cls_preds[valid_ids]</a>.squeeze(), cls_labels[valid_ids].squeeze().cuda())
        return loss_ce

</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/bwittmann/transoar/commit/50cc4661dc99397fe437a829cff6659bfd58eaba#diff-72325bd8560b0c87dc6c780bd674d1f642bdf043c4336b8d7d2033c2cfe1d9efL40' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 48658673</div><div id='project'> Project Name: bwittmann/transoar</div><div id='commit'> Commit Name: 50cc4661dc99397fe437a829cff6659bfd58eaba</div><div id='time'> Time: 2022-04-19</div><div id='author'> Author: bastian.wittmann@tum.de</div><div id='file'> File Name: transoar/models/criterion.py</div><div id='m_class'> M Class Name: TransoarCriterion</div><div id='n_method'> N Class Name: TransoarCriterion</div><div id='m_method'> M Method Name: loss_class(4)</div><div id='n_method'> N Method Name: loss_class(4)</div><div id='m_parent_class'> M Parent Class: nn.Module</div><div id='n_parent_class'> N Parent Class: nn.Module</div><div id='m_file'> M File Name: transoar/models/criterion.py</div><div id='n_file'> N File Name: transoar/models/criterion.py</div><div id='m_start'> M Start Line: 45</div><div id='m_end'> M End Line: 54</div><div id='n_start'> N Start Line: 42</div><div id='n_end'> N End Line: 48</div><BR>