<html><h3>Pattern ID :5108
</h3><img src='17966994.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
    print(object_info)
    timeout = int(object_info.get(&quottimeout&quot, 60 * 60 * 24 * 3))

    clusters<a id="change"> = </a>conf.get(&quotCLUSTERS&quot,<a id="change">{}</a>)
    for cluster_name in clusters:
        cluster = clusters[cluster_name]
        k8s_client = K8s(cluster[&quotKUBECONFIG&quot])</code></pre><h3>After Change</h3><pre><code class='java'>
    with session_scope(nullpool=True) as dbsession:
        &#47&#47 删除vscode的pod
        try:
            alert_time<a id="change"> = </a><a id="change">datetime.datetime.now() - datetime.timedelta(seconds=timeout) + </a>datetime.timedelta(days=1)
            notebooks = dbsession.query(Notebook).filter(Notebook.changed_on &lt; alert_time).all()   &#47&#47 需要删除或者需要通知续期的notebook
            for notebook in notebooks:
                if notebook.changed_on &lt; (datetime.datetime.now() - datetime.timedelta(seconds=timeout)):</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 5</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/tencentmusic/cube-studio/commit/842a46a1832379aade515f448e0763d7b1cf0194#diff-cccea5a99fac00532cf9f4a08008066dc95d61078b2c52727ed9a70ef702f2e5L322' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 17966994</div><div id='project'> Project Name: tencentmusic/cube-studio</div><div id='commit'> Commit Name: 842a46a1832379aade515f448e0763d7b1cf0194</div><div id='time'> Time: 2021-10-14</div><div id='author'> Author: pengluan@tencent.com</div><div id='file'> File Name: myapp/tasks/schedules.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: delete_notebook(1)</div><div id='n_method'> N Method Name: delete_notebook(1)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: myapp/tasks/schedules.py</div><div id='n_file'> N File Name: myapp/tasks/schedules.py</div><div id='m_start'> M Start Line: 323</div><div id='m_end'> M End Line: 348</div><div id='n_start'> N Start Line: 322</div><div id='n_end'> N End Line: 345</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
    Base class for all models.

    def __init__(self, device):
        self.logger<a id="change"> = </a><a id="change">{}</a>
        self.model = None

        if device is None:
            self.device = torch.device(</code></pre><h3>After Change</h3><pre><code class='java'>

            &#47&#47 get the current time to append to the dir name,
            &#47&#47 so you can use the same tb_file_saving_path for multiple running
            time_now = <a id="change">datetime.now()</a>.__format__("%Y-%m-%d_T%H:%M:%S")
            &#47&#47 the actual directory name to save the tensorboard file
            actual_tb_saving_dir_name = "tensorboard_"<a id="change"> + </a>time_now
            actual_tb_file_saving_path<a id="change"> = </a>os.path.join(
                tb_file_saving_path, actual_tb_saving_dir_name
            )
            os.makedirs(actual_tb_saving_dir_name)  &#47&#47 create the dir for file saving</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/wenjiedu/pypots/commit/e88739056a8b63464495b60d7144748f8baa7908#diff-6e5f5f1fb34116c84b878b32c14ce665b1cdc7a96d49d640084b7c1917b3d682L20' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 17967024</div><div id='project'> Project Name: wenjiedu/pypots</div><div id='commit'> Commit Name: e88739056a8b63464495b60d7144748f8baa7908</div><div id='time'> Time: 2023-04-07</div><div id='author'> Author: wenjay.du@gmail.com</div><div id='file'> File Name: pypots/base.py</div><div id='m_class'> M Class Name: BaseModel</div><div id='n_method'> N Class Name: BaseModel</div><div id='m_method'> M Method Name: __init__(3)</div><div id='n_method'> N Method Name: __init__(2)</div><div id='m_parent_class'> M Parent Class: ABC</div><div id='n_parent_class'> N Parent Class: ABC</div><div id='m_file'> M File Name: pypots/base.py</div><div id='n_file'> N File Name: pypots/base.py</div><div id='m_start'> M Start Line: 20</div><div id='m_end'> M End Line: 21</div><div id='n_start'> N Start Line: 33</div><div id='n_end'> N End Line: 77</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
            self.model.train()

            train_losses = []
            train_accuracies<a id="change"> = </a><a id="change">[]</a>

            for i, batch in tqdm(enumerate(self.train_loader)):
                src_input, tar_input, tar_output, encoder_mask, decoder_mask = batch</code></pre><h3>After Change</h3><pre><code class='java'>

                train_losses.append(loss.item())

            end_time = <a id="change">datetime.datetime.now()</a>
            training_time = end_time<a id="change"> - </a>start_time
            minutes = training_time.seconds // 60
            seconds = training_time.seconds

            mean_train_loss = np.mean(train_losses)
            print(f"&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47 Epoch: {epoch} &#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47&#47")
            print(f"Train loss: {mean_train_loss} || Training time: {minutes}mins {seconds}secs")

            summary.add_scalar(&quotloss/train_loss&quot, mean_train_loss, epoch)

            if mean_train_loss &lt; best_loss:
                if not os.path.exists(ckpt_dir):
                    os.mkdir(ckpt_dir)
                torch.save(self.model.state_dict(), f"{ckpt_dir}/best_model.pth")
                print(f"Current best model is saved.")
                best_loss = mean_train_loss

            total_training_time<a id="change"> += </a>training_time

        hours = total_training_time.seconds // 3600
        minutes = total_training_time.seconds // 60</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/devjwsong/transformer-translator-pytorch/commit/d377a69e76dcfd79366898a32ea36adf101422ee#diff-2e5ad92c43aa96cc3a9cef6c6aec998b216f1379c43b1f651013d25e55989312L57' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 17967008</div><div id='project'> Project Name: devjwsong/transformer-translator-pytorch</div><div id='commit'> Commit Name: d377a69e76dcfd79366898a32ea36adf101422ee</div><div id='time'> Time: 2020-04-30</div><div id='author'> Author: enflwodn@gmail.com</div><div id='file'> File Name: src/main.py</div><div id='m_class'> M Class Name: Manager</div><div id='n_method'> N Class Name: Manager</div><div id='m_method'> M Method Name: train(1)</div><div id='n_method'> N Method Name: train(1)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: src/main.py</div><div id='n_file'> N File Name: src/main.py</div><div id='m_start'> M Start Line: 61</div><div id='m_end'> M End Line: 113</div><div id='n_start'> N Start Line: 59</div><div id='n_end'> N End Line: 108</div><BR>