<html><h3>Pattern ID :23706
</h3><img src='73910918.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
        train_labeled_dataset, batch_size=args.batch_size[0], shuffle=(train_labeled_sampler is None),
        num_workers=args.workers, pin_memory=True, sampler=train_labeled_sampler, collate_fn=train_labeled_dataset.collate)

    loss_func<a id="change"> = </a><a id="change">nn.BCEWithLogitsLoss(reduction=&quotnone&quot).cuda()</a>
    &#47&#47 define loss function (criterion)
    def criterion(y_pred, y_target):
        is_labeled = ~torch.isnan(y_target)
        flattened_y_pred = y_pred[is_labeled].float()</code></pre><h3>After Change</h3><pre><code class='java'>
            if is_best:
                test_metric = tmp_test_metric
                shutil.copy(logger.get_checkpoint_path(&quotlatest&quot), logger.get_checkpoint_path(&quotbest&quot))
    <a id="change">print(</a><a id="change">"best val performance: {:.3f}".format(</a>best_val_metric<a id="change">))</a>
    print("test performance: {:.3f}".format(test_metric))

    logger.close()
    writer.close()</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 4</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/thuml/transfer-learning-library/commit/a506d6956e5d8734b2bb14edda8df7eeac8d0896#diff-03e79a17b6fbd9cfcb63d8e208872c6493a81b67b6b777a7bae7e3b74e9fadcaL69' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 73910918</div><div id='project'> Project Name: thuml/transfer-learning-library</div><div id='commit'> Commit Name: a506d6956e5d8734b2bb14edda8df7eeac8d0896</div><div id='time'> Time: 2022-03-17</div><div id='author'> Author: 3236488847@qq.com</div><div id='file'> File Name: examples/domain_adaptation/wilds_graph/erm.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: main(1)</div><div id='n_method'> N Method Name: main(1)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: examples/domain_adaptation/wilds_graph/erm.py</div><div id='n_file'> N File Name: examples/domain_adaptation/wilds_graph/erm.py</div><div id='m_start'> M Start Line: 74</div><div id='m_end'> M End Line: 165</div><div id='n_start'> N Start Line: 69</div><div id='n_end'> N End Line: 150</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
    
    def train(self, train_dataloader, eval_dataloader):
        if self.config[&quotgpu&quot]:
            criterion<a id="change"> = </a><a id="change">nn.NLLLoss().cuda()</a>
        else:
            criterion = nn.NLLLoss()
        optimizer = optim.Adam(filter(lambda p: p.requires_grad, self.model.parameters()), lr=self.config[&quotlearning_rate&quot],
                            weight_decay=self.config[&quotL2&quot])</code></pre><h3>After Change</h3><pre><code class='java'>
            print(&quot==&gt;Train Epoch:{:0&gt;2d} Loss:{:.4f} learning_rate:{}&quot.format(epoch, avg_loss, lr))
            &#47&#47 eval stage
            avg_acc = self._valid_epoch(eval_dataloader, self.model, self.config[&quotgpu&quot], eval_total_batch, self.config[&quotverbose&quot])
            <a id="change">print(</a><a id="change">&quot==&gt;Eval Acc:{:.4f}&quot.format(</a>avg_acc<a id="change">))</a>
            metrics[&quotaccuracy&quot].append(avg_acc)
            save_name_tmp = &quotep_&quot + str(epoch) + &quot.m&quot
            torch.save(self.model.state_dict(), self.tmp_path + save_name_tmp)
            scheduler.step(avg_acc)</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/libcity/bigscity-libcity/commit/691cf75a889019ef438062f38b0fb7d1d5fafbc1#diff-3b0408c84ea1982a6fe3d842dd9eff33a8bba27ca54ad0f448b9f8ae7b2c38e4L24' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 73910916</div><div id='project'> Project Name: libcity/bigscity-libcity</div><div id='commit'> Commit Name: 691cf75a889019ef438062f38b0fb7d1d5fafbc1</div><div id='time'> Time: 2021-01-18</div><div id='author'> Author: 33283819+WenMellors@users.noreply.github.com</div><div id='file'> File Name: trafficdl/executor/traj_loc_pred_executor.py</div><div id='m_class'> M Class Name: TrajLocPredExecutor</div><div id='n_method'> N Class Name: TrajLocPredExecutor</div><div id='m_method'> M Method Name: train(3)</div><div id='n_method'> N Method Name: train(3)</div><div id='m_parent_class'> M Parent Class: AbstractExecutor</div><div id='n_parent_class'> N Parent Class: AbstractExecutor</div><div id='m_file'> M File Name: trafficdl/executor/traj_loc_pred_executor.py</div><div id='n_file'> N File Name: trafficdl/executor/traj_loc_pred_executor.py</div><div id='m_start'> M Start Line: 25</div><div id='m_end'> M End Line: 49</div><div id='n_start'> N Start Line: 43</div><div id='n_end'> N End Line: 44</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>

    &#47&#47 define loss function (criterion)
    if args.smoothing:
        criterion<a id="change"> = </a><a id="change">LabelSmoothingCrossEntropy(args.smoothing).cuda()</a>
    else:
        criterion = nn.CrossEntropyLoss().cuda()

    if args.phase == &quottest&quot:</code></pre><h3>After Change</h3><pre><code class='java'>
            if is_best:
                best_test_metric = test_metric
                shutil.copy(logger.get_checkpoint_path(&quotlatest&quot), logger.get_checkpoint_path(&quotbest&quot))
    <a id="change">print(</a><a id="change">"best val performance: {:.3f}\n test performance: {:.3f}".format(</a>best_val_metric, best_test_metric<a id="change">))</a>


def train(train_loader, model, criterion, optimizer, epoch, writer, args):
    batch_time = AverageMeter(&quotTime&quot, &quot:3.1f&quot)</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/thuml/transfer-learning-library/commit/d341bd718cfb21441c0e530b3f70ded0a723f5be#diff-6f8e677bcd193ae95143866ab412fa3e530dcf76ed1ffee928046478d1be91c1L38' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 73910921</div><div id='project'> Project Name: thuml/transfer-learning-library</div><div id='commit'> Commit Name: d341bd718cfb21441c0e530b3f70ded0a723f5be</div><div id='time'> Time: 2022-03-16</div><div id='author'> Author: 3236488847@qq.com</div><div id='file'> File Name: examples/domain_adaptation/wilds_text/erm.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: main(1)</div><div id='n_method'> N Method Name: main(1)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: examples/domain_adaptation/wilds_text/erm.py</div><div id='n_file'> N File Name: examples/domain_adaptation/wilds_text/erm.py</div><div id='m_start'> M Start Line: 51</div><div id='m_end'> M End Line: 158</div><div id='n_start'> N Start Line: 40</div><div id='n_end'> N End Line: 169</div><BR>