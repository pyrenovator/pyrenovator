<html><h3>Pattern ID :30381
</h3><img src='89864051.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
            return self.scheduler.timesteps.to(device), num_inference_steps
        else:
            &#47&#47 get the original timestep using init_timestep
            offset<a id="change"> = </a>self.scheduler.config.get("steps_offset", 0)
            init_timestep = int(num_inference_steps * strength) + offset
            init_timestep<a id="change"> = </a><a id="change">min(</a>init_timestep, num_inference_steps<a id="change">)</a>

            t_start = max(num_inference_steps - init_timestep + offset, 0)
            timesteps = self.scheduler.timesteps[<a id="change">t_start:</a>].to(device)
            return timesteps, num_inference_steps - t_start

    def run_safety_checker(self, image, device, dtype):</code></pre><h3>After Change</h3><pre><code class='java'>
            return self.scheduler.timesteps.to(device), num_inference_steps
        else:
            &#47&#47 get the original timestep using init_timestep
            init_timestep = <a id="change">min(</a>int(num_inference_steps * strength), num_inference_steps<a id="change">)</a>

            t_start = max(num_inference_steps - init_timestep, 0)
            timesteps = self.scheduler.timesteps[t_start * self.scheduler.order :]
</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 5</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/huggingface/diffusers/commit/2ced899cc7cff5c37f2186819c90538ce301908c#diff-137485cb3293be40e8fbae3f413853388988a06e9c6c73352686946677ad2eb3L583' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 89864051</div><div id='project'> Project Name: huggingface/diffusers</div><div id='commit'> Commit Name: 2ced899cc7cff5c37f2186819c90538ce301908c</div><div id='time'> Time: 2023-04-27</div><div id='author'> Author: patrick.v.platen@gmail.com</div><div id='file'> File Name: examples/community/lpw_stable_diffusion.py</div><div id='m_class'> M Class Name: StableDiffusionLongPromptWeightingPipeline</div><div id='n_method'> N Class Name: StableDiffusionLongPromptWeightingPipeline</div><div id='m_method'> M Method Name: get_timesteps(5)</div><div id='n_method'> N Method Name: get_timesteps(5)</div><div id='m_parent_class'> M Parent Class: DiffusionPipeline,TextualInversionLoaderMixin,FromCkptMixin,LoraLoaderMixin</div><div id='n_parent_class'> N Parent Class: StableDiffusionPipeline</div><div id='m_file'> M File Name: examples/community/lpw_stable_diffusion.py</div><div id='n_file'> N File Name: examples/community/lpw_stable_diffusion.py</div><div id='m_start'> M Start Line: 583</div><div id='m_end'> M End Line: 588</div><div id='n_start'> N Start Line: 776</div><div id='n_end'> N End Line: 779</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
            return self.scheduler.timesteps.to(device), num_inference_steps
        else:
            &#47&#47 get the original timestep using init_timestep
            offset<a id="change"> = </a>self.scheduler.config.get("steps_offset", 0)
            init_timestep = int(num_inference_steps * strength) + offset
            init_timestep<a id="change"> = </a><a id="change">min(</a>init_timestep, num_inference_steps<a id="change">)</a>

            t_start = max(num_inference_steps - init_timestep + offset, 0)
            timesteps = self.scheduler.timesteps[<a id="change">t_start:</a>].to(device)
            return timesteps, num_inference_steps - t_start

    def run_safety_checker(self, image, device, dtype):</code></pre><h3>After Change</h3><pre><code class='java'>
            return self.scheduler.timesteps.to(device), num_inference_steps
        else:
            &#47&#47 get the original timestep using init_timestep
            init_timestep = <a id="change">min(</a>int(num_inference_steps * strength), num_inference_steps<a id="change">)</a>

            t_start = max(num_inference_steps - init_timestep, 0)
            timesteps = self.scheduler.timesteps[t_start * self.scheduler.order :]
</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/huggingface/diffusers/commit/9965cb50eac12e397473f01535aab43aae76b4ab#diff-137485cb3293be40e8fbae3f413853388988a06e9c6c73352686946677ad2eb3L578' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 89864050</div><div id='project'> Project Name: huggingface/diffusers</div><div id='commit'> Commit Name: 9965cb50eac12e397473f01535aab43aae76b4ab</div><div id='time'> Time: 2023-04-22</div><div id='author'> Author: SKYTNT@outlook.com</div><div id='file'> File Name: examples/community/lpw_stable_diffusion.py</div><div id='m_class'> M Class Name: StableDiffusionLongPromptWeightingPipeline</div><div id='n_method'> N Class Name: StableDiffusionLongPromptWeightingPipeline</div><div id='m_method'> M Method Name: get_timesteps(5)</div><div id='n_method'> N Method Name: get_timesteps(5)</div><div id='m_parent_class'> M Parent Class: DiffusionPipeline,TextualInversionLoaderMixin,FromCkptMixin,LoraLoaderMixin</div><div id='n_parent_class'> N Parent Class: StableDiffusionPipeline</div><div id='m_file'> M File Name: examples/community/lpw_stable_diffusion.py</div><div id='n_file'> N File Name: examples/community/lpw_stable_diffusion.py</div><div id='m_start'> M Start Line: 583</div><div id='m_end'> M End Line: 588</div><div id='n_start'> N Start Line: 776</div><div id='n_end'> N End Line: 779</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        for _ in range(self.d_sample_training_epochs):
            for corpus, fake_data in zip(train_data, fake_dataloader):
                &#47&#47 interaction = interaction.to(self.device)
                real_data<a id="change"> = </a>corpus[&quottarget_idx&quot]
                min_batch<a id="change"> = </a><a id="change">min(</a>real_data.shape[0], fake_data.shape[0]<a id="change">)</a>
                losses = self.model.calculate_d_train_loss(real_data[ <a id="change">: min_batch</a>], fake_data[ : min_batch], epoch_idx=epoch_idx)
                total_loss = self._optimize_step(losses, total_loss, self.model.discriminator, self.d_optimizer)

        return total_loss / len(train_data) / self.d_sample_training_epochs</code></pre><h3>After Change</h3><pre><code class='java'>
                losses = self.model.calculate_d_train_loss(real_data, fake_data, epoch_idx=epoch_idx)
                total_loss = self._optimize_step(losses, total_loss, self.model.discriminator, self.d_optimizer)

        return total_loss / len(<a id="change">min(</a>real_dataloader, fake_dataloader<a id="change">)</a>) / self.d_sample_training_epochs
    
    def _adversarial_train_epoch(self, train_data, epoch_idx):
        rAdversarial training in an epoch</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/rucaibox/textbox/commit/d2eba1b6e5e8b3a117c7ee4254a228832a52d500#diff-0d515b0c4df56ad2bd4ee01611408f580467bc1b88b8c14da6eaaa2c298e02c4L460' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 89864048</div><div id='project'> Project Name: rucaibox/textbox</div><div id='commit'> Commit Name: d2eba1b6e5e8b3a117c7ee4254a228832a52d500</div><div id='time'> Time: 2020-11-18</div><div id='author'> Author: 1020139164@qq.com</div><div id='file'> File Name: textbox/trainer/trainer.py</div><div id='m_class'> M Class Name: GANTrainer</div><div id='n_method'> N Class Name: GANTrainer</div><div id='m_method'> M Method Name: _d_train_epoch(3)</div><div id='n_method'> N Method Name: _d_train_epoch(3)</div><div id='m_parent_class'> M Parent Class: Trainer</div><div id='n_parent_class'> N Parent Class: Trainer</div><div id='m_file'> M File Name: textbox/trainer/trainer.py</div><div id='n_file'> N File Name: textbox/trainer/trainer.py</div><div id='m_start'> M Start Line: 474</div><div id='m_end'> M End Line: 485</div><div id='n_start'> N Start Line: 481</div><div id='n_end'> N End Line: 491</div><BR>