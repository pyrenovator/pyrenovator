<html><h3>Pattern ID :20843
</h3><img src='67223611.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
        idx2token = eval_data.idx2token
        
        for b in range(num_batch):
            leak_sample<a id="change">, _, _, _</a> = self.leakgan_forward(fake_sentences, dis, if_sample=True, no_log=False
                                                        , start_letter=self.start_idx, train=False)

            assert leak_sample.shape == (self.batch_size, self.max_length-1)</code></pre><h3>After Change</h3><pre><code class='java'>

        samples = samples[:number_to_gen, :]
        samples = samples.tolist()
        texts = <a id="change">[]</a>
        <a id="change">for </a>sen in samples<a id="change">:
            </a>text<a id="change"> = </a>[]
            for w in sen:
                <a id="change">if w != self.end_idx</a>:
                    text.append(idx2token[w])
                else:
                    <a id="change">break</a>
            <a id="change">texts.append(</a>text<a id="change">)</a>
        &#47&#47 samples = [[idx2token[w] for w in sen] for sen in samples]

        <a id="change">return </a>texts
    
    def adversarial_loss(self, dis):
        with torch.no_grad():</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 9</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/rucaibox/textbox/commit/9b5a6ec4e4a248b42892f4a8b7efc8a9a25630f7#diff-62933681a01584827327c04ae3e95ed02184dc2f518f346a504c8176cd63bcf9L303' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 67223611</div><div id='project'> Project Name: rucaibox/textbox</div><div id='commit'> Commit Name: 9b5a6ec4e4a248b42892f4a8b7efc8a9a25630f7</div><div id='time'> Time: 2020-12-14</div><div id='author'> Author: 1318829605@qq.com</div><div id='file'> File Name: textbox/module/Generator/LeakGANGenerator.py</div><div id='m_class'> M Class Name: LeakGANGenerator</div><div id='n_method'> N Class Name: LeakGANGenerator</div><div id='m_method'> M Method Name: generate(3)</div><div id='n_method'> N Method Name: generate(3)</div><div id='m_parent_class'> M Parent Class: UnconditionalGenerator</div><div id='n_parent_class'> N Parent Class: UnconditionalGenerator</div><div id='m_file'> M File Name: textbox/module/Generator/LeakGANGenerator.py</div><div id='n_file'> N File Name: textbox/module/Generator/LeakGANGenerator.py</div><div id='m_start'> M Start Line: 303</div><div id='m_end'> M End Line: 318</div><div id='n_start'> N Start Line: 338</div><div id='n_end'> N End Line: 361</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        idx2token = eval_data.idx2token
        
        for b in range(num_batch):
            leak_sample<a id="change">, _, _, _</a> = self.leakgan_forward(fake_sentences, dis, if_sample=True, no_log=False
                                                        , start_letter=self.start_idx, train=False)

            assert leak_sample.shape == (self.batch_size, self.max_length-1)</code></pre><h3>After Change</h3><pre><code class='java'>

        samples = samples[:number_to_gen, :]
        samples = samples.tolist()
        texts = <a id="change">[]</a>
        <a id="change">for </a><a id="change">sen</a> in samples<a id="change">:
            </a>text<a id="change"> = </a>[]
            for w in sen:
                <a id="change">if w != self.end_idx</a>:
                    text.append(idx2token[w])
                else:
                    <a id="change">break</a>
            <a id="change">texts.append(</a>text<a id="change">)</a>
        &#47&#47 samples = [[idx2token[w] for w in sen] for sen in samples]

        <a id="change">return </a>texts
    
    def adversarial_loss(self, dis):
        with torch.no_grad():</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/rucaibox/textbox/commit/f78c75cd5c890e60a063e95617768f9402a1d553#diff-62933681a01584827327c04ae3e95ed02184dc2f518f346a504c8176cd63bcf9L300' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 67223610</div><div id='project'> Project Name: rucaibox/textbox</div><div id='commit'> Commit Name: f78c75cd5c890e60a063e95617768f9402a1d553</div><div id='time'> Time: 2020-12-14</div><div id='author'> Author: 1318829605@qq.com</div><div id='file'> File Name: textbox/module/Generator/LeakGANGenerator.py</div><div id='m_class'> M Class Name: LeakGANGenerator</div><div id='n_method'> N Class Name: LeakGANGenerator</div><div id='m_method'> M Method Name: generate(3)</div><div id='n_method'> N Method Name: generate(3)</div><div id='m_parent_class'> M Parent Class: UnconditionalGenerator</div><div id='n_parent_class'> N Parent Class: UnconditionalGenerator</div><div id='m_file'> M File Name: textbox/module/Generator/LeakGANGenerator.py</div><div id='n_file'> N File Name: textbox/module/Generator/LeakGANGenerator.py</div><div id='m_start'> M Start Line: 303</div><div id='m_end'> M End Line: 318</div><div id='n_start'> N Start Line: 338</div><div id='n_end'> N End Line: 361</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
            &#47&#47 遍历翻译输出字符的下标（注意：开始符"BOS"的索引0不遍历）
            for j in range(1, out.size(1)):
                &#47&#47 获取当前下标的输出字符
                sym = data.cn_index_dict[out[0<a id="change">, j</a>].item()]
                &#47&#47 如果输出字符不为&quotEOS&quot终止符，则添加到当前句子的翻译结果列表
                if sym != &quotEOS&quot:
                    translation.append(sym)</code></pre><h3>After Change</h3><pre><code class='java'>
    在data上用训练好的模型进行预测，打印模型翻译结果
    sp_chn = chinese_tokenizer_load()
    trg = []
    res = <a id="change">[]</a>
    with torch.no_grad():
        &#47&#47 在data的英文数据长度上遍历下标
        <a id="change">for </a><a id="change">batch</a> in tqdm(data)<a id="change">:
            &#47&#47 待翻译的英文句子
            </a>en_sent = batch.src_text
            &#47&#47 对应的中文句子
            cn_sent = batch.trg_text
            &#47&#47 打印模型翻译输出的中文句子结果
            for i in range(len(en_sent)):
                src = batch.src[i]
                &#47&#47 增加一维
                src = src.unsqueeze(0)
                &#47&#47 设置attention mask
                src_mask = (src != 0).unsqueeze(-2)
                &#47&#47 用训练好的模型进行decode预测
                decode_result<a id="change"> = </a>greedy_decode(model, src, src_mask,
                                              max_len=config.max_len).squeeze().tolist()
                &#47&#47 模型翻译结果解码
                translation = sp_chn.decode_ids(decode_result)
                trg.append(cn_sent[i])
                <a id="change">res.append(</a>translation<a id="change">)</a>
                <a id="change">if i == 3</a>:
                    <a id="change">break</a>
    res = [res]
    bleu = sacrebleu.corpus_bleu(trg, res)
    <a id="change">return </a>float(bleu.score)


def test(data, model, criterion):</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/hemingkx/chinesenmt/commit/9adf53cb6d9b875c9d173643a8d266d49d6f90eb#diff-ed183d67207df065a11e1289f19d34cc2abbc5448dea952683cfe9728c342b95L46' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 67223612</div><div id='project'> Project Name: hemingkx/chinesenmt</div><div id='commit'> Commit Name: 9adf53cb6d9b875c9d173643a8d266d49d6f90eb</div><div id='time'> Time: 2020-12-15</div><div id='author'> Author: hemingkx@gmail.com</div><div id='file'> File Name: train.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: evaluate(2)</div><div id='n_method'> N Method Name: evaluate(2)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: train.py</div><div id='n_file'> N File Name: train.py</div><div id='m_start'> M Start Line: 53</div><div id='m_end'> M End Line: 84</div><div id='n_start'> N Start Line: 67</div><div id='n_end'> N End Line: 95</div><BR>