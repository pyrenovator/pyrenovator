<html><h3>Pattern ID :39739
</h3><img src='113204057.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
        mean_over = [x for x in range(len(loss_mat.shape))]
        loss_mat = loss_mat.mean(dim=mean_over[:-2])

        if <a id="change">self.hungarian</a>:
            raise NotImplementedError
        else:
             &#47&#47 fast pit --&gt; trades speed for memory here.... might as well also do the opposite
             loss = None
             assigned_perm<a id="change"> = None</a>
             <a id="change">for </a>p in permutations(range(n_sources))<a id="change">:
                 </a>c_loss = loss_mat[range(n_sources), p].mean()
                 <a id="change">if loss is None</a> or loss &gt; c_loss:
                     loss<a id="change"> = </a>c_loss
                     assigned_perm<a id="change"> = p</a>
             return loss, assigned_perm

    def forward(self, preds, targets):
        losses = []</code></pre><h3>After Change</h3><pre><code class='java'>
        target = target.unsqueeze(-1).repeat(1, *[1 for x in range(len(target.shape)-1)], n_sources)

        loss_mat = self.base_loss(pred, target)
        <a id="change">assert </a>len(loss_mat.shape) &gt;= 2, "Base loss should not perform any reduction operation"
        mean_over = [x for x in range(len(loss_mat.shape))]
        loss_mat = loss_mat.mean(dim=mean_over[:-2])
</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 7</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/speechbrain/speechbrain/commit/84b632ff28d516bccd44a675751fbe3b46aac51f#diff-dacadc87130a104a9b34b5d369c53e34f52662470ff3e0d91783d3ede95fee82L87' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 113204057</div><div id='project'> Project Name: speechbrain/speechbrain</div><div id='commit'> Commit Name: 84b632ff28d516bccd44a675751fbe3b46aac51f</div><div id='time'> Time: 2020-06-22</div><div id='author'> Author: cornellsamuele@gmail.com</div><div id='file'> File Name: speechbrain/nnet/losses.py</div><div id='m_class'> M Class Name: PitWrapper</div><div id='n_method'> N Class Name: PitWrapper</div><div id='m_method'> M Method Name: _opt_perm_loss(3)</div><div id='n_method'> N Method Name: _opt_perm_loss(3)</div><div id='m_parent_class'> M Parent Class: nn.Module</div><div id='n_parent_class'> N Parent Class: nn.Module</div><div id='m_file'> M File Name: speechbrain/nnet/losses.py</div><div id='n_file'> N File Name: speechbrain/nnet/losses.py</div><div id='m_start'> M Start Line: 222</div><div id='m_end'> M End Line: 243</div><div id='n_start'> N Start Line: 87</div><div id='n_end'> N End Line: 95</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        egress_cost = 0.0
        overall_best = None
        best_plan = {}
        while <a id="change">True</a>:
            best_costs = dp_best_cost[node]
            h, c = None, np.inf
            <a id="change">for resources</a> in best_costs<a id="change">:
                if best_costs[resources] &lt; c</a>:
                    h<a id="change"> = </a>resources
                    c<a id="change"> = </a>best_costs[resources]
            if not isinstance(h, DummyResources):
                message_data.append((node, h))
                best_plan[node] = (h, c)
                node.best_resources = h
            elif overall_best is None:
                overall_best<a id="change"> = </a>c
            if node not in dp_point_backs:
                break
            egress_cost = dp_point_backs[node][h][2]</code></pre><h3>After Change</h3><pre><code class='java'>
        node = topo_order[-1]
        &#47&#47 Find the best (hardware, cost) for node.
        best_costs = dp_best_cost[node]
        <a id="change">assert </a>len(best_costs) == 1, f&quotShould be DummyCloud: {best_costs}&quot
        h, overall_best = list(best_costs.items())[0]
        _walk(node, h, overall_best)
</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/skypilot-org/skypilot/commit/87c6f76b628db89e65db669ed8375eac2714f1c2#diff-29e1580cd3110f2187424743b65ddc99b9765416938cba77e17c26d4f4cad76dL239' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 113204056</div><div id='project'> Project Name: skypilot-org/skypilot</div><div id='commit'> Commit Name: 87c6f76b628db89e65db669ed8375eac2714f1c2</div><div id='time'> Time: 2021-11-03</div><div id='author'> Author: concretevitamin@users.noreply.github.com</div><div id='file'> File Name: prototype/sky/optimizer.py</div><div id='m_class'> M Class Name: Optimizer</div><div id='n_method'> N Class Name: Optimizer</div><div id='m_method'> M Method Name: read_optimized_plan(4)</div><div id='n_method'> N Method Name: read_optimized_plan(4)</div><div id='m_parent_class'> M Parent Class: object</div><div id='n_parent_class'> N Parent Class: object</div><div id='m_file'> M File Name: prototype/sky/optimizer.py</div><div id='n_file'> N File Name: prototype/sky/optimizer.py</div><div id='m_start'> M Start Line: 242</div><div id='m_end'> M End Line: 274</div><div id='n_start'> N Start Line: 247</div><div id='n_end'> N End Line: 284</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        mean_over = [x for x in range(len(loss_mat.shape))]
        loss_mat = loss_mat.mean(dim=mean_over[:-2])

        if <a id="change">self.hungarian</a>:
            raise NotImplementedError
        else:
             &#47&#47 fast pit --&gt; trades speed for memory here.... might as well also do the opposite
             loss = None
             assigned_perm<a id="change"> = </a>None
             <a id="change">for p</a> in permutations(range(n_sources))<a id="change">:
                 </a>c_loss = loss_mat[range(n_sources), p].mean()
                 <a id="change">if loss is None</a> or loss &gt; c_loss:
                     loss<a id="change"> = </a>c_loss
                     assigned_perm<a id="change"> = </a>p
             return loss, assigned_perm

    def forward(self, preds, targets):</code></pre><h3>After Change</h3><pre><code class='java'>
        target = target.unsqueeze(-1).repeat(1, *[1 for x in range(len(target.shape)-1)], n_sources)

        loss_mat = self.base_loss(pred, target)
        <a id="change">assert </a>len(loss_mat.shape) &gt;= 2, "Base loss should not perform any reduction operation"
        mean_over = [x for x in range(len(loss_mat.shape))]
        loss_mat = loss_mat.mean(dim=mean_over[:-2])
</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/speechbrain/speechbrain/commit/945aa944678b0aed98c1d86bfe67f74a9df58c6a#diff-dacadc87130a104a9b34b5d369c53e34f52662470ff3e0d91783d3ede95fee82L220' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 113204054</div><div id='project'> Project Name: speechbrain/speechbrain</div><div id='commit'> Commit Name: 945aa944678b0aed98c1d86bfe67f74a9df58c6a</div><div id='time'> Time: 2020-06-22</div><div id='author'> Author: cornellsamuele@gmail.com</div><div id='file'> File Name: speechbrain/nnet/losses.py</div><div id='m_class'> M Class Name: PitWrapper</div><div id='n_method'> N Class Name: PitWrapper</div><div id='m_method'> M Method Name: _opt_perm_loss(3)</div><div id='n_method'> N Method Name: _opt_perm_loss(3)</div><div id='m_parent_class'> M Parent Class: nn.Module</div><div id='n_parent_class'> N Parent Class: nn.Module</div><div id='m_file'> M File Name: speechbrain/nnet/losses.py</div><div id='n_file'> N File Name: speechbrain/nnet/losses.py</div><div id='m_start'> M Start Line: 222</div><div id='m_end'> M End Line: 243</div><div id='n_start'> N Start Line: 87</div><div id='n_end'> N End Line: 95</div><BR>