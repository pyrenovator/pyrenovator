<html><h3>Pattern ID :10052
</h3><img src='35741025.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
class TestOps(unittest.TestCase):
  def test_conv2d(self):
    x = torch.randn((5,2,10,7), requires_grad=True)
    w<a id="change"> = </a>torch.randn((4,2,3,2), requires_grad=True)
    xt = Tensor(x.detach().numpy())
    wt = Tensor(w.detach().numpy())

    out<a id="change"> = </a>torch.nn.functional.conv2d(x,w)
    ret<a id="change"> = </a>Tensor.conv2d(xt, wt)
    <a id="change">np.testing.assert_allclose(</a>ret.data, out.detach().numpy()<a id="change">, atol=1e-5)</a>

    out.mean().backward()
    ret.mean().backward()

    <a id="change">np.testing.assert_allclose(</a>w.grad, wt.grad<a id="change">, atol=1e-7)</a>
    np.testing.assert_allclose(x.grad, xt.grad, atol=1e-7)

  def test_maxpool2x2(self):
    x = torch.randn((5,2,10,8), requires_grad=True)</code></pre><h3>After Change</h3><pre><code class='java'>
      for H in [2,3,5]:
        for W in [2,3,5]:
          x = torch.randn((5,cin,10,7), requires_grad=True)
          w<a id="change"> = </a>torch.randn((4,cin,H,W), requires_grad=True)
          xt = Tensor(x.detach().numpy())
          wt = Tensor(w.detach().numpy())

          out<a id="change"> = </a>torch.nn.functional.conv2d(x,w)
          ret<a id="change"> = </a>Tensor.conv2d(xt, wt)
          <a id="change">np.testing.assert_allclose(</a>ret.data, out.detach().numpy()<a id="change">, atol=1e-5)</a>

          out.mean().backward()
          ret.mean().backward()

          <a id="change">np.testing.assert_allclose(</a>w.grad, wt.grad<a id="change">, atol=1e-7)</a>
          np.testing.assert_allclose(x.grad, xt.grad, atol=1e-7)

  def test_maxpool2x2(self):
    x = torch.randn((5,2,10,8), requires_grad=True)</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 10</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/geohot/tinygrad/commit/bb98cdfef78d52be96e21671a3d47f45ec1bd687#diff-98e9ed497a31001f04d452d03071386292b0bab5ea322a540f4b7d3a7930de24L69' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 35741025</div><div id='project'> Project Name: geohot/tinygrad</div><div id='commit'> Commit Name: bb98cdfef78d52be96e21671a3d47f45ec1bd687</div><div id='time'> Time: 2020-10-25</div><div id='author'> Author: geohot@gmail.com</div><div id='file'> File Name: test/test_tensor.py</div><div id='m_class'> M Class Name: TestOps</div><div id='n_method'> N Class Name: TestOps</div><div id='m_method'> M Method Name: test_conv2d(1)</div><div id='n_method'> N Method Name: test_conv2d(1)</div><div id='m_parent_class'> M Parent Class: unittest.TestCase</div><div id='n_parent_class'> N Parent Class: unittest.TestCase</div><div id='m_file'> M File Name: test/test_tensor.py</div><div id='n_file'> N File Name: test/test_tensor.py</div><div id='m_start'> M Start Line: 69</div><div id='m_end'> M End Line: 82</div><div id='n_start'> N Start Line: 69</div><div id='n_end'> N End Line: 87</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        graph = torch._C.parse_ir(graph_str)

        with kernel_arena_scope():
            kernel<a id="change"> = </a>torch._C._te.TensorExprKernel(graph)
            res1<a id="change"> = </a>kernel.run((x, y, z))
            res2<a id="change"> = </a>kernel.fallback((x, y, z))
            correct = f(x, y, z)
            <a id="change">np.testing.assert_allclose(</a>res1.numpy(), correct.numpy()<a id="change">, atol=2e-3)</a>
            <a id="change">np.testing.assert_allclose(</a>res2.numpy(), correct.numpy()<a id="change">, atol=2e-3)</a>

if __name__ == &quot__main__&quot:
    run_tests()
</code></pre><h3>After Change</h3><pre><code class='java'>
        
        graph = torch._C.parse_ir(graph_str)

        kernel<a id="change"> = </a>torch._C._te.TensorExprKernel(graph)
        res1<a id="change"> = </a>kernel.run((x, y, z))
        res2<a id="change"> = </a>kernel.fallback((x, y, z))
        correct = f(x, y, z)
        <a id="change">np.testing.assert_allclose(</a>res1.numpy(), correct.numpy()<a id="change">, atol=2e-3)</a>
        <a id="change">np.testing.assert_allclose(</a>res2.numpy(), correct.numpy()<a id="change">, atol=2e-3)</a>

    @unittest.skipIf(not LLVM_ENABLED, "LLVM backend not enabled")
    def test_kernel_shape_prop(self):
        device, size = &quotcpu&quot, (4, 4)</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/pytorch/pytorch/commit/3ad3d8bd3fa98b2e9ec330dd459de6e1a32f3e0d#diff-62b118433342a171a7e0645e0336aefe5b130ee3677ed2ca7d036658dbf769f5L96' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 35740992</div><div id='project'> Project Name: pytorch/pytorch</div><div id='commit'> Commit Name: 3ad3d8bd3fa98b2e9ec330dd459de6e1a32f3e0d</div><div id='time'> Time: 2021-05-03</div><div id='author'> Author: mvz@fb.com</div><div id='file'> File Name: test/test_tensorexpr_pybind.py</div><div id='m_class'> M Class Name: TestTensorExprPyBind</div><div id='n_method'> N Class Name: TestTensorExprPyBind</div><div id='m_method'> M Method Name: test_kernel_with_scalar_inputs(1)</div><div id='n_method'> N Method Name: test_kernel_with_scalar_inputs(1)</div><div id='m_parent_class'> M Parent Class: JitTestCase</div><div id='n_parent_class'> N Parent Class: JitTestCase</div><div id='m_file'> M File Name: test/test_tensorexpr_pybind.py</div><div id='n_file'> N File Name: test/test_tensorexpr_pybind.py</div><div id='m_start'> M Start Line: 114</div><div id='m_end'> M End Line: 121</div><div id='n_start'> N Start Line: 112</div><div id='n_end'> N End Line: 117</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        graph = torch._C.parse_ir(graph_str)

        with kernel_arena_scope():
            kernel<a id="change"> = </a>torch._C._te.TensorExprKernel(graph)
            res1<a id="change"> = </a>kernel.run((x, y, z))
            res2<a id="change"> = </a>kernel.fallback((x, y, z))
            correct = f(x, y, z)
            <a id="change">np.testing.assert_allclose(</a>res1.numpy(), correct.numpy()<a id="change">, atol=2e-3)</a>
            <a id="change">np.testing.assert_allclose(</a>res2.numpy(), correct.numpy()<a id="change">, atol=2e-3)</a>


    @unittest.skipIf(not LLVM_ENABLED, "LLVM backend not enabled")
    def test_kernel_with_scalar_inputs(self):</code></pre><h3>After Change</h3><pre><code class='java'>
        
        graph = torch._C.parse_ir(graph_str)

        kernel<a id="change"> = </a>torch._C._te.TensorExprKernel(graph)
        res1<a id="change"> = </a>kernel.run((x, y, z))
        res2<a id="change"> = </a>kernel.fallback((x, y, z))
        correct = f(x, y, z)
        <a id="change">np.testing.assert_allclose(</a>res1.numpy(), correct.numpy()<a id="change">, atol=2e-3)</a>
        <a id="change">np.testing.assert_allclose(</a>res2.numpy(), correct.numpy()<a id="change">, atol=2e-3)</a>

    @unittest.skipIf(not LLVM_ENABLED, "LLVM backend not enabled")
    def test_kernel_with_scalar_inputs(self):
        def f(a, b, c):</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/pytorch/pytorch/commit/3ad3d8bd3fa98b2e9ec330dd459de6e1a32f3e0d#diff-62b118433342a171a7e0645e0336aefe5b130ee3677ed2ca7d036658dbf769f5L67' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 35741019</div><div id='project'> Project Name: pytorch/pytorch</div><div id='commit'> Commit Name: 3ad3d8bd3fa98b2e9ec330dd459de6e1a32f3e0d</div><div id='time'> Time: 2021-05-03</div><div id='author'> Author: mvz@fb.com</div><div id='file'> File Name: test/test_tensorexpr_pybind.py</div><div id='m_class'> M Class Name: TestTensorExprPyBind</div><div id='n_method'> N Class Name: TestTensorExprPyBind</div><div id='m_method'> M Method Name: test_kernel_with_tensor_inputs(1)</div><div id='n_method'> N Method Name: test_kernel_with_tensor_inputs(1)</div><div id='m_parent_class'> M Parent Class: JitTestCase</div><div id='n_parent_class'> N Parent Class: JitTestCase</div><div id='m_file'> M File Name: test/test_tensorexpr_pybind.py</div><div id='n_file'> N File Name: test/test_tensorexpr_pybind.py</div><div id='m_start'> M Start Line: 86</div><div id='m_end'> M End Line: 95</div><div id='n_start'> N Start Line: 86</div><div id='n_end'> N End Line: 91</div><BR>