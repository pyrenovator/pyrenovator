<html><h3>Pattern ID :8999
</h3><img src='32864996.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>

        for l, (gru_cell, hid_dp) in enumerate(zip(self.cell_list, self.hidden_dps)):
            h = hidden_state[l]
            <a id="change">output_inner = </a><a id="change">[]</a>
            <a id="change">for t</a> in <a id="change">range(</a>seq_len<a id="change">)</a><a id="change">:
                </a>h = gru_cell(input=cur_layer_input[t], h_prev=h)
                <a id="change">output_inner.append(</a>h<a id="change">)</a>

            cur_layer_input<a id="change"> = </a><a id="change">torch.stack(output_inner</a><a id="change">)</a>  &#47&#47 list to array
            if l != self.n_layers:
                cur_layer_input = hid_dp(cur_layer_input)
            last_state_list.append(h)</code></pre><h3>After Change</h3><pre><code class='java'>
            New tensor plus the new state
        
        &#47&#47 Concatenate the inputs and previous state along the channel axis.
        num_channels = <a id="change">prev_state.shape[1]</a>
        xh = torch.cat([x, prev_state], dim=1)

        &#47&#47 Read gate of the GRU.
        read_gate_conv = layers.SNConv2D(</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 8</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/openclimatefix/skillful_nowcasting/commit/94b4812a28104192d6f14fa06317cf1a73e732e4#diff-cee00a565d888c684ec40bd3eac27669aa3223b223a80ae9f871383a9fb64917L31' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 32864996</div><div id='project'> Project Name: openclimatefix/skillful_nowcasting</div><div id='commit'> Commit Name: 94b4812a28104192d6f14fa06317cf1a73e732e4</div><div id='time'> Time: 2021-11-08</div><div id='author'> Author: jacob@bieker.tech</div><div id='file'> File Name: nowcasting_gan/layers/ConvGRU.py</div><div id='m_class'> M Class Name: ConvGRU</div><div id='n_method'> N Class Name: ConvGRU</div><div id='m_method'> M Method Name: forward(3)</div><div id='n_method'> N Method Name: forward(3)</div><div id='m_parent_class'> M Parent Class: torch.nn.Module</div><div id='n_parent_class'> N Parent Class: nn.Module</div><div id='m_file'> M File Name: nowcasting_gan/layers/ConvGRU.py</div><div id='n_file'> N File Name: nowcasting_gan/layers/ConvGRU.py</div><div id='m_start'> M Start Line: 196</div><div id='m_end'> M End Line: 221</div><div id='n_start'> N Start Line: 31</div><div id='n_end'> N End Line: 54</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        q_loss = (q_delta * sampling_weigths).mean()

        bg_mask = 1 - obs["fg_mask"]
        <a id="change">q_bg_pred = </a><a id="change">[]</a>
        <a id="change">for b</a> in <a id="change">range(</a>bg_mask.shape[0]<a id="change">)</a><a id="change">:
            </a>y, x = torch.where(bg_mask[b])
            i = torch.randint(low=0, high=len(y), size=()).item()
            <a id="change">q_bg_pred.append(</a>qs_pred[b, 0, y[i], x[i]]<a id="change">)</a>
        q_bg_pred<a id="change"> = </a><a id="change">torch.stack(</a>q_bg_pred<a id="change">)</a>
        q_bg_delta = torch.nn.functional.smooth_l1_loss(
            q_bg_pred,
            torch.zeros_like(q_bg_pred),
            reduction="none",</code></pre><h3>After Change</h3><pre><code class='java'>

        q_bg_delta = torch.nn.functional.smooth_l1_loss(
            qs_pred[:, 0] * (1 - obs["fg_mask"].float()),
            <a id="change">torch.zeros_like(qs_pred)[:, 0]</a>,
            reduction="none",
        ).mean(dim=(1, 2))
        q_bg_loss = (q_bg_delta * sampling_weigths).mean()</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/wkentaro/safepicking/commit/da3dc0dab7349f8d66d960e74177c69c60f594b6#diff-3a019c87efc0a2b3b3b7b4fc42dbe7ba183756b75362d92dbc72eab8953b42c6L173' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 32864993</div><div id='project'> Project Name: wkentaro/safepicking</div><div id='commit'> Commit Name: da3dc0dab7349f8d66d960e74177c69c60f594b6</div><div id='time'> Time: 2021-05-07</div><div id='author'> Author: www.kentaro.wada@gmail.com</div><div id='file'> File Name: examples/grasp_with_intent/agent.py</div><div id='m_class'> M Class Name: DqnAgent</div><div id='n_method'> N Class Name: DqnAgent</div><div id='m_method'> M Method Name: _update_q(2)</div><div id='n_method'> N Method Name: _update_q(2)</div><div id='m_parent_class'> M Parent Class: Agent</div><div id='n_parent_class'> N Parent Class: Agent</div><div id='m_file'> M File Name: examples/grasp_with_intent/agent.py</div><div id='n_file'> N File Name: examples/grasp_with_intent/agent.py</div><div id='m_start'> M Start Line: 182</div><div id='m_end'> M End Line: 232</div><div id='n_start'> N Start Line: 182</div><div id='n_end'> N End Line: 225</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>

        for l, (gru_cell, hid_dp) in enumerate(zip(self.cell_list, self.hidden_dps)):
            h = hidden_state[l]
            <a id="change">output_inner = </a><a id="change">[]</a>
            <a id="change">for t</a> in <a id="change">range(</a>seq_len<a id="change">)</a><a id="change">:
                </a>h = gru_cell(input=cur_layer_input[t], h_prev=h)
                <a id="change">output_inner.append(</a>h<a id="change">)</a>

            cur_layer_input = <a id="change">torch.stack(</a>output_inner<a id="change">)</a>  &#47&#47 list to array
            if l != self.n_layers:
                cur_layer_input<a id="change"> = </a>hid_dp(cur_layer_input)
            last_state_list.append(h)

        layer_output = torch.stack(output_inner, dim=int(self.batch_first))</code></pre><h3>After Change</h3><pre><code class='java'>
            New tensor plus the new state
        
        &#47&#47 Concatenate the inputs and previous state along the channel axis.
        num_channels = <a id="change">prev_state.shape[1]</a>
        xh = torch.cat([x, prev_state], dim=1)

        &#47&#47 Read gate of the GRU.
        read_gate_conv = layers.SNConv2D(</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/openclimatefix/skillful_nowcasting/commit/94b4812a28104192d6f14fa06317cf1a73e732e4#diff-cee00a565d888c684ec40bd3eac27669aa3223b223a80ae9f871383a9fb64917L185' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 32864994</div><div id='project'> Project Name: openclimatefix/skillful_nowcasting</div><div id='commit'> Commit Name: 94b4812a28104192d6f14fa06317cf1a73e732e4</div><div id='time'> Time: 2021-11-08</div><div id='author'> Author: jacob@bieker.tech</div><div id='file'> File Name: nowcasting_gan/layers/ConvGRU.py</div><div id='m_class'> M Class Name: ConvGRU</div><div id='n_method'> N Class Name: ConvGRU</div><div id='m_method'> M Method Name: forward(3)</div><div id='n_method'> N Method Name: forward(3)</div><div id='m_parent_class'> M Parent Class: torch.nn.Module</div><div id='n_parent_class'> N Parent Class: nn.Module</div><div id='m_file'> M File Name: nowcasting_gan/layers/ConvGRU.py</div><div id='n_file'> N File Name: nowcasting_gan/layers/ConvGRU.py</div><div id='m_start'> M Start Line: 196</div><div id='m_end'> M End Line: 221</div><div id='n_start'> N Start Line: 31</div><div id='n_end'> N End Line: 54</div><BR>