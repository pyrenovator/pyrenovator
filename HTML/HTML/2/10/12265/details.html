<html><h3>Pattern ID :12265
</h3><img src='41610107.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
                ])
                old_model.load_weights(weights)
                &#47&#47 Remove prediction layers
                old_model<a id="change"> = </a><a id="change">old_model.layers[:-1]</a>[0]
                old_model.save_weights(weights_notop)

            &#47&#47 Load model weights with no top</code></pre><h3>After Change</h3><pre><code class='java'>
    
    if weights == "cytoimagenet":
        &#47&#47 Specify number of classes based on dset
        <a id="change">if dset == &quottoy_20&quot</a>:
            num_classes<a id="change"> = </a>20
        elif dset == &quottoy_50&quot:
            num_classes<a id="change"> = </a>50
        else:
            num_classes<a id="change"> = </a>894

        &#47&#47 Load weights
        weights_str = f"{weights_dir}/{init}_init/{dset}/{weights_filename}"</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 8</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/stan-hua/cytoimagenet/commit/58d66c4cc6eed607192ce85534d29f8f8ca9fee4#diff-202824684bac175f9853e38480cec450ea0e7f2d7d85a167cfb0a2f593213726L67' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 41610107</div><div id='project'> Project Name: stan-hua/cytoimagenet</div><div id='commit'> Commit Name: 58d66c4cc6eed607192ce85534d29f8f8ca9fee4</div><div id='time'> Time: 2021-08-23</div><div id='author'> Author: stanley.hua@mail.utoronto.ca</div><div id='file'> File Name: scripts/model_evaluation.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: load_model(4)</div><div id='n_method'> N Method Name: load_model(1)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: scripts/model_evaluation.py</div><div id='n_file'> N File Name: scripts/model_evaluation.py</div><div id='m_start'> M Start Line: 67</div><div id='m_end'> M End Line: 123</div><div id='n_start'> N Start Line: 68</div><div id='n_end'> N End Line: 125</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
    @staticmethod
    def parse_name(name: str, pretrained_dataset: str = &quotM&quot, layer: int = 50) -&gt; tuple[str, str, int]:
        if name[:3] == &quotbit&quot:
            name = &quotBiT&quot + <a id="change">name[3:]</a>
        full_name_list: list[str] = re.findall(r&quot[0-9]+|[A-Za-z]+|_&quot, name)
        name_list = full_name_list[0].split(&quot-&quot)
        if len(name_list) == 1:
            name_list.append(pretrained_dataset)
            name_list.append(&quotR&quot)
        elif len(name_list) == 2:
            if name_list[1] == &quotR&quot:
                name_list.insert(1, pretrained_dataset)
            else:
                name_list.append(&quotR&quot)
        name_list[1] = name_list[1].upper()
        name_list[2]<a id="change"> = </a>name_list[2].upper()
        assert name_list[1] in [&quotS&quot, &quotM&quot, &quotL&quot] and name_list[2] == &quotR&quot, name
        pretrained_dataset = name_list[1]
        layer = int(name_list[3])</code></pre><h3>After Change</h3><pre><code class='java'>
        assert name_list[0] == &quotbit&quot
        if len(name_list) != 1:
            for element in name_list[1:]:
                <a id="change">if element[0] == &quotr&quot</a>:
                    sub_list = element[1:].split(&quotx&quot)
                    layer<a id="change"> = </a>int(sub_list[0])
                    if len(sub_list) == 2:
                        width_factor<a id="change"> = </a>int(sub_list[1])
                else:
                    assert len(element) == 1
                    pretrained_dataset<a id="change"> = </a>element
        return &quot-&quot.join([&quotbit&quot, pretrained_dataset, f&quotr{layer:d}x{width_factor:d}&quot])

    def get_official_weights(self, **kwargs) -&gt; OrderedDict[str, torch.Tensor]:</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/ain-soph/trojanzoo/commit/d1791a5d2011850d8796399912be84c49dd5e788#diff-4c3e42eb0c5012429d8a52fae551eaa3029b50408e5b3f7c99b9e5a17a76698eL48' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 41610110</div><div id='project'> Project Name: ain-soph/trojanzoo</div><div id='commit'> Commit Name: d1791a5d2011850d8796399912be84c49dd5e788</div><div id='time'> Time: 2021-04-06</div><div id='author'> Author: ain-soph@live.com</div><div id='file'> File Name: trojanvision/models/bit.py</div><div id='m_class'> M Class Name: BiT</div><div id='n_method'> N Class Name: BiT</div><div id='m_method'> M Method Name: parse_name(4)</div><div id='n_method'> N Method Name: parse_name(3)</div><div id='m_parent_class'> M Parent Class: ImageModel</div><div id='n_parent_class'> N Parent Class: ImageModel</div><div id='m_file'> M File Name: trojanvision/models/bit.py</div><div id='n_file'> N File Name: trojanvision/models/bit.py</div><div id='m_start'> M Start Line: 49</div><div id='m_end'> M End Line: 67</div><div id='n_start'> N Start Line: 48</div><div id='n_end'> N End Line: 61</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
    
    shape = distogram.shape
    n_bins = torch.ones(shape[-1] + 1) * min_t
    <a id="change">n_bins[1:]</a> = torch.tensor(bins)
    &#47&#47 center - median
    cum_dist = torch.cumsum(distogram, dim=-1)
    central  = torch.searchsorted(cum_dist, 0.5)
    for i in range(shape[-1]):
        central[central==i] = (n_bins[i]+n_bins[i+1])/2
    &#47&#47 mask diagonal to 0 dist
    central[np.arange(shape[-2]), np.arange(shape[-3])] = 0.
    &#47&#47 provide weights
    weights<a id="change"> = </a>torch.ones_like(central)
    return central, weights

def mds_torch(dist_mat, weights=None, iters=10, tol=1e-5, verbose=2):</code></pre><h3>After Change</h3><pre><code class='java'>
    &#47&#47 mask diagonal to 0 dist
    central[np.arange(shape[-2]), np.arange(shape[-3])] = 0.
    &#47&#47 provide weights
    <a id="change">if wide == "var"</a>:
        weights<a id="change"> = </a>(distogram * (bins - central.unsqueeze(-1))**2).sum(dim=-1)
    elif wide == "sqrt":
        weights<a id="change"> = </a>(distogram * (bins - central.unsqueeze(-1))**2).sum(dim=-1).sqrt()
    else:
        weights<a id="change"> = </a>torch.zeros_like(central)
    &#47&#47 rescale to 0-1. lower std / var  --&gt; weight=1
    weights = 1 / (1+weights)
    &#47&#47 TODO: rescale to 0-1?</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/lucidrains/alphafold2/commit/5013886fc413e143b7f3341db644d320a11c3804#diff-09d0cbaf891d623ac245ccf84485a687b554217349ca55557c60b33234b969aeL110' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 41610227</div><div id='project'> Project Name: lucidrains/alphafold2</div><div id='commit'> Commit Name: 5013886fc413e143b7f3341db644d320a11c3804</div><div id='time'> Time: 2021-01-14</div><div id='author'> Author: ericacaide1@gmail.com</div><div id='file'> File Name: utils.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: center_distogram_torch(5)</div><div id='n_method'> N Method Name: center_distogram_torch(3)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: utils.py</div><div id='n_file'> N File Name: utils.py</div><div id='m_start'> M Start Line: 119</div><div id='m_end'> M End Line: 130</div><div id='n_start'> N Start Line: 110</div><div id='n_end'> N End Line: 139</div><BR>