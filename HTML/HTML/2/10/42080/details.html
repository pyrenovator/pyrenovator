<html><h3>Pattern ID :42080
</h3><img src='117848070.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>

    &#47&#47Build description
    text = ""
    <a id="change">for </a>i, <a id="change">obj</a> in <a id="change">enumerate(</a>cell_objects<a id="change">):
        </a>color_dists = np.linalg.norm(COLORS - obj.color, axis=1)
        color_text = COLOR_NAMES[np.argmin(color_dists)]

        direction_diffs = np.linalg.norm(obj.center_in_cell[0:2] - DIRECTIONS, axis=1)
        direction<a id="change"> = DIRECTION_NAMES[np.argmin(direction_diffs)]</a>

        <a id="change">if </a>i==0:
            text += "In this cell there is a "
        else:
            text<a id="change"> += </a>" and a "
        text<a id="change"> += </a>f&quot{color_text} {obj.label} in the {direction}&quot
    text += "."

    return {&quotobjects&quot: cell_objects, &quotbbox&quot: cell_bbox, &quotdescription&quot: text}</code></pre><h3>After Change</h3><pre><code class='java'>
    &#47&#47     text += f&quot{color_text} {obj.label} in the {direction}&quot
    &#47&#47 text += "."

    <a id="change">return </a>{&quotobjects&quot: cell_objects, &quotbbox&quot: cell_bbox}</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 9</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/mako443/text2pos-cvpr2022/commit/35959fb96e722793a8c9dcf686c19f3389b5dae0#diff-769b348a5f9d621461dca17a8881f831a9566baed84d109e4248022f94c1e617L124' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 117848070</div><div id='project'> Project Name: mako443/text2pos-cvpr2022</div><div id='commit'> Commit Name: 35959fb96e722793a8c9dcf686c19f3389b5dae0</div><div id='time'> Time: 2021-03-04</div><div id='author'> Author: manuel.kolmet@gmail.com</div><div id='file'> File Name: datapreparation/descriptions.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: describe_cell(4)</div><div id='n_method'> N Method Name: describe_cell(4)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: datapreparation/descriptions.py</div><div id='n_file'> N File Name: datapreparation/descriptions.py</div><div id='m_start'> M Start Line: 124</div><div id='m_end'> M End Line: 164</div><div id='n_start'> N Start Line: 133</div><div id='n_end'> N End Line: 164</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        cur_layer_input = torch.unbind(input, dim=int(self.batch_first))

        if hidden_state is None:
            <a id="change">hidden_state</a> = self.get_init_states(cur_layer_input[0])

        seq_len = len(cur_layer_input)

        layer_output_list = []
        last_state_list = []

        <a id="change">for l</a>, (gru_cell, hid_dp) in <a id="change">enumerate(</a>zip(self.cell_list, self.hidden_dps)<a id="change">):
            </a>h<a id="change"> = hidden_state[l]</a>
            output_inner = []
            for t in range(seq_len):
                h<a id="change"> = </a>gru_cell(input=cur_layer_input[t], h_prev=h)
                output_inner.append(h)

            cur_layer_input = torch.stack(output_inner)  &#47&#47 list to array
            <a id="change">if </a>l != self.n_layers:
                cur_layer_input<a id="change"> = </a>hid_dp(cur_layer_input)
            last_state_list.append(h)

        layer_output = torch.stack(output_inner, dim=int(self.batch_first))</code></pre><h3>After Change</h3><pre><code class='java'>
        out = update_gate * prev_state + (1. - update_gate) * c
        new_state = out

        <a id="change">return </a>out, new_state
</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/openclimatefix/skillful_nowcasting/commit/94b4812a28104192d6f14fa06317cf1a73e732e4#diff-cee00a565d888c684ec40bd3eac27669aa3223b223a80ae9f871383a9fb64917L185' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 117848038</div><div id='project'> Project Name: openclimatefix/skillful_nowcasting</div><div id='commit'> Commit Name: 94b4812a28104192d6f14fa06317cf1a73e732e4</div><div id='time'> Time: 2021-11-08</div><div id='author'> Author: jacob@bieker.tech</div><div id='file'> File Name: nowcasting_gan/layers/ConvGRU.py</div><div id='m_class'> M Class Name: ConvGRU</div><div id='n_method'> N Class Name: ConvGRU</div><div id='m_method'> M Method Name: forward(3)</div><div id='n_method'> N Method Name: forward(3)</div><div id='m_parent_class'> M Parent Class: torch.nn.Module</div><div id='n_parent_class'> N Parent Class: nn.Module</div><div id='m_file'> M File Name: nowcasting_gan/layers/ConvGRU.py</div><div id='n_file'> N File Name: nowcasting_gan/layers/ConvGRU.py</div><div id='m_start'> M Start Line: 196</div><div id='m_end'> M End Line: 221</div><div id='n_start'> N Start Line: 31</div><div id='n_end'> N End Line: 54</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
                            [-1, 0],
                            [ 0, 0],]) * cell_size/3
    
    <a id="change">DIRECTION_NAMES</a> = [&quotnorth&quot, &quotsouth&quot, &quoteast&quot, &quotwest&quot, &quotcenter&quot]

    cell_mean = np.hstack((0.5*(cell_bbox[0:2] + cell_bbox[2:4]), 0))
    cell_objects = []
    for obj in scene_objects:
        mask = np.bitwise_and.reduce((  obj.points_w[:, 0] &gt;= cell_bbox[0], 
                                        obj.points_w[:, 1] &gt;= cell_bbox[1],
                                        obj.points_w[:, 0] &lt;= cell_bbox[2],
                                        obj.points_w[:, 1] &lt;= cell_bbox[3]))
        points_in_cell = obj.points_w[mask]
        if len(points_in_cell) / len(obj.points_w) &gt;= min_fraction:
            points_in_cell_relative = points_in_cell - cell_mean
            cell_object = CellObject(obj.points_w, points_in_cell_relative, obj.label, obj.id, obj.color, obj.scene_name)
            cell_objects.append(cell_object)

    if len(cell_objects) &lt; min_objects:
        return None

    &#47&#47Build description
    text = ""
    <a id="change">for </a>i, <a id="change">obj</a> in <a id="change">enumerate(</a>cell_objects<a id="change">):
        </a>color_dists = np.linalg.norm(COLORS - obj.color, axis=1)
        color_text = COLOR_NAMES[np.argmin(color_dists)]

        direction_diffs = np.linalg.norm(obj.center_in_cell[0:2] - DIRECTIONS, axis=1)
        direction<a id="change"> = DIRECTION_NAMES[np.argmin(direction_diffs)]</a>

        <a id="change">if </a>i==0:
            text<a id="change"> += </a>"In this cell there is a "
        else:
            text += " and a "
        text<a id="change"> += </a>f&quot{color_text} {obj.label} in the {direction}&quot
    text += "."

    return {&quotobjects&quot: cell_objects, &quotbbox&quot: cell_bbox, &quotdescription&quot: text}</code></pre><h3>After Change</h3><pre><code class='java'>
    &#47&#47     text += f&quot{color_text} {obj.label} in the {direction}&quot
    &#47&#47 text += "."

    <a id="change">return </a>{&quotobjects&quot: cell_objects, &quotbbox&quot: cell_bbox}</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/mako443/text2pos-cvpr2022/commit/35959fb96e722793a8c9dcf686c19f3389b5dae0#diff-769b348a5f9d621461dca17a8881f831a9566baed84d109e4248022f94c1e617L122' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 117848068</div><div id='project'> Project Name: mako443/text2pos-cvpr2022</div><div id='commit'> Commit Name: 35959fb96e722793a8c9dcf686c19f3389b5dae0</div><div id='time'> Time: 2021-03-04</div><div id='author'> Author: manuel.kolmet@gmail.com</div><div id='file'> File Name: datapreparation/descriptions.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: describe_cell(4)</div><div id='n_method'> N Method Name: describe_cell(4)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: datapreparation/descriptions.py</div><div id='n_file'> N File Name: datapreparation/descriptions.py</div><div id='m_start'> M Start Line: 124</div><div id='m_end'> M End Line: 164</div><div id='n_start'> N Start Line: 133</div><div id='n_end'> N End Line: 164</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        return inp

    inp = inp.reshape(ctx.dims.batch, -1, *[ctx.dims.spatial_mixing_kernel] * max_dims, ctx.dims.features)
    <a id="change">original_dims</a> = &quot&quot.join(chr(ord(&quota&quot) + i) for i in range(inp.ndim))
    <a id="change">for </a>i, <a id="change">wgt</a> in <a id="change">enumerate(</a>weights<a id="change">):
        </a>new_dims<a id="change"> = </a>original_dims[:i + 2] + "z" + original_dims[i + 3:]
        reduced_dim<a id="change"> = original_dims[i + 2]</a>
        <a id="change">if </a>i &gt; 0:
            inp<a id="change"> = </a>activate(inp)
        inp = jnp.einsum(f"{original_dims},{reduced_dim}z,{reduced_dim}z-&gt;{new_dims}", inp, wgt, mask)
    return inp.reshape(original_shape)
</code></pre><h3>After Change</h3><pre><code class='java'>
    out = jnp.einsum("bkrf,kg,kg-&gt;bgrf", out, wgt0, mask)
    out = activate(ctx, out)
    out = jnp.einsum("bkrf,kg,kg-&gt;bgrf", out, wgt1, mask)
    <a id="change">return </a>out.reshape(original_shape)
</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/homebrewnlp/homebrewnlp-jax/commit/acfb8d5fbb1ba8f6b7830832f913663e426b9d09#diff-efcd90cee8fb4dad861da47df28097bc6935541500854b8e2d68e0970e05f748L13' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 117848036</div><div id='project'> Project Name: homebrewnlp/homebrewnlp-jax</div><div id='commit'> Commit Name: acfb8d5fbb1ba8f6b7830832f913663e426b9d09</div><div id='time'> Time: 2022-09-01</div><div id='author'> Author: 39779310+ClashLuke@users.noreply.github.com</div><div id='file'> File Name: src/model/mixer.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: mix(3)</div><div id='n_method'> N Method Name: mix(2)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: src/model/mixer.py</div><div id='n_file'> N File Name: src/model/mixer.py</div><div id='m_start'> M Start Line: 14</div><div id='m_end'> M End Line: 32</div><div id='n_start'> N Start Line: 13</div><div id='n_end'> N End Line: 29</div><BR>