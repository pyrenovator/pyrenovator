<html><h3>Pattern ID :3964
</h3><img src='14898147.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
    def distance(a, b):
        a_bbox = a.get_bbox()
        b_bbox = b.get_bbox()
        bbox<a id="change"> = </a>max_bbox([a_bbox, b_bbox])
        area = bbox[2] * bbox[3]
        if not area:
            return 1

        &#47&#47 compute inter-line area, normalize by common bbox
        point_count = max(max(len(a.points) // 2, len(b.points) // 2), 5)
        a<a id="change">, sa</a> = smooth_line(a.points, point_count)
        b, sb = smooth_line(b.points, point_count)
        dists = np.linalg.norm(a - b, axis=1)
        dists = (dists[:-1] + dists[1:]) * 0.5
        s = np.sum(dists) * 0.5 * (sa + sb) / area
        return abs(1<a id="change"> - </a>s)

@attrs
class CaptionsMatcher(AnnotationMatcher):</code></pre><h3>After Change</h3><pre><code class='java'>
            if len(line) // 2 != segments + 1:
                line = approximate_line(line, segments=segments)
            return np.reshape(line, (-1, 2))
        segments = max(len(a.points) // 2, len(b.points) // 2, 5)<a id="change"> - </a>1

        a = _approx(a.points, segments)
        b = _approx(b.points, segments)
        dists = np.linalg.norm(a - b, axis=1)
        dists = dists[:-1] + dists[1:]
        a_steps = np.linalg.norm(<a id="change">a[1:]</a><a id="change"> - </a>a[:-1], axis=1)
        b_steps = np.linalg.norm(b[1:] - b[:-1], axis=1)

        &#47&#47 For the common bbox we can&quott use
        &#47&#47 - the AABB (axis-alinged bbox) of a point set
        &#47&#47 - the exterior of a point set
        &#47&#47 - the convex hull of a point set
        &#47&#47 because these soultions won&quott be correctly normalized.
        &#47&#47 The lines can have multiple self-intersections, which can give
        &#47&#47 the inter-line area more than internal area of the options above,
        &#47&#47 producing the value of the distance outside of the [0; 1] range.
        &#47&#47
        &#47&#47 Instead, we can compute the upper boundary for the inter-line
        &#47&#47 area based on the maximum point distance and line length.
        max_area = np.max(dists) * max(np.sum(a_steps), np.sum(b_steps))

        area<a id="change"> = </a>np.dot(dists, a_steps + b_steps) * 0.5 *<a id="change"> 0.5 / </a>max_area

        return <a id="change">abs(</a>1<a id="change"> - </a>area<a id="change">)</a>

@attrs
class CaptionsMatcher(AnnotationMatcher):
    def match_annotations(self, sources):</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 10</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/openvinotoolkit/datumaro/commit/4b53be73721c23738592db619b89fdb1cc18f2fe#diff-4a402f8d83ffab43f9ba3e1831858f8a09933ac4251dc5960d53abf1bc7db43eL771' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 14898147</div><div id='project'> Project Name: openvinotoolkit/datumaro</div><div id='commit'> Commit Name: 4b53be73721c23738592db619b89fdb1cc18f2fe</div><div id='time'> Time: 2021-12-22</div><div id='author'> Author: maxim.zhiltsov@intel.com</div><div id='file'> File Name: datumaro/components/operations.py</div><div id='m_class'> M Class Name: LineMatcher</div><div id='n_method'> N Class Name: LineMatcher</div><div id='m_method'> M Method Name: distance(2)</div><div id='n_method'> N Method Name: distance(2)</div><div id='m_parent_class'> M Parent Class: _ShapeMatcher</div><div id='n_parent_class'> N Parent Class: _ShapeMatcher</div><div id='m_file'> M File Name: datumaro/components/operations.py</div><div id='n_file'> N File Name: datumaro/components/operations.py</div><div id='m_start'> M Start Line: 771</div><div id='m_end'> M End Line: 785</div><div id='n_start'> N Start Line: 776</div><div id='n_end'> N End Line: 809</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
	y1 = y
	y2 = y + h
	&#47&#47cv2.rectangle(img, (x1, y1), (x2, y2), (0, 255, 0), 2)
	font_size<a id="change"> = </a>round(h / (line_count * 1.2))
	rows = h // font_size
	cols = w // font_size
	while rows * cols &lt; len(text) :
		font_size -= 1
		rows = h<a id="change"> // </a>font_size
		cols = w // font_size
	bgsize = int(max(font_size * 0.025, 1)) if bg else 0
	spacing_x = 0&#47&#47int(max(font_size * 0.05, 1))
	spacing_y = spacing_x
	x = x1 + max(spacing_x, 0)
	y = y1 + spacing_y
	txt_i = 0
	rot = 0
	i = 0
	while True :
		new_length = cols
		if not new_length :
			continue
		x = x1 + spacing_x
		cur_line_bbox = lines[i] if i &lt; len(lines) else BBox(x1, 0, w, 0, &quot&quot, 0)
		while True :
			(x_offset, y_offset), (ch_x<a id="change">, ch_y, ch_w, ch_h</a>), empty_ch, degree, char_color, border_color = put_char(img, mask, x, y, font_size, rot, text[txt_i], 0, char_color=fg,border_color=bg,border_size=bgsize)
			fg = char_color
			txt_i += 1
			if txt_i &gt;= len(text) :</code></pre><h3>After Change</h3><pre><code class='java'>
	&#47&#47 	font_size -= 1
	&#47&#47 	rows = h // font_size
	&#47&#47 	cols = w // font_size
	fg_avg<a id="change"> = </a>(fg<a id="change">[0] + fg[1] + fg[2]</a>)<a id="change"> / </a>3
	if bg :
		bg_avg = (bg[0] + bg[1] + bg[2]) / 3
		if <a id="change">abs(</a>fg_avg<a id="change"> - </a>bg_avg<a id="change">)</a> &lt; 40 :
			bg = None
	bgsize = int(max(font_size * 0.07, 1)) if bg else 0
	spacing_x = 0&#47&#47int(max(font_size * 0.05, 1))</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/zyddnys/manga-image-translator/commit/605e7ecd9cf3b0a00b67fab40020c269a7bea4a3#diff-a00d57a134f11bad95204dec4abd6df6ae878f21b5826d1211aa9e4570e77203L295' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 14898161</div><div id='project'> Project Name: zyddnys/manga-image-translator</div><div id='commit'> Commit Name: 605e7ecd9cf3b0a00b67fab40020c269a7bea4a3</div><div id='time'> Time: 2021-07-26</div><div id='author'> Author: zyddnys@outlook.com</div><div id='file'> File Name: text_render.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: put_text_horizontal(13)</div><div id='n_method'> N Method Name: put_text_horizontal(11)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: text_render.py</div><div id='n_file'> N File Name: text_render.py</div><div id='m_start'> M Start Line: 296</div><div id='m_end'> M End Line: 331</div><div id='n_start'> N Start Line: 310</div><div id='n_end'> N End Line: 350</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
	y1 = y
	y2 = y + h
	&#47&#47cv2.rectangle(img, (x1, y1), (x2, y2), (0, 255, 0), 2)
	font_size<a id="change"> = </a>round(w / (line_count * 1.2))
	rows = h // font_size
	cols = w // font_size
	while rows * cols &lt; len(text) :
		font_size -= 1
		rows = h // font_size
		cols = w<a id="change"> // </a>font_size
	bgsize = int(max(font_size * 0.025, 1)) if bg else 0
	spacing_y = 0&#47&#47int(max(font_size * 0.05, 1))
	spacing_x = spacing_y
	x = x2 - spacing_x - font_size
	y = y1 + max(spacing_y, 0)
	txt_i = 0
	rot = 0
	j = 0
	while True :
		new_length = rows
		if not new_length :
			continue
		y = y1 + spacing_y
		cur_line_bbox = lines[j] if j &lt; len(lines) else BBox(0, y1, 0, h, &quot&quot, 0)
		while True :
			(x_offset, y_offset)<a id="change">, (ch_x, ch_y, ch_w, ch_h), empty_ch, degree, char_color, border_color</a> = put_char(img, mask, x, y, font_size, rot, text[txt_i], 1, char_color=fg,border_color=bg,border_size=bgsize)
			fg = char_color
			txt_i += 1
			if txt_i &gt;= len(text) :</code></pre><h3>After Change</h3><pre><code class='java'>
	&#47&#47 	cols = w // font_size
	fg_avg = (fg[0] + fg[1] + fg[2]) / 3
	if bg :
		bg_avg<a id="change"> = </a>(bg<a id="change">[0] + bg[1] + bg[2]</a>)<a id="change"> / </a>3
		if <a id="change">abs(</a>fg_avg<a id="change"> - </a>bg_avg<a id="change">)</a> &lt; 40 :
			bg = None
	bgsize = int(max(font_size * 0.07, 1)) if bg else 0
	spacing_y = 0&#47&#47int(max(font_size * 0.05, 1))</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/zyddnys/manga-image-translator/commit/605e7ecd9cf3b0a00b67fab40020c269a7bea4a3#diff-a00d57a134f11bad95204dec4abd6df6ae878f21b5826d1211aa9e4570e77203L253' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 14897994</div><div id='project'> Project Name: zyddnys/manga-image-translator</div><div id='commit'> Commit Name: 605e7ecd9cf3b0a00b67fab40020c269a7bea4a3</div><div id='time'> Time: 2021-07-26</div><div id='author'> Author: zyddnys@outlook.com</div><div id='file'> File Name: text_render.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: put_text_vertical(13)</div><div id='n_method'> N Method Name: put_text_vertical(11)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: text_render.py</div><div id='n_file'> N File Name: text_render.py</div><div id='m_start'> M Start Line: 256</div><div id='m_end'> M End Line: 289</div><div id='n_start'> N Start Line: 264</div><div id='n_end'> N End Line: 304</div><BR>