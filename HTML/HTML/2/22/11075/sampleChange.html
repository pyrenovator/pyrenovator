<link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
    
    Test qc quantize layer and param wrapper
    
    inp<a id="change"> = </a>np.abs(np.random.randn(100, 2))
    model<a id="change"> = </a>dense_functional()
    <a id="change">model.layers[1].set_weights(</a>[np.ones((2, 2)), np.array([1.2, 1.5])]<a id="change">)</a>
    orig_out = model.predict(inp)
    <a id="change">replace_layer_in_functional_model(</a>model, model.layers[1], [QcQuantizeParamWrapper(model.layers[1]),
                                                               QcQuantizeLayer()]<a id="change">)</a>
    <a id="change">tf.keras.models.save_model(</a>model, &quot./data/saved_model&quot<a id="change">, save_format=&quottf&quot)</a>
    model<a id="change"> = </a>tf.keras.models.load_model(&quot./data/saved_model&quot)
    quant_out<a id="change"> = </a>model.predict(inp)
    assert not np.array_equal(orig_out, quant_out)

    model.compile(optimizer=tf.keras.optimizers.Adam(learning_rate=1e-3),
                  loss=tf.keras.losses.BinaryCrossentropy(),
                  metrics=[&quotaccuracy&quot])

    starting_weights = [weight for weight in model.layers[1]._layer_to_wrap.get_weights()]
    y = np.random.randn(100, 2)
    model.fit(x=inp, y=y, batch_size=1)
    ending_weights<a id="change"> = </a>[weight for weight in model.layers[1]._layer_to_wrap.get_weights()]
    for idx, weight in enumerate(starting_weights):
        assert not np.array_equal(weight, ending_weights[idx])
</code></pre><h3>After Change</h3><pre><code class='java'>
    
    Test qc quantize layer and param wrapper
    
    <a id="change">if version.parse(tf.version.VERSION) &gt;= version.parse("2.00")</a>:
        inp<a id="change"> = </a>np.abs(np.random.randn(100, 2))
        model<a id="change"> = </a>dense_functional()
        <a id="change">model.layers[1].set_weights(</a>[np.ones((2, 2)), np.array([1.2, 1.5])]<a id="change">)</a>
        orig_out = model.predict(inp)
        <a id="change">replace_layer_in_functional_model(</a>model, model.layers[1], [QcQuantizeParamWrapper(model.layers[1]),
                                                                   QcQuantizeLayer()]<a id="change">)</a>
        <a id="change">tf.keras.models.save_model(</a>model, &quot./data/saved_model&quot<a id="change">, save_format=&quottf&quot)</a>
        model<a id="change"> = </a>tf.keras.models.load_model(&quot./data/saved_model&quot)
        quant_out<a id="change"> = </a>model.predict(inp)
        assert not np.array_equal(orig_out, quant_out)

        model.compile(optimizer=tf.keras.optimizers.Adam(learning_rate=1e-3),
                      loss=tf.keras.losses.BinaryCrossentropy(),
                      metrics=[&quotaccuracy&quot])

        starting_weights = [weight for weight in model.layers[1]._layer_to_wrap.get_weights()]
        y = np.random.randn(100, 2)
        model.fit(x=inp, y=y, batch_size=1)
        ending_weights<a id="change"> = </a>[weight for weight in model.layers[1]._layer_to_wrap.get_weights()]
        for idx, weight in enumerate(starting_weights):
            assert not np.array_equal(weight, ending_weights[idx])
</code></pre>