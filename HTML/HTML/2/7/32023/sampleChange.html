<link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
    &#47&#47 if it&quots not a reduce, this should be a NOOP
    reduce_shape = (bufs[0][1].shape, ret.shape) if reduce_shape is None else reduce_shape
    view = View(reduce_shape[1], strides_for_shape(reduce_shape[0]))
    loop<a id="change"> : List[Tuple[str, str]] = </a><a id="change">[]</a>
    if reduce_shape[1] != reduce_shape[0]:   &#47&#47 this is a reduce
      &#47&#47 reverse operation of expand, this validates inputs
      &#47&#47 generate loops with combined adjacent reduce axis
      acc = 1
      <a id="change">for </a>shp,stride in ShapeTracker(reduce_shape[1]).movement_op(MovementOps.EXPAND, reduce_shape[0]).views[-1].shape_strides[::-1]<a id="change">:
        </a><a id="change">if stride == 0</a>: <a id="change">loop.append(</a>(f"for (int axis_{len(loop)} = 0; axis_{len(loop)} &lt; {shp}; axis_{len(loop)}++) {{", f"idx += {acc}; }} idx -= {shp*acc};")<a id="change">)</a>
        acc *= shp

    kernel_name = "reduce" if len(loop) &gt; 0 else "elementwise"
    views = {name:buf.contiguous_view_constant_fold(name) for name, buf in bufs}</code></pre><h3>After Change</h3><pre><code class='java'>
    &#47&#47 if it&quots a partial reduce, assert last non reduced axis is before the first reduced axis
    if red &gt; 1 and prod(ret.shape) != 1: assert max([i for i,(s,n) in enumerate(zip(*reduce_shape)) if s == n and n != 1]) &lt; min([i for i,(s,n) in enumerate(zip(*reduce_shape)) if s != 1 and n == 1])

    kernel_name = "reduce"<a id="change"> if </a>red &gt; 1<a id="change"> else </a>"elementwise"
    views = {name:buf.contiguous_view_constant_fold(name) for name, buf in bufs}
    buf_types = [f"__global const float *{name}_g" for name, _ in bufs if name not in views or views[name][1]] 
    conv_prg = CLProgram(kernel_name, f{chr(10).join([x[0] for x in views.values()])}</code></pre>