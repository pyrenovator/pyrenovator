<html><h3>Pattern ID :36875
</h3><img src='105006210.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>

class AugmentContextAndTarget(Augmenter):
    def __call__(self, contexts, targets):
        <a id="change">return </a>[<a id="change">np.array(</a>self.augment_op(el)<a id="change">)</a> for el in contexts], [<a id="change">np.array(</a>self.augment_op(el)<a id="change">)</a> for el in targets]


class AugmentContextOnly(Augmenter):</code></pre><h3>After Change</h3><pre><code class='java'>
class AugmentContextAndTarget(Augmenter):
    def __call__(self, contexts, targets):
        shape = contexts.shape
        contexts<a id="change"> = </a><a id="change">torch.reshape(</a>contexts, (shape[0]*shape[1], shape[2], shape[3])<a id="change">)</a>
        targets = torch.reshape(targets, (shape[0]<a id="change">*</a>shape[1], shape[2], shape[3]))
        import pdb; pdb.set_trace()
        contexts, targets = self.augment_op(contexts), self.augment_op(targets)
        import pdb; pdb.set_trace()
        contexts, targets = torch.reshape(contexts, shape), torch.reshape(targets, shape)
        import pdb; pdb.set_trace()
        <a id="change">return </a>contexts, targets

class AugmentContextOnly(Augmenter):
    def __call__(self, contexts, targets):</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 7</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/humancompatibleai/eirli/commit/334a80518fa3fc4e35471035f1e0372cda240bf6#diff-ee5ab27d08ddab6427c8d60644dc08cbaa5813e26ef8e6a81c1cb6d1198f2d08L27' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 105006210</div><div id='project'> Project Name: humancompatibleai/eirli</div><div id='commit'> Commit Name: 334a80518fa3fc4e35471035f1e0372cda240bf6</div><div id='time'> Time: 2020-07-30</div><div id='author'> Author: codywild@berkeley.edu</div><div id='file'> File Name: algos/augmenters.py</div><div id='m_class'> M Class Name: AugmentContextAndTarget</div><div id='n_method'> N Class Name: AugmentContextAndTarget</div><div id='m_method'> M Method Name: __call__(3)</div><div id='n_method'> N Method Name: __call__(3)</div><div id='m_parent_class'> M Parent Class: Augmenter</div><div id='n_parent_class'> N Parent Class: Augmenter</div><div id='m_file'> M File Name: algos/augmenters.py</div><div id='n_file'> N File Name: algos/augmenters.py</div><div id='m_start'> M Start Line: 27</div><div id='m_end'> M End Line: 27</div><div id='n_start'> N Start Line: 32</div><div id='n_end'> N End Line: 40</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>

class AugmentContextAndTarget(Augmenter):
    def __call__(self, contexts, targets):
        <a id="change">return </a>[<a id="change">np.array(</a>self.augment_op(el)<a id="change">)</a> for el in contexts], [<a id="change">np.array(</a>self.augment_op(el)<a id="change">)</a> for el in targets]


class AugmentContextOnly(Augmenter):</code></pre><h3>After Change</h3><pre><code class='java'>
class AugmentContextAndTarget(Augmenter):
    def __call__(self, contexts, targets):
        shape = contexts.shape
        contexts = torch.reshape(contexts, (shape[0]<a id="change">*</a>shape[1], shape[2], shape[3]))
        targets<a id="change"> = </a><a id="change">torch.reshape(</a>targets, (shape[0]*shape[1], shape[2], shape[3])<a id="change">)</a>
        import pdb; pdb.set_trace()
        contexts, targets = self.augment_op(contexts), self.augment_op(targets)
        import pdb; pdb.set_trace()
        contexts, targets = torch.reshape(contexts, shape), torch.reshape(targets, shape)
        import pdb; pdb.set_trace()
        <a id="change">return </a>contexts, targets

class AugmentContextOnly(Augmenter):
    def __call__(self, contexts, targets):</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/humancompatibleai/eirli/commit/97e3290550e7c3b387b5a3e8739020c2e1efd558#diff-ee5ab27d08ddab6427c8d60644dc08cbaa5813e26ef8e6a81c1cb6d1198f2d08L26' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 105006208</div><div id='project'> Project Name: humancompatibleai/eirli</div><div id='commit'> Commit Name: 97e3290550e7c3b387b5a3e8739020c2e1efd558</div><div id='time'> Time: 2020-07-30</div><div id='author'> Author: codywild@berkeley.edu</div><div id='file'> File Name: algos/augmenters.py</div><div id='m_class'> M Class Name: AugmentContextAndTarget</div><div id='n_method'> N Class Name: AugmentContextAndTarget</div><div id='m_method'> M Method Name: __call__(3)</div><div id='n_method'> N Method Name: __call__(3)</div><div id='m_parent_class'> M Parent Class: Augmenter</div><div id='n_parent_class'> N Parent Class: Augmenter</div><div id='m_file'> M File Name: algos/augmenters.py</div><div id='n_file'> N File Name: algos/augmenters.py</div><div id='m_start'> M Start Line: 27</div><div id='m_end'> M End Line: 27</div><div id='n_start'> N Start Line: 32</div><div id='n_end'> N End Line: 40</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>

            col_idxs.append(np.arange(start_index, end_index + 1, 1))  &#47&#47 correct for not including upper bound

        col_idxs = <a id="change">np.array(</a>col_idxs<a id="change">)</a>

        assert row_idxs.shape == col_idxs.shape == (self.batch_size, self.num_bptt)

        &#47&#47 numpy advanced indexing

        o = self._prepare(self.o[row_idxs, col_idxs]).view(self.batch_size, self.num_bptt, self.o_dim)
        a = self._prepare(self.a[row_idxs, col_idxs]).view(self.batch_size, self.num_bptt, self.a_dim)
        r = self._prepare(self.r[row_idxs, col_idxs]).view(self.batch_size, self.num_bptt, 1)
        no = self._prepare(self.no[row_idxs, col_idxs]).view(self.batch_size, self.num_bptt, self.o_dim)
        d = self._prepare(self.d[row_idxs, col_idxs]).view(self.batch_size, self.num_bptt, 1)
        m = self._prepare(self.m[row_idxs, col_idxs]).view(self.batch_size, self.num_bptt, 1)

        <a id="change">return </a>RecurrentBatch(o, a, r, no, d, m)
</code></pre><h3>After Change</h3><pre><code class='java'>
        &#47&#47 the example right above this section:
        &#47&#47 https://numpy.org/doc/stable/reference/arrays.indexing.html&#47&#47combining-advanced-and-basic-indexing

        row_idxs_for_o<a id="change"> = </a>np.repeat(<a id="change">ep_idxs.reshape(</a>-1, 1<a id="change">)</a>, repeats=self.num_bptt+1, axis=1)
        row_idxs_for_others = np.repeat(ep_idxs.reshape(-1, 1), repeats=self.num_bptt, axis=1)

        &#47&#47 suppose epi_idxs = [1, 2, 3, 4] and num_bptt = 10, then row_idxs =
        &#47&#47 1 1 1 1 1 1 1 1 1 1
        &#47&#47 2 2 2 2 2 2 2 2 2 2
        &#47&#47 3 3 3 3 3 3 3 3 3 3
        &#47&#47 4 4 4 4 4 4 4 4 4 4

        col_idxs_for_o = []
        col_idxs_for_others = []

        for ep_len in ep_lens:

            final_index = ep_len - 1  &#47&#47 the last valid index of the episode

            &#47&#47 first +1 is to correct for over subtraction
            &#47&#47 second +1 is to correct for the fact that np.random.randint does not include upper bound

            if ep_len &gt;= self.num_bptt:
                start_index = np.random.randint((final_index - self.num_bptt + 1) + 1)
            elif ep_len &lt; self.num_bptt:  &#47&#47 this is the case for which mask is actually useful
                start_index = 0

            end_index = start_index + (self.num_bptt - 1)  &#47&#47 correct for over addition

            col_idxs_for_o.append(np.arange(start_index, end_index + 1 + 1, 1))  &#47&#47 correct for not including upper bound
            col_idxs_for_others.append(np.arange(start_index, end_index + 1, 1))

        col_idxs_for_o = <a id="change">np.array(</a>col_idxs_for_o<a id="change">)</a>
        col_idxs_for_others = np.array(col_idxs_for_others)

        assert row_idxs_for_o.shape == col_idxs_for_o.shape == (self.batch_size, self.num_bptt + 1)
        assert row_idxs_for_others.shape == col_idxs_for_others.shape == (self.batch_size, self.num_bptt)

        &#47&#47 numpy advanced indexing

        o = self._prepare(self.o[row_idxs_for_o, col_idxs_for_o]).view(self.batch_size, self.num_bptt<a id="change">+</a>1, self.o_dim)
        a = self._prepare(self.a[row_idxs_for_others, col_idxs_for_others]).view(self.batch_size, self.num_bptt, self.a_dim)
        r = self._prepare(self.r[row_idxs_for_others, col_idxs_for_others]).view(self.batch_size, self.num_bptt, 1)
        d = self._prepare(self.d[row_idxs_for_others, col_idxs_for_others]).view(self.batch_size, self.num_bptt, 1)
        m = self._prepare(self.m[row_idxs_for_others, col_idxs_for_others]).view(self.batch_size, self.num_bptt, 1)

        <a id="change">return </a>RecurrentBatch(o, a, r, d, m)
</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/zhihanyang2022/off-policy-continuous-control/commit/ff05c5d10e3338ae6468407f3fdf47eed1a22559#diff-1507009ab57c9d4a09b2f6569e1a96597dc18c8ec7bf05b1135e5e636786df85L109' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 105006202</div><div id='project'> Project Name: zhihanyang2022/off-policy-continuous-control</div><div id='commit'> Commit Name: ff05c5d10e3338ae6468407f3fdf47eed1a22559</div><div id='time'> Time: 2021-05-23</div><div id='author'> Author: yangz2@carleton.edu</div><div id='file'> File Name: offpcc/basics/replay_buffer_recurrent.py</div><div id='m_class'> M Class Name: RecurrentReplayBuffer</div><div id='n_method'> N Class Name: RecurrentReplayBuffer</div><div id='m_method'> M Method Name: sample(1)</div><div id='n_method'> N Method Name: sample(1)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: offpcc/basics/replay_buffer_recurrent.py</div><div id='n_file'> N File Name: offpcc/basics/replay_buffer_recurrent.py</div><div id='m_start'> M Start Line: 132</div><div id='m_end'> M End Line: 171</div><div id='n_start'> N Start Line: 120</div><div id='n_end'> N End Line: 173</div><BR>