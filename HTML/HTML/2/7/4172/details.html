<html><h3>Pattern ID :4172
</h3><img src='15378574.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
    metric_value = None
    if cfg.get("optimized_metric"):
        metric_value = utils.get_metric_value(metric_name=cfg.optimized_metric, trainer=trainer)
        <a id="change">log.info(f"Retrieved metric value! &lt;{cfg.optimized_metric}={metric_value}&gt;"</a><a id="change">)</a>

    &#47&#47 test the model
    best_ckpt = trainer.checkpoint_callback.best_model_path
    best_ckpt = None if best_ckpt == "" else best_ckpt
    if cfg.get("test"):
        log.info("Starting testing!")
        trainer.test(model=model, datamodule=datamodule, ckpt_path=best_ckpt)

    &#47&#47 print paths
    <a id="change">log.info(f"Output dir: {cfg.paths.output_dir}"</a><a id="change">)</a>
    log.info(f"Best ckpt: {best_ckpt}")

    &#47&#47 return metric value for hyperparameter optimization
    return metric_value, object_dict</code></pre><h3>After Change</h3><pre><code class='java'>
    test_metrics = trainer.callback_metrics

    &#47&#47 merge train and test metrics
    metric_dict<a id="change"> = </a><a id="change">{**train_metrics, **test_metrics}</a>

    &#47&#47 return metric value for hyperparameter optimization
    return metric_dict, object_dict
</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 5</div><BR><div id='size'>Non-data size: 4</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/ashleve/lightning-hydra-template/commit/9e86f1696a2bf06f767678cd9bef6516ab2da281#diff-bd30339a5a3f716d139106d11ab98658a6e1d7e48c357c04112f3632cf3ab29fL51' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 15378574</div><div id='project'> Project Name: ashleve/lightning-hydra-template</div><div id='commit'> Commit Name: 9e86f1696a2bf06f767678cd9bef6516ab2da281</div><div id='time'> Time: 2022-07-12</div><div id='author'> Author: zalewski.ukas@gmail.com</div><div id='file'> File Name: src/tasks/train_task.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: train(1)</div><div id='n_method'> N Method Name: train(1)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: src/tasks/train_task.py</div><div id='n_file'> N File Name: src/tasks/train_task.py</div><div id='m_start'> M Start Line: 54</div><div id='m_end'> M End Line: 90</div><div id='n_start'> N Start Line: 51</div><div id='n_end'> N End Line: 88</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
    metric_value = None
    if cfg.get("optimized_metric"):
        metric_value = utils.get_metric_value(metric_name=cfg.optimized_metric, trainer=trainer)
        <a id="change">log.info(f"Retrieved metric value! &lt;{cfg.optimized_metric}={metric_value}&gt;"</a><a id="change">)</a>

    &#47&#47 test the model
    best_ckpt = trainer.checkpoint_callback.best_model_path
    best_ckpt = None if best_ckpt == "" else best_ckpt
    if cfg.get("test"):
        log.info("Starting testing!")
        trainer.test(model=model, datamodule=datamodule, ckpt_path=best_ckpt)

    &#47&#47 print paths
    <a id="change">log.info(f"Output dir: {cfg.paths.output_dir}"</a><a id="change">)</a>
    log.info(f"Best ckpt: {best_ckpt}")

    &#47&#47 return metric value for hyperparameter optimization
    return metric_value, object_dict</code></pre><h3>After Change</h3><pre><code class='java'>
    test_metrics = trainer.callback_metrics

    &#47&#47 merge train and test metrics
    metric_dict<a id="change"> = </a><a id="change">{**train_metrics, **test_metrics}</a>

    &#47&#47 return metric value for hyperparameter optimization
    return metric_dict, object_dict
</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/ashleve/lightning-hydra-template/commit/9e86f1696a2bf06f767678cd9bef6516ab2da281#diff-bd30339a5a3f716d139106d11ab98658a6e1d7e48c357c04112f3632cf3ab29fL15' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 15378590</div><div id='project'> Project Name: ashleve/lightning-hydra-template</div><div id='commit'> Commit Name: 9e86f1696a2bf06f767678cd9bef6516ab2da281</div><div id='time'> Time: 2022-07-12</div><div id='author'> Author: zalewski.ukas@gmail.com</div><div id='file'> File Name: src/tasks/train_task.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: train(1)</div><div id='n_method'> N Method Name: train(1)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: src/tasks/train_task.py</div><div id='n_file'> N File Name: src/tasks/train_task.py</div><div id='m_start'> M Start Line: 54</div><div id='m_end'> M End Line: 90</div><div id='n_start'> N Start Line: 51</div><div id='n_end'> N End Line: 88</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>

def main() -&gt; None:
    Run example.
    <a id="change">logger.info(f"features: {features}"</a><a id="change">)</a>
    <a id="change">logger.info(f"truth: {truth}"</a><a id="change">)</a>

    &#47&#47 single integer definition of class
    &#47&#47class_options = 3
    &#47&#47 list of classes</code></pre><h3>After Change</h3><pre><code class='java'>
    }

    &#47&#47 Configuration
    config<a id="change"> = </a><a id="change">{
        </a>"db": "/groups/icecube/petersen/GraphNetDatabaseRepository/Leon_MC_data/last_one_lvl3MC.db",
        "pulsemap": "SplitInIcePulses",
        "batch_size": 512,
        "num_workers": 10,
        "accelerator": "cpu",  &#47&#47 gpu
        "devices": 1,  &#47&#47 [0],
        "target": "pid",
        "classification": class_options,
        "n_epochs": 10,
        "patience": 5<a id="change">,
    }</a>
    archive = "/groups/icecube/petersen/GraphNetDatabaseRepository/example_results/train_classification_model"
    run_name = "dynedge_{}_example".format(config["target"])

    &#47&#47 Log configuration to W&B</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/graphnet-team/graphnet/commit/737bcecc71b5c72cc738bbe2c112e59d86e949dc#diff-44689e19604bc1e9d0d7c4ac79f0d66a5285ecf95fa7d43ab9f954cdc752a44eL53' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 15378575</div><div id='project'> Project Name: graphnet-team/graphnet</div><div id='commit'> Commit Name: 737bcecc71b5c72cc738bbe2c112e59d86e949dc</div><div id='time'> Time: 2022-11-21</div><div id='author'> Author: Volumunox@gmail.com</div><div id='file'> File Name: examples/train_classification_model.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: main(0)</div><div id='n_method'> N Method Name: main(0)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: examples/train_classification_model.py</div><div id='n_file'> N File Name: examples/train_classification_model.py</div><div id='m_start'> M Start Line: 55</div><div id='m_end'> M End Line: 177</div><div id='n_start'> N Start Line: 65</div><div id='n_end'> N End Line: 188</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        pdf_content = fh_pdf.read()

    &#47&#47 Convert the PDF to XML
    <a id="change">logger.info("Converting PDF to XML"</a><a id="change">)</a>
    from bluesearch.database.pdf import grobid_pdf_to_tei_xml

    xml_content = grobid_pdf_to_tei_xml(pdf_content, grobid_host, grobid_port)

    &#47&#47 Write the XML file
    logger.info("Writing the XML file to disk")
    with output_xml_path.open("w") as fh_xml:
        n_bytes = fh_xml.write(xml_content)
    logger.info("Wrote %d bytes to %s", n_bytes, output_xml_path.resolve().as_uri())

    <a id="change">logger.info("PDF conversion done"</a><a id="change">)</a>

    return 0
</code></pre><h3>After Change</h3><pre><code class='java'>
    &#47&#47 Collect input paths
    input_paths: Iterable[pathlib.Path]
    if input_path.is_file():
        input_paths<a id="change"> = </a><a id="change">[</a>input_path<a id="change"></a>]
        input_dir = input_path.parent
    else:
        input_paths = input_path.rglob("*.pdf")</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/bluebrain/search/commit/7dae95ebd57973adba75efbce55342e295b223bd#diff-0c5672607dda9074162d3f7dd21fb7a0b9bdf0004d223f8e9e44d122c19882f8L87' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 15378594</div><div id='project'> Project Name: bluebrain/search</div><div id='commit'> Commit Name: 7dae95ebd57973adba75efbce55342e295b223bd</div><div id='time'> Time: 2021-12-17</div><div id='author'> Author: Stannislav@users.noreply.github.com</div><div id='file'> File Name: src/bluesearch/entrypoint/database/convert_pdf.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: run(0)</div><div id='n_method'> N Method Name: run(0)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: src/bluesearch/entrypoint/database/convert_pdf.py</div><div id='n_file'> N File Name: src/bluesearch/entrypoint/database/convert_pdf.py</div><div id='m_start'> M Start Line: 131</div><div id='m_end'> M End Line: 162</div><div id='n_start'> N Start Line: 158</div><div id='n_end'> N End Line: 221</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        },
    )
    if not os.path.exists(hparams["dataset_cache_path"]):
        <a id="change">logging.info("Cannot find pre-made dataset"</a><a id="change">)</a>
        logging.info(
            "tokenizing and batching dataset to {}".format(
                hparams["dataset_cache_path"]
            )
        )

        def encode(data):  &#47&#47 encode the data using the pretrained dataset
            text = data["text"]
            tokens_list = [tokenizer.encode_as_ids(t) for t in text]
            tokens_bos = [[hparams["bos_index"]] + (tl) for tl in tokens_list]
            tokens_eos = [tl + [hparams["eos_index"]] for tl in tokens_list]
            return {
                "tokens_bos": tokens_bos,
                "tokens_eos": tokens_eos,
            }

        datasets = datasets.map(
            encode, batched=True, batch_size=hparams["batch_size"] * 20
        )
        datasets.save_to_disk(hparams["dataset_cache_path"])
        <a id="change">logging.info("Complete!"</a><a id="change">)</a>
    else:
        logging.info(
            "Found exiting pre-made dataset, load it from {}".format(
                hparams["dataset_cache_path"]</code></pre><h3>After Change</h3><pre><code class='java'>
        test_data
    )

    datasets<a id="change"> = </a><a id="change">[</a>train_data, valid_data, test_data<a id="change"></a>]

    &#47&#47 3. Define text pipeline:
    &#47&#47 TODO: implement text augmentations piplines</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/speechbrain/speechbrain/commit/521433f2bed65804ca43253c558fe3313f590138#diff-d8297cccdc50f06ccfbbd867cf59a26d2f8f9102a69616766e1c9374406798e4L87' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 15378579</div><div id='project'> Project Name: speechbrain/speechbrain</div><div id='commit'> Commit Name: 521433f2bed65804ca43253c558fe3313f590138</div><div id='time'> Time: 2021-01-13</div><div id='author'> Author: jzhong9@u.rochester.edu</div><div id='file'> File Name: recipes/LibriSpeech/LM/experiment.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: data_io_prepare(1)</div><div id='n_method'> N Method Name: data_io_prepare(2)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: recipes/LibriSpeech/LM/experiment.py</div><div id='n_file'> N File Name: recipes/LibriSpeech/LM/experiment.py</div><div id='m_start'> M Start Line: 87</div><div id='m_end'> M End Line: 158</div><div id='n_start'> N Start Line: 136</div><div id='n_end'> N End Line: 165</div><BR>