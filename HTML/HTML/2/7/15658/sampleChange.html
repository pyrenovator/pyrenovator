<link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>

        &#47&#47 I think if we include z_i here, we should use a mask (as in SymmetricContrastiveLoss) to subtract the column
        &#47&#47 on which the similarity is calculated with an image itself?
        mask<a id="change"> = </a><a id="change">torch.eye(</a>num_contexts<a id="change">)</a>.to(self.device)

        &#47&#47 Simplify the code
        z_all = torch.cat([z_i, z_j], 0)
        if num_targets &gt; num_contexts:
            z_j = z_j[:num_contexts]

        &#47&#47 zi and zj are both matrices of dim (n x c), since they are z vectors of dim c for every element in the batch
        &#47&#47 This einsum is constructing a vector of size n, where the nth element is a sum over C of the NCth elements
        &#47&#47 That is to say, the nth element is a dot product between the Nth C-dim vector of each matrix
        sim_ij = torch.einsum(&quotnc,nc-&gt;n&quot, [z_i, z_j]).unsqueeze(-1)  &#47&#47 Nx1

        &#47&#47 Calculate similarity of current batch&quots images and other images.
        sim_ik = torch.einsum(&quotnc,ck-&gt;nk&quot, [z_i, z_all.T])
        sim_ik<a id="change"> = </a>sim_ik<a id="change"> - </a>mask  &#47&#47 TODO: Check if the diagonal line are all 1s.

        logits<a id="change"> = </a>torch.cat((sim_ij, sim_ik), 1)
        logits /= self.temp

        labels<a id="change"> = </a>torch.zeros(logits.shape[0], dtype=torch.long, device=self.device)
        return self.criterion(logits, labels)

</code></pre><h3>After Change</h3><pre><code class='java'>
        z_i = F.normalize(z_i, dim=1)
        z_j = F.normalize(z_j, dim=1)

        logits<a id="change">, labels</a> = self.calculate_logits_and_labels(z_i, z_j)
        return self.criterion(logits, labels)

</code></pre>