<html><h3>Pattern ID :10154
</h3><img src='35921541.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>

        mat = self.distance(x)
        &#47&#47 remove self comparisons
        mask = <a id="change">torch.eye(</a>n<a id="change">, dtype=torch.bool)</a>
        mat = mat[~mask].view(n, n<a id="change"> - 1</a>)
        if not self.distance.is_inverted:
            mat *= -1
        mat<a id="change"> = </a>F.softmax(mat, dim=1)

        y = y.repeat(n, 1)[~mask].view(n, n - 1)

        target_probs = torch.sum(mat * y, dim=1, keepdims=True)
        src_probs = torch.sum(mat * (1 - y), dim=1, keepdims=True)
        probs<a id="change"> = </a>torch.cat([src_probs, target_probs], dim=1)

        ent_loss = self.ent_loss_fn(probs)
</code></pre><h3>After Change</h3><pre><code class='java'>

        mat = self.distance(x)
        &#47&#47 remove self comparisons
        mask = <a id="change">~torch.eye(n, dtype=torch.bool)</a>
        mat = mat[mask].view(n, n - 1)
        probs<a id="change"> = </a>get_probs(mat, mask, y, self.distance.is_inverted)

        return get_loss(probs, self.ent_loss_fn, self.div_loss_fn, self.with_div)
</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 7</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/kevinmusgrave/pytorch-adapt/commit/15f370b60db6caabe64d6dbe08f03e58acc7472f#diff-33482f5ae551032cfc0bd0845dc707a56bb1d09e2683a5f527f6a0cf9d3f4f5cL30' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 35921541</div><div id='project'> Project Name: kevinmusgrave/pytorch-adapt</div><div id='commit'> Commit Name: 15f370b60db6caabe64d6dbe08f03e58acc7472f</div><div id='time'> Time: 2022-03-09</div><div id='author'> Author: tkm45@cornell.edu</div><div id='file'> File Name: src/pytorch_adapt/layers/ist_loss.py</div><div id='m_class'> M Class Name: ISTLoss</div><div id='n_method'> N Class Name: ISTLoss</div><div id='m_method'> M Method Name: forward(3)</div><div id='n_method'> N Method Name: forward(3)</div><div id='m_parent_class'> M Parent Class: torch.nn.Module</div><div id='n_parent_class'> N Parent Class: torch.nn.Module</div><div id='m_file'> M File Name: src/pytorch_adapt/layers/ist_loss.py</div><div id='n_file'> N File Name: src/pytorch_adapt/layers/ist_loss.py</div><div id='m_start'> M Start Line: 30</div><div id='m_end'> M End Line: 54</div><div id='n_start'> N Start Line: 49</div><div id='n_end'> N End Line: 61</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        cs = np.zeros((n_clients, n_clients))
        for i in range(n_clients):
            for j in range(n_clients):
                cs[i][j]<a id="change"> = </a><a id="change">1</a><a id="change"> - </a>spatial.distance.cosine(feature_vec_list[i], feature_vec_list[j])
        cs<a id="change"> -= </a><a id="change">np.eye(</a>n_clients<a id="change">)</a>
        &#47&#47 cs = smp.cosine_similarity(feature_vec_list) - np.eye(n_clients)
        maxcs = np.max(cs, axis=1)
        &#47&#47 pardoning
        for i in range(n_clients):</code></pre><h3>After Change</h3><pre><code class='java'>
    def fools_gold_score(cls, feature_vec_list):
        import sklearn.metrics.pairwise as smp
        n_clients = len(feature_vec_list)
        cs<a id="change"> = </a>smp.cosine_similarity(feature_vec_list)<a id="change"> - </a><a id="change">np.eye(</a>n_clients<a id="change">)</a>
        maxcs = np.max(cs, axis=1)
        &#47&#47 pardoning
        for i in range(n_clients):
            for j in range(n_clients):</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/fedml-ai/fedml/commit/6e38f5c840378693e9643065a302ba9b6bffb2ff#diff-cb204bfb0c88c24d3e499caee204b4c6a0211a1555fed09b011e6bafa335da86L58' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 35921562</div><div id='project'> Project Name: fedml-ai/fedml</div><div id='commit'> Commit Name: 6e38f5c840378693e9643065a302ba9b6bffb2ff</div><div id='time'> Time: 2022-11-07</div><div id='author'> Author: sshan0731@hotmail.com</div><div id='file'> File Name: python/fedml/core/security/defense/foolsgold_defense.py</div><div id='m_class'> M Class Name: FoolsGoldDefense</div><div id='n_method'> N Class Name: FoolsGoldDefense</div><div id='m_method'> M Method Name: fools_gold_score(2)</div><div id='n_method'> N Method Name: fools_gold_score(2)</div><div id='m_parent_class'> M Parent Class: BaseDefenseMethod</div><div id='n_parent_class'> N Parent Class: BaseDefenseMethod</div><div id='m_file'> M File Name: python/fedml/core/security/defense/foolsgold_defense.py</div><div id='n_file'> N File Name: python/fedml/core/security/defense/foolsgold_defense.py</div><div id='m_start'> M Start Line: 59</div><div id='m_end'> M End Line: 64</div><div id='n_start'> N Start Line: 59</div><div id='n_end'> N End Line: 60</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        H1bar = H1 - H1.mean(dim=1).unsqueeze(dim=1)
        H2bar = H2 - H2.mean(dim=1).unsqueeze(dim=1)

        SigmaHat12<a id="change"> = </a>(<a id="change">1.0</a><a id="change"> / </a>(m - 1)) * torch.matmul(H1bar, H2bar.t())
        SigmaHat11 = (1 - self.r) * (1.0 / (m - 1)) * torch.matmul(H1bar,
                                                                   H1bar.t()) + self.r * torch.eye(o1,
                                                                                                   dtype=torch.double,
                                                                                                   device=H1.device).float()
        SigmaHat22 = (1 - self.r) * (1.0 / (m - 1)) * torch.matmul(H2bar,
                                                                   H2bar.t()) + self.r * <a id="change">torch.eye(</a>o2<a id="change">,
                                                                                                   dtype=torch.double,
                                                                                                   device=H2.device)</a>.float()

        &#47&#47 performs the inverse square root of the covariance matrices by the cholesky decomposition. This is more stable than using SVD
        SigmaHat11RootInv = torch.linalg.inv(torch.linalg.cholesky(_minimal_regularisation(SigmaHat11, self.eps)))
        SigmaHat22RootInv = torch.linalg.inv(torch.linalg.cholesky(_minimal_regularisation(SigmaHat22, self.eps)))

        Tval = torch.matmul(torch.matmul(SigmaHat11RootInv,
                                         SigmaHat12), SigmaHat22RootInv)

        trace_TT<a id="change"> = </a>torch.matmul(Tval.t(), Tval)
        eigvals = torch.real(torch.linalg.eigvals(trace_TT))
        eigvals = eigvals[torch.gt(eigvals, self.eps)]
        corr = torch.sum(torch.sqrt(eigvals))</code></pre><h3>After Change</h3><pre><code class='java'>
        SigmaHat11 = (1 - self.r) * (1.0 / (n - 1)) * torch.matmul(H1bar.T,
                                                                   H1bar) + self.r * torch.eye(o1, device=H1.device)
        SigmaHat22 = (1 - self.r) * (1.0 / (n - 1)) * torch.matmul(H2bar.T,
                                                                   H2bar) + self.r * <a id="change">torch.eye(</a>o2<a id="change">, device=H2.device)</a>

        &#47&#47 performs the inverse square root of the covariance matrices by the cholesky decomposition. This is more stable than using SVD
        SigmaHat11RootInv = _compute_matrix_power(_minimal_regularisation(SigmaHat11, self.eps), -0.5)
        SigmaHat22RootInv = _compute_matrix_power(_minimal_regularisation(SigmaHat22, self.eps), -0.5)
        &#47&#47 SigmaHat11RootInv = torch.linalg.cholesky(torch.linalg.inv(_minimal_regularisation(SigmaHat11, self.eps)))
        &#47&#47 SigmaHat22RootInv = torch.linalg.cholesky(torch.linalg.inv(_minimal_regularisation(SigmaHat22, self.eps)))
        Tval = torch.matmul(torch.matmul(SigmaHat11RootInv,
                                         SigmaHat12), SigmaHat22RootInv)
        trace_TT<a id="change"> = </a>Tval.T<a id="change"> @ </a>Tval
        eigvals = torch.linalg.eigvalsh(trace_TT)
        eigvals = eigvals[torch.gt(eigvals, self.eps)]
        corr = torch.sum(torch.sqrt(eigvals))</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/jameschapman19/cca_zoo/commit/109657aa0c08d40d8571bc16e653094cb6206408#diff-abb7a5d5582a748bb8e9b037ee50860d69b8505da48d9f6c9c4a34060dd0bac9L142' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 35921547</div><div id='project'> Project Name: jameschapman19/cca_zoo</div><div id='commit'> Commit Name: 109657aa0c08d40d8571bc16e653094cb6206408</div><div id='time'> Time: 2021-07-14</div><div id='author'> Author: james.chapman.19@ucl.ac.uk</div><div id='file'> File Name: cca_zoo/deepmodels/objectives.py</div><div id='m_class'> M Class Name: CCA</div><div id='n_method'> N Class Name: CCA</div><div id='m_method'> M Method Name: loss(3)</div><div id='n_method'> N Method Name: loss(3)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: cca_zoo/deepmodels/objectives.py</div><div id='n_file'> N File Name: cca_zoo/deepmodels/objectives.py</div><div id='m_start'> M Start Line: 143</div><div id='m_end'> M End Line: 171</div><div id='n_start'> N Start Line: 145</div><div id='n_end'> N End Line: 166</div><BR>