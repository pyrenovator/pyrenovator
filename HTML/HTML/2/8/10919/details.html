<html><h3>Pattern ID :10919
</h3><img src='37739085.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
            return item_embedding
        if self.sim_func == "cosine":
            y = torch.cosine_similarity(user_embedding, item_embedding, dim=1)
        elif <a id="change">self.sim_func == "dot"</a>:
            y = torch.mul(user_embedding, item_embedding).sum(dim=1)
        else:
            <a id="change">raise </a><a id="change">ValueError(</a>"similarity function only support %s, but got %s" % (["cosine", "dot"], self.sim_func)<a id="change">)</a>

        sample_weight = self.embedding(x, self.sample_weight_feature, squeeze_dim=True).squeeze(1)

        y = y - torch.log(sample_weight)  &#47&#47Sampling Bias Corrected</code></pre><h3>After Change</h3><pre><code class='java'>

        &#47&#47 pred[i, j] means predicted score that user_i give to item_j

        pred = torch.cosine_similarity(<a id="change">user_embedding.unsqueeze(1</a><a id="change">)</a>, item_embedding, dim=2)  &#47&#47 (batch_size, batch_size)

        &#47&#47 get sample weight of items in this batch
        sample_weight = self.embedding(x, self.sample_weight_feature, squeeze_dim=True).squeeze(1)  &#47&#47 (batch_size)

        scores = pred - torch.log(sample_weight)  &#47&#47Sampling Bias Corrected, using broadcast
        if user_embedding.shape[0] * (self.n_neg + 1) != self.index0.shape[0]:  &#47&#47 last batch
            batch_size = user_embedding.shape[0]
            index0 = self.index0[:batch_size * (self.n_neg + 1)]
            index1 = self.index1[:batch_size * (self.n_neg + 1)]
            index0[np.where(index0 &gt;= batch_size)] -= batch_size
            index1[np.where(index1 &gt;= batch_size)] -= batch_size

            scores<a id="change"> = </a>scores[index0, index1]
        else:
            scores = scores[self.index0, self.index1]

        scores = scores / self.temperature
        <a id="change">return </a>scores.view(-1, self.n_neg + 1)  &#47&#47(batch_size, 1 + self.n_neg)

    def user_tower(self, x):
        if self.mode == "item":</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 7</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/datawhalechina/torch-rechub/commit/d0461152ddffad7a6bf7c7532b7b540094623e95#diff-16cab9e6b17798cf716613c6493b3a5a50aea041bdf0c65f5c89b59a4d0c686aL55' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 37739085</div><div id='project'> Project Name: datawhalechina/torch-rechub</div><div id='commit'> Commit Name: d0461152ddffad7a6bf7c7532b7b540094623e95</div><div id='time'> Time: 2022-06-07</div><div id='author'> Author: icewwl@163.com</div><div id='file'> File Name: torch_rechub/models/matching/youtube_sbc.py</div><div id='m_class'> M Class Name: YoutubeSBC</div><div id='n_method'> N Class Name: YoutubeSBC</div><div id='m_method'> M Method Name: forward(2)</div><div id='n_method'> N Method Name: forward(2)</div><div id='m_parent_class'> M Parent Class: torch.nn.Module</div><div id='n_parent_class'> N Parent Class: torch.nn.Module</div><div id='m_file'> M File Name: torch_rechub/models/matching/youtube_sbc.py</div><div id='n_file'> N File Name: torch_rechub/models/matching/youtube_sbc.py</div><div id='m_start'> M Start Line: 55</div><div id='m_end'> M End Line: 80</div><div id='n_start'> N Start Line: 60</div><div id='n_end'> N End Line: 87</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
                raise ValueError(
                    f"{self.id} `predict_variance` module output should have 2D output, got {len(pred.shape)}"
                )
            elif <a id="change">pred.shape[-1] not in (1, self.param_rank)</a>:
                <a id="change">raise </a><a id="change">ValueError(
                    </a>f"{self.id} `predict_variance` module output should have `shape[-1]` of "
                    f"{self.param_rank}, got {pred.shape[-1]}"<a id="change">
                )</a>
        if pred is not None:
            diag_multi = torch.diag_embed(torch.exp(pred))
            mini_cov = diag_multi @ mini_cov @ diag_multi
</code></pre><h3>After Change</h3><pre><code class='java'>
            diag_multi = torch.diag_embed(torch.exp(pred))
            mini_cov = diag_multi @ mini_cov @ diag_multi

        mask<a id="change"> = </a><a id="change">self.mask.unsqueeze(0).unsqueeze(0</a><a id="change">)</a>

        <a id="change">return </a>mask @ mini_cov @ mask.tranpose(-1, -2)
</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/strongio/torchcast/commit/d98b47d1ac38c61653093efd887cc672f228917d#diff-65e118e1565802366914308589e1ad788cb0cd050a59e65d1c18b1195749bf05L244' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 37739080</div><div id='project'> Project Name: strongio/torchcast</div><div id='commit'> Commit Name: d98b47d1ac38c61653093efd887cc672f228917d</div><div id='time'> Time: 2021-09-01</div><div id='author'> Author: jacob.dink@strong.io</div><div id='file'> File Name: torchcast/covariance/base.py</div><div id='m_class'> M Class Name: Covariance</div><div id='n_method'> N Class Name: Covariance</div><div id='m_method'> M Method Name: forward(5)</div><div id='n_method'> N Method Name: forward(3)</div><div id='m_parent_class'> M Parent Class: nn.Module</div><div id='n_parent_class'> N Parent Class: nn.Module</div><div id='m_file'> M File Name: torchcast/covariance/base.py</div><div id='n_file'> N File Name: torchcast/covariance/base.py</div><div id='m_start'> M Start Line: 246</div><div id='m_end'> M End Line: 266</div><div id='n_start'> N Start Line: 266</div><div id='n_end'> N End Line: 290</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        return img

    def __call__(self, img: torch.Tensor) -&gt; torch.Tensor:
        <a id="change">if img.shape[1] != 3</a>:
            <a id="change">raise </a><a id="change">ValueError(</a>"HED jitter can only be applied to images with 3 channels (RGB)."<a id="change">)</a>

        return self.adjust_hed(img)

</code></pre><h3>After Change</h3><pre><code class='java'>
        if img.shape[0] &gt; 1:
            for i in range(img.shape[0]):
                img_tile = img[i]
                img[i]<a id="change"> = </a>self.adjust_hed(<a id="change">img_tile.unsqueeze(0</a><a id="change">)</a>)
            <a id="change">return </a>img
        else:
            img = self.adjust_hed(img)
            if len(original_shape) == 3:</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/microsoft/hi-ml/commit/5ce9e00fd52f9a4f80c11aa35d3b7152c1ce9fca#diff-01b65da2b180814d6d0b581e4a11ccaaca9d0a386437562e7dcba91e24110c7dL74' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 37739076</div><div id='project'> Project Name: microsoft/hi-ml</div><div id='commit'> Commit Name: 5ce9e00fd52f9a4f80c11aa35d3b7152c1ce9fca</div><div id='time'> Time: 2023-02-22</div><div id='author'> Author: 61745616+harshita-s@users.noreply.github.com</div><div id='file'> File Name: hi-ml/src/health_ml/utils/data_augmentations.py</div><div id='m_class'> M Class Name: HEDJitter</div><div id='n_method'> N Class Name: HEDJitter</div><div id='m_method'> M Method Name: __call__(2)</div><div id='n_method'> N Method Name: __call__(2)</div><div id='m_parent_class'> M Parent Class: object</div><div id='n_parent_class'> N Parent Class: object</div><div id='m_file'> M File Name: hi-ml/src/health_ml/utils/data_augmentations.py</div><div id='n_file'> N File Name: hi-ml/src/health_ml/utils/data_augmentations.py</div><div id='m_start'> M Start Line: 75</div><div id='m_end'> M End Line: 78</div><div id='n_start'> N Start Line: 75</div><div id='n_end'> N End Line: 90</div><BR>