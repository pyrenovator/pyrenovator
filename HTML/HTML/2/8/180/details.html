<html><h3>Pattern ID :180
</h3><img src='1642329.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
            values=torch.as_tensor([0, 1]),
            lengths=torch.as_tensor([1, 1]),
        )
        embeddings<a id="change"> = </a>ebc(features)

        &#47&#47 test forward
        &#47&#47 pyre-ignore [16]
        ebc.qconfig = torch.quantization.QConfig(
            activation=torch.quantization.PlaceholderObserver.with_args(
                dtype=torch.qint8
            ),
            weight=torch.quantization.PlaceholderObserver.with_args(dtype=torch.qint8),
        )

        qebc = QuantEmbeddingBagCollection.from_float(ebc)
        quantized_embeddings = qebc(features)

        self.assertEqual(embeddings.keys(), quantized_embeddings.keys())
        self.assertEqual(embeddings["f1"].shape, quantized_embeddings["f1"].shape)
        <a id="change">self.assertTrue(
            torch</a><a id="change">.allclose(
                </a>embeddings["f1"].cpu(),
                quantized_embeddings["f1"].cpu().float()<a id="change">,
                atol=1,
            )
        )</a>
        <a id="change">self.assertTrue(
            torch</a><a id="change">.allclose(
                </a>embeddings["f2"].cpu(),
                quantized_embeddings["f2"].cpu().float()<a id="change">,
                atol=1,
            )
        )</a>

        &#47&#47 test state dict
        state_dict = ebc.state_dict()
        quantized_state_dict = qebc.state_dict()</code></pre><h3>After Change</h3><pre><code class='java'>
            values=torch.as_tensor([0, 1]),
            lengths=torch.as_tensor([1, 1]),
        )
        self._test_ebc(<a id="change">[</a>eb1_config, eb2_config<a id="change"></a>], features)

    def test_shared_tables(self) -&gt; None:
        eb_config = EmbeddingBagConfig(</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 6</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/facebookresearch/torchrec/commit/bb09cecc27d93a503bf3c32c84934bb5f6e0115e#diff-bdcaac2e63eac38308ef554e04a50a999b3d3441fa35725a3d22bc50c455d451L31' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 1642329</div><div id='project'> Project Name: facebookresearch/torchrec</div><div id='commit'> Commit Name: bb09cecc27d93a503bf3c32c84934bb5f6e0115e</div><div id='time'> Time: 2022-02-14</div><div id='author'> Author: xingl@fb.com</div><div id='file'> File Name: torchrec/quant/tests/test_embedding_modules.py</div><div id='m_class'> M Class Name: EmbeddingBagCollectionTest</div><div id='n_method'> N Class Name: EmbeddingBagCollectionTest</div><div id='m_method'> M Method Name: test_ebc(1)</div><div id='n_method'> N Method Name: test_ebc(1)</div><div id='m_parent_class'> M Parent Class: unittest.TestCase</div><div id='n_parent_class'> N Parent Class: unittest.TestCase</div><div id='m_file'> M File Name: torchrec/quant/tests/test_embedding_modules.py</div><div id='n_file'> N File Name: torchrec/quant/tests/test_embedding_modules.py</div><div id='m_start'> M Start Line: 31</div><div id='m_end'> M End Line: 72</div><div id='n_start'> N Start Line: 61</div><div id='n_end'> N End Line: 72</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        )

        qebc = QuantEmbeddingBagCollection.from_float(ebc)
        quantized_embeddings<a id="change"> = </a>qebc(features)

        self.assertEqual(embeddings.keys(), quantized_embeddings.keys())
        self.assertEqual(embeddings["f1"].shape, quantized_embeddings["f1"].shape)
        <a id="change">self.assertTrue(
            </a><a id="change">torch.allclose(
                </a>embeddings["f1"].cpu(),
                quantized_embeddings["f1"].cpu().float()<a id="change">,
                atol=1,
            )
        )</a>
        <a id="change">self.assertTrue(
            </a><a id="change">torch.allclose(
                </a>embeddings["f2"].cpu(),
                quantized_embeddings["f2"].cpu().float()<a id="change">,
                atol=1,
            )
        )</a>

        &#47&#47 test state dict
        state_dict = ebc.state_dict()
        quantized_state_dict = qebc.state_dict()</code></pre><h3>After Change</h3><pre><code class='java'>
            values=torch.as_tensor([0, 1]),
            lengths=torch.as_tensor([1, 1]),
        )
        self._test_ebc(<a id="change">[</a>eb1_config, eb2_config<a id="change"></a>], features)

    def test_shared_tables(self) -&gt; None:
        eb_config = EmbeddingBagConfig(</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/facebookresearch/torchrec/commit/bb09cecc27d93a503bf3c32c84934bb5f6e0115e#diff-bdcaac2e63eac38308ef554e04a50a999b3d3441fa35725a3d22bc50c455d451L24' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 1642328</div><div id='project'> Project Name: facebookresearch/torchrec</div><div id='commit'> Commit Name: bb09cecc27d93a503bf3c32c84934bb5f6e0115e</div><div id='time'> Time: 2022-02-14</div><div id='author'> Author: xingl@fb.com</div><div id='file'> File Name: torchrec/quant/tests/test_embedding_modules.py</div><div id='m_class'> M Class Name: EmbeddingBagCollectionTest</div><div id='n_method'> N Class Name: EmbeddingBagCollectionTest</div><div id='m_method'> M Method Name: test_ebc(1)</div><div id='n_method'> N Method Name: test_ebc(1)</div><div id='m_parent_class'> M Parent Class: unittest.TestCase</div><div id='n_parent_class'> N Parent Class: unittest.TestCase</div><div id='m_file'> M File Name: torchrec/quant/tests/test_embedding_modules.py</div><div id='n_file'> N File Name: torchrec/quant/tests/test_embedding_modules.py</div><div id='m_start'> M Start Line: 31</div><div id='m_end'> M End Line: 72</div><div id='n_start'> N Start Line: 61</div><div id='n_end'> N End Line: 72</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        scale = 0.2
        zero_point = 2
        qr = torch.quantize_per_tensor(r, scale, zero_point, torch.qint8)
        rqr<a id="change"> = </a>qr.dequantize()
        <a id="change">self.assertTrue(</a><a id="change">np.allclose(</a>r.numpy(), rqr.numpy()<a id="change">, atol=2 / scale))</a>
        qr = torch.quantize_per_tensor(r, scale, zero_point, torch.quint8)
        rqr = qr.dequantize()
        <a id="change">self.assertTrue(</a><a id="change">np.allclose(</a>r.numpy(), rqr.numpy()<a id="change">, atol=2 / scale))</a>
        qr = torch.quantize_per_tensor(r, scale, zero_point, torch.qint32)
        rqr = qr.dequantize()
        self.assertTrue(np.allclose(r.numpy(), rqr.numpy(), atol=2 / scale))
</code></pre><h3>After Change</h3><pre><code class='java'>
        r = torch.rand(3, 2, dtype=torch.float) * 4 - 2
        scale = 0.2
        zero_point = 2
        for dtype in <a id="change">[</a>torch.qint8, torch.quint8, torch.qint32, torch.quint4x2<a id="change"></a>]:
            qr = torch.quantize_per_tensor(r, scale, zero_point, dtype)
            rqr = qr.dequantize()
            self.assertTrue(np.allclose(r.numpy(), rqr.numpy(), atol=2 / scale))</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/pytorch/pytorch/commit/04526a49d3c2a691d1a85565c4a96cf3fd6525ad#diff-8588f9eb86d85befaf482705b8d27c2aa1d42e15fba84059cc6c8ff2686df1f0L284' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 1642332</div><div id='project'> Project Name: pytorch/pytorch</div><div id='commit'> Commit Name: 04526a49d3c2a691d1a85565c4a96cf3fd6525ad</div><div id='time'> Time: 2020-10-01</div><div id='author'> Author: supriyar@fb.com</div><div id='file'> File Name: test/quantization/test_quantized_tensor.py</div><div id='m_class'> M Class Name: TestQuantizedTensor</div><div id='n_method'> N Class Name: TestQuantizedTensor</div><div id='m_method'> M Method Name: test_qtensor_dtypes(1)</div><div id='n_method'> N Method Name: test_qtensor_dtypes(1)</div><div id='m_parent_class'> M Parent Class: TestCase</div><div id='n_parent_class'> N Parent Class: TestCase</div><div id='m_file'> M File Name: test/quantization/test_quantized_tensor.py</div><div id='n_file'> N File Name: test/quantization/test_quantized_tensor.py</div><div id='m_start'> M Start Line: 285</div><div id='m_end'> M End Line: 296</div><div id='n_start'> N Start Line: 318</div><div id='n_end'> N End Line: 323</div><BR>