<html><h3>Pattern ID :31163
</h3><img src='91529260.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
        )[1]
        self.las[ChannelNames.PredictedClassification.value][
            assign_idx.cpu()
        ] = <a id="change">self.updates_classification.cpu()</a>
        log.info(f"Saving LAS updated with predicted classes to {self.output_path}")
        self.las.write(self.output_path)

        &#47&#47 Clean-up - get rid of current data to go easy on memory</code></pre><h3>After Change</h3><pre><code class='java'>
        &#47&#47 Cat positions
        self.updates_pos = torch.cat(self.updates_pos)
        self.updates_pos_subsampled = torch.cat(self.updates_pos_subsampled)
        self.updates_probas_subsampled<a id="change"> = </a>torch.cat(self.updates_probas_subsampled)

        device = self.updates_pos.device

        &#47&#47 Cat and remap predictions
        self.updates_classification_subsampled = torch.cat(
            self.updates_classification_subsampled
        )
        self.updates_classification_subsampled = np.vectorize(
            self.reverse_classification_mapper.get
        )(self.updates_classification_subsampled.cpu())
        self.updates_classification_subsampled = torch.from_numpy(
            self.updates_classification_subsampled
        ).to(device)

        &#47&#47 Accelerate KNN by moving to GPU if possible.
        self.las_pos = self.las_pos.to(device)

        &#47&#47 1/2 Interpolate locally to have dense classes in infered zones
        assign_idx = knn(
            self.updates_pos_subsampled,
            self.updates_pos,
            k=1,
            num_workers=1,
        )[1]
        self.updates_classification = self.updates_classification_subsampled[
            assign_idx
        ].cpu()
        <a id="change">self.updates_probas</a> = self.updates_probas_subsampled[assign_idx].cpu()

        &#47&#47 2/2 Propagate dense classes to the full las
        assign_idx = knn(
            self.las_pos,
            self.updates_pos,
            k=1,
            num_workers=1,
        )[1]
        assign_idx = assign_idx.cpu()
        self.las[ChannelNames.PredictedClassification.value][
            assign_idx
        ] = self.updates_classification

        <a id="change">for </a>class_idx_in_tensor, <a id="change">class_name</a> in <a id="change">enumerate(</a>self.names_of_probas_to_save<a id="change">):
            </a>self.las[class_name][assign_idx]<a id="change"> = self.updates_probas[
                :, class_idx_in_tensor
            ]</a>

        log.info(f"Saving LAS updated with predicted classes to {self.output_path}")
        self.las.write(self.output_path)
</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 7</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/ignf/myria3d/commit/ae5f65d713c0db3b5d179db5ccbe6e931655451d#diff-902cbb2db82204bf20e942b82ea58b506a02171c48e074d3d4590356ce38701dL497' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 91529260</div><div id='project'> Project Name: ignf/myria3d</div><div id='commit'> Commit Name: ae5f65d713c0db3b5d179db5ccbe6e931655451d</div><div id='time'> Time: 2022-01-17</div><div id='author'> Author: charles.gaydon@gmail.com</div><div id='file'> File Name: src/datamodules/processing.py</div><div id='m_class'> M Class Name: DataHandler</div><div id='n_method'> N Class Name: DataHandler</div><div id='m_method'> M Method Name: _interpolate_classification_and_save(2)</div><div id='n_method'> N Method Name: _interpolate_classification_and_save(2)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: src/datamodules/processing.py</div><div id='n_file'> N File Name: src/datamodules/processing.py</div><div id='m_start'> M Start Line: 497</div><div id='m_end'> M End Line: 521</div><div id='n_start'> N Start Line: 507</div><div id='n_end'> N End Line: 565</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        )[1]
        self.las[ChannelNames.PredictedClassification.value][
            assign_idx.cpu()
        ] = <a id="change">self.updates_classification.cpu()</a>
        log.info(f"Saving LAS updated with predicted classes to {self.output_path}")
        self.las.write(self.output_path)

        &#47&#47 Clean-up - get rid of current data to go easy on memory</code></pre><h3>After Change</h3><pre><code class='java'>
        self.updates_classification = self.updates_classification_subsampled[
            assign_idx
        ].cpu()
        <a id="change">self.updates_probas = </a>self.updates_probas_subsampled[assign_idx].cpu()

        &#47&#47 2/2 Propagate dense classes to the full las
        assign_idx = knn(
            self.las_pos,
            self.updates_pos,
            k=1,
            num_workers=1,
        )[1]
        assign_idx = assign_idx.cpu()
        self.las[ChannelNames.PredictedClassification.value][
            assign_idx
        ] = self.updates_classification

        <a id="change">for </a>class_idx_in_tensor, <a id="change">class_name</a> in <a id="change">enumerate(</a>self.names_of_probas_to_save<a id="change">):
            </a>self.las[class_name][assign_idx]<a id="change"> = self.updates_probas[
                :, class_idx_in_tensor
            ]</a>

        log.info(f"Saving LAS updated with predicted classes to {self.output_path}")
        self.las.write(self.output_path)
</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/ignf/myria3d/commit/ae5f65d713c0db3b5d179db5ccbe6e931655451d#diff-902cbb2db82204bf20e942b82ea58b506a02171c48e074d3d4590356ce38701dL471' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 91529261</div><div id='project'> Project Name: ignf/myria3d</div><div id='commit'> Commit Name: ae5f65d713c0db3b5d179db5ccbe6e931655451d</div><div id='time'> Time: 2022-01-17</div><div id='author'> Author: charles.gaydon@gmail.com</div><div id='file'> File Name: src/datamodules/processing.py</div><div id='m_class'> M Class Name: DataHandler</div><div id='n_method'> N Class Name: DataHandler</div><div id='m_method'> M Method Name: _interpolate_classification_and_save(2)</div><div id='n_method'> N Method Name: _interpolate_classification_and_save(2)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: src/datamodules/processing.py</div><div id='n_file'> N File Name: src/datamodules/processing.py</div><div id='m_start'> M Start Line: 497</div><div id='m_end'> M End Line: 521</div><div id='n_start'> N Start Line: 507</div><div id='n_end'> N End Line: 565</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        original_predictions = self._original_predictions

        &#47&#47 handle only first image (batch=1)
        predictions_in_xyxy_format = <a id="change">original_predictions.xyxy[0].cpu()</a>.detach().numpy()

        object_prediction_list = []
</code></pre><h3>After Change</h3><pre><code class='java'>

        &#47&#47 compatilibty for sahi v0.8.15
        if isinstance(shift_amount_list[0], int):
            <a id="change">shift_amount_list = </a>[shift_amount_list]
        if full_shape_list is not None and isinstance(full_shape_list[0], int):
            full_shape_list = [full_shape_list]

        &#47&#47 handle all predictions
        object_prediction_list_per_image = []
        <a id="change">for </a>image_ind, <a id="change">image_predictions_in_xyxy_format</a> in <a id="change">enumerate(</a>original_predictions.xyxy<a id="change">):
            </a>shift_amount<a id="change"> = shift_amount_list[image_ind]</a>
            full_shape = None if full_shape_list is None else full_shape_list[image_ind]
            object_prediction_list = []

            &#47&#47 process predictions</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/obss/sahi/commit/248cd2df7d3450eea48c0f03b75d1b7d0111dcf4#diff-34fb6fd3619110ee74df2d3aafa1b22f7cf122b36a43ec080f4dde16059022a3L455' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 91529259</div><div id='project'> Project Name: obss/sahi</div><div id='commit'> Commit Name: 248cd2df7d3450eea48c0f03b75d1b7d0111dcf4</div><div id='time'> Time: 2021-12-19</div><div id='author'> Author: 34196005+fcakyon@users.noreply.github.com</div><div id='file'> File Name: sahi/model.py</div><div id='m_class'> M Class Name: Yolov5DetectionModel</div><div id='n_method'> N Class Name: Yolov5DetectionModel</div><div id='m_method'> M Method Name: _create_object_prediction_list_from_original_predictions(3)</div><div id='n_method'> N Method Name: _create_object_prediction_list_from_original_predictions(3)</div><div id='m_parent_class'> M Parent Class: DetectionModel</div><div id='n_parent_class'> N Parent Class: DetectionModel</div><div id='m_file'> M File Name: sahi/model.py</div><div id='n_file'> N File Name: sahi/model.py</div><div id='m_start'> M Start Line: 470</div><div id='m_end'> M End Line: 509</div><div id='n_start'> N Start Line: 433</div><div id='n_end'> N End Line: 484</div><BR>