<html><h3>Pattern ID :31512
</h3><img src='92172199.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
                                    inference_cuda_module.residual_add_bias_fp32

    def forward(self, input, residual, residual_norm, bias):
        <a id="change">return </a>DeepSpeedMLPFunction.apply(input,
                                          residual,
                                          residual_norm,
                                          bias,</code></pre><h3>After Change</h3><pre><code class='java'>
            add_bias=bias is not None,
            residual_add=residual_add)

        <a id="change">if self.mp_group is not None and dist.get_world_size(group=self.mp_group) &gt; 1</a>:
            dist.all_reduce(residual, group=self.mp_group)

        return residual</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 5</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/microsoft/deepspeed/commit/c702b64c94243674c3143a4cf29d59777a88307d#diff-9e4ae80750d7192e689307f7e660fd912cebc385a8af9dd8aecb8db714ab98d1L67' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 92172199</div><div id='project'> Project Name: microsoft/deepspeed</div><div id='commit'> Commit Name: c702b64c94243674c3143a4cf29d59777a88307d</div><div id='time'> Time: 2023-01-09</div><div id='author'> Author: jerasley@microsoft.com</div><div id='file'> File Name: deepspeed/ops/transformer/inference/ds_mlp.py</div><div id='m_class'> M Class Name: DeepSpeedMLP</div><div id='n_method'> N Class Name: DeepSpeedMLP</div><div id='m_method'> M Method Name: forward(5)</div><div id='n_method'> N Method Name: forward(5)</div><div id='m_parent_class'> M Parent Class: nn.Module</div><div id='n_parent_class'> N Parent Class: nn.Module</div><div id='m_file'> M File Name: deepspeed/ops/transformer/inference/ds_mlp.py</div><div id='n_file'> N File Name: deepspeed/ops/transformer/inference/ds_mlp.py</div><div id='m_start'> M Start Line: 159</div><div id='m_end'> M End Line: 178</div><div id='n_start'> N Start Line: 67</div><div id='n_end'> N End Line: 94</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
            )
            num = images.size()
            top1 = (pred_labels[:, 0] == targets).float().sum()
            <a id="change">return </a>(num, top1)

    def validation_epoch_end(self, outputs):
        device = self.dummy_param.device</code></pre><h3>After Change</h3><pre><code class='java'>
                self.knn_k,
                self.knn_t,
            )
            <a id="change">if dist.is_initialized() and dist.get_world_size() &gt; 0</a>:
                &#47&#47 gather predictions and targets from all processes
                predicted_labels = torch.cat(dist.gather(predicted_labels), 0)
                targets = torch.cat(dist.gather(targets), 0)</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/lightly-ai/lightly/commit/000ebaa81361959c8cf9e4075f5c3e393df41a93#diff-43cbddca9ace4b754deea3ba36c45bcae6f3ffb12e574453ee9017566b6a35d2L195' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 92172196</div><div id='project'> Project Name: lightly-ai/lightly</div><div id='commit'> Commit Name: 000ebaa81361959c8cf9e4075f5c3e393df41a93</div><div id='time'> Time: 2023-04-12</div><div id='author'> Author: 43336610+guarin@users.noreply.github.com</div><div id='file'> File Name: lightly/utils/benchmarking.py</div><div id='m_class'> M Class Name: BenchmarkModule</div><div id='n_method'> N Class Name: BenchmarkModule</div><div id='m_method'> M Method Name: validation_step(3)</div><div id='n_method'> N Method Name: validation_step(3)</div><div id='m_parent_class'> M Parent Class: LightningModule</div><div id='n_parent_class'> N Parent Class: LightningModule</div><div id='m_file'> M File Name: lightly/utils/benchmarking.py</div><div id='n_file'> N File Name: lightly/utils/benchmarking.py</div><div id='m_start'> M Start Line: 197</div><div id='m_end'> M End Line: 211</div><div id='n_start'> N Start Line: 203</div><div id='n_end'> N End Line: 221</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
            self.score_context_func,
            alibi)

        <a id="change">return </a>output
</code></pre><h3>After Change</h3><pre><code class='java'>

        inp_norm = qkv_out[-1]

        <a id="change">if self.config.mlp_after_attn and self.mp_group is not None and dist.get_world_size(
                group=self.mp_group) &gt; 1</a>:
            dist.all_reduce(output, group=self.mp_group)

        return (output, key_layer, value_layer, context_layer, inp_norm)</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/microsoft/deepspeed/commit/bb68c526ad2c267dfb235db9c0d0fb1413d19a34#diff-88a3148746124b4093264a91ae8cac5be0bb592bfb2868d5df944836e55d93dbL446' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 92172195</div><div id='project'> Project Name: microsoft/deepspeed</div><div id='commit'> Commit Name: bb68c526ad2c267dfb235db9c0d0fb1413d19a34</div><div id='time'> Time: 2022-12-22</div><div id='author'> Author: jerasley@microsoft.com</div><div id='file'> File Name: deepspeed/ops/transformer/inference/ds_attention.py</div><div id='m_class'> M Class Name: DeepSpeedSelfAttention</div><div id='n_method'> N Class Name: DeepSpeedSelfAttention</div><div id='m_method'> M Method Name: forward(12)</div><div id='n_method'> N Method Name: forward(12)</div><div id='m_parent_class'> M Parent Class: nn.Module</div><div id='n_parent_class'> N Parent Class: nn.Module</div><div id='m_file'> M File Name: deepspeed/ops/transformer/inference/ds_attention.py</div><div id='n_file'> N File Name: deepspeed/ops/transformer/inference/ds_attention.py</div><div id='m_start'> M Start Line: 458</div><div id='m_end'> M End Line: 485</div><div id='n_start'> N Start Line: 120</div><div id='n_end'> N End Line: 151</div><BR>