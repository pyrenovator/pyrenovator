<html><h3>Pattern ID :27632
</h3><img src='81992019.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
        &#47&#47 (weight_name, importance_feature) = list(a_model.items())[-2]
        gradient = []
        protected_keys = []
        all_keys<a id="change"> = </a><a id="change">list(</a><a id="change">global_model_of_last_round.keys())</a>
        if self.protected_layers is not None:
            for protected_layer_idx in self.protected_layers:
                protected_keys.append(all_keys[protected_layer_idx])
        for key in global_model_of_last_round.keys():</code></pre><h3>After Change</h3><pre><code class='java'>

        layer_counter = 0
        for k, _ in global_model_of_last_round.items():
            <a id="change">if </a>"weight" in k or "bias" in k:
                if self.protected_layers is not None and layer_counter in self.protected_layers:
                    gradient.append(torch.from_numpy(np.zeros(global_model_of_last_round[k].size())).float())
                    &#47&#47 if the layer is protected, set to 0
                else:
                    gradient.append(a_model[k] - <a id="change">global_model_of_last_round[k].to(</a>self.device<a id="change">)</a>)  &#47&#47 todo: to double check
                layer_counter<a id="change"> += </a>1
        gradient = tuple(gradient)
        dummy_data = torch.randn(self.original_data_size)
        dummy_label = torch.randn(self.original_label_size)</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 6</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/fedml-ai/fedml/commit/a8f8cebbb7d07c671b270a83c08006501c221f2d#diff-a92997ecfd5ba4b0ec93d15f6288db32b01531d977514bb529e3da431799ae44L55' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 81992019</div><div id='project'> Project Name: fedml-ai/fedml</div><div id='commit'> Commit Name: a8f8cebbb7d07c671b270a83c08006501c221f2d</div><div id='time'> Time: 2023-03-07</div><div id='author'> Author: sshan0731@hotmail.com</div><div id='file'> File Name: python/fedml/core/security/attack/dlg_attack.py</div><div id='m_class'> M Class Name: DLGAttack</div><div id='n_method'> N Class Name: DLGAttack</div><div id='m_method'> M Method Name: reconstruct_data(3)</div><div id='n_method'> N Method Name: reconstruct_data(3)</div><div id='m_parent_class'> M Parent Class: BaseAttackMethod</div><div id='n_parent_class'> N Parent Class: BaseAttackMethod</div><div id='m_file'> M File Name: python/fedml/core/security/attack/dlg_attack.py</div><div id='n_file'> N File Name: python/fedml/core/security/attack/dlg_attack.py</div><div id='m_start'> M Start Line: 55</div><div id='m_end'> M End Line: 70</div><div id='n_start'> N Start Line: 59</div><div id='n_end'> N End Line: 71</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        &#47&#47 (weight_name, importance_feature) = list(a_model.items())[-2]
        gradient = []
        protected_keys = []
        all_keys<a id="change"> = </a><a id="change">list(</a><a id="change">global_model_of_last_round.keys())</a>
        if self.protected_layers is not None:
            for protected_layer_idx in self.protected_layers:
                protected_keys.append(all_keys[protected_layer_idx])
        for key in global_model_of_last_round.keys():</code></pre><h3>After Change</h3><pre><code class='java'>

        layer_counter = 0
        for k, _ in global_model_of_last_round.items():
            <a id="change">if </a>"weight" in k or "bias" in k:
                if self.protected_layers is not None and layer_counter in self.protected_layers:
                    gradient.append(torch.from_numpy(np.zeros(global_model_of_last_round[k].size())).float())
                    &#47&#47 if the layer is protected, set to 0
                else:
                    gradient.append(a_model[k] - <a id="change">global_model_of_last_round[k].to(</a>self.device<a id="change">)</a>)  &#47&#47 todo: to double check
                layer_counter<a id="change"> += </a>1
        gradient = tuple(gradient)
        dummy_data = torch.randn(self.original_data_size)
        dummy_label = torch.randn(self.original_label_size)</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/fedml-ai/fedml/commit/901b7f6432b4712acd8a9eebf98365a857db5f53#diff-a92997ecfd5ba4b0ec93d15f6288db32b01531d977514bb529e3da431799ae44L54' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 81992018</div><div id='project'> Project Name: fedml-ai/fedml</div><div id='commit'> Commit Name: 901b7f6432b4712acd8a9eebf98365a857db5f53</div><div id='time'> Time: 2023-03-07</div><div id='author'> Author: sshan0731@hotmail.com</div><div id='file'> File Name: python/fedml/core/security/attack/dlg_attack.py</div><div id='m_class'> M Class Name: DLGAttack</div><div id='n_method'> N Class Name: DLGAttack</div><div id='m_method'> M Method Name: reconstruct_data(3)</div><div id='n_method'> N Method Name: reconstruct_data(3)</div><div id='m_parent_class'> M Parent Class: BaseAttackMethod</div><div id='n_parent_class'> N Parent Class: BaseAttackMethod</div><div id='m_file'> M File Name: python/fedml/core/security/attack/dlg_attack.py</div><div id='n_file'> N File Name: python/fedml/core/security/attack/dlg_attack.py</div><div id='m_start'> M Start Line: 55</div><div id='m_end'> M End Line: 70</div><div id='n_start'> N Start Line: 59</div><div id='n_end'> N End Line: 71</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>

    compressed_st = {&quotstate_dict&quot: {}}

    layers<a id="change"> = </a><a id="change">list(</a><a id="change">st[&quotstate_dict&quot].keys())</a>
    print("getting compression")

    for name in layers:
        &#47&#47 print(each)</code></pre><h3>After Change</h3><pre><code class='java'>
def compress(delta_ckpt, ckpt, diffuser=False, compression_ratio=0.6, device=&quotcuda&quot):
    st = torch.load(f&quot{delta_ckpt}&quot)

    <a id="change">if </a>not diffuser:
        compressed_key = &quotstate_dict&quot
        compressed_st<a id="change"> = </a>{compressed_key: {}}
        pretrained_st = torch.load(ckpt)[&quotstate_dict&quot]
        if &quotembed&quot in st[&quotstate_dict&quot]:
            compressed_st[&quotstate_dict&quot][&quotembed&quot] = st[&quotstate_dict&quot][&quotembed&quot]
            del st[&quotstate_dict&quot][&quotembed&quot]

        st = st[&quotstate_dict&quot]
    else:
        from diffusers import StableDiffusionPipeline
        compressed_key = &quotunet&quot
        compressed_st = {compressed_key: {}}
        pretrained_st = <a id="change">StableDiffusionPipeline.from_pretrained(ckpt, torch_dtype=torch.float16).to(</a>"cuda"<a id="change">)</a>
        pretrained_st = pretrained_st.unet.state_dict()
        if &quotmodifier_token&quot in st:
            compressed_st[&quotmodifier_token&quot] = st[&quotmodifier_token&quot]
        st = st[&quotunet&quot]</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/adobe-research/custom-diffusion/commit/5cd1e9c869b793d88573533a6a2adccd10aadcd0#diff-0f4293c247a4f4e8eab25c82da6ce7037c91175297d9dae021e3b167f28c1121L9' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 81992017</div><div id='project'> Project Name: adobe-research/custom-diffusion</div><div id='commit'> Commit Name: 5cd1e9c869b793d88573533a6a2adccd10aadcd0</div><div id='time'> Time: 2023-01-05</div><div id='author'> Author: nupurkumari@Nupurs-MacBook-Pro.local</div><div id='file'> File Name: src/compress.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: compress(5)</div><div id='n_method'> N Method Name: compress(4)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: src/compress.py</div><div id='n_file'> N File Name: src/compress.py</div><div id='m_start'> M Start Line: 10</div><div id='m_end'> M End Line: 48</div><div id='n_start'> N Start Line: 8</div><div id='n_end'> N End Line: 48</div><BR>