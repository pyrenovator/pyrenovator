<html><h3>Pattern ID :27496
</h3><img src='81602884.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>

    feature_path = Path(export_dir, conf[&quotoutput&quot]+&quot.h5&quot)
    feature_path.parent.mkdir(exist_ok=True, parents=True)
    feature_file<a id="change"> = </a><a id="change">h5py.File(</a>str(feature_path), &quota&quot<a id="change">)</a>

    for data in tqdm(loader):
        if data[&quotname&quot][0] in feature_file:
            continue

        pred = model(map_tensor(data, lambda x: x.to(device)))
        pred = {k: v[0].cpu().numpy() for k, v in pred.items()}

        pred[&quotimage_size&quot] = original_size = data[&quotoriginal_size&quot][0].numpy()
        if &quotkeypoints&quot in pred:
            size = np.array(data[&quotimage&quot].shape[-2:][::-1])
            scales = (original_size / size).astype(np.float32)
            pred[&quotkeypoints&quot] = (pred[&quotkeypoints&quot] + .5) * scales[None] - .5

        if as_half:
            for k in pred:
                dt = pred[k].dtype
                if (dt == np.float32) and (dt != np.float16):
                    pred[k] = pred[k].astype(np.float16)

        grp = feature_file.create_group(data[&quotname&quot][0])
        for k, v in pred.items():
            grp.create_dataset(k, data=v)

        del pred

    <a id="change">feature_file.close()</a>
    logging.info(&quotFinished exporting features.&quot)

    return feature_path
</code></pre><h3>After Change</h3><pre><code class='java'>
                if (dt == np.float32) and (dt != np.float16):
                    pred[k] = pred[k].astype(np.float16)

        <a id="change">with h5py</a><a id="change">.File(str(feature_path), &quota&quot) as fd:
            </a>grp = fd.create_group(name)
            for k, v in pred.items():
                grp.create_dataset(k, data=v)
</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 6</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/cvg/hierarchical-localization/commit/4c974ed124a70aab5b85abb8c20c7dbeb18aa3c9#diff-23a056c8242f7db0eb87a42b37e0039462b8a5b0cd71f83e8605d6644338d045L158' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 81602884</div><div id='project'> Project Name: cvg/hierarchical-localization</div><div id='commit'> Commit Name: 4c974ed124a70aab5b85abb8c20c7dbeb18aa3c9</div><div id='time'> Time: 2021-06-26</div><div id='author'> Author: paul.edouard.sarlin@gmail.com</div><div id='file'> File Name: hloc/extract_features.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: main(6)</div><div id='n_method'> N Method Name: main(5)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: hloc/extract_features.py</div><div id='n_file'> N File Name: hloc/extract_features.py</div><div id='m_start'> M Start Line: 173</div><div id='m_end'> M End Line: 205</div><div id='n_start'> N Start Line: 158</div><div id='n_end'> N End Line: 203</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>

    def load_dataset(self):
        if self.hdf5_path is not None:
            self.hdf5<a id="change"> = </a><a id="change">h5.File(</a>self.hdf5_path, &quotr&quot<a id="change">)</a>
            if self.load_data_in_memory:
                print("Load {path} into memory.".format(path=self.hdf5_path))
                self.data = np.transpose(self.hdf5["imgs"], (0, 2, 3, 1))[:]
                self.labels = self.hdf5["labels"][:]
                <a id="change">self.hdf5.close()</a>
            return

        if self.data_name == "CIFAR10":
            self.data = CIFAR10(root=self.data_dir, train=self.train, download=True)</code></pre><h3>After Change</h3><pre><code class='java'>

    def load_dataset(self):
        if self.hdf5_path is not None:
            <a id="change">with h5</a><a id="change">.File(self.hdf5_path, "r") as f:
                </a>data, labels = f["imgs"], f["labels"]
                self.num_dataset = data.shape[0]
                if self.load_data_in_memory:
                    print("Load {path} into memory.".format(path=self.hdf5_path))</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/postech-cvlab/pytorch-studiogan/commit/b80b3b9d8b2e07f44ed25a21a795f2b759a2e70d#diff-bbfa5cf6d60fbd1a3659875cf1ec77383df18e6c83fb8656ca0258cbdb4c8938L90' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 81602883</div><div id='project'> Project Name: postech-cvlab/pytorch-studiogan</div><div id='commit'> Commit Name: b80b3b9d8b2e07f44ed25a21a795f2b759a2e70d</div><div id='time'> Time: 2021-09-09</div><div id='author'> Author: first287@naver.com</div><div id='file'> File Name: src/data_util.py</div><div id='m_class'> M Class Name: Dataset_</div><div id='n_method'> N Class Name: Dataset_</div><div id='m_method'> M Method Name: load_dataset(1)</div><div id='n_method'> N Method Name: load_dataset(1)</div><div id='m_parent_class'> M Parent Class: Dataset</div><div id='n_parent_class'> N Parent Class: Dataset</div><div id='m_file'> M File Name: src/data_util.py</div><div id='n_file'> N File Name: src/data_util.py</div><div id='m_start'> M Start Line: 92</div><div id='m_end'> M End Line: 98</div><div id='n_start'> N Start Line: 91</div><div id='n_end'> N End Line: 98</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
            import h5py

            print("&gt;&gt;&gt;&gt; Reload mismatched weights: {} -&gt; {}".format(request_resolution, (input_height, input_width)))
            ff<a id="change"> = </a><a id="change">h5py.File(</a>weight_file<a id="change">, mode="r")</a>
            weights = ff["model_weights"] if "model_weights" in ff else ff  &#47&#47 full model or weights only

            if isinstance(mismatch_class, (list, tuple)):
                is_mismatch_class = lambda xx: any([isinstance(ii, mm) for mm in mismatch_class])
            else:
                is_mismatch_class = lambda xx: isinstance(ii, mismatch_class)

            method_kwarg = {} if method is None else {"method": method}  &#47&#47 None for using class default one
            for ii in model.layers:
                if is_mismatch_class(ii) and ii.name in weights:
                    print("&gt;&gt;&gt;&gt; Reload layer:", ii.name)
                    ss = weights[ii.name]
                    &#47&#47 ss = {ww.decode().split("/")[-1] : tf.convert_to_tensor(ss[ww]) for ww in ss.attrs[&quotweight_names&quot]}
                    ss = {ww.decode("utf8") if hasattr(ww, "decode") else ww: tf.convert_to_tensor(ss[ww]) for ww in ss.attrs["weight_names"]}
                    ss = {kk.split("/")[-1]: vv for kk, vv in ss.items()}
                    model.get_layer(ii.name).load_resized_weights(ss, **method_kwarg)
            <a id="change">ff.close()</a>

        &#47&#47 print("&gt;&gt;&gt;&gt; Reload mismatched PositionalEmbedding weights: {} -&gt; {}".format(request_resolution, input_shape[0]))
        &#47&#47 bb = keras.models.load_model(pretrained_model)
        &#47&#47 for ii in model.layers:</code></pre><h3>After Change</h3><pre><code class='java'>
            import h5py

            print("&gt;&gt;&gt;&gt; Reload mismatched weights: {} -&gt; {}".format(request_resolution, (input_height, input_width)))
            <a id="change">with h5py</a><a id="change">.File(weight_file, mode="r") as h5_file:
                </a>weights = h5_file["model_weights"] if "model_weights" in h5_file else h5_file  &#47&#47 full model or weights only

                if isinstance(mismatch_class, (list, tuple)):
                    is_mismatch_class = lambda xx: any([isinstance(ii, mm) for mm in mismatch_class])</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/leondgarse/keras_cv_attention_models/commit/1aa29dc686f862bc1ff66a11700fa8ef16bd2b8a#diff-37028f58f90dc39d0ed1f23dec40bd7e001ad2d587c2dd6ddd16655aaec34d38L51' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 81602882</div><div id='project'> Project Name: leondgarse/keras_cv_attention_models</div><div id='commit'> Commit Name: 1aa29dc686f862bc1ff66a11700fa8ef16bd2b8a</div><div id='time'> Time: 2023-02-03</div><div id='author'> Author: leondgarse@gmail.com</div><div id='file'> File Name: keras_cv_attention_models/download_and_load.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: load_weights_with_mismatch(6)</div><div id='n_method'> N Method Name: load_weights_with_mismatch(6)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: keras_cv_attention_models/download_and_load.py</div><div id='n_file'> N File Name: keras_cv_attention_models/download_and_load.py</div><div id='m_start'> M Start Line: 57</div><div id='m_end'> M End Line: 90</div><div id='n_start'> N Start Line: 55</div><div id='n_end'> N End Line: 87</div><BR>