<html><h3>Pattern ID :587
</h3><img src='2964781.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
        

        &#47&#47 Start threads
        <a id="change">self.pull_thread.start()</a>
        for thread in self.update_threads:
            thread.start()
        for thread in self.push_threads:
            thread.start()</code></pre><h3>After Change</h3><pre><code class='java'>
                for thread in self.update_threads:
                    thread.start()
                break
        <a id="change">while True</a><a id="change">:
            if </a>not self.pq.empty():
                for thread in self.push_threads:
                    thread.start()
                <a id="change">break</a>

        &#47&#47 Try to join if not running in background
        if not self.run_in_background:
            for thread in self.push_threads:</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 4</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/relevanceai/relevanceai/commit/7ff72b8da8f8f2f61d3a29dc59d133f21bf48232#diff-6381bc42fc96d5408fc21bc0c5e13e7e988d68b4ad1b822e38153923b3d9ccf4L518' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 2964781</div><div id='project'> Project Name: relevanceai/relevanceai</div><div id='commit'> Commit Name: 7ff72b8da8f8f2f61d3a29dc59d133f21bf48232</div><div id='time'> Time: 2022-09-12</div><div id='author'> Author: joseph.twin@relevance.ai</div><div id='file'> File Name: relevanceai/operations_new/ops_run.py</div><div id='m_class'> M Class Name: PullTransformPush</div><div id='n_method'> N Class Name: PullTransformPush</div><div id='m_method'> M Method Name: _run_worker_threads(1)</div><div id='n_method'> N Method Name: _run_worker_threads(1)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: relevanceai/operations_new/ops_run.py</div><div id='n_file'> N File Name: relevanceai/operations_new/ops_run.py</div><div id='m_start'> M Start Line: 518</div><div id='m_end'> M End Line: 525</div><div id='n_start'> N Start Line: 518</div><div id='n_end'> N End Line: 530</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
            self.dht_handler_thread.start()

        if self.checkpoint_saver is not None:
            <a id="change">self.checkpoint_saver.start()</a>

        for process in self.conn_handlers:
            if not process.is_alive():
                process.start()</code></pre><h3>After Change</h3><pre><code class='java'>
            self.start()

    def run(self):
        <a id="change">while True</a><a id="change">:
            </a>block_indices = self._choose_blocks()
            self.module_container = ModuleContainer.create(
                dht=self.dht,
                prefix=self.prefix,
                converted_model_name_or_path=self.converted_model_name_or_path,
                block_config=self.block_config,
                memory_cache=self.memory_cache,
                throughput=self.throughput,
                block_indices=block_indices,
                num_handlers=self.num_handlers,
                min_batch_size=self.min_batch_size,
                max_batch_size=self.max_batch_size,
                inference_max_length=self.inference_max_length,
                torch_dtype=self.torch_dtype,
                cache_dir=self.cache_dir,
                device=self.device,
                compression=self.compression,
                stats_report_interval=self.stats_report_interval,
                update_period=self.update_period,
                expiration=self.expiration,
                prefetch_batches=self.prefetch_batches,
                sender_threads=self.sender_threads,
                use_auth_token=self.use_auth_token,
                load_in_8bit=self.load_in_8bit,
                start=True,
            )
            try:
                self.module_container.ready.wait()

                while True:
                    timeout = random.random() * 2 * self.mean_balance_check_period
                    &#47&#47 TODO: Follow ModuleContainer status (to restart/stop if it crashes)
                    <a id="change">if </a>self.stop.wait(timeout):
                        return

                    if self._should_choose_other_blocks():
                        logger.info("Swarm is imbalanced, server will load other blocks")
                        <a id="change">break</a>  &#47&#47 Stop serving this set of modules
            finally:
                self.module_container.shutdown()
</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/bigscience-workshop/distributed-bloom/commit/149f433763e2eb332b16de91cf47809579706001#diff-e0bb43e77afdc23f85aefba41e3d8fda1554c6402c8e08536508ed6246d8068fL68' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 2964717</div><div id='project'> Project Name: bigscience-workshop/distributed-bloom</div><div id='commit'> Commit Name: 149f433763e2eb332b16de91cf47809579706001</div><div id='time'> Time: 2022-10-12</div><div id='author'> Author: hxrussia@gmail.com</div><div id='file'> File Name: src/server/server.py</div><div id='m_class'> M Class Name: Server</div><div id='n_method'> N Class Name: Server</div><div id='m_method'> M Method Name: run(1)</div><div id='n_method'> N Method Name: run(1)</div><div id='m_parent_class'> M Parent Class: threading.Thread</div><div id='n_parent_class'> N Parent Class: threading.Thread</div><div id='m_file'> M File Name: src/server/server.py</div><div id='n_file'> N File Name: src/server/server.py</div><div id='m_start'> M Start Line: 73</div><div id='m_end'> M End Line: 99</div><div id='n_start'> N Start Line: 148</div><div id='n_end'> N End Line: 190</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
            listen = threading.Thread(target=self.listen_clients)

            activate.start()
            <a id="change">listen.start()</a>

            activate.join()
            listen.join()
</code></pre><h3>After Change</h3><pre><code class='java'>
            activate = threading.Thread(target=self.activate_clients)
            activate.start()

            <a id="change">while True</a><a id="change">:
                </a>sender, message_code, payload = PackageProcessor.recv_package()
                update_flag = self.on_receive(sender, message_code, payload)
                <a id="change">if </a>update_flag:
                    <a id="change">break</a>

        self.shutdown_clients()

    def on_receive(self, sender, message_code, payload):</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/smilelab-fl/fedlab/commit/66cdbfe7b10494d8cf8d6260214b0f8cb75b34ea#diff-846e3803606bd9e9a353f0a104d34ee2313532f2995f68e6fb0ead96e958f3ddL79' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 2964748</div><div id='project'> Project Name: smilelab-fl/fedlab</div><div id='commit'> Commit Name: 66cdbfe7b10494d8cf8d6260214b0f8cb75b34ea</div><div id='time'> Time: 2021-07-03</div><div id='author'> Author: 928255708@qq.com</div><div id='file'> File Name: fedlab_core/server/topology.py</div><div id='m_class'> M Class Name: ServerSynchronousTopology</div><div id='n_method'> N Class Name: ServerSynchronousTopology</div><div id='m_method'> M Method Name: run(1)</div><div id='n_method'> N Method Name: run(1)</div><div id='m_parent_class'> M Parent Class: Topology</div><div id='n_parent_class'> N Parent Class: ServerBasicTopology</div><div id='m_file'> M File Name: fedlab_core/server/topology.py</div><div id='n_file'> N File Name: fedlab_core/server/topology.py</div><div id='m_start'> M Start Line: 92</div><div id='m_end'> M End Line: 99</div><div id='n_start'> N Start Line: 90</div><div id='n_end'> N End Line: 96</div><BR>