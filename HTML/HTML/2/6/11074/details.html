<html><h3>Pattern ID :11074
</h3><img src='38147524.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
    check_file(os.path.join(third_party_path, &quotonnx&quot, &quotCMakeLists.txt&quot))
    check_file(os.path.join(third_party_path, &quotfoxi&quot, &quotCMakeLists.txt&quot))
    check_file(os.path.join(third_party_path, &quotQNNPACK&quot, &quotCMakeLists.txt&quot))
    check_file(<a id="change">os.path.join(</a>third_party_path, &quotfbgemm&quot, &quotCMakeLists.txt&quot<a id="change">)</a>)
    check_file(os.path.join(third_party_path, &quotfbgemm&quot, &quotthird_party&quot,
                            &quotasmjit&quot, &quotCMakeLists.txt&quot))
    check_file(os.path.join(third_party_path, &quotonnx&quot, &quotthird_party&quot,</code></pre><h3>After Change</h3><pre><code class='java'>
    if all(not_exists_or_empty(folder) for folder in folders):
        try:
            print(&quot --- Trying to initialize submodules&quot)
            start<a id="change"> = time</a><a id="change">.time()</a>
            subprocess.check_call(["git", "submodule", "update", "--init", "--recursive"], cwd=cwd)
            end = <a id="change">time.time()</a>
            print(&quot --- Submodule initialization took {:.2f} sec&quot.format(end<a id="change"> - </a>start))
        except Exception:
            print(&quot --- Submodule initalization failed&quot)
            print(&quotPlease run:\n\tgit submodule update --init --recursive&quot)</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 3</div><BR><div id='size'>Non-data size: 5</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/pytorch/pytorch/commit/7e6a84d2387e1693365f8650d9990c8adc4c7bf4#diff-60f61ab7a8d1910d86d9fda2261620314edcae5894d5aaa236b821c7256badd7L309' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 38147524</div><div id='project'> Project Name: pytorch/pytorch</div><div id='commit'> Commit Name: 7e6a84d2387e1693365f8650d9990c8adc4c7bf4</div><div id='time'> Time: 2021-03-09</div><div id='author'> Author: nshulga@fb.com</div><div id='file'> File Name: setup.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: check_submodules(0)</div><div id='n_method'> N Method Name: check_submodules(0)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: setup.py</div><div id='n_file'> N File Name: setup.py</div><div id='m_start'> M Start Line: 309</div><div id='m_end'> M End Line: 319</div><div id='n_start'> N Start Line: 324</div><div id='n_end'> N End Line: 344</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
    check_file(os.path.join(third_party_path, &quotonnx&quot, &quotCMakeLists.txt&quot))
    check_file(os.path.join(third_party_path, &quotfoxi&quot, &quotCMakeLists.txt&quot))
    check_file(os.path.join(third_party_path, &quotQNNPACK&quot, &quotCMakeLists.txt&quot))
    check_file(<a id="change">os.path.join(</a>third_party_path, &quotfbgemm&quot, &quotCMakeLists.txt&quot<a id="change">)</a>)
    check_file(os.path.join(third_party_path, &quotfbgemm&quot, &quotthird_party&quot,
                            &quotasmjit&quot, &quotCMakeLists.txt&quot))
    check_file(os.path.join(third_party_path, &quotonnx&quot, &quotthird_party&quot,</code></pre><h3>After Change</h3><pre><code class='java'>
    if all(not_exists_or_empty(folder) for folder in folders):
        try:
            print(&quot --- Trying to initialize submodules&quot)
            start = <a id="change">time.time()</a>
            subprocess.check_call(["git", "submodule", "update", "--init", "--recursive"], cwd=cwd)
            end<a id="change"> = </a><a id="change">time.time()</a>
            print(&quot --- Submodule initialization took {:.2f} sec&quot.format(end<a id="change"> - </a>start))
        except Exception:
            print(&quot --- Submodule initalization failed&quot)
            print(&quotPlease run:\n\tgit submodule update --init --recursive&quot)</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/pytorch/pytorch/commit/7e6a84d2387e1693365f8650d9990c8adc4c7bf4#diff-60f61ab7a8d1910d86d9fda2261620314edcae5894d5aaa236b821c7256badd7L300' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 38147525</div><div id='project'> Project Name: pytorch/pytorch</div><div id='commit'> Commit Name: 7e6a84d2387e1693365f8650d9990c8adc4c7bf4</div><div id='time'> Time: 2021-03-09</div><div id='author'> Author: nshulga@fb.com</div><div id='file'> File Name: setup.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: check_submodules(0)</div><div id='n_method'> N Method Name: check_submodules(0)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: setup.py</div><div id='n_file'> N File Name: setup.py</div><div id='m_start'> M Start Line: 309</div><div id='m_end'> M End Line: 319</div><div id='n_start'> N Start Line: 324</div><div id='n_end'> N End Line: 344</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
    log_dir = os.path.join(args.experiment_dir, "logs")

    train_dataset = DatasetFromObj(os.path.join(data_dir, &quottrain.obj&quot), augment=True, bold=True, rotate=True, blur=True)
    val_dataset = DatasetFromObj(<a id="change">os.path.join(</a>data_dir, &quotval.obj&quot<a id="change">)</a>)
    dataloader = DataLoader(train_dataset, batch_size=args.batch_size, shuffle=True)

    model = Zi2ZiModel(embedding_num=args.embedding_num, embedding_dim=args.embedding_dim,</code></pre><h3>After Change</h3><pre><code class='java'>
    checkpoint_dir = os.path.join(args.experiment_dir, "checkpoint")
    sample_dir = os.path.join(args.experiment_dir, "sample")
    log_dir = os.path.join(args.experiment_dir, "logs")
    start_time<a id="change"> = </a><a id="change">time.time()</a>

    &#47&#47 train_dataset = DatasetFromObj(os.path.join(data_dir, &quottrain.obj&quot), augment=True, bold=True, rotate=True, blur=True)
    &#47&#47 val_dataset = DatasetFromObj(os.path.join(data_dir, &quotval.obj&quot))
    &#47&#47 dataloader = DataLoader(train_dataset, batch_size=args.batch_size, shuffle=True)

    model = Zi2ZiModel(embedding_num=args.embedding_num, embedding_dim=args.embedding_dim,
                       Lconst_penalty=args.Lconst_penalty, Lcategory_penalty=args.Lcategory_penalty,
                       save_dir=checkpoint_dir, gpu_ids=args.gpu_ids)
    model.setup()
    model.print_networks(True)
    if args.resume is not None:
        model.load_networks(args.resume)

    start_epoch = args.resume if args.resume is not None else 0
    global_steps = 0

    for epoch in range(start_epoch, args.epoch):
        &#47&#47 generate dataset every epoch so that different styles of saved char imgs can be trained.
        train_dataset = DatasetFromObj(os.path.join(data_dir, &quottrain.obj&quot),
                                       augment=True, bold=True, rotate=True, blur=True)
        total_batches = math.ceil(len(train_dataset) / args.batch_size)
        dataloader = DataLoader(train_dataset, batch_size=args.batch_size, shuffle=True)
        for bid, batch in enumerate(dataloader):
            model.set_input(batch[0], batch[2], batch[1])
            const_loss, l1_loss, category_loss, cheat_loss = model.optimize_parameters()
            passed = <a id="change">time.time() - </a>start_time
            log_format = "Epoch: [%2d], [%4d/%4d] time: %4.2f, d_loss: %.5f, g_loss: %.5f, " + \
                         "category_loss: %.5f, cheat_loss: %.5f, const_loss: %.5f, l1_loss: %.5f"
            print(log_format % (epoch, bid, total_batches, passed, model.d_loss.item(), model.g_loss.item(),</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/euphoriayan/zi2zi-pytorch/commit/d18cdce2416d812c3944db8aef913e06879b022b#diff-ed183d67207df065a11e1289f19d34cc2abbc5448dea952683cfe9728c342b95L41' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 38147598</div><div id='project'> Project Name: euphoriayan/zi2zi-pytorch</div><div id='commit'> Commit Name: d18cdce2416d812c3944db8aef913e06879b022b</div><div id='time'> Time: 2020-06-29</div><div id='author'> Author: ysq58000@foxmail.com</div><div id='file'> File Name: train.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: main(0)</div><div id='n_method'> N Method Name: main(0)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: train.py</div><div id='n_file'> N File Name: train.py</div><div id='m_start'> M Start Line: 43</div><div id='m_end'> M End Line: 75</div><div id='n_start'> N Start Line: 49</div><div id='n_end'> N End Line: 92</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
            best_epoch = i + 1
            model_name = &quotmodel_&quot + str(best_epoch) + &quot.pkl&quot
            best_model_name = &quotbest_model.pkl&quot
            torch.save(model.state_dict(), <a id="change">os.path.join(</a>configs.checkpoints_dir, model_name<a id="change">)</a>)
            torch.save(model.state_dict(), os.path.join(configs.checkpoints_dir, best_model_name))
            logger.info(&quotsaved &quot + model_name + &quot successful...&quot)
            logger.info(&quotsaved best model successful...&quot)</code></pre><h3>After Change</h3><pre><code class='java'>
    best_f1 = 0
    best_epoch = 0
    unprocessed = 0
    very_start_time<a id="change"> = </a><a id="change">time.time()</a>
    for i in range(configs.epoch):
        logger.info(&quotepoch:{}/{}&quot.format(i + 1, configs.epoch))
        start_time = time.time()
        step, loss, loss_sum = 0, 0.0, 0.0
        for step, loader_res in tqdm(iter(enumerate(loader))):
            sentences = loader_res[&quotsentence&quot].to(device)
            attention_mask = loader_res[&quotattention_mask&quot].to(device)
            entity_vec = loader_res[&quotentity_vec&quot].to(device)
            with torch.no_grad():
                bert_hidden_states = bert_model(sentences, attention_mask=attention_mask)[0].to(device)
            model_output = model(bert_hidden_states).to(device)
            loss = loss_function(model_output, entity_vec.float())
            loss = torch.sum(torch.mean(loss, 3), 2)
            loss = torch.sum(loss * attention_mask) / torch.sum(attention_mask)
            loss_sum += loss.item()
            optimizer.zero_grad()
            loss.backward()
            optimizer.step()
        model.eval()
        logger.info(&quotstart evaluate engines...&quot)
        results_of_each_entity = evaluate(configs, bert_model, model, dev_data, device)
        time_span = (time.time() - start_time) / 60
        f1 = 0.0
        for class_id, performance in results_of_each_entity.items():
            f1 += performance[&quotf1&quot]
            &#47&#47 打印每个类别的指标
            logger.info(&quotclass_name: %s, precision: %.4f, recall: %.4f, f1: %.4f&quot
                        % (class_id, performance[&quotprecision&quot], performance[&quotrecall&quot], performance[&quotf1&quot]))
        &#47&#47 这里算得是所有类别的平均f1值
        f1 = f1 / len(results_of_each_entity)
        logger.info(&quottime consumption:%.2f(min)&quot % time_span)

        if f1 &gt;= best_f1:
            unprocessed = 0
            best_f1 = f1
            best_epoch = i + 1
            torch.save(model.state_dict(), os.path.join(configs.checkpoints_dir, &quotbest_model.pkl&quot))
            logger.info(&quotsaved model successful...&quot)
        else:
            unprocessed += 1
        aver_loss = loss_sum / step
        logger.info(
            &quotaver_loss: %.4f, f1: %.4f, best_f1: %.4f, best_epoch: %d \n&quot % (aver_loss, f1, best_f1, best_epoch))
        if configs.is_early_stop:
            if unprocessed &gt; configs.patient:
                logger.info(&quotearly stopped, no progress obtained within {} epochs&quot.format(configs.patient))
                logger.info(&quotoverall best f1 is {} at {} epoch&quot.format(best_f1, best_epoch))
                logger.info(&quottotal training time consumption: %.3f(min)&quot<a id="change"> % </a>((<a id="change">time.time()</a> - very_start_time) / 60))
                return
    logger.info(&quotoverall best f1 is {} at {} epoch&quot.format(best_f1, best_epoch))
    logger.info(&quottotal training time consumption: %.3f(min)&quot % ((time.time() - very_start_time) / 60))</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/stanleylsx/entity_extractor_by_binary_tagging/commit/08b7b24c919585d56fa49c90b1e299d64de842a1#diff-f78923b490affa9c24b04d4641bd9a4dd31198ebe9bc67b6630776cfac13ed20L18' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 38147663</div><div id='project'> Project Name: stanleylsx/entity_extractor_by_binary_tagging</div><div id='commit'> Commit Name: 08b7b24c919585d56fa49c90b1e299d64de842a1</div><div id='time'> Time: 2020-11-30</div><div id='author'> Author: gzlishouxian@gmail.com</div><div id='file'> File Name: engines/train.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: train(3)</div><div id='n_method'> N Method Name: train(3)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: engines/train.py</div><div id='n_file'> N File Name: engines/train.py</div><div id='m_start'> M Start Line: 37</div><div id='m_end'> M End Line: 91</div><div id='n_start'> N Start Line: 43</div><div id='n_end'> N End Line: 97</div><BR>