<html><h3>Pattern ID :15043
</h3><img src='50455041.png'><BR><BR><BR><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
        return inp

    inp = inp.reshape(ctx.dims.batch, -1, ctx.dims.spatial_mixing_kernel, ctx.dims.features)
    inp<a id="change"> = </a>inp.transpose(0, 3, 1, 2)
    shape = inp.shape
    transposed_shape = list(shape)
    transposed_shape[3], transposed_shape[2] = transposed_shape[2], transposed_shape[3]
    inp = jnp.einsum("bfrs,sz,sz-&gt;bfrz", inp, weights[0], mask)
    for wgt in weights[1:]:
        inp = <a id="change">activate(</a>ctx, inp<a id="change">)</a>
        inp = inp.reshape(*transposed_shape)
        inp = jnp.einsum("bfsr,sz,sz-&gt;bfrz", inp, wgt, mask)
    for _ in range(len(weights) - 1):
        inp<a id="change"> = </a>inp.transpose(0, 1, 3, 2)
        inp<a id="change"> = </a>inp.reshape(*shape)
    return inp.transpose(0, 2, 3, 1).reshape(original_shape)
</code></pre><h3>After Change</h3><pre><code class='java'>
        new_dims = original_dims[:i + 2] + "z" + original_dims[i + 3:]
        reduced_dim = original_dims[i + 2]
        if i &gt; 0:
            inp<a id="change"> = </a><a id="change">activate(</a>inp<a id="change">)</a>
        inp = jnp.einsum(f"{original_dims},{reduced_dim}z,{reduced_dim}z-&gt;{new_dims}", inp, wgt, mask)
    return inp.reshape(original_shape)
</code></pre><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 4</div><BR><div id='size'>Non-data size: 6</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/homebrewnlp/homebrewnlp-jax/commit/e3894fce349563809e673ef1a497a476f9bd8d34#diff-efcd90cee8fb4dad861da47df28097bc6935541500854b8e2d68e0970e05f748L12' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 50455041</div><div id='project'> Project Name: homebrewnlp/homebrewnlp-jax</div><div id='commit'> Commit Name: e3894fce349563809e673ef1a497a476f9bd8d34</div><div id='time'> Time: 2022-09-01</div><div id='author'> Author: 39779310+ClashLuke@users.noreply.github.com</div><div id='file'> File Name: src/model/mixer.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: mix(2)</div><div id='n_method'> N Method Name: mix(2)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: src/model/mixer.py</div><div id='n_file'> N File Name: src/model/mixer.py</div><div id='m_start'> M Start Line: 12</div><div id='m_end'> M End Line: 34</div><div id='n_start'> N Start Line: 14</div><div id='n_end'> N End Line: 32</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        return inp

    normed = instance_norm(ctx, inp)
    mid = <a id="change">activate(</a>ctx, lax.psum(matmul(normed, inp_weight, 2), ParallelAxes.model)<a id="change">)</a>
    out<a id="change"> = </a>dot(mid, out_weight, -1, 1)
    return out

</code></pre><h3>After Change</h3><pre><code class='java'>

    normed = instance_norm(ctx, inp)

    mid<a id="change"> = </a>dot(normed, inp_weight, -1, 1, -2, 0)
    mid = lax.psum(mid, ParallelAxes.model)
    mid = <a id="change">activate(</a>ctx, mid<a id="change">)</a>
    out<a id="change"> = </a>dot(mid, out_weight, -1, 1, 0, 0)
    out<a id="change"> = </a>transpose(out, tuple(range(1, inp.ndim - 1)) + (0, -1))
    return out

</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/homebrewnlp/olmax/commit/62328bde28eb42d5ab31fdce9e34c858d29a206b#diff-6159e4e86b1b15ffd250a78dbdf29a41b004b4963154e49f8b96609b8ea977ceL83' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 50455044</div><div id='project'> Project Name: homebrewnlp/olmax</div><div id='commit'> Commit Name: 62328bde28eb42d5ab31fdce9e34c858d29a206b</div><div id='time'> Time: 2022-02-04</div><div id='author'> Author: 39779310+ClashLuke@users.noreply.github.com</div><div id='file'> File Name: src/model.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: feed_forward(2)</div><div id='n_method'> N Method Name: feed_forward(2)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: src/model.py</div><div id='n_file'> N File Name: src/model.py</div><div id='m_start'> M Start Line: 84</div><div id='m_end'> M End Line: 91</div><div id='n_start'> N Start Line: 84</div><div id='n_end'> N End Line: 95</div><BR>'><BR><BR><BR><h3>Before Change</h3><pre><code class='java'>
        new_dims = original_dims[:i + 2] + "z" + original_dims[i + 3:]
        reduced_dim = original_dims[i + 2]
        if i &gt; 0:
            inp<a id="change"> = </a><a id="change">activate(</a>inp<a id="change">)</a>
        inp = jnp.einsum(f"{original_dims},{reduced_dim}z,{reduced_dim}z-&gt;{new_dims}", inp, wgt, mask)
    return inp.reshape(original_shape)
</code></pre><h3>After Change</h3><pre><code class='java'>
@with_context()
def mix(ctx: Context, inp: jnp.ndarray, depth: jnp.ndarray) -&gt; jnp.ndarray:
    weight_shape = [ctx.dims.spatial_mixing_kernel] * 2
    wgt0<a id="change"> = </a>get_param(ctx, f"mix_0", weight_shape)
    wgt1 = get_param(ctx, f"mix_1", weight_shape)
    if ctx.is_initializing:
        return inp

    original_shape = inp.shape
    max_dims = math.floor(math.log(ctx.dims.sequence, ctx.dims.spatial_mixing_kernel))
    batch = lax.max(ctx.dims.sequence // ctx.dims.spatial_mixing_kernel ** (depth % max_dims + 1), 1)

    mask = jnp.logical_not(jnp.tri(ctx.dims.spatial_mixing_kernel, k=-1)) if ctx.model.autoregressive else 1
    out = inp.reshape(ctx.dims.batch * batch, ctx.dims.spatial_mixing_kernel, -1, ctx.dims.features)
    out = jnp.einsum("bkrf,kg,kg-&gt;bgrf", out, wgt0, mask)
    out<a id="change"> = </a><a id="change">activate(</a>ctx, out<a id="change">)</a>
    out<a id="change"> = </a>jnp.einsum("bkrf,kg,kg-&gt;bgrf", out, wgt1, mask)
    return out.reshape(original_shape)
</code></pre>'><BR><BR><BR><BR><div id='link'><a href='https://github.com/homebrewnlp/homebrewnlp-jax/commit/acfb8d5fbb1ba8f6b7830832f913663e426b9d09#diff-efcd90cee8fb4dad861da47df28097bc6935541500854b8e2d68e0970e05f748L13' target='_blank'>Link</a></div><div id='fragmentid'> Fragment ID: 50455047</div><div id='project'> Project Name: homebrewnlp/homebrewnlp-jax</div><div id='commit'> Commit Name: acfb8d5fbb1ba8f6b7830832f913663e426b9d09</div><div id='time'> Time: 2022-09-01</div><div id='author'> Author: 39779310+ClashLuke@users.noreply.github.com</div><div id='file'> File Name: src/model/mixer.py</div><div id='m_class'> M Class Name: AnonimousClass</div><div id='n_method'> N Class Name: AnonimousClass</div><div id='m_method'> M Method Name: mix(3)</div><div id='n_method'> N Method Name: mix(2)</div><div id='m_parent_class'> M Parent Class: </div><div id='n_parent_class'> N Parent Class: </div><div id='m_file'> M File Name: src/model/mixer.py</div><div id='n_file'> N File Name: src/model/mixer.py</div><div id='m_start'> M Start Line: 14</div><div id='m_end'> M End Line: 32</div><div id='n_start'> N Start Line: 13</div><div id='n_end'> N End Line: 29</div><BR>